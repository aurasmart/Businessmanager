<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Manager - Cloud Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f9fafb;
            color: #111827;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sync-status {
            font-size: 0.875rem;
            color: #16a34a;
            margin-left: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-warning {
            background: #ea580c;
            color: white;
        }

        .btn-warning:hover {
            background: #c2410c;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            padding: 0.25rem 0.5rem;
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .card-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
        }

        .card-body {
            padding: 1rem;
        }

        .search-box {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .customer-list {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .customer-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .customer-item:hover {
            background: #f9fafb;
        }

        .customer-item.active {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
        }

        .customer-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .customer-contact {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .balance {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .balance.positive {
            color: #16a34a;
        }

        .balance.negative {
            color: #dc2626;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid;
        }

        .stat-card.green {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .stat-card.orange {
            background: #fff7ed;
            border-color: #fed7aa;
        }

        .stat-card.blue {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .stat-card.red {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .list-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .list-item:hover {
            background: #f9fafb;
        }

        .empty-state {
            padding: 3rem;
            text-align: center;
            color: #6b7280;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 100%;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background: white;
            margin-top: 0.75rem;
        }

        .file-upload:hover {
            background: #f9fafb;
        }

        .selected-files {
            margin-top: 0.75rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .file-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 0.25rem;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        .close-btn:hover {
            color: #6b7280;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .item-detail {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .item-date {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .placeholder {
            padding: 4rem;
            text-align: center;
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .placeholder-subtext {
            color: #9ca3af;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .attached-file {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }

        .download-btn {
            background: none;
            border: none;
            color: #2563eb;
            cursor: pointer;
            padding: 0.25rem;
        }

        .download-btn:hover {
            color: #1d4ed8;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
            padding: 0 0.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #111827;
        }

        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-won {
            background: #d1fae5;
            color: #065f46;
        }

        .status-ongoing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-handovered {
            background: #e0e7ff;
            color: #4338ca;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .setup-notice {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .setup-notice h3 {
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .setup-notice p {
            color: #78350f;
            font-size: 0.875rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            margin: 1rem;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            color: #111827;
        }

        .login-box .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 2rem;
            font-size: 0.875rem;
        }

        .login-box .form-group {
            margin-bottom: 1.5rem;
        }

        .login-box .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .login-box .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .login-box .btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .login-toggle {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .login-toggle a {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

        .login-toggle a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .role-badge-header {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .role-admin {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-viewer {
            background: #fef3c7;
            color: #92400e;
        }

        .role-superadmin {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .user-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .user-card-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .user-card-email {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .password-display {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .copy-button:hover {
            background: #1d4ed8;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .user-button:hover {
            background: #e5e7eb;
        }

        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 100;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        .user-dropdown-item:hover {
            background: #f9fafb;
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
            color: #dc2626;
        }

        .readonly-notice {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #92400e;
        }

        /* Aura Smart Logo Styles */
        .aura-logo-header {
            height: 40px;
            width: auto;
            margin-right: 1rem;
        }

        .aura-logo-login {
            height: 70px;
            width: auto;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <img src="data:image/png;base64,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" class="aura-logo-login" alt="Aura Smart">
            <h1>üè¢ Business Manager</h1>
            <p class="subtitle">Secure access to your business data</p>
            
            <div id="loginError" class="error-message" style="display: none;"></div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" class="input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="input" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>
                <div class="login-toggle">
               
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signupName" class="input" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" class="input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" class="input" placeholder="Min. 6 characters">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="signupRole" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="superadmin">Super Admin (User Management)</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="handleSignup()">Create Account</button>
                <div class="login-toggle">
                    Already have an account? <a onclick="toggleAuthForm()">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <div class="header" id="appHeader" style="display: none;">
        <div class="header-content">
            <div style="display: flex; align-items: center;">
                <img src="data:image/png;base64,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" class="aura-logo-header" alt="Aura Smart">
                <h1>Business Manager</h1>
                <span class="sync-status" id="syncStatus">‚òÅÔ∏è Cloud Sync Active</span>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-secondary" onclick="testFirebaseConnection()" style="background: #10b981; color: white; border: none;">üß™ Test Firebase</button>
                <button class="btn btn-primary" id="addCustomerBtn" onclick="showAddCustomerModal()">+ Add Customer</button>
                <button class="btn btn-primary" id="addProjectBtn" onclick="showAddProjectModal()" style="display: none;">+ Add Project</button>
                
                <!-- User Menu -->
                <div class="user-menu">
                    <button class="user-button" onclick="toggleUserMenu()">
                        <span id="userDisplayName">User</span>
                        <span class="role-badge-header" id="userRoleBadge">Viewer</span>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-item" style="cursor: default; background: #f9fafb;">
                            <div style="font-weight: 600;" id="dropdownEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bdd8d0dcd4d1fdd8c5dcd0cdd1d893ded2d0">[email&#160;protected]</a></div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;" id="dropdownRole">Role: Viewer</div>
                        </div>
                        <div class="user-dropdown-item" onclick="handleLogout()">üö™ Logout</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <div id="setupNotice" class="setup-notice" style="display: none;">
            <h3>‚ö†Ô∏è Firebase Setup Required</h3>
            <p>Please add your Firebase configuration in the script section. See SETUP_GUIDE.md for instructions.</p>
        </div>

        <div id="loadingState" class="loading">
            <div>Loading data from cloud...</div>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('customers')">üë• Customers</button>
                <button class="tab" onclick="switchTab('projects')">üèóÔ∏è Projects</button>
                <button class="tab" id="userManagementTab" onclick="switchTab('users')" style="display: none;">‚öôÔ∏è User Management</button>
            </div>

            <!-- Customers Tab -->
            <div id="customersTab" style="display: block;">
                <div class="grid">
                    <!-- Customer List -->
                    <div class="card">
                        <div class="card-header">
                            <input type="text" class="search-box" placeholder="üîç Search customers..." id="searchInput" oninput="filterCustomers()">
                        </div>
                        <div class="customer-list" id="customerList"></div>
                    </div>

                    <!-- Customer Details -->
                    <div id="detailsPanel"></div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="projectsTab" style="display: none;">
                <div class="grid">
                    <!-- Project List -->
                    <div class="card">
                        <div class="card-header">
                            <input type="text" class="search-box" placeholder="üîç Search projects..." id="projectSearchInput" oninput="filterProjects()">
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('all')">All</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('won')">Won</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('ongoing')">Ongoing</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('handovered')">Handovered</button>
                            </div>
                        </div>
                        <div class="customer-list" id="projectList"></div>
                    </div>

                    <!-- Project Details -->
                    <div id="projectDetailsPanel"></div>
                </div>
            </div>

            <!-- User Management Tab (Super Admin Only) -->
            <div id="usersTab" style="display: none;">
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>üë• User Management</h2>
                        <button class="btn btn-primary" onclick="showCreateUserModal()">+ Create User</button>
                    </div>
                    <div class="card-body">
                        <div id="usersList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal (Super Admin) -->
    <div class="modal" id="createUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New User</h2>
                <button class="close-btn" onclick="closeModal('createUserModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="createUserError" class="error-message" style="display: none;"></div>
                
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="createUserName" class="input" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="createUserEmail" class="input" placeholder="user@company.com">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="createUserRole" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="superadmin">Super Admin (User Management)</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="generateRandomPassword()" style="width: 100%;">üé≤ Generate Random Password</button>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="text" id="createUserPassword" class="input" placeholder="Min. 8 characters">
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        User will receive this password. Ask them to change it after first login.
                    </div>
                </div>
                <div id="generatedPasswordDisplay" style="display: none;">
                    <label style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; display: block;">Generated Password:</label>
                    <div class="password-display">
                        <span id="generatedPasswordText"></span>
                        <button class="copy-button" onclick="copyPassword()">üìã Copy</button>
                    </div>
                    <div style="font-size: 0.75rem; color: #dc2626; margin-top: 0.25rem;">
                        ‚ö†Ô∏è Save this password! Share it securely with the user.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="createNewUser()" style="flex: 1">Create User</button>
            </div>
        </div>
    </div>

    <!-- Change Role Modal -->
    <div class="modal" id="changeRoleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change User Role</h2>
                <button class="close-btn" onclick="closeModal('changeRoleModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Change role for: <strong id="changeRoleUserEmail"></strong></p>
                <div class="form-group">
                    <label>New Role</label>
                    <select id="newRoleSelect" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="superadmin">Super Admin (User Management)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('changeRoleModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveRoleChange()" style="flex: 1">Save Role</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal" id="resetPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset User Password</h2>
                <button class="close-btn" onclick="closeModal('resetPasswordModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Reset password for: <strong id="resetPasswordUserEmail"></strong></p>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="generateResetPassword()" style="width: 100%;">üé≤ Generate Random Password</button>
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="text" id="resetPasswordInput" class="input" placeholder="Min. 8 characters">
                </div>
                <div id="resetPasswordDisplay" style="display: none;">
                    <label style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; display: block;">Generated Password:</label>
                    <div class="password-display">
                        <span id="resetPasswordText"></span>
                        <button class="copy-button" onclick="copyResetPassword()">üìã Copy</button>
                    </div>
                    <div style="font-size: 0.75rem; color: #dc2626; margin-top: 0.25rem;">
                        ‚ö†Ô∏è Save this password! Share it securely with the user.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="resetUserPassword()" style="flex: 1">Reset Password</button>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Customer</h2>
                <button class="close-btn" onclick="closeModal('addCustomerModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" class="input" id="newCustomerName" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label>Contact (Optional)</label>
                    <input type="text" class="input" id="newCustomerContact" placeholder="Phone or email">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addCustomerModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="addCustomer()" style="flex: 1">Add Customer</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">Add New Project</h2>
                <button class="close-btn" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" class="input" id="projectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <select class="input" id="projectCustomer">
                        <option value="">Select customer (optional)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stage *</label>
                    <select class="input" id="projectStage">
                        <option value="won">Won</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="handovered">Handovered</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project Value</label>
                    <input type="number" class="input" id="projectValue" placeholder="Enter value">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="input" id="projectStartDate">
                </div>
                <div class="form-group">
                    <label>Expected Completion</label>
                    <input type="date" class="input" id="projectEndDate">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="input" id="projectDescription" rows="3" placeholder="Project details..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()" style="flex: 1" id="saveProjectBtn">Add Project</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // ====================================
        // FIREBASE CONFIGURATION
        // Replace these values with your Firebase project settings
        // ====================================
        const firebaseConfig = {
            apiKey: "AIzaSyAn46wP_Z4ABgo-J3R-oRl-BDPJVih9IEg",
            authDomain: "business-manager-73c4e.firebaseapp.com",
            projectId: "business-manager-73c4e",
            storageBucket: "business-manager-73c4e.firebasestorage.app",
            messagingSenderId: "612350057386",
            appId: "1:612350057386:web:35c5f4d65ce0066b88e9d3"
        };

        // Initialize Firebase
        let db;
        let auth;
        let customersListener;
        let projectsListener;
        let customers = [];
        let projects = [];
        let selectedCustomer = null;
        let selectedProject = null;
        let selectedFiles = [];
        let currentTab = 'customers';
        let projectStageFilter = 'all';
        let editingProjectId = null;
        let currentUser = null;
        let userRole = null;
        let allUsers = [];
        let selectedUserForRole = null;
        let selectedUserForPassword = null;
        
        // Backend API URL - Update this to your deployed backend URL
        const BACKEND_API_URL = 'https://business-manager-backend-production-8034.up.railway.app/api';  // Change to your production URL when deployed

        // ========================================
        // AUTHENTICATION
        // ========================================

        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            }
            
            document.getElementById('loginError').style.display = 'none';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Login successful');
            } catch (error) {
                console.error('Login error:', error);
                showError(getAuthErrorMessage(error.code));
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;
            
            if (!name || !email || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update profile with name
                await userCredential.user.updateProfile({ displayName: name });
                
                // Store user role in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString()
                });
                
                console.log('‚úÖ Signup successful');
            } catch (error) {
                console.error('Signup error:', error);
                showError(getAuthErrorMessage(error.code));
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                console.log('‚úÖ Logout successful');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out');
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu && !userMenu.contains(event.target)) {
                document.getElementById('userDropdown').classList.remove('show');
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function getAuthErrorMessage(code) {
            const messages = {
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/email-already-in-use': 'Email already registered',
                'auth/weak-password': 'Password is too weak',
                'auth/invalid-email': 'Invalid email address',
                'auth/too-many-requests': 'Too many attempts. Try again later'
            };
            return messages[code] || 'Authentication error. Please try again.';
        }

        async function getUserRole(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    return userDoc.data().role || 'viewer';
                }
                return 'viewer'; // Default to viewer if no role found
            } catch (error) {
                console.error('Error getting user role:', error);
                return 'viewer';
            }
        }

        function isAdmin() {
            return userRole === 'admin' || userRole === 'superadmin';
        }

        function isSuperAdmin() {
            return userRole === 'superadmin';
        }

        function canManageData() {
            return userRole === 'admin' || userRole === 'superadmin';
        }

        function canManageUsers() {
            return userRole === 'superadmin';
        }

        function updateUIForRole() {
            const isAdminUser = isAdmin();
            const isSuperAdminUser = isSuperAdmin();
            
            // Update role badge
            const roleBadge = document.getElementById('userRoleBadge');
            if (isSuperAdminUser) {
                roleBadge.textContent = 'Super Admin';
                roleBadge.className = 'role-badge-header role-superadmin';
            } else if (isAdminUser) {
                roleBadge.textContent = 'Admin';
                roleBadge.className = 'role-badge-header role-admin';
            } else {
                roleBadge.textContent = 'Viewer';
                roleBadge.className = 'role-badge-header role-viewer';
            }
            
            // Show/hide tabs and buttons
            document.getElementById('userManagementTab').style.display = isSuperAdminUser ? 'block' : 'none';
            document.getElementById('addCustomerBtn').style.display = canManageData() ? 'block' : 'none';
            document.getElementById('addProjectBtn').style.display = (canManageData() && currentTab === 'projects') ? 'block' : 'none';
            
            // Add notices
            if (isSuperAdminUser) {
                const notice = document.createElement('div');
                notice.className = 'readonly-notice';
                notice.style.background = '#f3e8ff';
                notice.style.borderColor = '#c084fc';
                notice.style.color = '#6b21a8';
                notice.innerHTML = 'üëë <strong>Super Admin:</strong> You have full access to everything - user management AND business operations.';
                notice.id = 'readonlyNotice';
                
                const container = document.getElementById('appContainer');
                if (container && !document.getElementById('readonlyNotice')) {
                    container.insertBefore(notice, container.firstChild);
                }
            } else if (!isAdminUser) {
                const notice = document.createElement('div');
                notice.className = 'readonly-notice';
                notice.innerHTML = 'üëÅÔ∏è <strong>View-Only Access:</strong> You can view all data but cannot make changes.';
                notice.id = 'readonlyNotice';
                
                const container = document.getElementById('appContainer');
                if (container && !document.getElementById('readonlyNotice')) {
                    container.insertBefore(notice, container.firstChild);
                }
            } else {
                const notice = document.getElementById('readonlyNotice');
                if (notice) notice.remove();
            }
            
            // Re-render UI
            if (currentTab === 'customers' && selectedCustomer) {
                renderDetails();
            } else if (currentTab === 'projects' && selectedProject) {
                renderProjectDetails();
            } else if (currentTab === 'users' && isSuperAdminUser) {
                loadAllUsers();
            }
        }

        function checkPermission(action = 'write') {
            if (action === 'write' && !canManageData()) {
                alert('‚õî Permission Denied\n\nYou have view-only access. Contact an admin to make changes.');
                return false;
            }
            if (action === 'manage-users' && !isSuperAdmin()) {
                alert('‚õî Permission Denied\n\nOnly Super Admins can manage users.');
                return false;
            }
            return true;
        }

        // ========================================
        // USER MANAGEMENT (SUPER ADMIN ONLY)
        // ========================================

        async function loadAllUsers() {
            if (!isSuperAdmin()) return;
            
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    allUsers.push({
                        uid: doc.id,
                        ...doc.data()
                    });
                });
                renderUsersList();
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load users');
            }
        }

        function renderUsersList() {
            if (!isSuperAdmin()) return;
            
            const usersHtml = allUsers.length === 0 ?
                '<div class="empty-state">No users yet</div>' :
                allUsers.map(user => {
                    const roleClass = `status-${user.role}`;
                    const roleBadgeClass = user.role === 'superadmin' ? 'role-superadmin' : user.role === 'admin' ? 'role-admin' : 'role-viewer';
                    const roleLabel = user.role === 'superadmin' ? 'Super Admin' : user.role === 'admin' ? 'Admin' : 'Viewer';
                    
                    return `
                        <div class="user-card">
                            <div class="user-card-header">
                                <div>
                                    <div class="user-card-name">${user.name || 'Unnamed User'}</div>
                                    <div class="user-card-email">${user.email}</div>
                                </div>
                                <span class="status-badge ${roleBadgeClass}">${roleLabel}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                Created: ${new Date(user.createdAt).toLocaleDateString()}
                            </div>
                            ${user.uid !== currentUser.uid ? `
                                <div class="user-actions">
                                    <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="showChangeRoleModal('${user.uid}', '${user.email}', '${user.role}')">Change Role</button>
                                    <button class="btn btn-warning" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="showResetPasswordModal('${user.uid}', '${user.email}')">Reset Password</button>
                                    <button class="btn btn-danger" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="deleteUser('${user.uid}', '${user.email}')">Delete</button>
                                </div>
                            ` : '<div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem; font-style: italic;">This is your account</div>'}
                        </div>
                    `;
                }).join('');
            
            document.getElementById('usersList').innerHTML = usersHtml;
        }

        function showCreateUserModal() {
            if (!checkPermission('manage-users')) return;
            
            document.getElementById('createUserName').value = '';
            document.getElementById('createUserEmail').value = '';
            document.getElementById('createUserRole').value = 'viewer';
            document.getElementById('createUserPassword').value = '';
            document.getElementById('generatedPasswordDisplay').style.display = 'none';
            document.getElementById('createUserError').style.display = 'none';
            document.getElementById('createUserModal').classList.add('show');
        }

        function generateRandomPassword() {
            const length = 12;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('createUserPassword').value = password;
            document.getElementById('generatedPasswordText').textContent = password;
            document.getElementById('generatedPasswordDisplay').style.display = 'block';
        }

        function copyPassword() {
            const password = document.getElementById('generatedPasswordText').textContent;
            navigator.clipboard.writeText(password).then(() => {
                const btn = event.target;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy', 2000);
            });
        }

        async function createNewUser() {
            if (!checkPermission('manage-users')) return;
            
            const name = document.getElementById('createUserName').value.trim();
            const email = document.getElementById('createUserEmail').value.trim();
            const role = document.getElementById('createUserRole').value;
            const password = document.getElementById('createUserPassword').value;
            
            const errorDiv = document.getElementById('createUserError');
            
            if (!name || !email || !password) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 8) {
                errorDiv.textContent = 'Password must be at least 8 characters';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // Get current user's auth token
                const idToken = await currentUser.getIdToken();
                
                // Call backend API to create user
                const response = await fetch(`${BACKEND_API_URL}/users/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        displayName: name,
                        role: role
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create user');
                }
                
                console.log('‚úÖ User created successfully:', data);
                alert(`‚úÖ User created successfully!

Email: ${email}
Password: ${password}
Role: ${role === 'superadmin' ? 'Super Admin' : role === 'admin' ? 'Admin' : 'Viewer'}

Share these credentials securely with the user.
They can login immediately!`);
                
                closeModal('createUserModal');
                loadAllUsers();
                
            } catch (error) {
                console.error('‚ùå Error creating user:', error);
                errorDiv.textContent = 'Failed to create user: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function showChangeRoleModal(uid, email, currentRole) {
            if (!checkPermission('manage-users')) return;
            
            selectedUserForRole = uid;
            document.getElementById('changeRoleUserEmail').textContent = email;
            document.getElementById('newRoleSelect').value = currentRole;
            document.getElementById('changeRoleModal').classList.add('show');
        }

        async function saveRoleChange() {
            if (!checkPermission('manage-users')) return;
            
            const newRole = document.getElementById('newRoleSelect').value;
            
            try {
                await db.collection('users').doc(selectedUserForRole).update({
                    role: newRole
                });
                
                console.log('‚úÖ Role updated successfully');
                alert('Role updated successfully! User will see changes on next login.');
                closeModal('changeRoleModal');
                loadAllUsers();
            } catch (error) {
                console.error('Error updating role:', error);
                alert('Failed to update role: ' + error.message);
            }
        }

        function showResetPasswordModal(uid, email) {
            if (!checkPermission('manage-users')) return;
            
            selectedUserForPassword = { uid, email };
            document.getElementById('resetPasswordUserEmail').textContent = email;
            document.getElementById('resetPasswordInput').value = '';
            document.getElementById('resetPasswordDisplay').style.display = 'none';
            document.getElementById('resetPasswordModal').classList.add('show');
        }

        function generateResetPassword() {
            const length = 12;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('resetPasswordInput').value = password;
            document.getElementById('resetPasswordText').textContent = password;
            document.getElementById('resetPasswordDisplay').style.display = 'block';
        }

        function copyResetPassword() {
            const password = document.getElementById('resetPasswordText').textContent;
            navigator.clipboard.writeText(password).then(() => {
                const btn = event.target;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy', 2000);
            });
        }

        async function resetUserPassword() {
            if (!checkPermission('manage-users')) return;
            
            const newPassword = document.getElementById('resetPasswordInput').value;
            
            if (!newPassword || newPassword.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }
            
            try {
                // Get current user's auth token
                const idToken = await currentUser.getIdToken();
                
                // Call backend API to reset password
                const response = await fetch(`${BACKEND_API_URL}/users/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        email: selectedUserForPassword.email,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to reset password');
                }
                
                console.log('‚úÖ Password reset successfully');
                alert(`‚úÖ Password reset successfully!

User: ${selectedUserForPassword.email}
New Password: ${newPassword}

Share this password securely with the user.
They can login immediately with the new password!`);
                
                closeModal('resetPasswordModal');
            } catch (error) {
                console.error('‚ùå Error resetting password:', error);
                alert('Failed to reset password: ' + error.message);
            }
        }

        async function deleteUser(uid, email) {
            if (!checkPermission('manage-users')) return;
            
            if (!confirm(`Are you sure you want to delete user: ${email}?\n\nThis will:\n- Remove from Firestore\n- Delete Firebase Authentication account\n\nThis action cannot be undone.`)) return;
            
            try {
                // Get current user's auth token
                const idToken = await currentUser.getIdToken();
                
                // Call backend API to delete user completely
                const response = await fetch(`${BACKEND_API_URL}/users/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        uid: uid
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete user');
                }
                
                console.log('‚úÖ User deleted successfully');
                alert(`‚úÖ User deleted successfully!

${email} has been completely removed from the system.`);
                
                loadAllUsers();
            } catch (error) {
                console.error('‚ùå Error deleting user:', error);
                alert('Failed to delete user: ' + error.message);
            }
        }

        // Firebase Connection Test
        async function testFirebaseConnection() {
            const results = [];
            
            try {
                results.push('üîç Starting Firebase Connection Test...\n');
                
                // Test 1: Check if Firebase is initialized
                results.push('Test 1: Firebase Initialization');
                if (!firebase.apps.length) {
                    results.push('‚ùå FAILED: Firebase not initialized');
                    results.push('   Fix: Check if firebaseConfig is correct\n');
                    alert(results.join('\n'));
                    console.log(results.join('\n'));
                    return;
                }
                results.push('‚úÖ PASSED: Firebase initialized\n');
                
                // Test 2: Check Firestore connection
                results.push('Test 2: Firestore Connection');
                if (!db) {
                    results.push('‚ùå FAILED: Firestore not connected');
                    results.push('   Fix: Check Firebase console - Firestore should be enabled\n');
                    alert(results.join('\n'));
                    console.log(results.join('\n'));
                    return;
                }
                results.push('‚úÖ PASSED: Firestore connected\n');
                
                // Test 3: Try to write test data
                results.push('Test 3: Write Test Data');
                const testDoc = {
                    testField: 'Firebase Connection Test',
                    timestamp: new Date().toISOString()
                };
                
                try {
                    const docRef = await db.collection('_test').add(testDoc);
                    results.push('‚úÖ PASSED: Successfully wrote test document');
                    results.push(`   Document ID: ${docRef.id}\n`);
                    
                    // Test 4: Try to read the data back
                    results.push('Test 4: Read Test Data');
                    const doc = await docRef.get();
                    if (doc.exists) {
                        results.push('‚úÖ PASSED: Successfully read test document');
                        results.push(`   Data: ${JSON.stringify(doc.data())}\n`);
                    } else {
                        results.push('‚ùå FAILED: Could not read test document\n');
                    }
                    
                    // Test 5: Delete test document
                    results.push('Test 5: Delete Test Data');
                    await docRef.delete();
                    results.push('‚úÖ PASSED: Successfully deleted test document\n');
                    
                    // Test 6: Check customers collection
                    results.push('Test 6: Check Customers Collection');
                    const customersSnapshot = await db.collection('customers').limit(1).get();
                    results.push(`‚úÖ PASSED: Customers collection accessible`);
                    results.push(`   Current customers: ${customersSnapshot.size}\n`);
                    
                } catch (writeError) {
                    results.push('‚ùå FAILED: ' + writeError.message);
                    
                    if (writeError.code === 'permission-denied') {
                        results.push('\nüîß FIX NEEDED: Security Rules Issue');
                        results.push('   Go to Firebase Console ‚Üí Firestore ‚Üí Rules');
                        results.push('   Replace rules with:\n');
                        results.push('   rules_version = \'2\';');
                        results.push('   service cloud.firestore {');
                        results.push('     match /databases/{database}/documents {');
                        results.push('       match /{document=**} {');
                        results.push('         allow read, write: if true;');
                        results.push('       }');
                        results.push('     }');
                        results.push('   }\n');
                    } else if (writeError.code === 'unavailable') {
                        results.push('\nüîß FIX NEEDED: Network/Connection Issue');
                        results.push('   - Check your internet connection');
                        results.push('   - Try refreshing the page');
                        results.push('   - Check if Firebase service is down\n');
                    } else {
                        results.push(`\nüîß Error Code: ${writeError.code}`);
                        results.push(`   Message: ${writeError.message}\n`);
                    }
                }
                
                results.push('\n' + '='.repeat(50));
                results.push('üìä TEST SUMMARY');
                results.push('='.repeat(50));
                
                const passed = results.filter(r => r.includes('‚úÖ PASSED')).length;
                const failed = results.filter(r => r.includes('‚ùå FAILED')).length;
                
                results.push(`Tests Passed: ${passed}`);
                results.push(`Tests Failed: ${failed}`);
                
                if (failed === 0) {
                    results.push('\nüéâ ALL TESTS PASSED!');
                    results.push('Firebase is working correctly.');
                    results.push('Your data should sync properly.');
                    document.getElementById('syncStatus').textContent = '‚úÖ Firebase Connected';
                    document.getElementById('syncStatus').style.color = '#16a34a';
                } else {
                    results.push('\n‚ö†Ô∏è  SOME TESTS FAILED');
                    results.push('Please fix the issues above.');
                    document.getElementById('syncStatus').textContent = '‚ö†Ô∏è  Connection Issue';
                    document.getElementById('syncStatus').style.color = '#ea580c';
                }
                
            } catch (error) {
                results.push('\nüí• CRITICAL ERROR:');
                results.push(error.message);
                results.push('\nStack trace:');
                results.push(error.stack);
            }
            
            // Display results
            const resultText = results.join('\n');
            console.log(resultText);
            alert(resultText);
        }

        function initializeFirebase() {
            try {
                // Check if config is set
                if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                    document.getElementById('setupNotice').style.display = 'block';
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    // Fallback to localStorage
                    loadFromLocalStorage();
                    return;
                }

                console.log('üî• Initializing Firebase...');
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log('‚úÖ Firebase initialized successfully!');
                
                // Set up authentication state listener
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üë§ User logged in:', user.email);
                        currentUser = user;
                        
                        // Get user role
                        userRole = await getUserRole(user.uid);
                        console.log('üîë User role:', userRole);
                        
                        // Update UI with user info
                        document.getElementById('userDisplayName').textContent = user.displayName || user.email.split('@')[0];
                        document.getElementById('dropdownEmail').textContent = user.email;
                        document.getElementById('dropdownRole').textContent = `Role: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`;
                        
                        // Hide login, show app
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('appHeader').style.display = 'block';
                        document.getElementById('appContainer').style.display = 'block';
                        
                        // Update UI based on role
                        updateUIForRole();
                        
                        // Initialize data listeners
                        setupDataListeners();
                    } else {
                        console.log('üë§ User logged out');
                        currentUser = null;
                        userRole = null;
                        
                        // Show login, hide app
                        document.getElementById('loginScreen').style.display = 'flex';
                        document.getElementById('appHeader').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'none';
                        
                        // Clear data
                        customers = [];
                        projects = [];
                        selectedCustomer = null;
                        selectedProject = null;
                    }
                });
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.getElementById('syncStatus').textContent = '‚ùå Offline Mode';
                loadFromLocalStorage();
            }
        }

        function setupDataListeners() {
            // Listen to real-time updates
            customersListener = db.collection('customers').onSnapshot((snapshot) => {
                console.log('üì° Received snapshot update:', snapshot.size, 'customers');
                customers = [];
                snapshot.forEach((doc) => {
                    customers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by creation date
                customers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                document.getElementById('syncStatus').style.color = '#16a34a';
                renderCustomerList();
                
                // Update selected customer if viewing one
                if (selectedCustomer) {
                    const updated = customers.find(c => c.id === selectedCustomer.id);
                    if (updated) {
                        selectedCustomer = updated;
                        renderDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Firebase snapshot error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                document.getElementById('syncStatus').textContent = '‚ùå Sync Error';
                document.getElementById('syncStatus').style.color = '#dc2626';
                
                if (error.code === 'permission-denied') {
                    alert('‚ö†Ô∏è PERMISSION DENIED\n\nFirebase security rules are blocking access.\n\nFix:\n1. Go to Firebase Console\n2. Click Firestore Database\n3. Click Rules tab\n4. Update rules (see setup guide)\n5. Click Publish\n\nThen refresh this page.');
                }
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            });

            // Listen to projects real-time updates
            projectsListener = db.collection('projects').onSnapshot((snapshot) => {
                console.log('üì° Received projects update:', snapshot.size, 'projects');
                projects = [];
                snapshot.forEach((doc) => {
                    projects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                renderProjectList();
                
                if (selectedProject) {
                    const updated = projects.find(p => p.id === selectedProject.id);
                    if (updated) {
                        selectedProject = updated;
                        renderProjectDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Projects snapshot error:', error);
            });
        }

        // Fallback to localStorage if Firebase not configured
        function loadFromLocalStorage() {
            const customerData = localStorage.getItem('business-manager-data');
            if (customerData) {
                customers = JSON.parse(customerData);
            }
            const projectData = localStorage.getItem('business-manager-projects');
            if (projectData) {
                projects = JSON.parse(projectData);
            }
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            renderCustomerList();
            renderProjectList();
            renderDetails();
        }

        function saveToLocalStorage() {
            localStorage.setItem('business-manager-data', JSON.stringify(customers));
            localStorage.setItem('business-manager-projects', JSON.stringify(projects));
        }

        // Add customer
        async function addCustomer() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('newCustomerName').value.trim();
            const contact = document.getElementById('newCustomerContact').value.trim();

            if (!name) {
                alert('Please enter customer name');
                return;
            }

            const newCustomer = {
                name: name,
                contact: contact,
                payments: [],
                materials: [],
                createdAt: new Date().toISOString()
            };

            try {
                console.log('üíæ Attempting to add customer:', newCustomer);
                
                if (db) {
                    console.log('üì§ Writing to Firebase...');
                    const docRef = await db.collection('customers').add(newCustomer);
                    console.log('‚úÖ Customer added to Firebase with ID:', docRef.id);
                } else {
                    console.log('üíæ No Firebase connection - saving to localStorage');
                    customers.push({
                        id: Date.now().toString(),
                        ...newCustomer
                    });
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                closeModal('addCustomerModal');
                document.getElementById('newCustomerName').value = '';
                document.getElementById('newCustomerContact').value = '';
            } catch (error) {
                console.error('‚ùå Error adding customer:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                if (error.code === 'permission-denied') {
                    alert('‚ö†Ô∏è PERMISSION DENIED\n\nCannot write to Firebase.\n\nFix:\n1. Go to Firebase Console\n2. Click Firestore Database\n3. Click Rules tab\n4. Set: allow read, write: if true;\n5. Click Publish');
                } else {
                    alert('Failed to add customer: ' + error.message);
                }
            }
        }

        // Render customer list
        function renderCustomerList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(search) || 
                (c.contact && c.contact.toLowerCase().includes(search))
            );

            const html = filtered.length === 0 ? 
                '<div class="empty-state">No customers found</div>' :
                filtered.map(c => {
                    const customerProjects = projects.filter(p => p.customerId === c.id);
                    const projectCount = customerProjects.length;
                    const totalValue = customerProjects.reduce((sum, p) => sum + (p.value || 0), 0);
                    const isActive = selectedCustomer && selectedCustomer.id === c.id;
                    
                    return `
                        <div class="customer-item ${isActive ? 'active' : ''}" onclick="selectCustomer('${c.id}')">
                            <div class="customer-name">${c.name}</div>
                            ${c.contact ? `<div class="customer-contact">${c.contact}</div>` : ''}
                            <div class="balance positive">
                                ${projectCount} project${projectCount !== 1 ? 's' : ''}
                                ${totalValue > 0 ? ` ‚Ä¢ ${formatCurrency(totalValue)}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('customerList').innerHTML = html;
        }

        // Select customer
        function selectCustomer(id) {
            selectedCustomer = customers.find(c => c.id === id);
            renderCustomerList();
            renderDetails();
        }

        // Calculate totals
        function calculateTotals(customer) {
            const totalPaid = (customer.payments || []).reduce((sum, p) => sum + p.amount, 0);
            const totalMaterials = (customer.materials || []).reduce((sum, m) => sum + m.cost, 0);
            return {
                totalPaid,
                totalMaterials,
                balance: totalPaid - totalMaterials
            };
        }

        // Format currency
        function formatCurrency(amount) {
            return '‚Çπ' + amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Render details panel
        function renderDetails() {
            if (!selectedCustomer) {
                document.getElementById('detailsPanel').innerHTML = `
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">üìä</div>
                            <div class="placeholder-text">Select a Customer</div>
                            <div class="placeholder-subtext">Choose a customer to view their projects</div>
                        </div>
                    </div>
                `;
                return;
            }

            // Get projects for this customer
            const customerProjects = projects.filter(p => p.customerId === selectedCustomer.id);
            
            // Calculate totals across all projects
            let totalProjectValue = 0;
            let totalPaid = 0;
            let totalMaterials = 0;
            
            customerProjects.forEach(p => {
                if (p.value) totalProjectValue += p.value;
                if (p.payments) totalPaid += p.payments.reduce((sum, pay) => sum + pay.amount, 0);
                if (p.materials) totalMaterials += p.materials.reduce((sum, mat) => sum + mat.cost, 0);
            });
            
            const balance = totalPaid - totalMaterials;

            const projectsHtml = customerProjects.length === 0 ?
                '<div class="empty-state">No projects for this customer yet</div>' :
                customerProjects.map(p => {
                    const stageClass = `status-${p.stage}`;
                    const stageLabel = p.stage.charAt(0).toUpperCase() + p.stage.slice(1);
                    const projectPayments = (p.payments || []).reduce((sum, pay) => sum + pay.amount, 0);
                    const projectMaterials = (p.materials || []).reduce((sum, mat) => sum + mat.cost, 0);
                    const projectBalance = projectPayments - projectMaterials;
                    
                    return `
                        <div class="list-item" style="cursor: pointer;" onclick="switchToProject('${p.id}')">
                            <div class="item-info" style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div class="item-title">${p.name}</div>
                                    <span class="status-badge ${stageClass}">${stageLabel}</span>
                                </div>
                                ${p.value ? `<div class="item-detail">üí∞ Project Value: ${formatCurrency(p.value)}</div>` : ''}
                                <div class="item-detail">
                                    Paid: ${formatCurrency(projectPayments)} | Materials: ${formatCurrency(projectMaterials)} | 
                                    <span style="color: ${projectBalance >= 0 ? '#16a34a' : '#dc2626'}; font-weight: 600;">
                                        Balance: ${formatCurrency(projectBalance)}
                                    </span>
                                </div>
                                ${p.startDate ? `<div class="item-date">Started: ${new Date(p.startDate).toLocaleDateString()}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('detailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Customer Info -->
                    <div class="card">
                        <div class="card-header">
                            <h2>${selectedCustomer.name}</h2>
                        </div>
                        <div class="card-body">
                            ${selectedCustomer.contact ? `
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Contact</div>
                                    <div style="font-weight: 600;">üìû ${selectedCustomer.contact}</div>
                                </div>
                            ` : ''}
                            <div style="font-size: 0.75rem; color: #9ca3af;">
                                Customer since: ${formatDate(selectedCustomer.createdAt)}
                            </div>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="stats">
                        <div class="stat-card green">
                            <div class="stat-label" style="color: #16a34a">Total Projects</div>
                            <div class="stat-value" style="color: #15803d">${customerProjects.length}</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-label" style="color: #2563eb">Total Value</div>
                            <div class="stat-value" style="color: #1d4ed8">${formatCurrency(totalProjectValue)}</div>
                        </div>
                        <div class="stat-card ${balance >= 0 ? 'blue' : 'red'}">
                            <div class="stat-label" style="color: ${balance >= 0 ? '#2563eb' : '#dc2626'}">Net Balance</div>
                            <div class="stat-value" style="color: ${balance >= 0 ? '#1d4ed8' : '#b91c1c'}">${formatCurrency(balance)}</div>
                        </div>
                    </div>

                    <!-- Projects List -->
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>üèóÔ∏è Projects</h3>
                            ${isAdmin() ? `<button class="btn btn-primary" onclick="createProjectForCustomer('${selectedCustomer.id}')" style="font-size: 0.875rem; padding: 0.5rem 1rem;">+ New Project</button>` : ''}
                        </div>
                        <div>${projectsHtml}</div>
                    </div>

                    ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteCustomer()">Delete Customer</button>` : ''}
                </div>
            `;
        }

        // Add payment
        async function addPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const note = document.getElementById('paymentNote').value.trim();
            const date = document.getElementById('paymentDate').value;

            if (!amount || amount <= 0) {
                alert('Please enter valid amount');
                return;
            }

            const payment = {
                id: Date.now().toString(),
                amount: amount,
                note: note,
                paymentDate: date || new Date().toISOString(),
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const payments = [...(selectedCustomer.payments || []), payment];
                    await db.collection('customers').doc(selectedCustomer.id).update({ payments });
                } else {
                    selectedCustomer.payments = [...(selectedCustomer.payments || []), payment];
                    saveToLocalStorage();
                    renderDetails();
                }

                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentNote').value = '';
                document.getElementById('paymentDate').value = '';
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Failed to add payment');
            }
        }

        // Delete payment
        async function deletePayment(id) {
            try {
                if (db) {
                    const payments = (selectedCustomer.payments || []).filter(p => p.id !== id);
                    await db.collection('customers').doc(selectedCustomer.id).update({ payments });
                } else {
                    selectedCustomer.payments = (selectedCustomer.payments || []).filter(p => p.id !== id);
                    saveToLocalStorage();
                    renderCustomerList();
                    renderDetails();
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Failed to delete payment');
            }
        }

        // Handle file selection
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 2 * 1024 * 1024) {
                    alert(file.name + ' is too large (max 2MB)');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFiles.push({
                        id: Date.now().toString() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderSelectedFiles();
                };
                reader.readAsDataURL(file);
            });
        }

        // Render selected files
        function renderSelectedFiles() {
            if (selectedFiles.length === 0) {
                document.getElementById('selectedFiles').innerHTML = '';
                return;
            }

            const html = `
                <div style="margin-top: 0.75rem;">
                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Selected Files:</div>
                    ${selectedFiles.map(f => `
                        <div class="file-item">
                            ${f.type.startsWith('image/') ?
                                `<img src="${f.data}" class="file-thumbnail" alt="${f.name}">` :
                                `<div class="file-icon">${getFileIcon(f.type)}</div>`
                            }
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.875rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFile('${f.id}')">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('selectedFiles').innerHTML = html;
        }

        // Remove file
        function removeFile(id) {
            selectedFiles = selectedFiles.filter(f => f.id !== id);
            renderSelectedFiles();
        }

        // Get file icon
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.includes('pdf')) return 'üìÑ';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Download file
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add material
        async function addMaterial() {
            const name = document.getElementById('materialName').value.trim();
            const cost = parseFloat(document.getElementById('materialCost').value);
            const quantity = document.getElementById('materialQuantity').value.trim();
            const date = document.getElementById('materialDate').value;

            if (!name || !cost || cost <= 0) {
                alert('Please enter valid material details');
                return;
            }

            const material = {
                id: Date.now().toString(),
                name: name,
                cost: cost,
                quantity: quantity,
                procurementDate: date || new Date().toISOString(),
                files: [...selectedFiles],
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const materials = [...(selectedCustomer.materials || []), material];
                    await db.collection('customers').doc(selectedCustomer.id).update({ materials });
                } else {
                    selectedCustomer.materials = [...(selectedCustomer.materials || []), material];
                    saveToLocalStorage();
                    renderDetails();
                }

                document.getElementById('materialName').value = '';
                document.getElementById('materialCost').value = '';
                document.getElementById('materialQuantity').value = '';
                document.getElementById('materialDate').value = '';
                selectedFiles = [];
            } catch (error) {
                console.error('Error adding material:', error);
                alert('Failed to add material');
            }
        }

        // Delete material
        async function deleteMaterial(id) {
            try {
                if (db) {
                    const materials = (selectedCustomer.materials || []).filter(m => m.id !== id);
                    await db.collection('customers').doc(selectedCustomer.id).update({ materials });
                } else {
                    selectedCustomer.materials = (selectedCustomer.materials || []).filter(m => m.id !== id);
                    saveToLocalStorage();
                    renderCustomerList();
                    renderDetails();
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material');
            }
        }

        // Delete customer
        async function deleteCustomer() {
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            try {
                if (db) {
                    await db.collection('customers').doc(selectedCustomer.id).delete();
                } else {
                    customers = customers.filter(c => c.id !== selectedCustomer.id);
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                selectedCustomer = null;
                renderDetails();
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('Failed to delete customer');
            }
        }

        // Filter customers
        function filterCustomers() {
            renderCustomerList();
        }

        // Show modal
        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('show');
        }

        // Close modal
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // ========================================
        // TAB SWITCHING
        // ========================================
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content
            if (tab === 'customers') {
                document.getElementById('customersTab').style.display = 'block';
                document.getElementById('projectsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('addCustomerBtn').style.display = canManageData() ? 'block' : 'none';
                document.getElementById('addProjectBtn').style.display = 'none';
            } else if (tab === 'projects') {
                document.getElementById('customersTab').style.display = 'none';
                document.getElementById('projectsTab').style.display = 'block';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('addCustomerBtn').style.display = 'none';
                document.getElementById('addProjectBtn').style.display = canManageData() ? 'block' : 'none';
            } else if (tab === 'users') {
                document.getElementById('customersTab').style.display = 'none';
                document.getElementById('projectsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'block';
                document.getElementById('addCustomerBtn').style.display = 'none';
                document.getElementById('addProjectBtn').style.display = 'none';
                if (isSuperAdmin()) {
                    loadAllUsers();
                }
            }
        }

        // ========================================
        // PROJECT MANAGEMENT
        // ========================================
        
        function showAddProjectModal() {
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('saveProjectBtn').textContent = 'Add Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectCustomer').value = '';
            document.getElementById('projectStage').value = 'won';
            document.getElementById('projectValue').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            document.getElementById('projectDescription').value = '';
            
            // Populate customer dropdown
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        function showEditProjectModal(project) {
            editingProjectId = project.id;
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('saveProjectBtn').textContent = 'Update Project';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectCustomer').value = project.customerId || '';
            document.getElementById('projectStage').value = project.stage;
            document.getElementById('projectValue').value = project.value || '';
            document.getElementById('projectStartDate').value = project.startDate ? project.startDate.split('T')[0] : '';
            document.getElementById('projectEndDate').value = project.endDate ? project.endDate.split('T')[0] : '';
            document.getElementById('projectDescription').value = project.description || '';
            
            // Populate customer dropdown
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === project.customerId) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        async function saveProject() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('projectName').value.trim();
            const customerId = document.getElementById('projectCustomer').value;
            const stage = document.getElementById('projectStage').value;
            const value = parseFloat(document.getElementById('projectValue').value) || 0;
            const startDate = document.getElementById('projectStartDate').value;
            const endDate = document.getElementById('projectEndDate').value;
            const description = document.getElementById('projectDescription').value.trim();

            if (!name) {
                alert('Please enter project name');
                return;
            }

            const projectData = {
                name,
                customerId,
                customerName: customerId ? customers.find(c => c.id === customerId)?.name : '',
                stage,
                value,
                startDate: startDate || null,
                endDate: endDate || null,
                description,
                updatedAt: new Date().toISOString()
            };

            try {
                if (editingProjectId) {
                    // Update existing project
                    console.log('üìù Updating project:', editingProjectId);
                    if (db) {
                        await db.collection('projects').doc(editingProjectId).update(projectData);
                    } else {
                        const index = projects.findIndex(p => p.id === editingProjectId);
                        if (index !== -1) {
                            projects[index] = { ...projects[index], ...projectData };
                        }
                        saveToLocalStorage();
                        renderProjectList();
                    }
                } else {
                    // Add new project
                    projectData.createdAt = new Date().toISOString();
                    console.log('üíæ Adding new project:', projectData);
                    
                    if (db) {
                        await db.collection('projects').add(projectData);
                    } else {
                        projects.push({
                            id: Date.now().toString(),
                            ...projectData
                        });
                        saveToLocalStorage();
                        renderProjectList();
                    }
                }

                closeModal('projectModal');
            } catch (error) {
                console.error('‚ùå Error saving project:', error);
                alert('Failed to save project: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            if (!checkPermission('write')) return;
            if (!confirm('Are you sure you want to delete this project?')) return;
            
            try {
                if (db) {
                    await db.collection('projects').doc(projectId).delete();
                } else {
                    projects = projects.filter(p => p.id !== projectId);
                    saveToLocalStorage();
                    renderProjectList();
                }
                
                if (selectedProject?.id === projectId) {
                    selectedProject = null;
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project');
            }
        }

        async function updateProjectStage(projectId, newStage) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    await db.collection('projects').doc(projectId).update({ 
                        stage: newStage,
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    const project = projects.find(p => p.id === projectId);
                    if (project) {
                        project.stage = newStage;
                        project.updatedAt = new Date().toISOString();
                        saveToLocalStorage();
                        renderProjectList();
                        if (selectedProject?.id === projectId) {
                            selectedProject.stage = newStage;
                            renderProjectDetails();
                        }
                    }
                }
                console.log('‚úÖ Updated project stage to:', newStage);
            } catch (error) {
                console.error('Error updating stage:', error);
                alert('Failed to update project stage');
            }
        }

        function selectProject(id) {
            selectedProject = projects.find(p => p.id === id);
            renderProjectList();
            renderProjectDetails();
        }

        function filterProjects() {
            renderProjectList();
        }

        function filterProjectsByStage(stage) {
            projectStageFilter = stage;
            renderProjectList();
        }

        function renderProjectList() {
            const search = document.getElementById('projectSearchInput')?.value.toLowerCase() || '';
            let filtered = projects.filter(p => 
                p.name.toLowerCase().includes(search) || 
                (p.customerName && p.customerName.toLowerCase().includes(search)) ||
                (p.description && p.description.toLowerCase().includes(search))
            );

            if (projectStageFilter !== 'all') {
                filtered = filtered.filter(p => p.stage === projectStageFilter);
            }

            const html = filtered.length === 0 ? 
                '<div class="empty-state">No projects found</div>' :
                filtered.map(p => {
                    const isActive = selectedProject && selectedProject.id === p.id;
                    const stageClass = `status-${p.stage}`;
                    const stageLabel = p.stage.charAt(0).toUpperCase() + p.stage.slice(1);
                    
                    return `
                        <div class="customer-item ${isActive ? 'active' : ''}" onclick="selectProject('${p.id}')">
                            <div class="project-header">
                                <div class="customer-name">${p.name}</div>
                                <span class="status-badge ${stageClass}">${stageLabel}</span>
                            </div>
                            ${p.customerName ? `<div class="customer-contact">üë§ ${p.customerName}</div>` : ''}
                            ${p.value ? `<div class="customer-contact">üí∞ ${formatCurrency(p.value)}</div>` : ''}
                        </div>
                    `;
                }).join('');

            const listElement = document.getElementById('projectList');
            if (listElement) {
                listElement.innerHTML = html;
            }
        }

        function renderProjectDetails() {
            if (!selectedProject) {
                document.getElementById('projectDetailsPanel').innerHTML = `
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">üèóÔ∏è</div>
                            <div class="placeholder-text">Select a Project</div>
                            <div class="placeholder-subtext">Choose a project to manage payments and materials</div>
                        </div>
                    </div>
                `;
                return;
            }

            const stageClass = `status-${selectedProject.stage}`;
            const stageLabel = selectedProject.stage.charAt(0).toUpperCase() + selectedProject.stage.slice(1);

            // Calculate project financials
            const payments = selectedProject.payments || [];
            const materials = selectedProject.materials || [];
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const totalMaterials = materials.reduce((sum, m) => sum + m.cost, 0);
            const balance = totalPaid - totalMaterials;
            const balanceColor = balance >= 0 ? 'blue' : 'red';
            const balanceLabel = balance >= 0 ? 'Balance' : 'Outstanding';

            const paymentsHtml = payments.length === 0 ?
                '<div class="empty-state">No payments yet</div>' :
                payments.map(p => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">${formatCurrency(p.amount)}</div>
                            ${p.note ? `<div class="item-detail">${p.note}</div>` : ''}
                            <div class="item-date">Received: ${p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : formatDate(p.date)}</div>
                        </div>
                        ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteProjectPayment('${p.id}')">Delete</button>` : ''}
                    </div>
                `).join('');

            const materialsHtml = materials.length === 0 ?
                '<div class="empty-state">No materials yet</div>' :
                materials.map(m => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">${m.name}${m.quantity ? ` (${m.quantity})` : ''}</div>
                            <div class="item-detail">${formatCurrency(m.cost)}</div>
                            <div class="item-date">Procured: ${m.procurementDate ? new Date(m.procurementDate).toLocaleDateString() : formatDate(m.date)}</div>
                            ${m.files && m.files.length > 0 ? `
                                <div class="files-grid">
                                    ${m.files.map(f => `
                                        <div class="attached-file">
                                            ${f.type.startsWith('image/') ? 
                                                `<img src="${f.data}" class="file-thumbnail" alt="${f.name}">` :
                                                `<div class="file-icon">${getFileIcon(f.type)}</div>`
                                            }
                                            <div style="flex: 1; min-width: 0; overflow: hidden;">
                                                <div style="font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                                            </div>
                                            <button class="download-btn" onclick='downloadFile(${JSON.stringify(f)})' title="Download">‚¨áÔ∏è</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteProjectMaterial('${m.id}')">Delete</button>` : ''}
                    </div>
                `).join('');

            document.getElementById('projectDetailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Project Header -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2>${selectedProject.name}</h2>
                                <span class="status-badge ${stageClass}">${stageLabel}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; gap: 1rem;">
                                ${selectedProject.customerName ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Customer</div>
                                        <div style="font-weight: 600;">üë§ ${selectedProject.customerName}</div>
                                    </div>
                                ` : ''}
                                
                                ${selectedProject.value ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Project Value</div>
                                        <div style="font-weight: 600; font-size: 1.25rem; color: #16a34a;">${formatCurrency(selectedProject.value)}</div>
                                    </div>
                                ` : ''}

                                <div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Update Stage</div>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button class="btn ${selectedProject.stage === 'won' ? 'btn-success' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'won')">Won</button>
                                        <button class="btn ${selectedProject.stage === 'ongoing' ? 'btn-primary' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'ongoing')">Ongoing</button>
                                        <button class="btn ${selectedProject.stage === 'handovered' ? 'btn-secondary' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'handovered')" style="background: #6366f1;">Handovered</button>
                                    </div>
                                </div>

                                ${selectedProject.startDate || selectedProject.endDate ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Timeline</div>
                                        <div>
                                            ${selectedProject.startDate ? `üìÖ Start: ${new Date(selectedProject.startDate).toLocaleDateString()}` : ''}
                                            ${selectedProject.startDate && selectedProject.endDate ? ' ‚Üí ' : ''}
                                            ${selectedProject.endDate ? `üèÅ End: ${new Date(selectedProject.endDate).toLocaleDateString()}` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                ${selectedProject.description ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Description</div>
                                        <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">${selectedProject.description}</div>
                                    </div>
                                ` : ''}

                                ${isAdmin() ? `
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button class="btn btn-primary" onclick="showEditProjectModal(selectedProject)" style="flex: 1">‚úèÔ∏è Edit Project</button>
                                        <button class="btn btn-danger" onclick="deleteProject('${selectedProject.id}')">üóëÔ∏è Delete</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Financial Summary -->
                    <div class="stats">
                        <div class="stat-card green">
                            <div class="stat-label" style="color: #16a34a">Total Paid</div>
                            <div class="stat-value" style="color: #15803d">${formatCurrency(totalPaid)}</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-label" style="color: #ea580c">Materials Cost</div>
                            <div class="stat-value" style="color: #c2410c">${formatCurrency(totalMaterials)}</div>
                        </div>
                        <div class="stat-card ${balanceColor}">
                            <div class="stat-label" style="color: ${balanceColor === 'blue' ? '#2563eb' : '#dc2626'}">${balanceLabel}</div>
                            <div class="stat-value" style="color: ${balanceColor === 'blue' ? '#1d4ed8' : '#b91c1c'}">${formatCurrency(Math.abs(balance))}</div>
                        </div>
                    </div>

                    <!-- Payments Section -->
                    <div class="card">
                        <div class="card-header">üí∞ Payments Received</div>
                        ${isAdmin() ? `
                            <div class="card-body">
                                <div class="form-grid">
                                    <input type="number" class="input" id="projectPaymentAmount" placeholder="Amount">
                                    <input type="text" class="input" id="projectPaymentNote" placeholder="Note (optional)">
                                    <input type="date" class="input" id="projectPaymentDate">
                                    <button class="btn btn-success" onclick="addProjectPayment()">Add Payment</button>
                                </div>
                            </div>
                        ` : ''}
                        <div>${paymentsHtml}</div>
                    </div>

                    <!-- Materials Section -->
                    <div class="card">
                        <div class="card-header">üì¶ Materials Procured</div>
                        ${isAdmin() ? `
                            <div class="card-body">
                                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))">
                                    <input type="text" class="input" id="projectMaterialName" placeholder="Material name">
                                    <input type="number" class="input" id="projectMaterialCost" placeholder="Cost">
                                    <input type="text" class="input" id="projectMaterialQuantity" placeholder="Quantity">
                                    <input type="date" class="input" id="projectMaterialDate">
                                    <button class="btn btn-warning" onclick="addProjectMaterial()">Add Material</button>
                                </div>
                                <div class="file-upload" onclick="document.getElementById('projectFileInput').click()">
                                    <div>üìé Click to attach files</div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Max 2MB per file</div>
                                </div>
                                <input type="file" id="projectFileInput" multiple accept="image/*,.pdf" style="display: none" onchange="handleProjectFiles(this.files)">
                                <div class="selected-files" id="projectSelectedFiles"></div>
                            </div>
                        ` : ''}
                        <div>${materialsHtml}</div>
                    </div>
                </div>
            `;
        }

        // Initialize
        initializeFirebase();

        // ========================================
        // PROJECT PAYMENTS & MATERIALS
        // ========================================

        async function addProjectPayment() {
            if (!checkPermission('write')) return;
            
            const amount = parseFloat(document.getElementById('projectPaymentAmount').value);
            const note = document.getElementById('projectPaymentNote').value.trim();
            const date = document.getElementById('projectPaymentDate').value;

            if (!amount || amount <= 0) {
                alert('Please enter valid amount');
                return;
            }

            const payment = {
                id: Date.now().toString(),
                amount: amount,
                note: note,
                paymentDate: date || new Date().toISOString(),
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const payments = [...(selectedProject.payments || []), payment];
                    await db.collection('projects').doc(selectedProject.id).update({ payments });
                } else {
                    selectedProject.payments = [...(selectedProject.payments || []), payment];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                document.getElementById('projectPaymentAmount').value = '';
                document.getElementById('projectPaymentNote').value = '';
                document.getElementById('projectPaymentDate').value = '';
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Failed to add payment');
            }
        }

        async function deleteProjectPayment(id) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    const payments = (selectedProject.payments || []).filter(p => p.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ payments });
                } else {
                    selectedProject.payments = (selectedProject.payments || []).filter(p => p.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Failed to delete payment');
            }
        }

        function handleProjectFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 2 * 1024 * 1024) {
                    alert(file.name + ' is too large (max 2MB)');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFiles.push({
                        id: Date.now().toString() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderProjectSelectedFiles();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderProjectSelectedFiles() {
            if (selectedFiles.length === 0) {
                document.getElementById('projectSelectedFiles').innerHTML = '';
                return;
            }

            const html = `
                <div style="margin-top: 0.75rem;">
                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Selected Files:</div>
                    ${selectedFiles.map(f => `
                        <div class="file-item">
                            ${f.type.startsWith('image/') ?
                                `<img src="${f.data}" class="file-thumbnail" alt="${f.name}">` :
                                `<div class="file-icon">${getFileIcon(f.type)}</div>`
                            }
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.875rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFile('${f.id}')">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('projectSelectedFiles').innerHTML = html;
        }

        async function addProjectMaterial() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('projectMaterialName').value.trim();
            const cost = parseFloat(document.getElementById('projectMaterialCost').value);
            const quantity = document.getElementById('projectMaterialQuantity').value.trim();
            const date = document.getElementById('projectMaterialDate').value;

            if (!name || !cost || cost <= 0) {
                alert('Please enter valid material details');
                return;
            }

            const material = {
                id: Date.now().toString(),
                name: name,
                cost: cost,
                quantity: quantity,
                procurementDate: date || new Date().toISOString(),
                files: [...selectedFiles],
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const materials = [...(selectedProject.materials || []), material];
                    await db.collection('projects').doc(selectedProject.id).update({ materials });
                } else {
                    selectedProject.materials = [...(selectedProject.materials || []), material];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                document.getElementById('projectMaterialName').value = '';
                document.getElementById('projectMaterialCost').value = '';
                document.getElementById('projectMaterialQuantity').value = '';
                document.getElementById('projectMaterialDate').value = '';
                selectedFiles = [];
            } catch (error) {
                console.error('Error adding material:', error);
                alert('Failed to add material');
            }
        }

        async function deleteProjectMaterial(id) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    const materials = (selectedProject.materials || []).filter(m => m.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ materials });
                } else {
                    selectedProject.materials = (selectedProject.materials || []).filter(m => m.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material');
            }
        }

        // Helper to switch to projects tab and select a project
        function switchToProject(projectId) {
            currentTab = 'projects';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('customersTab').style.display = 'none';
            document.getElementById('projectsTab').style.display = 'block';
            document.getElementById('addCustomerBtn').style.display = 'none';
            document.getElementById('addProjectBtn').style.display = 'block';
            
            selectedProject = projects.find(p => p.id === projectId);
            renderProjectList();
            renderProjectDetails();
        }

        // Helper to create a new project for a customer
        function createProjectForCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('saveProjectBtn').textContent = 'Add Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectStage').value = 'won';
            document.getElementById('projectValue').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            document.getElementById('projectDescription').value = '';
            
            // Populate customer dropdown and pre-select this customer
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === customerId) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        // Delete customer
        async function deleteCustomer() {
            if (!checkPermission('write')) return;
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            try {
                if (db) {
                    await db.collection('customers').doc(selectedCustomer.id).delete();
                } else {
                    customers = customers.filter(c => c.id !== selectedCustomer.id);
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                selectedCustomer = null;
                renderDetails();
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('Failed to delete customer');
            }
        }

        // Get file icon
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.includes('pdf')) return 'üìÑ';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Download file
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
    
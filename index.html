<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Manager - Cloud Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f9fafb;
            color: #111827;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sync-status {
            font-size: 0.875rem;
            color: #16a34a;
            margin-left: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-warning {
            background: #ea580c;
            color: white;
        }

        .btn-warning:hover {
            background: #c2410c;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            padding: 0.25rem 0.5rem;
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .card-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
        }

        .card-body {
            padding: 1rem;
        }

        .search-box {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .customer-list {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .customer-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .customer-item:hover {
            background: #f9fafb;
        }

        .customer-item.active {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
        }

        .customer-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .customer-contact {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .balance {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .balance.positive {
            color: #16a34a;
        }

        .balance.negative {
            color: #dc2626;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid;
        }

        .stat-card.green {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .stat-card.orange {
            background: #fff7ed;
            border-color: #fed7aa;
        }

        .stat-card.blue {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .stat-card.red {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .list-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .list-item:hover {
            background: #f9fafb;
        }

        .empty-state {
            padding: 3rem;
            text-align: center;
            color: #6b7280;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: flex-start;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 100%;
            margin: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background: white;
            margin-top: 0.75rem;
        }

        .file-upload:hover {
            background: #f9fafb;
        }

        .selected-files {
            margin-top: 0.75rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .file-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 0.25rem;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        .close-btn:hover {
            color: #6b7280;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .item-detail {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .item-date {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .placeholder {
            padding: 4rem;
            text-align: center;
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .placeholder-subtext {
            color: #9ca3af;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .attached-file {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }

        .download-btn {
            background: none;
            border: none;
            color: #2563eb;
            cursor: pointer;
            padding: 0.25rem;
        }

        .download-btn:hover {
            color: #1d4ed8;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
            padding: 0 0.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #111827;
        }

        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-won {
            background: #d1fae5;
            color: #065f46;
        }

        .status-ongoing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-handovered {
            background: #e0e7ff;
            color: #4338ca;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .setup-notice {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .setup-notice h3 {
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .setup-notice p {
            color: #78350f;
            font-size: 0.875rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            margin: 1rem;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            color: #111827;
        }

        .login-box .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 2rem;
            font-size: 0.875rem;
        }

        .login-box .form-group {
            margin-bottom: 1.5rem;
        }

        .login-box .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .login-box .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .login-box .btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .login-toggle {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .login-toggle a {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

        .login-toggle a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .role-badge-header {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .role-admin {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-viewer {
            background: #fef3c7;
            color: #92400e;
        }

        .role-superadmin {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .user-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .user-card-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .user-card-email {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .password-display {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .copy-button:hover {
            background: #1d4ed8;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .user-button:hover {
            background: #e5e7eb;
        }

        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 100;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        .user-dropdown-item:hover {
            background: #f9fafb;
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
            color: #dc2626;
        }

        .readonly-notice {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #92400e;
        }

        /* Lead Pipeline Styles */
        .lead-pipeline {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 1rem;
            min-height: 500px;
        }

        .lead-column {
            flex: 0 0 280px;
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .lead-column-header {
            font-weight: 600;
            padding: 0.5rem;
            border-radius: 0.375rem;
            color: white;
            text-align: center;
            font-size: 0.875rem;
        }

        .lead-column-count {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-left: 0.5rem;
        }

        .lead-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lead-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .lead-card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }

        .lead-card-company {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .lead-card-value {
            font-size: 0.875rem;
            color: #16a34a;
            font-weight: 600;
        }

        .lead-card-date {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }

        .stage-contacted { background: #3b82f6; }
        .stage-proposal_shared { background: #8b5cf6; }
        .stage-negotiation { background: #f59e0b; }
        .stage-won_token { background: #10b981; }
        .stage-won_material { background: #059669; }
        .stage-dropped { background: #ef4444; }
        .stage-on_hold { background: #64748b; }
    </style>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üè¢ Business Manager</h1>
            <p class="subtitle">Secure access to your business data</p>
            
            <div id="loginError" class="error-message" style="display: none;"></div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" class="input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="input" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>
                <div class="login-toggle">
               
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signupName" class="input" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" class="input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" class="input" placeholder="Min. 6 characters">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="signupRole" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="superadmin">Super Admin (User Management)</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="handleSignup()">Create Account</button>
                <div class="login-toggle">
                    Already have an account? <a onclick="toggleAuthForm()">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <div class="header" id="appHeader" style="display: none;">
        <div class="header-content">
            <div style="display: flex; align-items: center;">
                <h1>Business Manager</h1>
                <span class="sync-status" id="syncStatus">‚òÅÔ∏è Cloud Sync Active</span>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-primary" id="addCustomerBtn" onclick="showAddCustomerModal()">+ Add Customer</button>
                <button class="btn btn-primary" id="addProjectBtn" onclick="showAddProjectModal()" style="display: none;">+ Add Project</button>
                
                <!-- User Menu -->
                <div class="user-menu">
                    <button class="user-button" onclick="toggleUserMenu()">
                        <span id="userDisplayName">User</span>
                        <span class="role-badge-header" id="userRoleBadge">Viewer</span>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-item" style="cursor: default; background: #f9fafb;">
                            <div style="font-weight: 600;" id="dropdownEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d0b5bdb1b9bc90b5a8b1bda0bcb5feb3bfbd">[email&#160;protected]</a></div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;" id="dropdownRole">Role: Viewer</div>
                        </div>
                        <div class="user-dropdown-item" onclick="handleLogout()">üö™ Logout</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <div id="setupNotice" class="setup-notice" style="display: none;">
            <h3>‚ö†Ô∏è Firebase Setup Required</h3>
            <p>Please add your Firebase configuration in the script section. See SETUP_GUIDE.md for instructions.</p>
        </div>

        <div id="loadingState" class="loading">
            <div>Loading data from cloud...</div>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab" onclick="switchTab('leads')">üéØ Sales Leads</button>
                <button class="tab active" onclick="switchTab('customers')">üë• Customers</button>
                <button class="tab" onclick="switchTab('projects')">üèóÔ∏è Projects</button>
                <button class="tab" onclick="switchTab('tasks')">‚úÖ Tasks</button>
                <button class="tab" id="userManagementTab" onclick="switchTab('users')" style="display: none;">‚öôÔ∏è User Management</button>
            </div>

            <!-- Leads Tab -->
            <div id="leadsTab" style="display: none;">
                <div class="grid">
                    <!-- Lead Pipeline -->
                    <div class="card" style="grid-column: 1 / -1;">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="text" class="search-box" placeholder="üîç Search leads..." id="leadSearchInput" oninput="filterLeads()" style="margin: 0;">
                                    <select class="input" id="leadStageFilter" onchange="filterLeadsByStage()" style="width: auto; margin: 0;">
                                        <option value="all">All Stages</option>
                                        <option value="new">New</option>
                                        <option value="site_survey">Site Survey Scheduled</option>
                                        <option value="initial_quote">Initial Quote Shared</option>
                                        <option value="negotiation">Negotiation</option>
                                        <option value="final_quote">Final Quote Shared</option>
                                        <option value="mockup">Mockup</option>
                                        <option value="won">Won with Token Advance</option>
                                        <option value="loi">LOI Received</option>
                                        <option value="on_hold">On Hold</option>
                                        <option value="dropped">Dropped</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="showAddLeadModal()">+ Add Lead</button>
                            </div>
                        </div>
                        <div class="lead-pipeline" id="leadPipeline"></div>
                    </div>

                    <!-- Lead Details Panel -->
                    <div class="card" style="grid-column: 1 / -1;" id="leadDetailsPanelCard" style="display: none;">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>Lead Details</h3>
                                <button class="btn btn-secondary" onclick="closeLeadDetails()">‚úï Close</button>
                            </div>
                        </div>
                        <div id="leadDetailsPanel"></div>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customersTab" style="display: block;">
                <div class="grid">
                    <!-- Customer List -->
                    <div class="card">
                        <div class="card-header">
                            <input type="text" class="search-box" placeholder="üîç Search customers..." id="searchInput" oninput="filterCustomers()">
                        </div>
                        <div class="customer-list" id="customerList"></div>
                    </div>

                    <!-- Customer Details -->
                    <div id="detailsPanel"></div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="projectsTab" style="display: none;">
                <div class="grid">
                    <!-- Project List -->
                    <div class="card">
                        <div class="card-header">
                            <input type="text" class="search-box" placeholder="üîç Search projects..." id="projectSearchInput" oninput="filterProjects()">
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('all')">All</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('won')">Won</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('ongoing')">Ongoing</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('handovered')">Handovered</button>
                            </div>
                        </div>
                        <div class="customer-list" id="projectList"></div>
                    </div>

                    <!-- Project Details -->
                    <div id="projectDetailsPanel"></div>
                </div>
            </div>

            <!-- User Management Tab (Super Admin Only) -->
            <div id="usersTab" style="display: none;">
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>üë• User Management</h2>
                        <button class="btn btn-primary" onclick="showCreateUserModal()">+ Create User</button>
                    </div>
                    <div class="card-body">
                        <div id="usersList"></div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasksTab" style="display: none;">
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem;">
                        <h2 style="margin: 0;">‚úÖ Tasks</h2>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            <select class="input" id="taskStatusFilter" onchange="renderTasksTab()" style="width: auto; padding: 0.4rem 0.6rem; font-size: 0.82rem;">
                                <option value="all">Active (Default)</option>
                                <option value="overdue">üî¥ Overdue</option>
                                <option value="due_today">‚ö†Ô∏è Due Today</option>
                                <option value="upcoming">‚è≥ Upcoming</option>
                                <option value="completed">‚úÖ Completed</option>
                            </select>
                            <select class="input" id="taskOwnerFilter" onchange="renderTasksTab()" style="width: auto; padding: 0.4rem 0.6rem; font-size: 0.82rem;">
                                <option value="all">All Owners</option>
                            </select>
                            <input type="text" class="input" id="taskSearchInput" oninput="renderTasksTab()" placeholder="üîç Search..." style="width: 160px; padding: 0.4rem 0.6rem; font-size: 0.82rem;">
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="tasksSummaryBadges" style="display: flex; gap: 0.75rem; padding: 1rem; background: #f9fafb; border-bottom: 1px solid #e5e7eb; flex-wrap: wrap;"></div>
                        <div id="tasksList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal (Super Admin) -->
    <div class="modal" id="createUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New User</h2>
                <button class="close-btn" onclick="closeModal('createUserModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="createUserError" class="error-message" style="display: none;"></div>
                
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="createUserName" class="input" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="createUserEmail" class="input" placeholder="user@company.com">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="createUserRole" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="superadmin">Super Admin (User Management)</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="generateRandomPassword()" style="width: 100%;">üé≤ Generate Random Password</button>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="text" id="createUserPassword" class="input" placeholder="Min. 8 characters">
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        User will receive this password. Ask them to change it after first login.
                    </div>
                </div>
                <div id="generatedPasswordDisplay" style="display: none;">
                    <label style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; display: block;">Generated Password:</label>
                    <div class="password-display">
                        <span id="generatedPasswordText"></span>
                        <button class="copy-button" onclick="copyPassword()">üìã Copy</button>
                    </div>
                    <div style="font-size: 0.75rem; color: #dc2626; margin-top: 0.25rem;">
                        ‚ö†Ô∏è Save this password! Share it securely with the user.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="createNewUser()" style="flex: 1">Create User</button>
            </div>
        </div>
    </div>

    <!-- Change Role Modal -->
    <div class="modal" id="changeRoleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change User Role</h2>
                <button class="close-btn" onclick="closeModal('changeRoleModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Change role for: <strong id="changeRoleUserEmail"></strong></p>
                <div class="form-group">
                    <label>New Role</label>
                    <select id="newRoleSelect" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="superadmin">Super Admin (User Management)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('changeRoleModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveRoleChange()" style="flex: 1">Save Role</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal" id="resetPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset User Password</h2>
                <button class="close-btn" onclick="closeModal('resetPasswordModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Reset password for: <strong id="resetPasswordUserEmail"></strong></p>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="generateResetPassword()" style="width: 100%;">üé≤ Generate Random Password</button>
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="text" id="resetPasswordInput" class="input" placeholder="Min. 8 characters">
                </div>
                <div id="resetPasswordDisplay" style="display: none;">
                    <label style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; display: block;">Generated Password:</label>
                    <div class="password-display">
                        <span id="resetPasswordText"></span>
                        <button class="copy-button" onclick="copyResetPassword()">üìã Copy</button>
                    </div>
                    <div style="font-size: 0.75rem; color: #dc2626; margin-top: 0.25rem;">
                        ‚ö†Ô∏è Save this password! Share it securely with the user.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="resetUserPassword()" style="flex: 1">Reset Password</button>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Customer</h2>
                <button class="close-btn" onclick="closeModal('addCustomerModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" class="input" id="newCustomerName" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label>Contact (Optional)</label>
                    <input type="text" class="input" id="newCustomerContact" placeholder="Phone or email">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addCustomerModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="addCustomer()" style="flex: 1">Add Customer</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">Add New Project</h2>
                <button class="close-btn" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" class="input" id="projectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <select class="input" id="projectCustomer">
                        <option value="">Select customer (optional)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stage *</label>
                    <select class="input" id="projectStage">
                        <option value="won">Won</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="handovered">Handovered</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project Value</label>
                    <input type="number" class="input" id="projectValue" placeholder="Enter value">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="input" id="projectStartDate">
                </div>
                <div class="form-group">
                    <label>Expected Completion</label>
                    <input type="date" class="input" id="projectEndDate">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="input" id="projectDescription" rows="3" placeholder="Project details..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()" style="flex: 1" id="saveProjectBtn">Add Project</button>
            </div>
        </div>
    </div>

    <!-- Generate Delivery Challan Modal -->
    <div class="modal" id="challanModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2 id="challanModalTitle">Generate Delivery Challan</h2>
                <span class="close" onclick="closeModal('challanModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Challan Number*</label>
                    <input type="text" class="input" id="challanNumber" placeholder="DC-001">
                </div>
                <div class="form-group">
                    <label>Delivery Date*</label>
                    <input type="date" class="input" id="challanDeliveryDate">
                </div>
                <div class="form-group">
                    <label>Vehicle Number</label>
                    <input type="text" class="input" id="challanVehicle" placeholder="MH-01-AB-1234">
                </div>
                <div class="form-group">
                    <label>Received By</label>
                    <input type="text" class="input" id="challanReceivedBy" placeholder="Name of receiver">
                </div>
                <div class="form-group">
                    <label>Select Materials to Deliver*</label>
                    <div id="materialCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;"></div>
                </div>
                <div class="form-group">
                    <label>Remarks</label>
                    <textarea class="input" id="challanRemarks" rows="3" placeholder="Additional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('challanModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveDeliveryChallan()" style="flex: 1">Generate Challan</button>
            </div>
        </div>
    </div>

    <!-- Material Installation/Handover Modal -->
    <div class="modal" id="installationModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Add Installation / Handover</h2>
                <span class="close" onclick="closeModal('installationModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Delivered Item*</label>
                    <select class="input" id="installationItemSelect">
                        <option value="">-- Select Item --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Item Name*</label>
                    <input type="text" class="input" id="installationItemName" placeholder="Material/Item name">
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="text" class="input" id="installationQuantity" placeholder="e.g., 50 bags, 100 sq ft">
                </div>
                <div class="form-group">
                    <label>Status*</label>
                    <select class="input" id="installationStatus">
                        <option value="pending">Pending</option>
                        <option value="installed">Installed</option>
                        <option value="handed_over">Handed Over</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Installation Date</label>
                    <input type="date" class="input" id="installationDate">
                </div>
                <div class="form-group">
                    <label>Installed By</label>
                    <input type="text" class="input" id="installedBy" placeholder="Contractor/Team name">
                </div>
                <div class="form-group">
                    <label>Handover Date</label>
                    <input type="date" class="input" id="handoverDate">
                </div>
                <div class="form-group">
                    <label>Handed Over To</label>
                    <input type="text" class="input" id="handedOverTo" placeholder="Client/Customer name">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" class="input" id="installationLocation" placeholder="e.g., Bedroom 1, Kitchen">
                </div>
                <div class="form-group">
                    <label>Remarks</label>
                    <textarea class="input" id="installationRemarks" rows="3" placeholder="Additional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('installationModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-success" onclick="saveInstallation()" style="flex: 1">Save</button>
            </div>
        </div>
    </div>

    <!-- Generate Invoice Modal -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="invoiceModalTitle">Generate Tax Invoice</h2>
                <span class="close" onclick="closeModal('invoiceModal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Invoice Details -->
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Invoice Number*</label>
                        <input type="text" class="input" id="invoiceNumber" placeholder="INV-001">
                    </div>
                    <div class="form-group">
                        <label>Invoice Date*</label>
                        <input type="date" class="input" id="invoiceDate">
                    </div>
                </div>

                <!-- Company GST Details -->
                <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <div style="font-weight: 600; margin-bottom: 0.75rem;">üè¢ Company GST Details</div>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label>Company Name*</label>
                            <input type="text" class="input" id="companyName" placeholder="Your Company Pvt Ltd">
                        </div>
                        <div class="form-group">
                            <label>GSTIN*</label>
                            <input type="text" class="input" id="companyGSTIN" placeholder="22AAAAA0000A1Z5" maxlength="15">
                        </div>
                        <div class="form-group">
                            <label>State*</label>
                            <input type="text" class="input" id="companyState" placeholder="Maharashtra">
                        </div>
                        <div class="form-group">
                            <label>State Code*</label>
                            <input type="text" class="input" id="companyStateCode" placeholder="27">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address*</label>
                        <textarea class="input" id="companyAddress" rows="2" placeholder="Complete address..."></textarea>
                    </div>
                </div>

                <!-- Customer GST Details -->
                <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <div style="font-weight: 600; margin-bottom: 0.75rem;">üë§ Customer GST Details</div>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label>Customer Name*</label>
                            <input type="text" class="input" id="customerName" placeholder="Customer Name">
                        </div>
                        <div class="form-group">
                            <label>GSTIN</label>
                            <input type="text" class="input" id="customerGSTIN" placeholder="Optional - 22BBBBB0000B1Z5" maxlength="15">
                        </div>
                        <div class="form-group">
                            <label>State*</label>
                            <input type="text" class="input" id="customerState" placeholder="Maharashtra">
                        </div>
                        <div class="form-group">
                            <label>State Code*</label>
                            <input type="text" class="input" id="customerStateCode" placeholder="27">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address*</label>
                        <textarea class="input" id="customerAddress" rows="2" placeholder="Complete address..."></textarea>
                    </div>
                </div>

                <!-- Invoice Items -->
                <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div style="font-weight: 600;">üì¶ Invoice Items</div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="showLoadFromChallanModal()" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">üìã Load from Challan</button>
                            <button class="btn btn-secondary" onclick="addInvoiceItemRow()" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">+ Add Item</button>
                        </div>
                    </div>
                    <div id="invoiceItemsContainer">
                        <!-- Items will be added here -->
                    </div>
                </div>

                <!-- Discount -->
                <div class="form-group">
                    <label>Discount</label>
                    <input type="number" class="input" id="invoiceDiscount" placeholder="0" value="0" onchange="calculateInvoiceTotal()">
                </div>

                <!-- Invoice Summary -->
                <div style="background: #e0f2fe; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Invoice Summary</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem;">
                        <div>Subtotal:</div><div style="text-align: right;" id="invoiceSubtotal">‚Çπ0.00</div>
                        <div>Discount:</div><div style="text-align: right;" id="invoiceDiscountDisplay">‚Çπ0.00</div>
                        <div>CGST:</div><div style="text-align: right;" id="invoiceCGST">‚Çπ0.00</div>
                        <div>SGST:</div><div style="text-align: right;" id="invoiceSGST">‚Çπ0.00</div>
                        <div>IGST:</div><div style="text-align: right;" id="invoiceIGST">‚Çπ0.00</div>
                        <div style="font-weight: 700; font-size: 1rem; border-top: 2px solid #0284c7; padding-top: 0.5rem;">Grand Total:</div>
                        <div style="font-weight: 700; font-size: 1rem; text-align: right; border-top: 2px solid #0284c7; padding-top: 0.5rem;" id="invoiceGrandTotal">‚Çπ0.00</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('invoiceModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" id="saveInvoiceBtn" onclick="saveInvoice()" style="flex: 1">Generate Invoice</button>
            </div>
        </div>
    </div>

    <!-- Final Quote Modal -->
    <div class="modal" id="finalQuoteModal">
        <div class="modal-content" style="max-width: 860px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>üìã Final Quote / Proposal</h2>
                <span class="close" onclick="closeModal('finalQuoteModal')">&times;</span>
            </div>
            <div class="modal-body">

                <!-- Quote Header -->
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Quote Number*</label>
                        <input type="text" class="input" id="fqQuoteNo" placeholder="QT-001">
                    </div>
                    <div class="form-group">
                        <label>Quote Date*</label>
                        <input type="date" class="input" id="fqDate">
                    </div>
                    <div class="form-group">
                        <label>Valid for (days)</label>
                        <input type="number" class="input" id="fqValidDays" placeholder="30" value="30">
                    </div>
                </div>

                <!-- Client Details -->
                <div style="background:#f0f9ff;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;border-left:3px solid #0284c7;">
                    <div style="font-weight:700;margin-bottom:0.75rem;color:#0369a1;">üë§ Client Details</div>
                    <div class="form-grid" style="grid-template-columns:1fr 1fr;">
                        <div class="form-group">
                            <label>Client Name*</label>
                            <input type="text" class="input" id="fqClientName" placeholder="Client Name">
                        </div>
                        <div class="form-group">
                            <label>Company</label>
                            <input type="text" class="input" id="fqClientCompany" placeholder="Company Name">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" class="input" id="fqClientPhone" placeholder="+91 98765 43210">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="input" id="fqClientEmail" placeholder="client@email.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address / Location</label>
                        <textarea class="input" id="fqClientAddress" rows="2" placeholder="Site address or location..."></textarea>
                    </div>
                </div>

                <!-- Project Details -->
                <div style="background:#f9fafb;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;border-left:3px solid #6b7280;">
                    <div style="font-weight:700;margin-bottom:0.75rem;color:#374151;">üèóÔ∏è Project Details</div>
                    <div class="form-grid" style="grid-template-columns:1fr 1fr;">
                        <div class="form-group">
                            <label>Project Type</label>
                            <input type="text" class="input" id="fqProjectType" placeholder="e.g. Full Interior, Modular Kitchen">
                        </div>
                        <div class="form-group">
                            <label>Property Type</label>
                            <input type="text" class="input" id="fqPropertyType" placeholder="e.g. 2BHK, Villa, Office">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Scope of Work</label>
                        <textarea class="input" id="fqScopeOfWork" rows="2" placeholder="Brief description of work included..."></textarea>
                    </div>
                </div>

                <!-- Line Items -->
                <div style="background:#f9fafb;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;border-left:3px solid #10b981;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
                        <div style="font-weight:700;color:#065f46;">üì¶ Work Items / Line Items</div>
                        <button class="btn btn-secondary" onclick="addFQItem()" style="padding:0.3rem 0.75rem;font-size:0.82rem;">+ Add Item</button>
                    </div>
                    <!-- Header Row -->
                    <div style="display:grid;grid-template-columns:2fr 60px 90px 100px 70px 90px 110px 36px;gap:0.35rem;padding:0.3rem 0;font-size:0.72rem;font-weight:600;color:#6b7280;border-bottom:2px solid #e5e7eb;margin-bottom:0.25rem;">
                        <span>Description</span><span>Qty</span><span>Unit</span><span>Rate (‚Çπ)</span><span>GST%</span><span>GST Amt</span><span>Total</span><span></span>
                    </div>
                    <div id="fqItemsContainer"></div>
                </div>

                <!-- Pricing Summary ‚Äî discount only at order level -->
                <div class="form-grid" style="grid-template-columns:1fr 1fr;gap:1rem;">
                    <div>
                        <div class="form-group">
                            <label>Overall Discount (‚Çπ)</label>
                            <input type="number" class="input" id="fqDiscount" value="0" placeholder="0" oninput="calculateFQTotal()">
                        </div>
                    </div>
                    <div style="background:#e0f2fe;border-radius:0.5rem;padding:1rem;font-size:0.875rem;">
                        <div style="font-weight:700;margin-bottom:0.6rem;color:#0369a1;">Quote Summary</div>
                        <div style="display:grid;grid-template-columns:1fr auto;gap:0.35rem;">
                            <span>Subtotal (before GST):</span><span id="fqSubtotal" style="text-align:right;font-weight:600;">‚Çπ0.00</span>
                            <span>Total GST:</span><span id="fqGSTDisplay" style="text-align:right;">‚Çπ0.00</span>
                            <span>Discount:</span><span id="fqDiscountDisplay" style="text-align:right;color:#dc2626;">‚Çπ0.00</span>
                            <span style="font-weight:700;font-size:1rem;border-top:2px solid #0284c7;padding-top:0.4rem;">Grand Total:</span>
                            <span id="fqGrandTotal" style="font-weight:700;font-size:1rem;text-align:right;border-top:2px solid #0284c7;padding-top:0.4rem;color:#0369a1;">‚Çπ0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Notes / Terms -->
                <div class="form-group">
                    <label>Terms & Notes</label>
                    <textarea class="input" id="fqNotes" rows="3" placeholder="Payment terms, inclusions, exclusions, warranty info..."></textarea>
                </div>

                <!-- File Upload (Mandatory) -->
                <div style="background:#fff7ed;border:2px dashed #f97316;border-radius:0.5rem;padding:1rem;margin-top:0.5rem;">
                    <div style="font-weight:700;color:#c2410c;margin-bottom:0.5rem;">üìé Upload Quote Document <span style="color:#dc2626;">*</span> <span style="font-size:0.75rem;font-weight:400;color:#92400e;">(mandatory ‚Äî uploads to OneDrive)</span></div>
                    <label style="cursor:pointer;display:inline-flex;align-items:center;gap:0.5rem;background:#f97316;color:white;padding:0.4rem 0.85rem;border-radius:0.375rem;font-size:0.85rem;font-weight:600;">
                        üìÅ Choose File(s)
                        <input type="file" id="fqFileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" style="display:none" onchange="handleFQFiles(this.files)">
                    </label>
                    <div id="fqUploadStatus" style="margin-top:0.5rem;font-size:0.8rem;color:#6b7280;"></div>
                    <div id="fqUploadedFilesList" style="margin-top:0.5rem;"></div>
                </div>

            </div>
            <div class="modal-footer" style="display:flex;gap:0.75rem;">
                <button class="btn btn-secondary" onclick="closeModal('finalQuoteModal')" style="flex:1;">Cancel</button>
                <button class="btn btn-primary" onclick="saveFinalQuote()" style="flex:2;">üíæ Save Quote &amp; Proceed</button>
            </div>
        </div>
    </div>

    <!-- Load from Delivery Challan Modal -->
    <div class="modal" id="loadChallanModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìã Load Items from Delivery Challan</h2>
                <span class="close" onclick="closeModal('loadChallanModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <p style="color: #64748b; font-size: 0.875rem;">Select a delivery challan to import all materials as invoice items</p>
                </div>
                <div id="challanListForInvoice" style="max-height: 400px; overflow-y: auto;">
                    <!-- Challan list will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('loadChallanModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Lead Modal -->
    <div class="modal" id="leadModal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2 id="leadModalTitle">Add Sales Lead</h2>
                <span class="close" onclick="closeModal('leadModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Contact Person*</label>
                        <input type="text" class="input" id="leadContactPerson" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" class="input" id="leadCompany" placeholder="ABC Corporation">
                    </div>
                    <div class="form-group">
                        <label>Email*</label>
                        <input type="email" class="input" id="leadEmail" placeholder="contact@company.com">
                    </div>
                    <div class="form-group">
                        <label>Phone*</label>
                        <input type="tel" class="input" id="leadPhone" placeholder="+91 98765 43210">
                    </div>
                    <div class="form-group">
                        <label>Lead Gen Date*</label>
                        <input type="date" class="input" id="leadGenDate">
                    </div>
                    <div class="form-group">
                        <label>Property Type</label>
                        <select class="input" id="leadPropertyType">
                            <option value="">Select property type...</option>
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="industrial">Industrial</option>
                            <option value="hospitality">Hospitality</option>
                            <option value="retail">Retail</option>
                            <option value="mixed_use">Mixed Use</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Community Name/Location</label>
                        <input type="text" class="input" id="leadLocation" placeholder="e.g., DLF Phase 3, Gurgaon">
                    </div>
                    <div class="form-group">
                        <label>Project Type</label>
                        <input type="text" class="input" id="leadProjectType" placeholder="e.g., Office Interior, Home Automation">
                    </div>
                    <div class="form-group">
                        <label>Estimated Value</label>
                        <input type="number" class="input" id="leadValue" placeholder="500000">
                    </div>
                    <div class="form-group">
                        <label>Stage*</label>
                        <select class="input" id="leadStage">
                            <option value="contacted">Contacted</option>
                            <option value="proposal_shared">Proposal Shared</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="won_token">Won with Token</option>
                            <option value="won_material">Won with Material Advance</option>
                            <option value="dropped">Dropped</option>
                            <option value="on_hold">On Hold/Archive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source*</label>
                        <select class="input" id="leadSource" onchange="toggleLeadSourceOther()">
                            <option value="">Select source...</option>
                            <option value="website">Website</option>
                            <option value="referral">Referral</option>
                            <option value="cold_call">Cold Call</option>
                            <option value="social_media">Social Media</option>
                            <option value="exhibition">Exhibition</option>
                            <option value="email_campaign">Email Campaign</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" id="leadSourceOtherContainer" style="display: none;">
                        <label>Source (Other)</label>
                        <input type="text" class="input" id="leadSourceOther" placeholder="Specify other source...">
                    </div>
                    <div class="form-group">
                        <label>Lead Owner / Sales Person</label>
                        <select class="input" id="leadOwner">
                            <option value="">Select sales person...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Expected Close Date</label>
                        <input type="date" class="input" id="leadCloseDate">
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select class="input" id="leadPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Scope of Work</label>
                    <textarea class="input" id="leadScopeOfWork" rows="3" placeholder="Detailed scope of work, deliverables, milestones..."></textarea>
                </div>
                <div class="form-group">
                    <label>Requirements/Notes</label>
                    <textarea class="input" id="leadNotes" rows="4" placeholder="Project requirements, budget constraints, timeline..."></textarea>
                </div>
                
                <!-- BOQ Files Section -->
                <div class="form-group">
                    <label>üìä BOQ (Bill of Quantities)</label>
                    <div class="file-upload" onclick="document.getElementById('leadBOQFiles').click()">
                        <div>üìé Click to upload BOQ files</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Any file type ‚Ä¢ No size limit</div>
                    </div>
                    <input type="file" id="leadBOQFiles" multiple style="display: none" onchange="handleLeadBOQFiles(this.files)">
                    <div class="selected-files" id="leadBOQFilesList"></div>
                </div>

                <!-- Design Bundle Files Section -->
                <div class="form-group">
                    <label>üé® Design Bundle</label>
                    <div class="file-upload" onclick="document.getElementById('leadDesignFiles').click()">
                        <div>üìé Click to upload design files</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Any file type ‚Ä¢ No size limit</div>
                    </div>
                    <input type="file" id="leadDesignFiles" multiple style="display: none" onchange="handleLeadDesignFiles(this.files)">
                    <div class="selected-files" id="leadDesignFilesList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('leadModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveLead()" style="flex: 1" id="saveLeadBtn">Add Lead</button>
            </div>
        </div>
    </div>

    <!-- Microsoft Authentication Library (MSAL) for OneDrive -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // ====================================
        // FIREBASE CONFIGURATION
        // Replace these values with your Firebase project settings
        // ====================================
        const firebaseConfig = {
            apiKey: "AIzaSyAn46wP_Z4ABgo-J3R-oRl-BDPJVih9IEg",
            authDomain: "business-manager-73c4e.firebaseapp.com",
            projectId: "business-manager-73c4e",
            storageBucket: "business-manager-73c4e.firebasestorage.app",
            messagingSenderId: "612350057386",
            appId: "1:612350057386:web:35c5f4d65ce0066b88e9d3"
        };

        // Initialize Firebase
        let db;
        let auth;
        let customersListener;
        let projectsListener;
        let customers = [];
        let projects = [];
        let leads = [];
        let selectedCustomer = null;
        let selectedProject = null;
        let selectedLead = null;
        let selectedFiles = [];
        let selectedBOQFiles = [];
        let selectedDesignFiles = [];
        let tempMaterialItems = []; // Temporary storage for material items before saving
        let editingMaterialId = null; // Track which material is being edited
        let currentTab = 'customers';
        let projectStageFilter = 'all';
        let leadStageFilter = 'all';
        let editingProjectId = null;
        let editingLeadId = null;
        let leadsListener;
        let currentUser = null;
        let userRole = null;
        let allUsers = [];
        let selectedUserForRole = null;
        let selectedUserForPassword = null;
        
        // Backend API URL - Update this to your deployed backend URL
        const BACKEND_API_URL = 'https://business-manager-backend-production-8034.up.railway.app/api';  // Change to your production URL when deployed

        // ========================================
        // ONEDRIVE CONFIGURATION
        // ========================================
        const ONEDRIVE_CLIENT_ID = 'e17cddb9-60f6-44c5-b26f-e8d87534d112';
        const ONEDRIVE_REDIRECT_URI = 'https://aurasmart.github.io/Businessmanager/';
        // Popup uses same origin but MSAL intercepts the hash before any app code runs
        const ONEDRIVE_POPUP_REDIRECT_URI = 'https://aurasmart.github.io/Businessmanager/';
        const ONEDRIVE_SCOPES = ['Files.ReadWrite', 'Files.ReadWrite.All', 'User.Read', 'offline_access'];
        
        let msalInstance = null;
        let oneDriveAccessToken = null;

        // Initialize MSAL eagerly on load so tokens are restored from localStorage cache
        async function initializeOneDrive() {
            if (msalInstance) return;
            
            const msalConfig = {
                auth: {
                    clientId: ONEDRIVE_CLIENT_ID,
                    authority: 'https://login.microsoftonline.com/common',
                    redirectUri: ONEDRIVE_REDIRECT_URI
                },
                cache: {
                    cacheLocation: 'localStorage',
                    storeAuthStateInCookie: true
                },
                system: {
                    allowRedirectInIframe: false,
                    windowHashTimeout: 60000,
                    iframeHashTimeout: 6000,
                    loadFrameTimeout: 0
                }
            };

            msalInstance = new msal.PublicClientApplication(msalConfig);

            // Handle any redirect response first
            try {
                const response = await msalInstance.handleRedirectPromise();
                if (response && response.accessToken) {
                    oneDriveAccessToken = response.accessToken;
                    localStorage.setItem('onedrive_connected', 'true');
                    console.log('‚úÖ OneDrive authenticated via redirect');
                    return;
                }
            } catch (e) {
                console.warn('Redirect handling error:', e);
            }

            // Try to restore session silently from cache (no UI prompt)
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                try {
                    const response = await msalInstance.acquireTokenSilent({
                        scopes: ONEDRIVE_SCOPES,
                        account: accounts[0]
                    });
                    oneDriveAccessToken = response.accessToken;
                    localStorage.setItem('onedrive_connected', 'true');
                    console.log('‚úÖ OneDrive session restored silently');
                } catch (e) {
                    console.log('Silent token restore failed, will prompt when needed');
                    oneDriveAccessToken = null;
                }
            }
        }

        async function connectOneDrive() {
            try {
                if (!msalInstance) await initializeOneDrive();
                // Use loginRedirect so MS login happens in main window (not popup)
                // MSAL handles the redirect response on return automatically
                await msalInstance.loginRedirect({
                    scopes: ONEDRIVE_SCOPES,
                    redirectUri: ONEDRIVE_REDIRECT_URI,
                    prompt: 'select_account'
                });
                return true; // Won't reach here - page will redirect
            } catch (error) {
                console.error('OneDrive connection error:', error);
                alert('Failed to connect OneDrive: ' + error.message);
                return false;
            }
        }

        async function acquireOneDriveToken() {
            if (!msalInstance) await initializeOneDrive();

            const accounts = msalInstance.getAllAccounts();

            // Already have a valid in-memory token
            if (oneDriveAccessToken && accounts.length > 0) {
                return true;
            }

            // Try silent token acquisition (no popup)
            if (accounts.length > 0) {
                try {
                    const response = await msalInstance.acquireTokenSilent({
                        scopes: ONEDRIVE_SCOPES,
                        account: accounts[0]
                    });
                    oneDriveAccessToken = response.accessToken;
                    return true;
                } catch (silentError) {
                    console.warn('Silent token failed, redirecting to login:', silentError);
                }
            }

            // Only show login popup if truly no session exists
            return await connectOneDrive();
        }

        async function uploadToOneDrive(file, folder) {
            // Ensure we have a token
            if (!oneDriveAccessToken) {
                const connected = await acquireOneDriveToken();
                if (!connected) {
                    throw new Error('OneDrive not connected');
                }
            }

            // Create unique filename
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substr(2, 9);
            const fileName = `lead_${timestamp}_${randomId}_${file.name}`;
            const folderPath = folder === 'boq' ? 'Business Manager Files/BOQ Files' : 'Business Manager Files/Design Files';

            try {
                // Upload file to OneDrive
                const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${folderPath}/${fileName}:/content`;
                
                // Convert base64 to blob
                const base64Data = file.data.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: file.type });

                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${oneDriveAccessToken}`,
                        'Content-Type': file.type
                    },
                    body: blob
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }

                const result = await response.json();

                // Create sharing link
                const shareUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${result.id}/createLink`;
                const shareResponse = await fetch(shareUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${oneDriveAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'view',
                        scope: 'anonymous'
                    })
                });

                const shareResult = await shareResponse.json();

                return {
                    id: result.id,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    oneDriveId: result.id,
                    webUrl: result.webUrl,
                    downloadUrl: result['@microsoft.graph.downloadUrl'],
                    shareLink: shareResult.link.webUrl,
                    uploadedAt: new Date().toISOString()
                };
            } catch (error) {
                console.error('OneDrive upload error:', error);
                throw error;
            }
        }

        // ========================================
        // AUTHENTICATION
        // ========================================

        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            }
            
            document.getElementById('loginError').style.display = 'none';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Login successful');
            } catch (error) {
                console.error('Login error:', error);
                showError(getAuthErrorMessage(error.code));
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;
            
            if (!name || !email || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update profile with name
                await userCredential.user.updateProfile({ displayName: name });
                
                // Store user role in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString()
                });
                
                console.log('‚úÖ Signup successful');
            } catch (error) {
                console.error('Signup error:', error);
                showError(getAuthErrorMessage(error.code));
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                console.log('‚úÖ Logout successful');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out');
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu && !userMenu.contains(event.target)) {
                document.getElementById('userDropdown').classList.remove('show');
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function getAuthErrorMessage(code) {
            const messages = {
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/email-already-in-use': 'Email already registered',
                'auth/weak-password': 'Password is too weak',
                'auth/invalid-email': 'Invalid email address',
                'auth/too-many-requests': 'Too many attempts. Try again later'
            };
            return messages[code] || 'Authentication error. Please try again.';
        }

        async function getUserRole(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    return userDoc.data().role || 'viewer';
                }
                return 'viewer'; // Default to viewer if no role found
            } catch (error) {
                console.error('Error getting user role:', error);
                return 'viewer';
            }
        }

        function isAdmin() {
            return userRole === 'admin' || userRole === 'superadmin';
        }

        function isSuperAdmin() {
            return userRole === 'superadmin';
        }

        function canManageData() {
            return userRole === 'admin' || userRole === 'superadmin';
        }

        function canManageUsers() {
            return userRole === 'superadmin';
        }

        function updateUIForRole() {
            const isAdminUser = isAdmin();
            const isSuperAdminUser = isSuperAdmin();
            
            // Update role badge
            const roleBadge = document.getElementById('userRoleBadge');
            if (isSuperAdminUser) {
                roleBadge.textContent = 'Super Admin';
                roleBadge.className = 'role-badge-header role-superadmin';
            } else if (isAdminUser) {
                roleBadge.textContent = 'Admin';
                roleBadge.className = 'role-badge-header role-admin';
            } else {
                roleBadge.textContent = 'Viewer';
                roleBadge.className = 'role-badge-header role-viewer';
            }
            
            // Show/hide tabs and buttons
            document.getElementById('userManagementTab').style.display = isSuperAdminUser ? 'block' : 'none';
            document.getElementById('addCustomerBtn').style.display = canManageData() ? 'block' : 'none';
            document.getElementById('addProjectBtn').style.display = (canManageData() && currentTab === 'projects') ? 'block' : 'none';
            
            // Add notices
            if (isSuperAdminUser) {
                const notice = document.createElement('div');
                notice.className = 'readonly-notice';
                notice.style.background = '#f3e8ff';
                notice.style.borderColor = '#c084fc';
                notice.style.color = '#6b21a8';
                notice.innerHTML = 'üëë <strong>Super Admin:</strong> You have full access to everything - user management AND business operations.';
                notice.id = 'readonlyNotice';
                
                const container = document.getElementById('appContainer');
                if (container && !document.getElementById('readonlyNotice')) {
                    container.insertBefore(notice, container.firstChild);
                }
            } else if (!isAdminUser) {
                const notice = document.createElement('div');
                notice.className = 'readonly-notice';
                notice.innerHTML = 'üëÅÔ∏è <strong>View-Only Access:</strong> You can view all data but cannot make changes.';
                notice.id = 'readonlyNotice';
                
                const container = document.getElementById('appContainer');
                if (container && !document.getElementById('readonlyNotice')) {
                    container.insertBefore(notice, container.firstChild);
                }
            } else {
                const notice = document.getElementById('readonlyNotice');
                if (notice) notice.remove();
            }
            
            // Re-render UI
            if (currentTab === 'customers' && selectedCustomer) {
                renderDetails();
            } else if (currentTab === 'projects' && selectedProject) {
                renderProjectDetails();
            } else if (currentTab === 'users' && isSuperAdminUser) {
                loadAllUsers();
            }
        }

        function checkPermission(action = 'write') {
            if (action === 'write' && !canManageData()) {
                alert('‚õî Permission Denied\n\nYou have view-only access. Contact an admin to make changes.');
                return false;
            }
            if (action === 'manage-users' && !isSuperAdmin()) {
                alert('‚õî Permission Denied\n\nOnly Super Admins can manage users.');
                return false;
            }
            return true;
        }

        // ========================================
        // USER MANAGEMENT (SUPER ADMIN ONLY)
        // ========================================

        async function loadAllUsers() {
            // Load all users for everyone (needed for lead owner dropdown)
            // But only super admins can see the user management UI
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    allUsers.push({
                        uid: doc.id,
                        ...doc.data()
                    });
                });
                // Only render the users management UI if super admin
                if (isSuperAdmin()) {
                    renderUsersList();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderUsersList() {
            if (!isSuperAdmin()) return;
            
            const usersHtml = allUsers.length === 0 ?
                '<div class="empty-state">No users yet</div>' :
                allUsers.map(user => {
                    const roleClass = `status-${user.role}`;
                    const roleBadgeClass = user.role === 'superadmin' ? 'role-superadmin' : user.role === 'admin' ? 'role-admin' : 'role-viewer';
                    const roleLabel = user.role === 'superadmin' ? 'Super Admin' : user.role === 'admin' ? 'Admin' : 'Viewer';
                    
                    return `
                        <div class="user-card">
                            <div class="user-card-header">
                                <div>
                                    <div class="user-card-name">${user.name || 'Unnamed User'}</div>
                                    <div class="user-card-email">${user.email}</div>
                                </div>
                                <span class="status-badge ${roleBadgeClass}">${roleLabel}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                Created: ${new Date(user.createdAt).toLocaleDateString()}
                            </div>
                            ${user.uid !== currentUser.uid ? `
                                <div class="user-actions">
                                    <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="showChangeRoleModal('${user.uid}', '${user.email}', '${user.role}')">Change Role</button>
                                    <button class="btn btn-warning" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="showResetPasswordModal('${user.uid}', '${user.email}')">Reset Password</button>
                                    <button class="btn btn-danger" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="deleteUser('${user.uid}', '${user.email}')">Delete</button>
                                </div>
                            ` : '<div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem; font-style: italic;">This is your account</div>'}
                        </div>
                    `;
                }).join('');
            
            document.getElementById('usersList').innerHTML = usersHtml;
        }

        function showCreateUserModal() {
            if (!checkPermission('manage-users')) return;
            
            document.getElementById('createUserName').value = '';
            document.getElementById('createUserEmail').value = '';
            document.getElementById('createUserRole').value = 'viewer';
            document.getElementById('createUserPassword').value = '';
            document.getElementById('generatedPasswordDisplay').style.display = 'none';
            document.getElementById('createUserError').style.display = 'none';
            document.getElementById('createUserModal').classList.add('show');
        }

        function generateRandomPassword() {
            const length = 12;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('createUserPassword').value = password;
            document.getElementById('generatedPasswordText').textContent = password;
            document.getElementById('generatedPasswordDisplay').style.display = 'block';
        }

        function copyPassword() {
            const password = document.getElementById('generatedPasswordText').textContent;
            navigator.clipboard.writeText(password).then(() => {
                const btn = event.target;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy', 2000);
            });
        }

        async function createNewUser() {
            if (!checkPermission('manage-users')) return;
            
            const name = document.getElementById('createUserName').value.trim();
            const email = document.getElementById('createUserEmail').value.trim();
            const role = document.getElementById('createUserRole').value;
            const password = document.getElementById('createUserPassword').value;
            
            const errorDiv = document.getElementById('createUserError');
            
            if (!name || !email || !password) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 8) {
                errorDiv.textContent = 'Password must be at least 8 characters';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // Get current user's auth token
                const idToken = await currentUser.getIdToken();
                
                // Call backend API to create user
                const response = await fetch(`${BACKEND_API_URL}/users/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        displayName: name,
                        role: role
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create user');
                }
                
                console.log('‚úÖ User created successfully:', data);
                alert(`‚úÖ User created successfully!

Email: ${email}
Password: ${password}
Role: ${role === 'superadmin' ? 'Super Admin' : role === 'admin' ? 'Admin' : 'Viewer'}

Share these credentials securely with the user.
They can login immediately!`);
                
                closeModal('createUserModal');
                loadAllUsers();
                
            } catch (error) {
                console.error('‚ùå Error creating user:', error);
                errorDiv.textContent = 'Failed to create user: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function showChangeRoleModal(uid, email, currentRole) {
            if (!checkPermission('manage-users')) return;
            
            selectedUserForRole = uid;
            document.getElementById('changeRoleUserEmail').textContent = email;
            document.getElementById('newRoleSelect').value = currentRole;
            document.getElementById('changeRoleModal').classList.add('show');
        }

        async function saveRoleChange() {
            if (!checkPermission('manage-users')) return;
            
            const newRole = document.getElementById('newRoleSelect').value;
            
            try {
                await db.collection('users').doc(selectedUserForRole).update({
                    role: newRole
                });
                
                console.log('‚úÖ Role updated successfully');
                alert('Role updated successfully! User will see changes on next login.');
                closeModal('changeRoleModal');
                loadAllUsers();
            } catch (error) {
                console.error('Error updating role:', error);
                alert('Failed to update role: ' + error.message);
            }
        }

        function showResetPasswordModal(uid, email) {
            if (!checkPermission('manage-users')) return;
            
            selectedUserForPassword = { uid, email };
            document.getElementById('resetPasswordUserEmail').textContent = email;
            document.getElementById('resetPasswordInput').value = '';
            document.getElementById('resetPasswordDisplay').style.display = 'none';
            document.getElementById('resetPasswordModal').classList.add('show');
        }

        function generateResetPassword() {
            const length = 12;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('resetPasswordInput').value = password;
            document.getElementById('resetPasswordText').textContent = password;
            document.getElementById('resetPasswordDisplay').style.display = 'block';
        }

        function copyResetPassword() {
            const password = document.getElementById('resetPasswordText').textContent;
            navigator.clipboard.writeText(password).then(() => {
                const btn = event.target;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy', 2000);
            });
        }

        async function resetUserPassword() {
            if (!checkPermission('manage-users')) return;
            
            const newPassword = document.getElementById('resetPasswordInput').value;
            
            if (!newPassword || newPassword.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }
            
            try {
                // Get current user's auth token
                const idToken = await currentUser.getIdToken();
                
                // Call backend API to reset password
                const response = await fetch(`${BACKEND_API_URL}/users/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        email: selectedUserForPassword.email,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to reset password');
                }
                
                console.log('‚úÖ Password reset successfully');
                alert(`‚úÖ Password reset successfully!

User: ${selectedUserForPassword.email}
New Password: ${newPassword}

Share this password securely with the user.
They can login immediately with the new password!`);
                
                closeModal('resetPasswordModal');
            } catch (error) {
                console.error('‚ùå Error resetting password:', error);
                alert('Failed to reset password: ' + error.message);
            }
        }

        async function deleteUser(uid, email) {
            if (!checkPermission('manage-users')) return;
            
            if (!confirm(`Are you sure you want to delete user: ${email}?\n\nThis will:\n- Remove from Firestore\n- Delete Firebase Authentication account\n\nThis action cannot be undone.`)) return;
            
            try {
                // Get current user's auth token
                const idToken = await currentUser.getIdToken();
                
                // Call backend API to delete user completely
                const response = await fetch(`${BACKEND_API_URL}/users/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        uid: uid
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete user');
                }
                
                console.log('‚úÖ User deleted successfully');
                alert(`‚úÖ User deleted successfully!

${email} has been completely removed from the system.`);
                
                loadAllUsers();
            } catch (error) {
                console.error('‚ùå Error deleting user:', error);
                alert('Failed to delete user: ' + error.message);
            }
        }

        // Firebase Connection Test
        async function testFirebaseConnection() {
            const results = [];
            
            try {
                results.push('üîç Starting Firebase Connection Test...\n');
                
                // Test 1: Check if Firebase is initialized
                results.push('Test 1: Firebase Initialization');
                if (!firebase.apps.length) {
                    results.push('‚ùå FAILED: Firebase not initialized');
                    results.push('   Fix: Check if firebaseConfig is correct\n');
                    alert(results.join('\n'));
                    console.log(results.join('\n'));
                    return;
                }
                results.push('‚úÖ PASSED: Firebase initialized\n');
                
                // Test 2: Check Firestore connection
                results.push('Test 2: Firestore Connection');
                if (!db) {
                    results.push('‚ùå FAILED: Firestore not connected');
                    results.push('   Fix: Check Firebase console - Firestore should be enabled\n');
                    alert(results.join('\n'));
                    console.log(results.join('\n'));
                    return;
                }
                results.push('‚úÖ PASSED: Firestore connected\n');
                
                // Test 3: Try to write test data
                results.push('Test 3: Write Test Data');
                const testDoc = {
                    testField: 'Firebase Connection Test',
                    timestamp: new Date().toISOString()
                };
                
                try {
                    const docRef = await db.collection('_test').add(testDoc);
                    results.push('‚úÖ PASSED: Successfully wrote test document');
                    results.push(`   Document ID: ${docRef.id}\n`);
                    
                    // Test 4: Try to read the data back
                    results.push('Test 4: Read Test Data');
                    const doc = await docRef.get();
                    if (doc.exists) {
                        results.push('‚úÖ PASSED: Successfully read test document');
                        results.push(`   Data: ${JSON.stringify(doc.data())}\n`);
                    } else {
                        results.push('‚ùå FAILED: Could not read test document\n');
                    }
                    
                    // Test 5: Delete test document
                    results.push('Test 5: Delete Test Data');
                    await docRef.delete();
                    results.push('‚úÖ PASSED: Successfully deleted test document\n');
                    
                    // Test 6: Check customers collection
                    results.push('Test 6: Check Customers Collection');
                    const customersSnapshot = await db.collection('customers').limit(1).get();
                    results.push(`‚úÖ PASSED: Customers collection accessible`);
                    results.push(`   Current customers: ${customersSnapshot.size}\n`);
                    
                } catch (writeError) {
                    results.push('‚ùå FAILED: ' + writeError.message);
                    
                    if (writeError.code === 'permission-denied') {
                        results.push('\nüîß FIX NEEDED: Security Rules Issue');
                        results.push('   Go to Firebase Console ‚Üí Firestore ‚Üí Rules');
                        results.push('   Replace rules with:\n');
                        results.push('   rules_version = \'2\';');
                        results.push('   service cloud.firestore {');
                        results.push('     match /databases/{database}/documents {');
                        results.push('       match /{document=**} {');
                        results.push('         allow read, write: if true;');
                        results.push('       }');
                        results.push('     }');
                        results.push('   }\n');
                    } else if (writeError.code === 'unavailable') {
                        results.push('\nüîß FIX NEEDED: Network/Connection Issue');
                        results.push('   - Check your internet connection');
                        results.push('   - Try refreshing the page');
                        results.push('   - Check if Firebase service is down\n');
                    } else {
                        results.push(`\nüîß Error Code: ${writeError.code}`);
                        results.push(`   Message: ${writeError.message}\n`);
                    }
                }
                
                results.push('\n' + '='.repeat(50));
                results.push('üìä TEST SUMMARY');
                results.push('='.repeat(50));
                
                const passed = results.filter(r => r.includes('‚úÖ PASSED')).length;
                const failed = results.filter(r => r.includes('‚ùå FAILED')).length;
                
                results.push(`Tests Passed: ${passed}`);
                results.push(`Tests Failed: ${failed}`);
                
                if (failed === 0) {
                    results.push('\nüéâ ALL TESTS PASSED!');
                    results.push('Firebase is working correctly.');
                    results.push('Your data should sync properly.');
                    document.getElementById('syncStatus').textContent = '‚úÖ Firebase Connected';
                    document.getElementById('syncStatus').style.color = '#16a34a';
                } else {
                    results.push('\n‚ö†Ô∏è  SOME TESTS FAILED');
                    results.push('Please fix the issues above.');
                    document.getElementById('syncStatus').textContent = '‚ö†Ô∏è  Connection Issue';
                    document.getElementById('syncStatus').style.color = '#ea580c';
                }
                
            } catch (error) {
                results.push('\nüí• CRITICAL ERROR:');
                results.push(error.message);
                results.push('\nStack trace:');
                results.push(error.stack);
            }
            
            // Display results
            const resultText = results.join('\n');
            console.log(resultText);
            alert(resultText);
        }

        function initializeFirebase() {
            try {
                // Check if config is set
                if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                    document.getElementById('setupNotice').style.display = 'block';
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    // Fallback to localStorage
                    loadFromLocalStorage();
                    return;
                }

                console.log('üî• Initializing Firebase...');
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log('‚úÖ Firebase initialized successfully!');
                
                // Set up authentication state listener
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üë§ User logged in:', user.email);
                        currentUser = user;
                        
                        // Get user role
                        userRole = await getUserRole(user.uid);
                        console.log('üîë User role:', userRole);
                        
                        // Update UI with user info
                        document.getElementById('userDisplayName').textContent = user.displayName || user.email.split('@')[0];
                        document.getElementById('dropdownEmail').textContent = user.email;
                        document.getElementById('dropdownRole').textContent = `Role: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`;
                        
                        // Hide login, show app
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('appHeader').style.display = 'block';
                        document.getElementById('appContainer').style.display = 'block';
                        
                        // Update UI based on role
                        updateUIForRole();
                        
                        // Initialize data listeners
                        setupDataListeners();

                        // Initialize OneDrive silently in background (restore saved session)
                        initializeOneDrive().catch(e => console.warn('OneDrive background init:', e));
                    } else {
                        console.log('üë§ User logged out');
                        currentUser = null;
                        userRole = null;
                        
                        // Show login, hide app
                        document.getElementById('loginScreen').style.display = 'flex';
                        document.getElementById('appHeader').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'none';
                        
                        // Clear data
                        customers = [];
                        projects = [];
                        selectedCustomer = null;
                        selectedProject = null;
                    }
                });
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.getElementById('syncStatus').textContent = '‚ùå Offline Mode';
                loadFromLocalStorage();
            }
        }

        function setupDataListeners() {
            // Listen to real-time updates
            customersListener = db.collection('customers').onSnapshot((snapshot) => {
                console.log('üì° Received snapshot update:', snapshot.size, 'customers');
                customers = [];
                snapshot.forEach((doc) => {
                    customers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by creation date
                customers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                document.getElementById('syncStatus').style.color = '#16a34a';
                renderCustomerList();
                
                // Update selected customer if viewing one
                if (selectedCustomer) {
                    const updated = customers.find(c => c.id === selectedCustomer.id);
                    if (updated) {
                        selectedCustomer = updated;
                        renderDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Firebase snapshot error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                document.getElementById('syncStatus').textContent = '‚ùå Sync Error';
                document.getElementById('syncStatus').style.color = '#dc2626';
                
                if (error.code === 'permission-denied') {
                    alert('Logged Out');
                }
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            });

            // Listen to projects real-time updates
            projectsListener = db.collection('projects').onSnapshot((snapshot) => {
                console.log('üì° Received projects update:', snapshot.size, 'projects');
                projects = [];
                snapshot.forEach((doc) => {
                    projects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                renderProjectList();
                
                if (selectedProject) {
                    const updated = projects.find(p => p.id === selectedProject.id);
                    if (updated) {
                        selectedProject = updated;
                        renderProjectDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Projects snapshot error:', error);
            });

            // Listen to leads real-time updates
            leadsListener = db.collection('leads').onSnapshot((snapshot) => {
                console.log('üì° Received leads update:', snapshot.size, 'leads');
                leads = [];
                snapshot.forEach((doc) => {
                    leads.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by creation date
                leads.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                if (currentTab === 'leads') {
                    renderLeadPipeline();
                }
                
                // Update selected lead if viewing one
                if (selectedLead) {
                    const updated = leads.find(l => l.id === selectedLead.id);
                    if (updated) {
                        selectedLead = updated;
                        renderLeadDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Leads snapshot error:', error);
            });

            // Load all users for lead owner dropdown (available to all roles)
            loadAllUsers();
        }

        // Fallback to localStorage if Firebase not configured
        function loadFromLocalStorage() {
            const customerData = localStorage.getItem('business-manager-data');
            if (customerData) {
                customers = JSON.parse(customerData);
            }
            const projectData = localStorage.getItem('business-manager-projects');
            if (projectData) {
                projects = JSON.parse(projectData);
            }
            const leadsData = localStorage.getItem('business-manager-leads');
            if (leadsData) {
                leads = JSON.parse(leadsData);
            }
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            renderCustomerList();
            renderProjectList();
            renderLeadPipeline();
            renderDetails();
        }

        function saveToLocalStorage() {
            localStorage.setItem('business-manager-data', JSON.stringify(customers));
            localStorage.setItem('business-manager-projects', JSON.stringify(projects));
            localStorage.setItem('business-manager-leads', JSON.stringify(leads));
        }

        // Add customer
        async function addCustomer() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('newCustomerName').value.trim();
            const contact = document.getElementById('newCustomerContact').value.trim();

            if (!name) {
                alert('Please enter customer name');
                return;
            }

            const newCustomer = {
                name: name,
                contact: contact,
                payments: [],
                materials: [],
                createdAt: new Date().toISOString()
            };

            try {
                console.log('üíæ Attempting to add customer:', newCustomer);
                
                if (db) {
                    console.log('üì§ Writing to Firebase...');
                    const docRef = await db.collection('customers').add(newCustomer);
                    console.log('‚úÖ Customer added to Firebase with ID:', docRef.id);
                } else {
                    console.log('üíæ No Firebase connection - saving to localStorage');
                    customers.push({
                        id: Date.now().toString(),
                        ...newCustomer
                    });
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                closeModal('addCustomerModal');
                document.getElementById('newCustomerName').value = '';
                document.getElementById('newCustomerContact').value = '';
            } catch (error) {
                console.error('‚ùå Error adding customer:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                if (error.code === 'permission-denied') {
                    alert('Logged Out');
                } else {
                    alert('Failed to add customer: ' + error.message);
                }
            }
        }

        // Render customer list
        function renderCustomerList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(search) || 
                (c.contact && c.contact.toLowerCase().includes(search))
            );

            const html = filtered.length === 0 ? 
                '<div class="empty-state">No customers found</div>' :
                filtered.map(c => {
                    const customerProjects = projects.filter(p => p.customerId === c.id);
                    const projectCount = customerProjects.length;
                    const totalValue = customerProjects.reduce((sum, p) => sum + (p.value || 0), 0);
                    const isActive = selectedCustomer && selectedCustomer.id === c.id;
                    
                    return `
                        <div class="customer-item ${isActive ? 'active' : ''}" onclick="selectCustomer('${c.id}')">
                            <div class="customer-name">${c.name}</div>
                            ${c.contact ? `<div class="customer-contact">${c.contact}</div>` : ''}
                            <div class="balance positive">
                                ${projectCount} project${projectCount !== 1 ? 's' : ''}
                                ${totalValue > 0 ? ` ‚Ä¢ ${formatCurrency(totalValue)}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('customerList').innerHTML = html;
        }

        // Select customer
        function selectCustomer(id) {
            selectedCustomer = customers.find(c => c.id === id);
            renderCustomerList();
            renderDetails();
        }

        // Calculate totals
        function calculateTotals(customer) {
            const totalPaid = (customer.payments || []).reduce((sum, p) => sum + p.amount, 0);
            
            // Calculate total materials cost - handle both old and new formats
            const totalMaterials = (customer.materials || []).reduce((sum, m) => {
                if (m.items && m.items.length > 0) {
                    // New format - sum all items
                    const itemsTotal = m.items.reduce((itemSum, item) => itemSum + (parseFloat(item.cost) || 0), 0);
                    return sum + itemsTotal;
                } else if (m.totalCost) {
                    // New format with pre-calculated total
                    return sum + (parseFloat(m.totalCost) || 0);
                } else if (m.cost) {
                    // Old format - single item
                    return sum + (parseFloat(m.cost) || 0);
                }
                return sum;
            }, 0);
            
            return {
                totalPaid,
                totalMaterials,
                balance: totalPaid - totalMaterials
            };
        }

        // Format currency
        function formatCurrency(amount) {
            return '‚Çπ' + amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Render details panel
        function renderDetails() {
            if (!selectedCustomer) {
                document.getElementById('detailsPanel').innerHTML = `
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">üìä</div>
                            <div class="placeholder-text">Select a Customer</div>
                            <div class="placeholder-subtext">Choose a customer to view their projects</div>
                        </div>
                    </div>
                `;
                return;
            }

            // Get projects for this customer
            const customerProjects = projects.filter(p => p.customerId === selectedCustomer.id);
            
            // Calculate totals across all projects
            let totalProjectValue = 0;
            let totalPaid = 0;
            let totalMaterials = 0;
            
            customerProjects.forEach(p => {
                if (p.value) totalProjectValue += p.value;
                if (p.payments) totalPaid += p.payments.reduce((sum, pay) => sum + pay.amount, 0);
                if (p.materials) totalMaterials += p.materials.reduce((sum, mat) => sum + mat.cost, 0);
            });
            
            const balance = totalPaid - totalMaterials;

            const projectsHtml = customerProjects.length === 0 ?
                '<div class="empty-state">No projects for this customer yet</div>' :
                customerProjects.map(p => {
                    const stageClass = `status-${p.stage}`;
                    const stageLabel = p.stage.charAt(0).toUpperCase() + p.stage.slice(1);
                    const projectPayments = (p.payments || []).reduce((sum, pay) => sum + pay.amount, 0);
                    const projectMaterials = (p.materials || []).reduce((sum, mat) => sum + mat.cost, 0);
                    const projectBalance = projectPayments - projectMaterials;
                    
                    return `
                        <div class="list-item" style="cursor: pointer;" onclick="switchToProject('${p.id}')">
                            <div class="item-info" style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div class="item-title">${p.name}</div>
                                    <span class="status-badge ${stageClass}">${stageLabel}</span>
                                </div>
                                ${p.value ? `<div class="item-detail">üí∞ Project Value: ${formatCurrency(p.value)}</div>` : ''}
                                <div class="item-detail">
                                    Paid: ${formatCurrency(projectPayments)} | Materials: ${formatCurrency(projectMaterials)} | 
                                    <span style="color: ${projectBalance >= 0 ? '#16a34a' : '#dc2626'}; font-weight: 600;">
                                        Balance: ${formatCurrency(projectBalance)}
                                    </span>
                                </div>
                                ${p.startDate ? `<div class="item-date">Started: ${new Date(p.startDate).toLocaleDateString()}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('detailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Customer Info -->
                    <div class="card">
                        <div class="card-header">
                            <h2>${selectedCustomer.name}</h2>
                        </div>
                        <div class="card-body">
                            ${selectedCustomer.contact ? `
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Contact</div>
                                    <div style="font-weight: 600;">üìû ${selectedCustomer.contact}</div>
                                </div>
                            ` : ''}
                            <div style="font-size: 0.75rem; color: #9ca3af;">
                                Customer since: ${formatDate(selectedCustomer.createdAt)}
                            </div>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="stats">
                        <div class="stat-card green">
                            <div class="stat-label" style="color: #16a34a">Total Projects</div>
                            <div class="stat-value" style="color: #15803d">${customerProjects.length}</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-label" style="color: #2563eb">Total Value</div>
                            <div class="stat-value" style="color: #1d4ed8">${formatCurrency(totalProjectValue)}</div>
                        </div>
                        <div class="stat-card ${balance >= 0 ? 'blue' : 'red'}">
                            <div class="stat-label" style="color: ${balance >= 0 ? '#2563eb' : '#dc2626'}">Net Balance</div>
                            <div class="stat-value" style="color: ${balance >= 0 ? '#1d4ed8' : '#b91c1c'}">${formatCurrency(balance)}</div>
                        </div>
                    </div>

                    <!-- Projects List -->
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>üèóÔ∏è Projects</h3>
                            ${isAdmin() ? `<button class="btn btn-primary" onclick="createProjectForCustomer('${selectedCustomer.id}')" style="font-size: 0.875rem; padding: 0.5rem 1rem;">+ New Project</button>` : ''}
                        </div>
                        <div>${projectsHtml}</div>
                    </div>

                    ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteCustomer()">Delete Customer</button>` : ''}
                </div>
            `;
        }

        // Add payment
        async function addPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const note = document.getElementById('paymentNote').value.trim();
            const date = document.getElementById('paymentDate').value;

            if (!amount || amount <= 0) {
                alert('Please enter valid amount');
                return;
            }

            const payment = {
                id: Date.now().toString(),
                amount: amount,
                note: note,
                paymentDate: date || new Date().toISOString(),
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const payments = [...(selectedCustomer.payments || []), payment];
                    await db.collection('customers').doc(selectedCustomer.id).update({ payments });
                } else {
                    selectedCustomer.payments = [...(selectedCustomer.payments || []), payment];
                    saveToLocalStorage();
                    renderDetails();
                }

                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentNote').value = '';
                document.getElementById('paymentDate').value = '';
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Failed to add payment');
            }
        }

        // Delete payment
        async function deletePayment(id) {
            try {
                if (db) {
                    const payments = (selectedCustomer.payments || []).filter(p => p.id !== id);
                    await db.collection('customers').doc(selectedCustomer.id).update({ payments });
                } else {
                    selectedCustomer.payments = (selectedCustomer.payments || []).filter(p => p.id !== id);
                    saveToLocalStorage();
                    renderCustomerList();
                    renderDetails();
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Failed to delete payment');
            }
        }

        // Handle file selection
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 2 * 1024 * 1024) {
                    alert(file.name + ' is too large (max 2MB)');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFiles.push({
                        id: Date.now().toString() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderSelectedFiles();
                };
                reader.readAsDataURL(file);
            });
        }

        // Render selected files
        function renderSelectedFiles() {
            if (selectedFiles.length === 0) {
                document.getElementById('selectedFiles').innerHTML = '';
                return;
            }

            const html = `
                <div style="margin-top: 0.75rem;">
                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Selected Files:</div>
                    ${selectedFiles.map(f => `
                        <div class="file-item">
                            ${f.type.startsWith('image/') ?
                                `<img src="${f.data}" class="file-thumbnail" alt="${f.name}">` :
                                `<div class="file-icon">${getFileIcon(f.type)}</div>`
                            }
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.875rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFile('${f.id}')">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('selectedFiles').innerHTML = html;
        }

        // Remove file
        function removeFile(id) {
            selectedFiles = selectedFiles.filter(f => f.id !== id);
            renderSelectedFiles();
        }

        // Get file icon
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.includes('pdf')) return 'üìÑ';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Download file
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add material
        async function addMaterial() {
            const name = document.getElementById('materialName').value.trim();
            const cost = parseFloat(document.getElementById('materialCost').value);
            const quantity = document.getElementById('materialQuantity').value.trim();
            const date = document.getElementById('materialDate').value;

            if (!name || !cost || cost <= 0) {
                alert('Please enter valid material details');
                return;
            }

            const material = {
                id: Date.now().toString(),
                name: name,
                cost: cost,
                quantity: quantity,
                procurementDate: date || new Date().toISOString(),
                files: [...selectedFiles],
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const materials = [...(selectedCustomer.materials || []), material];
                    await db.collection('customers').doc(selectedCustomer.id).update({ materials });
                } else {
                    selectedCustomer.materials = [...(selectedCustomer.materials || []), material];
                    saveToLocalStorage();
                    renderDetails();
                }

                document.getElementById('materialName').value = '';
                document.getElementById('materialCost').value = '';
                document.getElementById('materialQuantity').value = '';
                document.getElementById('materialDate').value = '';
                selectedFiles = [];
            } catch (error) {
                console.error('Error adding material:', error);
                alert('Failed to add material');
            }
        }

        // Delete material
        async function deleteMaterial(id) {
            try {
                const materials = (selectedCustomer.materials || []).filter(m => m.id !== id);
                
                if (db) {
                    await db.collection('customers').doc(selectedCustomer.id).update({ materials });
                }
                
                selectedCustomer.materials = materials;
                saveToLocalStorage();
                renderCustomerList();
                renderDetails();
                
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material');
            }
        }

        // Delete customer
        async function deleteCustomer() {
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            try {
                if (db) {
                    await db.collection('customers').doc(selectedCustomer.id).delete();
                } else {
                    customers = customers.filter(c => c.id !== selectedCustomer.id);
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                selectedCustomer = null;
                renderDetails();
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('Failed to delete customer');
            }
        }

        // Filter customers
        function filterCustomers() {
            renderCustomerList();
        }

        // Show modal
        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('show');
        }

        // Close modal
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // ========================================
        // TAB SWITCHING
        // ========================================
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all tabs
            ['leadsTab','customersTab','projectsTab','usersTab','tasksTab'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            document.getElementById('addCustomerBtn').style.display = 'none';
            document.getElementById('addProjectBtn').style.display = 'none';

            if (tab === 'leads') {
                document.getElementById('leadsTab').style.display = 'block';
                renderLeadPipeline();
            } else if (tab === 'customers') {
                document.getElementById('customersTab').style.display = 'block';
                document.getElementById('addCustomerBtn').style.display = canManageData() ? 'block' : 'none';
            } else if (tab === 'projects') {
                document.getElementById('projectsTab').style.display = 'block';
                document.getElementById('addProjectBtn').style.display = canManageData() ? 'block' : 'none';
            } else if (tab === 'tasks') {
                document.getElementById('tasksTab').style.display = 'block';
                renderTasksTab();
            } else if (tab === 'users') {
                document.getElementById('usersTab').style.display = 'block';
                if (isSuperAdmin()) loadAllUsers();
            }
        }

        // ========================================
        // PROJECT MANAGEMENT
        // ========================================
        
        function showAddProjectModal() {
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('saveProjectBtn').textContent = 'Add Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectCustomer').value = '';
            document.getElementById('projectStage').value = 'won';
            document.getElementById('projectValue').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            document.getElementById('projectDescription').value = '';
            
            // Populate customer dropdown
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        function showEditProjectModal(project) {
            editingProjectId = project.id;
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('saveProjectBtn').textContent = 'Update Project';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectCustomer').value = project.customerId || '';
            document.getElementById('projectStage').value = project.stage;
            document.getElementById('projectValue').value = project.value || '';
            document.getElementById('projectStartDate').value = project.startDate ? project.startDate.split('T')[0] : '';
            document.getElementById('projectEndDate').value = project.endDate ? project.endDate.split('T')[0] : '';
            document.getElementById('projectDescription').value = project.description || '';
            
            // Populate customer dropdown
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === project.customerId) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        async function saveProject() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('projectName').value.trim();
            const customerId = document.getElementById('projectCustomer').value;
            const stage = document.getElementById('projectStage').value;
            const value = parseFloat(document.getElementById('projectValue').value) || 0;
            const startDate = document.getElementById('projectStartDate').value;
            const endDate = document.getElementById('projectEndDate').value;
            const description = document.getElementById('projectDescription').value.trim();

            if (!name) {
                alert('Please enter project name');
                return;
            }

            const projectData = {
                name,
                customerId,
                customerName: customerId ? customers.find(c => c.id === customerId)?.name : '',
                stage,
                value,
                startDate: startDate || null,
                endDate: endDate || null,
                description,
                updatedAt: new Date().toISOString()
            };

            try {
                if (editingProjectId) {
                    // Update existing project
                    console.log('üìù Updating project:', editingProjectId);
                    if (db) {
                        await db.collection('projects').doc(editingProjectId).update(projectData);
                    } else {
                        const index = projects.findIndex(p => p.id === editingProjectId);
                        if (index !== -1) {
                            projects[index] = { ...projects[index], ...projectData };
                        }
                        saveToLocalStorage();
                        renderProjectList();
                    }
                } else {
                    // Add new project
                    projectData.createdAt = new Date().toISOString();
                    console.log('üíæ Adding new project:', projectData);
                    
                    if (db) {
                        await db.collection('projects').add(projectData);
                    } else {
                        projects.push({
                            id: Date.now().toString(),
                            ...projectData
                        });
                        saveToLocalStorage();
                        renderProjectList();
                    }
                }

                closeModal('projectModal');
            } catch (error) {
                console.error('‚ùå Error saving project:', error);
                alert('Failed to save project: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            if (!checkPermission('write')) return;
            if (!confirm('Are you sure you want to delete this project?')) return;
            
            try {
                if (db) {
                    await db.collection('projects').doc(projectId).delete();
                } else {
                    projects = projects.filter(p => p.id !== projectId);
                    saveToLocalStorage();
                    renderProjectList();
                }
                
                if (selectedProject?.id === projectId) {
                    selectedProject = null;
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project');
            }
        }

        async function updateProjectStage(projectId, newStage) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    await db.collection('projects').doc(projectId).update({ 
                        stage: newStage,
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    const project = projects.find(p => p.id === projectId);
                    if (project) {
                        project.stage = newStage;
                        project.updatedAt = new Date().toISOString();
                        saveToLocalStorage();
                        renderProjectList();
                        if (selectedProject?.id === projectId) {
                            selectedProject.stage = newStage;
                            renderProjectDetails();
                        }
                    }
                }
                console.log('‚úÖ Updated project stage to:', newStage);
            } catch (error) {
                console.error('Error updating stage:', error);
                alert('Failed to update project stage');
            }
        }

        function selectProject(id) {
            selectedProject = projects.find(p => p.id === id);
            tempMaterialItems = []; // Clear temp items
            selectedFiles = []; // Clear selected files
            editingMaterialId = null; // Clear editing state
            renderProjectList();
            renderProjectDetails();
            // Initialize material items container after a short delay to ensure DOM is ready
            setTimeout(() => {
                if (document.getElementById('materialItemsContainer')) {
                    renderMaterialItemsContainer();
                }
            }, 100);
        }

        function filterProjects() {
            renderProjectList();
        }

        function filterProjectsByStage(stage) {
            projectStageFilter = stage;
            renderProjectList();
        }

        function renderProjectList() {
            const search = document.getElementById('projectSearchInput')?.value.toLowerCase() || '';
            let filtered = projects.filter(p => 
                p.name.toLowerCase().includes(search) || 
                (p.customerName && p.customerName.toLowerCase().includes(search)) ||
                (p.description && p.description.toLowerCase().includes(search))
            );

            if (projectStageFilter !== 'all') {
                filtered = filtered.filter(p => p.stage === projectStageFilter);
            }

            const html = filtered.length === 0 ? 
                '<div class="empty-state">No projects found</div>' :
                filtered.map(p => {
                    const isActive = selectedProject && selectedProject.id === p.id;
                    const stageClass = `status-${p.stage}`;
                    const stageLabel = p.stage.charAt(0).toUpperCase() + p.stage.slice(1);
                    
                    return `
                        <div class="customer-item ${isActive ? 'active' : ''}" onclick="selectProject('${p.id}')">
                            <div class="project-header">
                                <div class="customer-name">${p.name}</div>
                                <span class="status-badge ${stageClass}">${stageLabel}</span>
                            </div>
                            ${p.customerName ? `<div class="customer-contact">üë§ ${p.customerName}</div>` : ''}
                            ${p.value ? `<div class="customer-contact">üí∞ ${formatCurrency(p.value)}</div>` : ''}
                        </div>
                    `;
                }).join('');

            const listElement = document.getElementById('projectList');
            if (listElement) {
                listElement.innerHTML = html;
            }
        }

        function renderProjectDetails() {
            if (!selectedProject) {
                document.getElementById('projectDetailsPanel').innerHTML = `
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">üèóÔ∏è</div>
                            <div class="placeholder-text">Select a Project</div>
                            <div class="placeholder-subtext">Choose a project to manage payments and materials</div>
                        </div>
                    </div>
                `;
                return;
            }

            const stageClass = `status-${selectedProject.stage}`;
            const stageLabel = selectedProject.stage.charAt(0).toUpperCase() + selectedProject.stage.slice(1);

            // Calculate project financials
            const payments = selectedProject.payments || [];
            const materials = selectedProject.materials || [];
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const collection = parseFloat(selectedProject.collection) || 0;
            
            // Calculate total materials cost - handle both old and new formats
            const totalMaterials = materials.reduce((sum, m) => {
                if (m.grandTotal) {
                    // New format with grandTotal
                    return sum + parseFloat(m.grandTotal);
                } else if (m.items && m.items.length > 0) {
                    // Items format - calculate from items
                    const itemsTotal = m.items.reduce((itemSum, item) => {
                        const cost = parseFloat(item.cost) || ((parseFloat(item.quantity) || 0) * (parseFloat(item.rate) || 0));
                        const gst = parseFloat(item.gstAmount) || (cost * (parseFloat(item.gstPercent) || 0) / 100);
                        return itemSum + cost + gst;
                    }, 0);
                    return sum + itemsTotal;
                } else if (m.totalCost) {
                    // Old totalCost format
                    return sum + (parseFloat(m.totalCost) || 0);
                } else if (m.cost) {
                    // Very old single cost format
                    return sum + (parseFloat(m.cost) || 0);
                }
                return sum;
            }, 0);
            
            const balance = totalPaid - totalMaterials;
            const balanceColor = balance >= 0 ? 'blue' : 'red';
            const balanceLabel = balance >= 0 ? 'Balance' : 'Outstanding';

            const paymentsHtml = payments.length === 0 ?
                '<div class="empty-state">No payments yet</div>' :
                payments.map(p => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">${formatCurrency(p.amount)}</div>
                            ${p.note ? `<div class="item-detail">${p.note}</div>` : ''}
                            <div class="item-date">Received: ${p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : formatDate(p.date)}</div>
                        </div>
                        ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteProjectPayment('${p.id}')">Delete</button>` : ''}
                    </div>
                `).join('');

            const materialsHtml = materials.length === 0 ?
                '<div class="empty-state">No materials yet</div>' :
                materials.map(m => {
                    // Calculate total cost properly
                    let totalCost = 0;
                    if (m.items && m.items.length > 0) {
                        totalCost = m.items.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
                    } else if (m.cost) {
                        totalCost = parseFloat(m.cost) || 0;
                    } else if (m.totalCost) {
                        totalCost = parseFloat(m.totalCost) || 0;
                    }
                    
                    return `
                    <div class="list-item">
                        <div class="item-info">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <div class="item-title">üè™ ${m.supplierName || 'Supplier'}</div>
                                    <div class="item-date">üìÖ Procured: ${m.procurementDate ? new Date(m.procurementDate).toLocaleDateString() : formatDate(m.date || m.createdAt)}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="item-detail" style="font-size: 1.125rem; font-weight: 700;">Grand Total: ${formatCurrency(totalCost)}</div>
                                    ${(m.paymentAmount || 0) > 0 ? `
                                        <div style="font-size: 0.875rem; color: #10b981; margin-top: 0.25rem;">
                                            ‚úÖ Paid: ${formatCurrency(m.paymentAmount)}
                                        </div>
                                        ${(m.balanceDueToSupplier || 0) > 0 ? `
                                            <div style="font-size: 0.875rem; color: #ef4444; margin-top: 0.125rem;">
                                                üî¥ Balance Due: ${formatCurrency(m.balanceDueToSupplier)}
                                            </div>
                                        ` : ''}
                                    ` : '<div style="font-size: 0.875rem; color: #ef4444;">‚è≥ Payment Pending</div>'}
                                </div>
                            </div>
                            
                            ${m.items && m.items.length > 0 ? `
                                <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">üì¶ Items (${m.items.length}):</div>
                                    <div style="display: grid; grid-template-columns: 2fr 60px 70px 80px 70px 80px 90px; gap: 0.25rem; font-size: 0.75rem; font-weight: 600; color: #6b7280; margin-bottom: 0.25rem;">
                                        <span>Item</span><span>Unit</span><span>Qty</span><span>Rate</span><span>GST%</span><span>GST Amt</span><span>Total</span>
                                    </div>
                                    ${m.items.map(item => {
                                        const qty = parseFloat(item.quantity) || 0;
                                        const rate = parseFloat(item.rate) || parseFloat(item.cost) || 0;
                                        const cost = item.cost !== undefined ? parseFloat(item.cost) : (qty * rate);
                                        const gstAmt = parseFloat(item.gstAmount) || (cost * (parseFloat(item.gstPercent) || 0) / 100);
                                        const total = cost + gstAmt;
                                        return `
                                        <div style="display: grid; grid-template-columns: 2fr 60px 70px 80px 70px 80px 90px; gap: 0.25rem; padding: 0.25rem 0; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb;">
                                            <span>${item.name}</span>
                                            <span>${item.unit || 'Nos'}</span>
                                            <span>${qty}</span>
                                            <span>${formatCurrency(rate)}</span>
                                            <span style="color: #6b7280;">${item.gstPercent || 0}%</span>
                                            <span style="color: #6b7280;">${formatCurrency(gstAmt)}</span>
                                            <span style="font-weight: 600;">${formatCurrency(total)}</span>
                                        </div>`;
                                    }).join('')}
                                    <div style="display: grid; grid-template-columns: 2fr 60px 70px 80px 70px 80px 90px; gap: 0.25rem; padding: 0.5rem 0 0; font-size: 0.875rem; font-weight: 700; border-top: 2px solid #e5e7eb; margin-top: 0.25rem;">
                                        <span>Totals</span><span></span><span></span><span></span><span></span>
                                        <span style="color: #0284c7;">${formatCurrency(m.totalGST || 0)}</span>
                                        <span style="color: #059669;">${formatCurrency(m.grandTotal || (m.totalCost || 0) + (m.totalGST || 0))}</span>
                                    </div>
                                </div>
                            ` : m.name ? `
                                <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.875rem;">
                                        ${m.name}${m.quantity ? ` (${m.quantity})` : ''} - ${formatCurrency(m.cost || 0)}
                                    </div>
                                </div>
                            ` : ''}

                            ${m.supplierPayments && m.supplierPayments.length > 0 ? `
                                <div style="background: #f0fdf4; border: 1px solid #86efac; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #166534;">üí∏ Supplier Payments</div>
                                    ${m.supplierPayments.map(p => `
                                        <div style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem; border-bottom: 1px solid #d1fae5;">
                                            <span>${new Date(p.date).toLocaleDateString('en-IN')}${p.note ? ' ¬∑ ' + p.note : ''}</span>
                                            <span style="font-weight: 600; color: #10b981;">+${formatCurrency(p.amount)}</span>
                                        </div>
                                    `).join('')}
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0 0; font-size: 0.875rem; font-weight: 700; border-top: 2px solid #86efac; margin-top: 0.5rem;">
                                        <span>Paid: ${formatCurrency(m.paymentAmount || 0)}</span>
                                        ${(m.balanceDueToSupplier || 0) > 0 ? `
                                            <span style="color: #ef4444;">üî¥ Balance Due: ${formatCurrency(m.balanceDueToSupplier)}</span>
                                        ` : `
                                            <span style="color: #10b981;">‚úÖ Fully Paid</span>
                                        `}
                                    </div>
                                </div>
                            ` : (m.paymentAmount && m.paymentAmount > 0) ? `
                                <div style="background: #f0fdf4; padding: 0.5rem; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.85rem;">
                                    üí∏ Paid: ${formatCurrency(m.paymentAmount)} ${m.paymentDate ? 'on ' + new Date(m.paymentDate).toLocaleDateString('en-IN') : ''}
                                </div>
                            ` : ''}
                            
                            ${m.files && m.files.length > 0 ? `
                                <div class="files-grid">
                                    ${m.files.map(f => `
                                        <div class="attached-file">
                                            <div class="file-icon">${f.type && f.type.startsWith('image/') ? 'üñºÔ∏è' : getFileIcon(f.type)}</div>
                                            <div style="flex: 1; min-width: 0; overflow: hidden;">
                                                <div style="font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                                                <div style="font-size: 0.7rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                                            </div>
                                            <a href="${f.downloadUrl || f.data}" download="${f.name}" target="_blank" class="download-btn" title="Download">‚¨áÔ∏è</a>
                                            ${isAdmin() ? `<button onclick="deleteProjectMaterialFile('${m.id}','${f.id || f.name}')" style="background:none;border:none;cursor:pointer;color:#ef4444;font-size:1rem;padding:0 4px;" title="Delete file">üóëÔ∏è</button>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        ${isAdmin() ? `
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" onclick="editProjectMaterial('${m.id}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteProjectMaterial('${m.id}')">Delete</button>
                            </div>
                        ` : ''}
                    </div>
                `}).join('');

            // Delivery Challans HTML
            const deliveryChallans = selectedProject.deliveryChallans || [];
            const deliveryChallansHtml = deliveryChallans.length === 0 ?
                '<div class="empty-state">No delivery challans yet</div>' :
                deliveryChallans.map(dc => `
                    <div class="list-item" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">
                            <div class="item-info" style="flex: 1;">
                                <div class="item-title">Challan #${dc.challanNumber}</div>
                                <div class="item-detail">
                                    üìÖ Date: ${new Date(dc.deliveryDate).toLocaleDateString()}
                                    ${dc.vehicleNumber ? ` | üöõ Vehicle: ${dc.vehicleNumber}` : ''}
                                </div>
                                <div class="item-date">
                                    <strong>Items:</strong> ${dc.items.map(item => `${item.name} (${item.quantity})`).join(', ')}
                                </div>
                                ${dc.receivedBy ? `<div class="item-date">Received by: ${dc.receivedBy}</div>` : ''}
                                ${dc.remarks ? `<div class="item-date">Remarks: ${dc.remarks}</div>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.4rem; align-items: flex-end;">
                                <button class="btn btn-primary" onclick="downloadChallan('${dc.id}')">üìÑ Download PDF</button>
                                ${isAdmin() ? `
                                    <button class="btn btn-secondary" onclick="editDeliveryChallan('${dc.id}')">‚úèÔ∏è Edit</button>
                                    <button class="btn btn-danger" onclick="deleteDeliveryChallan('${dc.id}')">Delete</button>
                                ` : ''}
                            </div>
                        </div>
                        <!-- Signed Copy Section -->
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 0.5rem;">
                            ${dc.signedCopy ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                    <span style="font-size: 0.8rem; color: #059669; font-weight: 600;">‚úÖ Signed copy uploaded</span>
                                    <a href="${dc.signedCopy.downloadUrl || dc.signedCopy.data}" target="_blank" download="${dc.signedCopy.name}"
                                       class="btn btn-secondary" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">‚¨áÔ∏è ${dc.signedCopy.name}</a>
                                    ${isAdmin() ? `<button class="btn btn-danger" onclick="removeSignedCopy('${dc.id}')" style="padding:0.2rem 0.6rem; font-size:0.75rem;">Remove</button>` : ''}
                                </div>
                            ` : `
                                ${isAdmin() ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.8rem; color: #6b7280;">üìé No signed copy yet</span>
                                    <label class="btn btn-secondary" style="padding: 0.2rem 0.6rem; font-size: 0.75rem; cursor: pointer; margin: 0;">
                                        ‚¨ÜÔ∏è Upload Signed Copy
                                        <input type="file" accept="image/*,.pdf" style="display:none"
                                            onchange="uploadSignedCopy('${dc.id}', this)">
                                    </label>
                                </div>
                                ` : '<span style="font-size:0.8rem; color:#6b7280;">No signed copy yet</span>'}
                            `}
                        </div>
                    </div>
                `).join('');

            // Material Installed/Handover HTML
            const installations = selectedProject.installations || [];
            const installationsHtml = installations.length === 0 ?
                '<div class="empty-state">No installations/handovers yet</div>' :
                installations.map(inst => {
                    const statusColors = {
                        'installed': 'green',
                        'handed_over': 'blue',
                        'pending': 'orange'
                    };
                    const statusLabels = {
                        'installed': 'Installed',
                        'handed_over': 'Handed Over',
                        'pending': 'Pending'
                    };
                    const statusColor = statusColors[inst.status] || 'gray';
                    const statusLabel = statusLabels[inst.status] || inst.status;
                    
                    return `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">
                                ${inst.itemName}
                                <span class="status-badge ${statusColor}" style="display: inline-block; margin-left: 0.5rem; font-size: 0.75rem;">
                                    ${statusLabel}
                                </span>
                            </div>
                            <div class="item-detail">
                                ${inst.installationDate ? `üîß Installed: ${new Date(inst.installationDate).toLocaleDateString()}` : ''}
                                ${inst.installationDate && inst.handoverDate ? ' | ' : ''}
                                ${inst.handoverDate ? `‚úÖ Handed Over: ${new Date(inst.handoverDate).toLocaleDateString()}` : ''}
                            </div>
                            ${inst.quantity ? `<div class="item-date">Quantity: ${inst.quantity}</div>` : ''}
                            ${inst.installedBy ? `<div class="item-date">Installed by: ${inst.installedBy}</div>` : ''}
                            ${inst.handedOverTo ? `<div class="item-date">Handed over to: ${inst.handedOverTo}</div>` : ''}
                            ${inst.location ? `<div class="item-date">Location: ${inst.location}</div>` : ''}
                            ${inst.remarks ? `<div class="item-date">Remarks: ${inst.remarks}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            ${isAdmin() ? `
                                <button class="btn btn-secondary" onclick="updateInstallationStatus('${inst.id}')">Update Status</button>
                                <button class="btn btn-danger" onclick="deleteInstallation('${inst.id}')">Delete</button>
                            ` : ''}
                        </div>
                    </div>
                `}).join('');

            // Invoices HTML
            const invoices = selectedProject.invoices || [];
            const invoicesHtml = invoices.length === 0 ?
                '<div class="empty-state">No invoices generated yet</div>' :
                invoices.map(inv => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">Invoice #${inv.invoiceNumber}</div>
                            <div class="item-detail">
                                üìÖ Date: ${new Date(inv.invoiceDate).toLocaleDateString()} | 
                                üí∞ Total: ${formatCurrency(inv.grandTotal)} | 
                                üè¢ GSTIN: ${inv.companyGSTIN || 'N/A'}
                            </div>
                            <div class="item-date">
                                <strong>Items:</strong> ${inv.items.length} | 
                                Subtotal: ${formatCurrency(inv.subtotal)} | 
                                GST: ${formatCurrency(inv.totalGST)}
                                ${inv.discount > 0 ? ` | Discount: ${formatCurrency(inv.discount)}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="downloadInvoice('${inv.id}')">üìÑ Download</button>
                            ${isAdmin() ? `
                                <button class="btn btn-secondary" onclick="editInvoice('${inv.id}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteInvoice('${inv.id}')">Delete</button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

            // Quotes HTML
            const projectQuotes = selectedProject.quotes || [];
            const quotesHtml = projectQuotes.length === 0 ?
                '<div class="empty-state">No quotes linked to this project yet</div>' :
                projectQuotes.map(q => {
                    const fmt = v => '‚Çπ' + (v||0).toLocaleString('en-IN', { maximumFractionDigits: 0 });
                    const dateStr = q.date ? new Date(q.date).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }) : '-';
                    return `
                    <div class="list-item" style="flex-direction:column;align-items:stretch;gap:0.5rem;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:0.5rem;">
                            <div class="item-info" style="flex:1;">
                                <div class="item-title">üìã Quote #${q.quoteNo || '-'}</div>
                                <div class="item-detail">
                                    üìÖ ${dateStr}
                                    ${q.validDays ? ` | Valid: ${q.validDays} days` : ''}
                                    ${q.clientName ? ` | üë§ ${q.clientName}` : ''}
                                </div>
                                <div class="item-date" style="margin-top:0.25rem;">
                                    Items: ${(q.items||[]).length} | 
                                    Subtotal: ${fmt(q.subtotal)} | 
                                    GST: ${fmt(q.totalGST)} | 
                                    Discount: ${fmt(q.discount)}
                                </div>
                                <div style="font-size:0.9rem;font-weight:700;color:#0369a1;margin-top:0.25rem;">
                                    Grand Total: ${fmt(q.grandTotal)}
                                </div>
                                ${q.scopeOfWork ? `<div class="item-date" style="margin-top:0.25rem;">üìù ${q.scopeOfWork}</div>` : ''}
                                ${q.notes ? `<div class="item-date" style="background:#f9fafb;padding:0.25rem 0.5rem;border-radius:0.25rem;margin-top:0.25rem;">üí¨ ${q.notes}</div>` : ''}
                                ${(q.files||[]).length > 0 ? `<div style="margin-top:0.3rem;">${(q.files||[]).map(f=>`<a href="${f.shareLink||f.downloadUrl||f.data||'#'}" target="_blank" style="font-size:0.75rem;color:#0369a1;margin-right:0.5rem;display:inline-flex;align-items:center;gap:0.2rem;">üìé ${f.name}</a>`).join('')}</div>` : ''}
                            </div>
                            ${isAdmin() ? `<div style="display:flex;flex-direction:column;gap:0.35rem;flex-shrink:0;">
                                <button class="btn btn-secondary" onclick="editProjectQuote('${selectedProject.id}','${q.id}')" style="padding:0.25rem 0.6rem;font-size:0.75rem;">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteProjectQuote('${selectedProject.id}','${q.id}')" style="padding:0.25rem 0.6rem;font-size:0.75rem;">üóëÔ∏è Delete</button>
                            </div>` : ''}
                        </div>
                        ${(q.items||[]).length > 0 ? `
                        <div style="background:#f9fafb;border-radius:0.375rem;overflow:hidden;border:1px solid #e5e7eb;">
                            <div style="display:grid;grid-template-columns:2fr 60px 90px 90px 70px 90px 100px;gap:0;font-size:0.72rem;font-weight:600;color:#6b7280;background:#f3f4f6;padding:0.3rem 0.6rem;border-bottom:1px solid #e5e7eb;">
                                <span>Description</span><span>Qty</span><span>Unit</span><span>Rate</span><span>GST%</span><span>GST Amt</span><span>Total</span>
                            </div>
                            ${(q.items||[]).map(item => {
                                const base = (item.qty||0)*(item.rate||0);
                                const gst = base * (item.gstPct||0)/100;
                                const tot = base + gst;
                                return `<div style="display:grid;grid-template-columns:2fr 60px 90px 90px 70px 90px 100px;gap:0;font-size:0.78rem;padding:0.3rem 0.6rem;border-bottom:1px solid #f0f0f0;">
                                    <span>${item.description||'-'}</span>
                                    <span>${item.qty||0}</span>
                                    <span>${item.unit||''}</span>
                                    <span>‚Çπ${(item.rate||0).toLocaleString('en-IN')}</span>
                                    <span>${item.gstPct||0}%</span>
                                    <span>‚Çπ${gst.toLocaleString('en-IN',{maximumFractionDigits:0})}</span>
                                    <span style="font-weight:600;">‚Çπ${tot.toLocaleString('en-IN',{maximumFractionDigits:0})}</span>
                                </div>`;
                            }).join('')}
                        </div>` : ''}
                    </div>`;
                }).join('');

            document.getElementById('projectDetailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Project Header -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2>${selectedProject.name}</h2>
                                <span class="status-badge ${stageClass}">${stageLabel}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; gap: 1rem;">
                                ${selectedProject.customerName ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Customer</div>
                                        <div style="font-weight: 600;">üë§ ${selectedProject.customerName}</div>
                                    </div>
                                ` : ''}
                                
                                ${selectedProject.value ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Project Value</div>
                                        <div style="font-weight: 600; font-size: 1.25rem; color: #16a34a;">${formatCurrency(selectedProject.value)}</div>
                                    </div>
                                ` : ''}

                                <div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Update Stage</div>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button class="btn ${selectedProject.stage === 'won' ? 'btn-success' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'won')">Won</button>
                                        <button class="btn ${selectedProject.stage === 'ongoing' ? 'btn-primary' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'ongoing')">Ongoing</button>
                                        <button class="btn ${selectedProject.stage === 'handovered' ? 'btn-secondary' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'handovered')" style="background: #6366f1;">Handovered</button>
                                    </div>
                                </div>

                                ${selectedProject.startDate || selectedProject.endDate ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Timeline</div>
                                        <div>
                                            ${selectedProject.startDate ? `üìÖ Start: ${new Date(selectedProject.startDate).toLocaleDateString()}` : ''}
                                            ${selectedProject.startDate && selectedProject.endDate ? ' ‚Üí ' : ''}
                                            ${selectedProject.endDate ? `üèÅ End: ${new Date(selectedProject.endDate).toLocaleDateString()}` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                ${selectedProject.description ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Description</div>
                                        <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">${selectedProject.description}</div>
                                    </div>
                                ` : ''}

                                ${isAdmin() ? `
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button class="btn btn-primary" onclick="showEditProjectModal(selectedProject)" style="flex: 1">‚úèÔ∏è Edit Project</button>
                                        <button class="btn btn-danger" onclick="deleteProject('${selectedProject.id}')">üóëÔ∏è Delete</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Financial Summary -->
                    <div class="stats">
                        <div class="stat-card green">
                            <div class="stat-label" style="color: #16a34a">Total Paid</div>
                            <div class="stat-value" style="color: #15803d">${formatCurrency(totalPaid)}</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-label" style="color: #ea580c">Materials Cost</div>
                            <div class="stat-value" style="color: #c2410c">${formatCurrency(totalMaterials)}</div>
                        </div>
                        <div class="stat-card ${balanceColor}">
                            <div class="stat-label" style="color: ${balanceColor === 'blue' ? '#2563eb' : '#dc2626'}">${balanceLabel}</div>
                            <div class="stat-value" style="color: ${balanceColor === 'blue' ? '#1d4ed8' : '#b91c1c'}">${formatCurrency(Math.abs(balance))}</div>
                        </div>
                        <div class="stat-card ${collection >= 0 ? 'green' : 'red'}" style="position: relative;">
                            <div class="stat-label" style="color: ${collection >= 0 ? '#16a34a' : '#dc2626'}">Collection</div>
                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                <div class="stat-value" style="color: ${collection >= 0 ? '#15803d' : '#b91c1c'}; font-size: 1rem;">
                                    ${collection >= 0 ? '+' : ''}${formatCurrency(collection)}
                                </div>
                                ${isAdmin() ? `<button onclick="editProjectCollection()" title="Edit collection" style="background:none;border:none;cursor:pointer;font-size:0.75rem;padding:0.1rem 0.3rem;color:#6b7280;">‚úèÔ∏è</button>` : ''}
                            </div>
                            <div id="collectionEditBox" style="display:none; position:absolute; top:100%; left:0; right:0; z-index:100; background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; padding:0.5rem; box-shadow:0 4px 12px rgba(0,0,0,0.15); margin-top:0.25rem;">
                                <input type="number" id="collectionInput" value="${collection}" placeholder="e.g. 5000 or -2000"
                                    style="width:100%; padding:0.4rem; border:1px solid #d1d5db; border-radius:0.375rem; font-size:0.875rem; margin-bottom:0.4rem;">
                                <div style="display:flex; gap:0.25rem;">
                                    <button class="btn btn-primary" onclick="saveProjectCollection()" style="flex:1; padding:0.3rem; font-size:0.75rem;">Save</button>
                                    <button class="btn btn-secondary" onclick="document.getElementById('collectionEditBox').style.display='none'" style="flex:1; padding:0.3rem; font-size:0.75rem;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payments Section -->
                    <div class="card">
                        <div class="card-header">üí∞ Payments Received</div>
                        ${isAdmin() ? `
                            <div class="card-body">
                                <div class="form-grid">
                                    <input type="number" class="input" id="projectPaymentAmount" placeholder="Amount">
                                    <input type="text" class="input" id="projectPaymentNote" placeholder="Note (optional)">
                                    <input type="date" class="input" id="projectPaymentDate">
                                    <button class="btn btn-success" onclick="addProjectPayment()">Add Payment</button>
                                </div>
                            </div>
                        ` : ''}
                        <div>${paymentsHtml}</div>
                    </div>

                    <!-- Materials Section -->
                    <div class="card">
                        <div class="card-header">üì¶ Materials Procured</div>
                        ${isAdmin() ? `
                            <div class="card-body">
                                <!-- Supplier and Payment Info -->
                                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; display: block;">Supplier Name*</label>
                                        <input type="text" class="input" id="projectSupplierName" placeholder="Enter supplier name">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; display: block;">Procurement Date*</label>
                                        <input type="date" class="input" id="projectProcurementDate">
                                    </div>
                                </div>

                                <!-- Material Items -->
                                <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <label style="font-size: 0.875rem; font-weight: 600;">Material Items*</label>
                                        <button class="btn btn-secondary" onclick="addMaterialItemRow()" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">+ Add Item</button>
                                    </div>
                                    <div id="materialItemsContainer">
                                        <!-- Material items will be added here -->
                                    </div>
                                </div>

                                <!-- Supplier Payments -->
                                <div style="background: #f0fdf4; border: 1px solid #86efac; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <label style="font-size: 0.875rem; font-weight: 600; color: #166534;">üí∏ Payments to Supplier</label>
                                        <button class="btn btn-secondary" onclick="addSupplierPaymentRow()" style="padding: 0.25rem 0.75rem; font-size: 0.875rem; background: #10b981; color: white;">+ Add Payment</button>
                                    </div>
                                    <div id="supplierPaymentsContainer">
                                        <!-- Supplier payments will be added here -->
                                    </div>
                                    <div id="supplierPaymentSummary" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 2px solid #86efac; font-size: 0.875rem; font-weight: 600; text-align: right;">
                                        <!-- Summary will be shown here -->
                                    </div>
                                </div>

                                <!-- File Upload -->
                                <div class="file-upload" onclick="document.getElementById('projectFileInput').click()">
                                    <div>üìé Click to upload files to OneDrive</div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Invoices, receipts, photos ‚Ä¢ Any file type, any size</div>
                                </div>
                                <input type="file" id="projectFileInput" multiple style="display: none" onchange="handleProjectFiles(this.files)">
                                <div class="selected-files" id="projectSelectedFiles"></div>

                                <!-- Save Button -->
                                <button class="btn btn-primary" onclick="saveProjectMaterials()" style="width: 100%; margin-top: 1rem;">üíæ Save Materials Procurement</button>
                            </div>
                        ` : ''}
                        <div>${materialsHtml}</div>
                    </div>

                    <!-- Delivery Challan Section -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>üöö Delivery Challans</span>
                                ${isAdmin() && materials.length > 0 ? `
                                    <button class="btn btn-primary" onclick="showGenerateChallanModal()">+ Generate Challan</button>
                                ` : ''}
                            </div>
                        </div>
                        <div>${deliveryChallansHtml}</div>
                    </div>

                    <!-- Material Installed/Handover Section -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>‚úÖ Material Installed / Handover</span>
                                ${isAdmin() && deliveryChallans.length > 0 ? `
                                    <button class="btn btn-success" onclick="showInstallationModal()">+ Add Installation/Handover</button>
                                ` : ''}
                            </div>
                        </div>
                        <div>${installationsHtml}</div>
                    </div>

                    <!-- Quotes Section -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>üìã Quotes / Proposals</span>
                                ${isAdmin() ? `<button class="btn btn-primary" onclick="showProjectQuoteModal()">+ Add Quote</button>` : ''}
                            </div>
                        </div>
                        <div>${quotesHtml}</div>
                    </div>

                    <!-- Invoices Section -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>üßæ Tax Invoices</span>
                                ${isAdmin() ? `
                                    <button class="btn btn-primary" onclick="showGenerateInvoiceModal()">+ Generate Invoice</button>
                                ` : ''}
                            </div>
                        </div>
                        <div>${invoicesHtml}</div>
                    </div>
                </div>
            `;
        }

        // Initialize
        initializeFirebase();

        // ========================================
        // PROJECT PAYMENTS & MATERIALS
        // ========================================

        async function addProjectPayment() {
            if (!checkPermission('write')) return;
            
            const amount = parseFloat(document.getElementById('projectPaymentAmount').value);
            const note = document.getElementById('projectPaymentNote').value.trim();
            const date = document.getElementById('projectPaymentDate').value;

            if (!amount || amount <= 0) {
                alert('Please enter valid amount');
                return;
            }

            const payment = {
                id: Date.now().toString(),
                amount: amount,
                note: note,
                paymentDate: date || new Date().toISOString(),
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const payments = [...(selectedProject.payments || []), payment];
                    await db.collection('projects').doc(selectedProject.id).update({ payments });
                } else {
                    selectedProject.payments = [...(selectedProject.payments || []), payment];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                document.getElementById('projectPaymentAmount').value = '';
                document.getElementById('projectPaymentNote').value = '';
                document.getElementById('projectPaymentDate').value = '';
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Failed to add payment');
            }
        }

        async function deleteProjectPayment(id) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    const payments = (selectedProject.payments || []).filter(p => p.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ payments });
                } else {
                    selectedProject.payments = (selectedProject.payments || []).filter(p => p.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Failed to delete payment');
            }
        }

        function editProjectCollection() {
            const box = document.getElementById('collectionEditBox');
            if (box) {
                box.style.display = box.style.display === 'none' ? 'block' : 'none';
                const input = document.getElementById('collectionInput');
                if (input) input.focus();
            }
        }

        async function saveProjectCollection() {
            if (!checkPermission('write')) return;
            const input = document.getElementById('collectionInput');
            const val = parseFloat(input?.value) || 0;
            try {
                if (db) {
                    await db.collection('projects').doc(selectedProject.id).update({ collection: val });
                }
                selectedProject.collection = val;
                saveToLocalStorage();
                renderProjectDetails();
            } catch (error) {
                console.error('Error saving collection:', error);
                alert('Failed to save collection: ' + error.message);
            }
        }

        async function handleProjectFiles(files) {
            for (const file of Array.from(files)) {
                // Initialize OneDrive if not already done
                if (!msalInstance) {
                    initializeOneDrive();
                }
                
                // Check OneDrive connection
                if (!oneDriveAccessToken) {
                    const connected = await connectOneDrive();
                    if (!connected) {
                        alert('Please connect OneDrive to upload files');
                        return;
                    }
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };

                        // Show upload progress
                        document.getElementById('syncStatus').textContent = `Uploading ${file.name} to OneDrive...`;

                        // Upload to OneDrive (using 'materials' folder)
                        const folderPath = 'Business Manager Files/Materials';
                        const timestamp = Date.now();
                        const randomId = Math.random().toString(36).substr(2, 9);
                        const fileName = `material_${timestamp}_${randomId}_${file.name}`;
                        const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${folderPath}/${fileName}:/content`;
                        
                        // Convert base64 to blob
                        const base64Data = fileData.data.split(',')[1];
                        const byteCharacters = atob(base64Data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: file.type });

                        const response = await fetch(uploadUrl, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${oneDriveAccessToken}`,
                                'Content-Type': file.type
                            },
                            body: blob
                        });

                        if (!response.ok) {
                            throw new Error(`Upload failed: ${response.statusText}`);
                        }

                        const result = await response.json();

                        // Create sharing link
                        const shareUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${result.id}/createLink`;
                        const shareResponse = await fetch(shareUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${oneDriveAccessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                type: 'view',
                                scope: 'anonymous'
                            })
                        });

                        const shareResult = await shareResponse.json();

                        const oneDriveFile = {
                            id: result.id,
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            oneDriveId: result.id,
                            webUrl: result.webUrl,
                            downloadUrl: result['@microsoft.graph.downloadUrl'],
                            shareLink: shareResult.link.webUrl,
                            uploadedAt: new Date().toISOString()
                        };
                        
                        selectedFiles.push(oneDriveFile);
                        renderProjectSelectedFiles();

                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert(`Failed to upload ${file.name}: ${error.message}`);
                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function renderProjectSelectedFiles() {
            if (selectedFiles.length === 0) {
                document.getElementById('projectSelectedFiles').innerHTML = '';
                return;
            }

            const html = `
                <div style="margin-top: 0.75rem;">
                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Uploaded Files:</div>
                    ${selectedFiles.map(f => `
                        <div class="file-item">
                            <div class="file-icon">${f.type && f.type.startsWith('image/') ? 'üñºÔ∏è' : getFileIcon(f.type)}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.875rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(f.size)} ‚Ä¢ OneDrive</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFile('${f.id || f.oneDriveId}')">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('projectSelectedFiles').innerHTML = html;
        }

        // ========================================
        // MATERIALS PROCUREMENT - MULTI-ITEM
        // ========================================

        function addMaterialItemRow() {
            const itemId = Date.now().toString() + Math.random();
            const row = {
                id: itemId,
                name: '',
                unit: 'Nos',
                quantity: 1,
                rate: 0,
                gstPercent: 18
            };
            tempMaterialItems.push(row);
            renderMaterialItemsContainer();
        }

        function renderMaterialItemsContainer() {
            const container = document.getElementById('materialItemsContainer');
            if (!container) return;

            if (tempMaterialItems.length === 0) {
                addMaterialItemRow();
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 80px 80px 100px 70px 90px 100px auto; gap: 0.4rem; margin-bottom: 0.25rem; align-items: center;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: #374151;">Item Name*</div>
                    <div style="font-size: 0.75rem; font-weight: 600; color: #374151;">Unit</div>
                    <div style="font-size: 0.75rem; font-weight: 600; color: #374151;">Qty*</div>
                    <div style="font-size: 0.75rem; font-weight: 600; color: #374151;">Rate (ex-GST)*</div>
                    <div style="font-size: 0.75rem; font-weight: 600; color: #374151;">GST %</div>
                    <div style="font-size: 0.75rem; font-weight: 600; color: #374151;">GST Amt</div>
                    <div style="font-size: 0.75rem; font-weight: 600; color: #374151;">Total</div>
                    <div></div>
                </div>
                ${tempMaterialItems.map((item) => {
                    const qty = parseFloat(item.quantity) || 0;
                    const rate = parseFloat(item.rate) || 0;
                    const cost = qty * rate;
                    const gstAmt = (cost * (parseFloat(item.gstPercent) || 0) / 100);
                    const total = cost + gstAmt;
                    return `
                    <div style="display: grid; grid-template-columns: 2fr 80px 80px 100px 70px 90px 100px auto; gap: 0.4rem; margin-bottom: 0.5rem; align-items: center;">
                        <input type="text" class="input" placeholder="Material name*" value="${item.name}" 
                               onchange="updateMaterialItem('${item.id}', 'name', this.value)" style="margin: 0;">
                        <select class="input" onchange="updateMaterialItem('${item.id}', 'unit', this.value)" style="margin: 0; padding: 0.4rem;">
                            <option value="Nos" ${item.unit === 'Nos' ? 'selected' : ''}>Nos</option>
                            <option value="Mtrs" ${item.unit === 'Mtrs' ? 'selected' : ''}>Mtrs</option>
                            <option value="Sqft" ${item.unit === 'Sqft' ? 'selected' : ''}>Sqft</option>
                            <option value="Kg" ${item.unit === 'Kg' ? 'selected' : ''}>Kg</option>
                            <option value="Ltr" ${item.unit === 'Ltr' ? 'selected' : ''}>Ltr</option>
                            <option value="Set" ${item.unit === 'Set' ? 'selected' : ''}>Set</option>
                            <option value="Pair" ${item.unit === 'Pair' ? 'selected' : ''}>Pair</option>
                            <option value="Box" ${item.unit === 'Box' ? 'selected' : ''}>Box</option>
                        </select>
                        <input type="number" class="input" placeholder="Qty*" value="${item.quantity || ''}" min="0" step="0.01"
                               onchange="updateMaterialItem('${item.id}', 'quantity', this.value)" style="margin: 0;">
                        <input type="number" class="input" placeholder="Rate*" value="${item.rate || ''}" min="0" step="0.01"
                               onchange="updateMaterialItem('${item.id}', 'rate', this.value)" style="margin: 0;">
                        <select class="input" onchange="updateMaterialItem('${item.id}', 'gstPercent', this.value)" style="margin: 0; padding: 0.4rem;">
                            <option value="0" ${item.gstPercent == 0 ? 'selected' : ''}>0%</option>
                            <option value="5" ${item.gstPercent == 5 ? 'selected' : ''}>5%</option>
                            <option value="12" ${item.gstPercent == 12 ? 'selected' : ''}>12%</option>
                            <option value="18" ${item.gstPercent == 18 ? 'selected' : ''}>18%</option>
                            <option value="28" ${item.gstPercent == 28 ? 'selected' : ''}>28%</option>
                        </select>
                        <input type="number" class="input" value="‚Çπ${gstAmt.toFixed(2)}" readonly
                               style="margin: 0; background: #f3f4f6; color: #374151; font-size: 0.85rem;">
                        <input type="number" class="input" value="‚Çπ${total.toFixed(2)}" readonly
                               style="margin: 0; background: #eff6ff; color: #1e40af; font-weight: 600; font-size: 0.85rem;">
                        <button class="btn btn-danger" onclick="removeMaterialItem('${item.id}')" style="padding: 0.5rem; margin: 0;">√ó</button>
                    </div>`;
                }).join('')}
                <div style="text-align: right; font-size: 0.875rem; font-weight: 600; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 2px solid #e5e7eb; display: grid; grid-template-columns: 2fr 80px 80px 100px 70px 90px 100px auto; gap: 0.4rem;">
                    <span></span><span></span><span></span>
                    <span style="color: #6b7280;">Totals:</span>
                    <span></span>
                    <span style="color: #0284c7;">‚Çπ${tempMaterialItems.reduce((sum, item) => {
                        const cost = (parseFloat(item.quantity) || 0) * (parseFloat(item.rate) || 0);
                        return sum + (cost * (parseFloat(item.gstPercent) || 0) / 100);
                    }, 0).toFixed(2)}</span>
                    <span style="color: #059669; font-size: 1rem;">‚Çπ${tempMaterialItems.reduce((sum, item) => {
                        const cost = (parseFloat(item.quantity) || 0) * (parseFloat(item.rate) || 0);
                        const gst = cost * (parseFloat(item.gstPercent) || 0) / 100;
                        return sum + cost + gst;
                    }, 0).toFixed(2)}</span>
                    <span></span>
                </div>
            `;
        }

        function updateMaterialItem(id, field, value) {
            const item = tempMaterialItems.find(i => i.id === id);
            if (item) {
                if (field === 'rate' || field === 'gstPercent' || field === 'quantity') {
                    item[field] = parseFloat(value) || 0;
                } else {
                    item[field] = value;
                }
                renderMaterialItemsContainer();
            }
        }

        function removeMaterialItem(id) {
            tempMaterialItems = tempMaterialItems.filter(i => i.id !== id);
            if (tempMaterialItems.length === 0) {
                addMaterialItemRow();
            } else {
                renderMaterialItemsContainer();
            }
        }

        let tempSupplierPayments = [];

        function addSupplierPaymentRow() {
            const paymentId = Date.now().toString() + Math.random();
            const payment = {
                id: paymentId,
                amount: 0,
                date: new Date().toISOString().split('T')[0],
                note: ''
            };
            tempSupplierPayments.push(payment);
            renderSupplierPaymentsContainer();
        }

        function renderSupplierPaymentsContainer() {
            const container = document.getElementById('supplierPaymentsContainer');
            if (!container) return;

            if (tempSupplierPayments.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 0.5rem; font-size: 0.875rem;">No payments yet. Click "+ Add Payment" to record a payment.</div>';
                renderSupplierPaymentSummary();
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: 120px 2fr 120px auto; gap: 0.4rem; margin-bottom: 0.25rem; align-items: center;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: #166534;">Date</div>
                    <div style="font-size: 0.75rem; font-weight: 600; color: #166534;">Note</div>
                    <div style="font-size: 0.75rem; font-weight: 600; color: #166534;">Amount (‚Çπ)*</div>
                    <div></div>
                </div>
                ${tempSupplierPayments.map(payment => `
                    <div style="display: grid; grid-template-columns: 120px 2fr 120px auto; gap: 0.4rem; margin-bottom: 0.5rem; align-items: center;">
                        <input type="date" class="input" value="${payment.date}" 
                               onchange="updateSupplierPayment('${payment.id}', 'date', this.value)" style="margin: 0;">
                        <input type="text" class="input" placeholder="Payment note (optional)" value="${payment.note}" 
                               onchange="updateSupplierPayment('${payment.id}', 'note', this.value)" style="margin: 0;">
                        <input type="number" class="input" placeholder="Amount" value="${payment.amount || ''}" min="0" step="0.01"
                               onchange="updateSupplierPayment('${payment.id}', 'amount', this.value)" style="margin: 0;">
                        <button class="btn btn-danger" onclick="removeSupplierPayment('${payment.id}')" style="padding: 0.5rem; margin: 0;">√ó</button>
                    </div>
                `).join('')}
            `;
            renderSupplierPaymentSummary();
        }

        function updateSupplierPayment(id, field, value) {
            const payment = tempSupplierPayments.find(p => p.id === id);
            if (payment) {
                if (field === 'amount') {
                    payment[field] = parseFloat(value) || 0;
                } else {
                    payment[field] = value;
                }
                renderSupplierPaymentSummary();
            }
        }

        function removeSupplierPayment(id) {
            tempSupplierPayments = tempSupplierPayments.filter(p => p.id !== id);
            renderSupplierPaymentsContainer();
        }

        function renderSupplierPaymentSummary() {
            const summaryDiv = document.getElementById('supplierPaymentSummary');
            if (!summaryDiv) return;

            const totalBase = tempMaterialItems.reduce((sum, item) => {
                return sum + ((parseFloat(item.quantity) || 0) * (parseFloat(item.rate) || 0));
            }, 0);
            
            const totalGST = tempMaterialItems.reduce((sum, item) => {
                const cost = (parseFloat(item.quantity) || 0) * (parseFloat(item.rate) || 0);
                return sum + (cost * (parseFloat(item.gstPercent) || 0) / 100);
            }, 0);

            const grandTotal = totalBase + totalGST;
            const totalPaid = tempSupplierPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const balanceDue = grandTotal - totalPaid;

            summaryDiv.innerHTML = `
                <div style="color: #374151;">Order Total: <span style="font-weight: 700;">‚Çπ${grandTotal.toFixed(2)}</span></div>
                <div style="color: #10b981; margin-top: 0.25rem;">Paid: <span style="font-weight: 700;">‚Çπ${totalPaid.toFixed(2)}</span></div>
                ${balanceDue > 0 ? `
                    <div style="color: #ef4444; margin-top: 0.25rem;">üî¥ Balance Due to Supplier: <span style="font-weight: 700;">‚Çπ${balanceDue.toFixed(2)}</span></div>
                ` : `
                    <div style="color: #10b981; margin-top: 0.25rem;">‚úÖ Fully Paid</div>
                `}
            `;
        }

        async function saveProjectMaterials() {
            if (!checkPermission('write')) return;
            
            const supplierName = document.getElementById('projectSupplierName').value.trim();
            const procurementDate = document.getElementById('projectProcurementDate').value;

            if (!supplierName) {
                alert('Please enter supplier name');
                return;
            }

            if (!procurementDate) {
                alert('Please enter procurement date');
                return;
            }

            // Validate material items
            const validItems = tempMaterialItems.filter(item => item.name && item.rate > 0 && item.quantity > 0);
            if (validItems.length === 0) {
                alert('Please add at least one material item with name, quantity, and rate');
                return;
            }

            // Calculate totals
            const totalBase = validItems.reduce((sum, item) => {
                return sum + ((parseFloat(item.quantity) || 0) * (parseFloat(item.rate) || 0));
            }, 0);

            const totalGST = validItems.reduce((sum, item) => {
                const cost = (parseFloat(item.quantity) || 0) * (parseFloat(item.rate) || 0);
                return sum + (cost * (parseFloat(item.gstPercent) || 0) / 100);
            }, 0);

            const grandTotal = totalBase + totalGST;
            const totalPaid = tempSupplierPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const balanceDue = grandTotal - totalPaid;

            // Create/update procurement record
            const procurement = {
                id: editingMaterialId || Date.now().toString(),
                supplierName: supplierName,
                procurementDate: procurementDate,
                items: validItems.map(item => {
                    const qty = parseFloat(item.quantity) || 0;
                    const rate = parseFloat(item.rate) || 0;
                    const cost = qty * rate;
                    const gstAmt = cost * (parseFloat(item.gstPercent) || 0) / 100;
                    return {
                        name: item.name,
                        unit: item.unit || 'Nos',
                        quantity: qty,
                        rate: rate,
                        cost: cost,
                        gstPercent: parseFloat(item.gstPercent) || 0,
                        gstAmount: gstAmt,
                        total: cost + gstAmt
                    };
                }),
                totalCost: totalBase,
                totalGST: totalGST,
                grandTotal: grandTotal,
                supplierPayments: tempSupplierPayments.map(p => ({
                    id: p.id,
                    amount: parseFloat(p.amount) || 0,
                    date: p.date,
                    note: p.note || ''
                })),
                paymentAmount: totalPaid,  // kept for backward compatibility
                balanceDueToSupplier: balanceDue,
                files: [...selectedFiles],
                createdAt: editingMaterialId ? (selectedProject.materials.find(m => m.id === editingMaterialId)?.createdAt) : new Date().toISOString(),
                createdBy: currentUser?.uid
            };

            try {
                if (db) {
                    let materials;
                    if (editingMaterialId) {
                        // Update existing
                        materials = selectedProject.materials.map(m => m.id === editingMaterialId ? procurement : m);
                    } else {
                        // Add new
                        materials = [...(selectedProject.materials || []), procurement];
                    }
                    await db.collection('projects').doc(selectedProject.id).update({ materials });
                } else {
                    if (editingMaterialId) {
                        selectedProject.materials = selectedProject.materials.map(m => m.id === editingMaterialId ? procurement : m);
                    } else {
                        selectedProject.materials = [...(selectedProject.materials || []), procurement];
                    }
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                // Clear form
                document.getElementById('projectSupplierName').value = '';
                document.getElementById('projectProcurementDate').value = '';
                tempMaterialItems = [];
                tempSupplierPayments = [];
                selectedFiles = [];
                editingMaterialId = null;
                renderMaterialItemsContainer();
                renderSupplierPaymentsContainer();
                document.getElementById('projectSelectedFiles').innerHTML = '';
                
                // Update button text back
                const saveBtn = document.querySelector('#projectDetailsPanel button[onclick="saveProjectMaterials()"]');
                if (saveBtn) saveBtn.textContent = 'üíæ Save Materials Procurement';
                
                alert(editingMaterialId ? '‚úÖ Materials updated successfully!' : '‚úÖ Materials procurement saved successfully!');
            } catch (error) {
                console.error('Error saving materials:', error);
                alert('Failed to save materials');
            }
        }

        function editProjectMaterial(id) {
            if (!checkPermission('write')) return;
            
            const material = selectedProject.materials.find(m => m.id === id);
            if (!material) return;
            
            editingMaterialId = id;
            
            // Fill form with existing data
            document.getElementById('projectSupplierName').value = material.supplierName || '';
            document.getElementById('projectProcurementDate').value = material.procurementDate || material.date || '';
            
            // Load items - handle both new (rate/qty/unit) and old (cost) formats
            if (material.items && material.items.length > 0) {
                tempMaterialItems = material.items.map(item => ({
                    id: Date.now().toString() + Math.random(),
                    name: item.name,
                    unit: item.unit || 'Nos',
                    quantity: parseFloat(item.quantity) || 1,
                    rate: parseFloat(item.rate) || parseFloat(item.cost) || 0,  // backward compat
                    gstPercent: parseFloat(item.gstPercent) || 0
                }));
            } else if (material.name) {
                // Old format - single item
                tempMaterialItems = [{
                    id: Date.now().toString(),
                    name: material.name,
                    unit: 'Nos',
                    quantity: 1,
                    rate: parseFloat(material.cost) || 0,
                    gstPercent: 0
                }];
            }

            // Load supplier payments - handle both new (array) and old (single) formats
            if (material.supplierPayments && material.supplierPayments.length > 0) {
                tempSupplierPayments = material.supplierPayments.map(p => ({
                    id: p.id || Date.now().toString() + Math.random(),
                    amount: parseFloat(p.amount) || 0,
                    date: p.date || new Date().toISOString().split('T')[0],
                    note: p.note || ''
                }));
            } else if (material.paymentAmount && material.paymentAmount > 0) {
                // Old format - single payment
                tempSupplierPayments = [{
                    id: Date.now().toString(),
                    amount: parseFloat(material.paymentAmount) || 0,
                    date: material.paymentDate || new Date().toISOString().split('T')[0],
                    note: 'Payment'
                }];
            } else {
                tempSupplierPayments = [];
            }
            
            // Load files
            selectedFiles = material.files || [];
            
            // Update UI
            renderMaterialItemsContainer();
            renderSupplierPaymentsContainer();
            renderProjectSelectedFiles();
            
            // Update button text
            const saveBtn = document.querySelector('#projectDetailsPanel button[onclick="saveProjectMaterials()"]');
            if (saveBtn) saveBtn.textContent = 'üíæ Update Materials Procurement';
            
            // Scroll to form
            document.querySelector('.card-header:has(+ .card-body)').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function deleteProjectMaterial(id) {
            if (!checkPermission('write')) return;
            
            if (!confirm('Delete this procurement record? This cannot be undone.')) return;
            
            try {
                const materials = (selectedProject.materials || []).filter(m => m.id !== id);
                
                if (db) {
                    await db.collection('projects').doc(selectedProject.id).update({ materials });
                }
                
                // Update local state and refresh
                selectedProject.materials = materials;
                saveToLocalStorage();
                renderProjectDetails();
                
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material: ' + error.message);
            }
        }

        async function deleteProjectMaterialFile(materialId, fileIdOrName) {
            if (!checkPermission('write')) return;
            if (!confirm('Delete this file? This cannot be undone.')) return;

            try {
                const materials = (selectedProject.materials || []).map(m => {
                    if (m.id !== materialId) return m;
                    // Remove the file by id or name
                    const files = (m.files || []).filter(f => 
                        (f.id || f.name) !== fileIdOrName
                    );
                    return { ...m, files };
                });

                if (db) {
                    await db.collection('projects').doc(selectedProject.id).update({ materials });
                }

                selectedProject.materials = materials;
                saveToLocalStorage();
                renderProjectDetails();

            } catch (error) {
                console.error('Error deleting file:', error);
                alert('Failed to delete file: ' + error.message);
            }
        }

        // ========================================
        // DELIVERY CHALLAN FUNCTIONS
        // ========================================

        function showGenerateChallanModal() {
            if (!checkPermission('write')) return;
            
            const materials = selectedProject.materials || [];
            if (materials.length === 0) {
                alert('No materials available to create delivery challan');
                return;
            }

            // Populate material checkboxes - handle both old and new formats
            const checkboxContainer = document.getElementById('materialCheckboxes');
            
            // Flatten all items from all materials
            const allItems = [];
            materials.forEach(m => {
                if (m.items && m.items.length > 0) {
                    // New format - multiple items
                    m.items.forEach((item, index) => {
                        allItems.push({
                            id: `${m.id}_${index}`,
                            name: item.name,
                            quantity: item.quantity || '',
                            supplierId: m.id,
                            supplier: m.supplierName || 'Supplier'
                        });
                    });
                } else if (m.name) {
                    // Old format - single item
                    allItems.push({
                        id: m.id,
                        name: m.name,
                        quantity: m.quantity || '',
                        supplierId: m.id,
                        supplier: m.supplierName || 'Supplier'
                    });
                }
            });

            if (allItems.length === 0) {
                alert('No material items available to create delivery challan');
                return;
            }

            checkboxContainer.innerHTML = allItems.map(item => `
                <div style="padding: 0.5rem; border-bottom: 1px solid #f3f4f6;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${item.id}" data-name="${item.name}" data-quantity="${item.quantity}" style="margin-right: 0.5rem;">
                        <span>${item.name}${item.quantity ? ` (${item.quantity})` : ''}</span>
                        <span style="font-size: 0.75rem; color: #6b7280; margin-left: auto;">from ${item.supplier}</span>
                    </label>
                </div>
            `).join('');

            // Set default challan number
            const challanCount = (selectedProject.deliveryChallans || []).length + 1;
            document.getElementById('challanNumber').value = `DC-${String(challanCount).padStart(3, '0')}`;
            
            // Set today's date
            document.getElementById('challanDeliveryDate').value = new Date().toISOString().split('T')[0];

            document.getElementById('challanModal').classList.add('show');
        }

        let editingChallanId = null;

        async function saveDeliveryChallan() {
            if (!checkPermission('write')) return;

            const challanNumber = document.getElementById('challanNumber').value.trim();
            const deliveryDate = document.getElementById('challanDeliveryDate').value;
            const vehicleNumber = document.getElementById('challanVehicle').value.trim();
            const receivedBy = document.getElementById('challanReceivedBy').value.trim();
            const remarks = document.getElementById('challanRemarks').value.trim();

            if (!challanNumber) { alert('Please enter challan number'); return; }
            if (!deliveryDate) { alert('Please select delivery date'); return; }

            const checkboxes = document.querySelectorAll('#materialCheckboxes input[type="checkbox"]:checked');
            if (checkboxes.length === 0) { alert('Please select at least one material'); return; }

            const selectedItems = Array.from(checkboxes).map(cb => ({
                id: cb.value,
                name: cb.dataset.name,
                quantity: cb.dataset.quantity
            }));

            // Preserve existing signed copy when editing
            const existingChallan = editingChallanId
                ? (selectedProject.deliveryChallans || []).find(dc => dc.id === editingChallanId)
                : null;

            const challan = {
                id: editingChallanId || Date.now().toString(),
                challanNumber,
                deliveryDate,
                vehicleNumber,
                receivedBy,
                remarks,
                items: selectedItems,
                signedCopy: existingChallan?.signedCopy || null,
                createdAt: existingChallan?.createdAt || new Date().toISOString(),
                createdBy: existingChallan?.createdBy || currentUser?.uid
            };

            try {
                let deliveryChallans;
                if (editingChallanId) {
                    deliveryChallans = (selectedProject.deliveryChallans || []).map(dc => dc.id === editingChallanId ? challan : dc);
                } else {
                    deliveryChallans = [...(selectedProject.deliveryChallans || []), challan];
                }
                if (db) {
                    await db.collection('projects').doc(selectedProject.id).update({ deliveryChallans });
                }
                selectedProject.deliveryChallans = deliveryChallans;
                saveToLocalStorage();
                renderProjectDetails();
                closeModal('challanModal');
                editingChallanId = null;
                document.getElementById('challanModalTitle').textContent = 'Generate Delivery Challan';
                alert(editingChallanId ? '‚úÖ Challan updated!' : '‚úÖ Delivery Challan generated successfully!');
            } catch (error) {
                console.error('Error saving challan:', error);
                alert('Failed to save delivery challan');
            }
        }

        function editDeliveryChallan(id) {
            if (!checkPermission('write')) return;
            const challan = (selectedProject.deliveryChallans || []).find(dc => dc.id === id);
            if (!challan) return;

            editingChallanId = id;

            // Re-use the generate challan modal but pre-fill it
            showGenerateChallanModal();

            // After modal opens, populate fields
            setTimeout(() => {
                document.getElementById('challanModalTitle').textContent = 'Edit Delivery Challan';
                document.getElementById('challanNumber').value = challan.challanNumber || '';
                document.getElementById('challanDeliveryDate').value = challan.deliveryDate || '';
                document.getElementById('challanVehicle').value = challan.vehicleNumber || '';
                document.getElementById('challanReceivedBy').value = challan.receivedBy || '';
                document.getElementById('challanRemarks').value = challan.remarks || '';

                // Check the boxes that were previously selected
                const challanItemIds = (challan.items || []).map(i => i.id);
                document.querySelectorAll('#materialCheckboxes input[type="checkbox"]').forEach(cb => {
                    cb.checked = challanItemIds.includes(cb.value);
                });
            }, 50);
        }

        async function uploadSignedCopy(challanId, input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const btn = input.parentElement;
            btn.textContent = '‚è≥ Uploading...';

            try {
                let fileData = { name: file.name, size: file.size, type: file.type };

                // Try OneDrive first
                if (await acquireOneDriveToken()) {
                    try {
                        const result = await uploadToOneDrive(file, 'Challans');
                        fileData.downloadUrl = result.webUrl || result['@microsoft.graph.downloadUrl'];
                        fileData.oneDriveId = result.id;
                    } catch (e) {
                        // Fall back to base64
                        fileData.data = await fileToBase64(file);
                    }
                } else {
                    fileData.data = await fileToBase64(file);
                }

                // Save signed copy to challan
                const deliveryChallans = (selectedProject.deliveryChallans || []).map(dc =>
                    dc.id === challanId ? { ...dc, signedCopy: fileData } : dc
                );
                if (db) {
                    await db.collection('projects').doc(selectedProject.id).update({ deliveryChallans });
                }
                selectedProject.deliveryChallans = deliveryChallans;
                saveToLocalStorage();
                renderProjectDetails();
            } catch (error) {
                console.error('Error uploading signed copy:', error);
                alert('Failed to upload signed copy: ' + error.message);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function removeSignedCopy(challanId) {
            if (!confirm('Remove the signed copy from this challan?')) return;
            const deliveryChallans = (selectedProject.deliveryChallans || []).map(dc =>
                dc.id === challanId ? { ...dc, signedCopy: null } : dc
            );
            if (db) {
                await db.collection('projects').doc(selectedProject.id).update({ deliveryChallans });
            }
            selectedProject.deliveryChallans = deliveryChallans;
            saveToLocalStorage();
            renderProjectDetails();
        }

        async function deleteDeliveryChallan(id) {
            if (!checkPermission('write')) return;
            if (!confirm('Delete this delivery challan?')) return;
            try {
                const deliveryChallans = (selectedProject.deliveryChallans || []).filter(dc => dc.id !== id);
                if (db) {
                    await db.collection('projects').doc(selectedProject.id).update({ deliveryChallans });
                }
                selectedProject.deliveryChallans = deliveryChallans;
                saveToLocalStorage();
                renderProjectDetails();
            } catch (error) {
                console.error('Error deleting challan:', error);
                alert('Failed to delete delivery challan');
            }
        }

        function downloadChallan(id) {
            const challan = (selectedProject.deliveryChallans || []).find(dc => dc.id === id);
            if (!challan) return;

            // Create challan HTML for PDF
            const challanHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Delivery Challan ${challan.challanNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #333; padding-bottom: 20px; }
                        .company-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
                        .challan-title { font-size: 20px; color: #666; }
                        .info-section { margin: 20px 0; }
                        .info-row { display: flex; margin: 10px 0; }
                        .label { font-weight: bold; width: 150px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f3f4f6; font-weight: bold; }
                        .footer { margin-top: 50px; border-top: 2px solid #333; padding-top: 20px; }
                        .signature { margin-top: 60px; }
                        .signature-line { border-top: 1px solid #333; width: 200px; display: inline-block; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">AURA SMART</div>
                        <div class="challan-title">DELIVERY CHALLAN</div>
                    </div>

                    <div class="info-section">
                        <div class="info-row">
                            <div class="label">Challan No:</div>
                            <div>${challan.challanNumber}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Date:</div>
                            <div>${new Date(challan.deliveryDate).toLocaleDateString()}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Project:</div>
                            <div>${selectedProject.name}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Customer:</div>
                            <div>${selectedProject.customerName || '-'}</div>
                        </div>
                        ${challan.vehicleNumber ? `
                        <div class="info-row">
                            <div class="label">Vehicle No:</div>
                            <div>${challan.vehicleNumber}</div>
                        </div>
                        ` : ''}
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">Sr. No.</th>
                                <th>Item Description</th>
                                <th style="width: 150px;">Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${challan.items.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.name}</td>
                                    <td>${item.quantity || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    ${challan.remarks ? `
                    <div class="info-section">
                        <div class="label">Remarks:</div>
                        <div>${challan.remarks}</div>
                    </div>
                    ` : ''}

                    <div class="footer">
                        <div class="signature">
                            <div>Delivered By</div>
                            <div class="signature-line"></div>
                        </div>
                        <div class="signature" style="float: right;">
                            <div>Received By${challan.receivedBy ? `: ${challan.receivedBy}` : ''}</div>
                            <div class="signature-line"></div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            // Create a new window and print
            const printWindow = window.open('', '_blank');
            printWindow.document.write(challanHTML);
            printWindow.document.close();
            printWindow.print();
        }

        // ========================================
        // MATERIAL INSTALLATION/HANDOVER FUNCTIONS
        // ========================================

        function showInstallationModal() {
            if (!checkPermission('write')) return;

            const deliveryChallans = selectedProject.deliveryChallans || [];
            if (deliveryChallans.length === 0) {
                alert('No delivered items available. Please create a delivery challan first.');
                return;
            }

            // Populate item dropdown from delivery challans
            const itemSelect = document.getElementById('installationItemSelect');
            const allItems = [];
            deliveryChallans.forEach(dc => {
                dc.items.forEach(item => {
                    allItems.push({
                        name: item.name,
                        quantity: item.quantity,
                        challanId: dc.id
                    });
                });
            });

            itemSelect.innerHTML = '<option value="">-- Select Item --</option>' +
                allItems.map((item, index) => 
                    `<option value="${index}" data-name="${item.name}" data-quantity="${item.quantity}">${item.name}${item.quantity ? ` (${item.quantity})` : ''}</option>`
                ).join('');

            // Auto-fill item name when selected
            itemSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('installationItemName').value = selectedOption.dataset.name;
                    document.getElementById('installationQuantity').value = selectedOption.dataset.quantity || '';
                }
            });

            // Set today's date for installation
            document.getElementById('installationDate').value = new Date().toISOString().split('T')[0];

            document.getElementById('installationModal').classList.add('show');
        }

        async function saveInstallation() {
            if (!checkPermission('write')) return;

            const itemName = document.getElementById('installationItemName').value.trim();
            const quantity = document.getElementById('installationQuantity').value.trim();
            const status = document.getElementById('installationStatus').value;
            const installationDate = document.getElementById('installationDate').value;
            const installedBy = document.getElementById('installedBy').value.trim();
            const handoverDate = document.getElementById('handoverDate').value;
            const handedOverTo = document.getElementById('handedOverTo').value.trim();
            const location = document.getElementById('installationLocation').value.trim();
            const remarks = document.getElementById('installationRemarks').value.trim();

            if (!itemName) {
                alert('Please enter item name');
                return;
            }

            const installation = {
                id: Date.now().toString(),
                itemName: itemName,
                quantity: quantity,
                status: status,
                installationDate: installationDate || null,
                installedBy: installedBy,
                handoverDate: handoverDate || null,
                handedOverTo: handedOverTo,
                location: location,
                remarks: remarks,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.uid
            };

            try {
                if (db) {
                    const installations = [...(selectedProject.installations || []), installation];
                    await db.collection('projects').doc(selectedProject.id).update({ installations });
                } else {
                    selectedProject.installations = [...(selectedProject.installations || []), installation];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                closeModal('installationModal');
                
                // Clear form
                document.getElementById('installationItemSelect').value = '';
                document.getElementById('installationItemName').value = '';
                document.getElementById('installationQuantity').value = '';
                document.getElementById('installationStatus').value = 'pending';
                document.getElementById('installationDate').value = '';
                document.getElementById('installedBy').value = '';
                document.getElementById('handoverDate').value = '';
                document.getElementById('handedOverTo').value = '';
                document.getElementById('installationLocation').value = '';
                document.getElementById('installationRemarks').value = '';

                alert('‚úÖ Installation/Handover record added successfully!');
            } catch (error) {
                console.error('Error saving installation:', error);
                alert('Failed to save installation record');
            }
        }

        async function updateInstallationStatus(id) {
            if (!checkPermission('write')) return;

            const installation = (selectedProject.installations || []).find(inst => inst.id === id);
            if (!installation) return;

            const statuses = ['pending', 'installed', 'handed_over'];
            const currentIndex = statuses.indexOf(installation.status);
            const nextStatus = statuses[(currentIndex + 1) % statuses.length];

            try {
                if (db) {
                    const installations = (selectedProject.installations || []).map(inst => {
                        if (inst.id === id) {
                            const updated = {...inst, status: nextStatus};
                            // Auto-set dates based on status
                            if (nextStatus === 'installed' && !updated.installationDate) {
                                updated.installationDate = new Date().toISOString().split('T')[0];
                            }
                            if (nextStatus === 'handed_over' && !updated.handoverDate) {
                                updated.handoverDate = new Date().toISOString().split('T')[0];
                            }
                            return updated;
                        }
                        return inst;
                    });
                    await db.collection('projects').doc(selectedProject.id).update({ installations });
                } else {
                    selectedProject.installations = (selectedProject.installations || []).map(inst => {
                        if (inst.id === id) {
                            const updated = {...inst, status: nextStatus};
                            if (nextStatus === 'installed' && !updated.installationDate) {
                                updated.installationDate = new Date().toISOString().split('T')[0];
                            }
                            if (nextStatus === 'handed_over' && !updated.handoverDate) {
                                updated.handoverDate = new Date().toISOString().split('T')[0];
                            }
                            return updated;
                        }
                        return inst;
                    });
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error updating installation status:', error);
                alert('Failed to update status');
            }
        }

        async function deleteInstallation(id) {
            if (!checkPermission('write')) return;

            if (!confirm('Delete this installation/handover record?')) return;

            try {
                if (db) {
                    const installations = (selectedProject.installations || []).filter(inst => inst.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ installations });
                } else {
                    selectedProject.installations = (selectedProject.installations || []).filter(inst => inst.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting installation:', error);
                alert('Failed to delete installation record');
            }
        }

        // ========================================
        // INVOICE MANAGEMENT
        // ========================================

        let tempInvoiceItems = [];
        let editingInvoiceId = null;

        function showGenerateInvoiceModal() {
            if (!checkPermission('write')) return;

            editingInvoiceId = null;
            document.getElementById('invoiceModalTitle').textContent = 'Generate Tax Invoice';
            document.getElementById('saveInvoiceBtn').textContent = 'Generate Invoice';

            // Set invoice number
            const invoiceCount = (selectedProject.invoices || []).length + 1;
            document.getElementById('invoiceNumber').value = `INV-${String(invoiceCount).padStart(4, '0')}`;
            
            // Set today's date
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            // Pre-fill company details (Latigid Engineering - editable)
            document.getElementById('companyName').value = 'Aura Smart (Latigid Engineering Pvt Ltd)';
            document.getElementById('companyGSTIN').value = '29AADCL3532A1ZX';
            document.getElementById('companyState').value = 'Karnataka';
            document.getElementById('companyStateCode').value = '29';
            document.getElementById('companyAddress').value = 'First Floor Building No./Flat No.: 151 Name Of Premises/Building: Swasti Road/Street: 1st Main Road Nearby Landmark: opposite Someshwara Temple, Locality/Sub Locality: Koramangala 7th Block, Bengaluru Karnataka 560095, India';

            // Pre-fill customer details from project
            document.getElementById('customerName').value = selectedProject.customerName || '';
            document.getElementById('customerGSTIN').value = selectedCustomer?.gstin || '';
            document.getElementById('customerState').value = selectedCustomer?.state || '';
            document.getElementById('customerStateCode').value = selectedCustomer?.stateCode || '';
            document.getElementById('customerAddress').value = selectedCustomer?.address || '';

            // Clear items and discounts
            tempInvoiceItems = [];
            document.getElementById('invoiceDiscount').value = 0;

            renderInvoiceItemsContainer();
            calculateInvoiceTotal();

            document.getElementById('invoiceModal').classList.add('show');
        }

        function showLoadFromChallanModal() {
            const challans = selectedProject.deliveryChallans || [];
            if (!selectedProject || challans.length === 0) {
                alert('No delivery challans found for this project. Please create a delivery challan first.');
                return;
            }

            const challanList = challans.map(challan => {
                const challanDate = challan.deliveryDate ? new Date(challan.deliveryDate).toLocaleDateString() : new Date(challan.createdAt).toLocaleDateString();
                const itemCount = (challan.items || []).length;

                return `
                    <div class="list-item" style="margin-bottom: 0.5rem;">
                        <div class="item-info">
                            <div class="item-title">Challan #${challan.challanNumber}</div>
                            <div class="item-detail">
                                üìÖ ${challanDate} | üì¶ ${itemCount} item${itemCount !== 1 ? 's' : ''}
                            </div>
                            <div class="item-date" style="font-size: 0.75rem; color: #64748b;">
                                ${(challan.items || []).map(i => i.name).join(', ').substring(0, 80) || 'No items'}
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary" style="padding: 0.5rem 1rem;" onclick="loadItemsFromChallan('${challan.id}')">Load Items</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('challanListForInvoice').innerHTML = challanList;
            document.getElementById('loadChallanModal').classList.add('show');
        }

        function loadItemsFromChallan(challanId) {
            const challans = selectedProject.deliveryChallans || [];
            const challan = challans.find(c => c.id === challanId);
            if (!challan) {
                alert('Challan not found');
                return;
            }

            // Challan stores items directly (name + quantity from selected materials)
            const challanItems = challan.items || [];
            if (challanItems.length === 0) {
                alert('No items found in this challan');
                return;
            }

            let importedCount = 0;

            challanItems.forEach(item => {
                // Find the matching material to get cost info
                const materials = selectedProject.materials || [];
                let rate = 0;

                // Try to find cost from original material
                materials.forEach(mat => {
                    if (mat.items && mat.items.length > 0) {
                        mat.items.forEach(matItem => {
                            if (matItem.name === item.name) {
                                const qty = parseFloat(matItem.quantity) || 1;
                                const cost = parseFloat(matItem.cost) || 0;
                                rate = qty > 0 ? cost / qty : cost;
                            }
                        });
                    } else if (mat.name === item.name) {
                        const qty = parseFloat(mat.quantity) || 1;
                        const cost = parseFloat(mat.cost) || parseFloat(mat.totalCost) || 0;
                        rate = qty > 0 ? cost / qty : cost;
                    }
                });

                const qty = parseFloat(item.quantity) || 1;

                tempInvoiceItems.push({
                    id: Date.now().toString() + Math.random(),
                    description: item.name || 'Item',
                    hsnCode: '',
                    quantity: qty,
                    unit: 'Nos',
                    rate: rate,
                    gstRate: 18
                });
                importedCount++;
            });

            closeModal('loadChallanModal');
            renderInvoiceItemsContainer();
            calculateInvoiceTotal();

            alert(`‚úÖ Loaded ${importedCount} items from Challan #${challan.challanNumber}. Please fill in HSN codes, rates and adjust GST% as needed.`);
        }

        function addInvoiceItemRow() {
            const itemId = Date.now().toString() + Math.random();
            const row = {
                id: itemId,
                description: '',
                hsnCode: '',
                quantity: 1,
                unit: 'Nos',
                rate: 0,
                gstRate: 18
            };
            
            tempInvoiceItems.push(row);
            renderInvoiceItemsContainer();
        }

        function renderInvoiceItemsContainer() {
            const container = document.getElementById('invoiceItemsContainer');
            if (!container) return;

            if (tempInvoiceItems.length === 0) {
                addInvoiceItemRow();
                return;
            }

            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: #e5e7eb;">
                                <th style="padding: 0.5rem; text-align: left;">Description*</th>
                                <th style="padding: 0.5rem; text-align: left;">HSN Code*</th>
                                <th style="padding: 0.5rem; text-align: right;">Qty*</th>
                                <th style="padding: 0.5rem; text-align: left;">Unit</th>
                                <th style="padding: 0.5rem; text-align: right;">Rate*</th>
                                <th style="padding: 0.5rem; text-align: right;">GST%*</th>
                                <th style="padding: 0.5rem; text-align: right;">Amount</th>
                                <th style="padding: 0.5rem;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tempInvoiceItems.map((item, index) => {
                                const amount = (item.quantity || 0) * (item.rate || 0);
                                return `
                                <tr>
                                    <td style="padding: 0.5rem;">
                                        <input type="text" class="input" placeholder="Item description" value="${item.description}" 
                                               onchange="updateInvoiceItem('${item.id}', 'description', this.value)" style="margin: 0; min-width: 200px;">
                                    </td>
                                    <td style="padding: 0.5rem;">
                                        <input type="text" class="input" placeholder="HSN" value="${item.hsnCode}" 
                                               onchange="updateInvoiceItem('${item.id}', 'hsnCode', this.value)" style="margin: 0; width: 100px;">
                                    </td>
                                    <td style="padding: 0.5rem;">
                                        <input type="number" class="input" value="${item.quantity}" 
                                               onchange="updateInvoiceItem('${item.id}', 'quantity', this.value)" style="margin: 0; width: 60px; text-align: right;">
                                    </td>
                                    <td style="padding: 0.5rem;">
                                        <select class="input" onchange="updateInvoiceItem('${item.id}', 'unit', this.value)" style="margin: 0; width: 80px;">
                                            <option value="Nos" ${item.unit === 'Nos' ? 'selected' : ''}>Nos</option>
                                            <option value="Pcs" ${item.unit === 'Pcs' ? 'selected' : ''}>Pcs</option>
                                            <option value="Kgs" ${item.unit === 'Kgs' ? 'selected' : ''}>Kgs</option>
                                            <option value="Mtr" ${item.unit === 'Mtr' ? 'selected' : ''}>Mtr</option>
                                            <option value="Sq Ft" ${item.unit === 'Sq Ft' ? 'selected' : ''}>Sq Ft</option>
                                            <option value="Hours" ${item.unit === 'Hours' ? 'selected' : ''}>Hours</option>
                                            <option value="Set" ${item.unit === 'Set' ? 'selected' : ''}>Set</option>
                                        </select>
                                    </td>
                                    <td style="padding: 0.5rem;">
                                        <input type="number" class="input" value="${item.rate}" 
                                               onchange="updateInvoiceItem('${item.id}', 'rate', this.value)" style="margin: 0; width: 100px; text-align: right;">
                                    </td>
                                    <td style="padding: 0.5rem;">
                                        <select class="input" onchange="updateInvoiceItem('${item.id}', 'gstRate', this.value)" style="margin: 0; width: 80px;">
                                            <option value="0" ${item.gstRate === 0 ? 'selected' : ''}>0%</option>
                                            <option value="5" ${item.gstRate === 5 ? 'selected' : ''}>5%</option>
                                            <option value="12" ${item.gstRate === 12 ? 'selected' : ''}>12%</option>
                                            <option value="18" ${item.gstRate === 18 ? 'selected' : ''}>18%</option>
                                            <option value="28" ${item.gstRate === 28 ? 'selected' : ''}>28%</option>
                                        </select>
                                    </td>
                                    <td style="padding: 0.5rem; text-align: right; font-weight: 600;">
                                        ‚Çπ${formatCurrency(amount)}
                                    </td>
                                    <td style="padding: 0.5rem;">
                                        <button class="btn btn-danger" onclick="removeInvoiceItem('${item.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">√ó</button>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function updateInvoiceItem(id, field, value) {
            const item = tempInvoiceItems.find(i => i.id === id);
            if (item) {
                if (field === 'quantity' || field === 'rate' || field === 'gstRate') {
                    item[field] = parseFloat(value) || 0;
                } else {
                    item[field] = value;
                }
                renderInvoiceItemsContainer();
                calculateInvoiceTotal();
            }
        }

        function removeInvoiceItem(id) {
            tempInvoiceItems = tempInvoiceItems.filter(i => i.id !== id);
            if (tempInvoiceItems.length === 0) {
                addInvoiceItemRow();
            } else {
                renderInvoiceItemsContainer();
                calculateInvoiceTotal();
            }
        }

        function calculateInvoiceTotal() {
            // Calculate subtotal
            const subtotal = tempInvoiceItems.reduce((sum, item) => {
                return sum + ((item.quantity || 0) * (item.rate || 0));
            }, 0);

            // Get discount (applied BEFORE GST)
            const discount = parseFloat(document.getElementById('invoiceDiscount')?.value) || 0;
            
            // Amount after discount (this is what GST is calculated on)
            const amountAfterDiscount = subtotal - discount;

            // Get company and customer states to determine GST type
            const companyStateCode = document.getElementById('companyStateCode')?.value;
            const customerStateCode = document.getElementById('customerStateCode')?.value;
            const isIntraState = companyStateCode === customerStateCode;

            // Calculate GST on discounted amount
            let totalCGST = 0;
            let totalSGST = 0;
            let totalIGST = 0;

            tempInvoiceItems.forEach(item => {
                const itemTotal = (item.quantity || 0) * (item.rate || 0);
                // Apply proportional discount to each item
                const itemDiscountedTotal = amountAfterDiscount > 0 ? (itemTotal / subtotal) * amountAfterDiscount : 0;
                const gstAmount = (itemDiscountedTotal * (item.gstRate || 0)) / 100;
                
                if (isIntraState) {
                    totalCGST += gstAmount / 2;
                    totalSGST += gstAmount / 2;
                } else {
                    totalIGST += gstAmount;
                }
            });

            const totalGST = totalCGST + totalSGST + totalIGST;

            // Calculate grand total
            const grandTotal = amountAfterDiscount + totalGST;

            // Update summary
            document.getElementById('invoiceSubtotal').textContent = '‚Çπ' + formatCurrency(subtotal);
            document.getElementById('invoiceDiscountDisplay').textContent = '‚Çπ' + formatCurrency(discount);
            document.getElementById('invoiceCGST').textContent = '‚Çπ' + formatCurrency(totalCGST);
            document.getElementById('invoiceSGST').textContent = '‚Çπ' + formatCurrency(totalSGST);
            document.getElementById('invoiceIGST').textContent = '‚Çπ' + formatCurrency(totalIGST);
            document.getElementById('invoiceGrandTotal').textContent = '‚Çπ' + formatCurrency(grandTotal);
        }

        async function saveInvoice() {
            if (!checkPermission('write')) return;

            // Validate required fields
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const companyName = document.getElementById('companyName').value.trim();
            const companyGSTIN = document.getElementById('companyGSTIN').value.trim();
            const companyState = document.getElementById('companyState').value.trim();
            const companyStateCode = document.getElementById('companyStateCode').value.trim();
            const companyAddress = document.getElementById('companyAddress').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const customerState = document.getElementById('customerState').value.trim();
            const customerStateCode = document.getElementById('customerStateCode').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();

            if (!invoiceNumber || !invoiceDate) {
                alert('Please enter invoice number and date');
                return;
            }

            if (!companyName || !companyGSTIN || !companyState || !companyStateCode || !companyAddress) {
                alert('Please complete all company GST details');
                return;
            }

            if (!customerName || !customerState || !customerStateCode || !customerAddress) {
                alert('Please complete all customer details');
                return;
            }

            // Validate items
            const validItems = tempInvoiceItems.filter(item => item.description && item.hsnCode && item.rate > 0);
            if (validItems.length === 0) {
                alert('Please add at least one item with description, HSN code, and rate');
                return;
            }

            // Calculate totals
            const subtotal = validItems.reduce((sum, item) => sum + (item.quantity * item.rate), 0);
            const discount = parseFloat(document.getElementById('invoiceDiscount').value) || 0;
            
            // Amount after discount (GST calculated on this)
            const amountAfterDiscount = subtotal - discount;

            const isIntraState = companyStateCode === customerStateCode;
            let totalCGST = 0, totalSGST = 0, totalIGST = 0;

            validItems.forEach(item => {
                const itemTotal = item.quantity * item.rate;
                // Apply proportional discount to each item
                const itemDiscountedTotal = amountAfterDiscount > 0 ? (itemTotal / subtotal) * amountAfterDiscount : 0;
                const gstAmount = (itemDiscountedTotal * item.gstRate) / 100;
                if (isIntraState) {
                    totalCGST += gstAmount / 2;
                    totalSGST += gstAmount / 2;
                } else {
                    totalIGST += gstAmount;
                }
            });

            const totalGST = totalCGST + totalSGST + totalIGST;
            const grandTotal = amountAfterDiscount + totalGST;

            const invoice = {
                id: editingInvoiceId || Date.now().toString(),
                invoiceNumber,
                invoiceDate,
                companyName,
                companyGSTIN,
                companyState,
                companyStateCode,
                companyAddress,
                customerName,
                customerGSTIN: document.getElementById('customerGSTIN').value.trim(),
                customerState,
                customerStateCode,
                customerAddress,
                items: validItems,
                subtotal,
                discount,
                cgst: totalCGST,
                sgst: totalSGST,
                igst: totalIGST,
                totalGST,
                grandTotal,
                createdAt: editingInvoiceId ? (selectedProject.invoices.find(inv => inv.id === editingInvoiceId)?.createdAt) : new Date().toISOString(),
                createdBy: currentUser?.uid
            };

            try {
                if (db) {
                    let invoices;
                    if (editingInvoiceId) {
                        invoices = (selectedProject.invoices || []).map(inv => inv.id === editingInvoiceId ? invoice : inv);
                    } else {
                        invoices = [...(selectedProject.invoices || []), invoice];
                    }
                    await db.collection('projects').doc(selectedProject.id).update({ invoices });
                } else {
                    if (editingInvoiceId) {
                        selectedProject.invoices = (selectedProject.invoices || []).map(inv => inv.id === editingInvoiceId ? invoice : inv);
                    } else {
                        selectedProject.invoices = [...(selectedProject.invoices || []), invoice];
                    }
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                closeModal('invoiceModal');
                alert('‚úÖ Invoice saved successfully!');
            } catch (error) {
                console.error('Error saving invoice:', error);
                alert('Failed to save invoice');
            }
        }

        async function deleteInvoice(id) {
            if (!checkPermission('write')) return;
            if (!confirm('Delete this invoice?')) return;

            try {
                if (db) {
                    const invoices = (selectedProject.invoices || []).filter(inv => inv.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ invoices });
                } else {
                    selectedProject.invoices = (selectedProject.invoices || []).filter(inv => inv.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting invoice:', error);
                alert('Failed to delete invoice');
            }
        }

        function downloadInvoice(id) {
            const invoice = (selectedProject.invoices || []).find(inv => inv.id === id);
            if (!invoice) {
                alert('Invoice not found');
                return;
            }

            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const leftMargin = 15;
            const rightMargin = 195;
            const pageWidth = 210;
            const pageHeight = 297;

            // Helper function to add new page if needed
            const checkPageBreak = (requiredSpace) => {
                if (yPos + requiredSpace > pageHeight - 20) {
                    doc.addPage();
                    yPos = 20;
                    return true;
                }
                return false;
            };

            // Helper to format currency without rupee symbol
            // Helper to format amount as plain number (no currency symbol)
            const formatAmount = (amount) => {
                return amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            // HEADER - TAX INVOICE (right side)
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('TAX INVOICE', rightMargin, yPos, { align: 'right' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`# ${invoice.invoiceNumber}`, rightMargin, yPos + 8, { align: 'right' });
            
            // Balance Due (right side, below invoice number)
            doc.setFontSize(9);
            doc.text('Balance Due', rightMargin, yPos + 16, { align: 'right' });
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(`Rs. ${formatAmount(invoice.grandTotal)}`, rightMargin, yPos + 22, { align: 'right' });
            
            // Reset yPos for left side content
            doc.setFont('helvetica', 'normal');

            // Company Details (left side, starts from top)
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(invoice.companyName, leftMargin, yPos);
            yPos += 6;
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            const companyAddressLines = doc.splitTextToSize(invoice.companyAddress, 100);
            doc.text(companyAddressLines, leftMargin, yPos);
            yPos += (companyAddressLines.length * 4);
            
            doc.text(`GSTIN ${invoice.companyGSTIN}`, leftMargin, yPos);
            yPos += 10;

            // Invoice Date and Terms (right side)
            const dateYPos = yPos;
            doc.setFontSize(9);
            doc.text(`Invoice Date: ${new Date(invoice.invoiceDate).toLocaleDateString('en-IN')}`, rightMargin, dateYPos, { align: 'right' });
            doc.text('Terms: Due on Receipt', rightMargin, dateYPos + 5, { align: 'right' });
            doc.text(`Due Date: ${new Date(invoice.invoiceDate).toLocaleDateString('en-IN')}`, rightMargin, dateYPos + 10, { align: 'right' });
            
            yPos += 15;

            // Bill To Section
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('Bill To', leftMargin, yPos);
            yPos += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(invoice.customerName, leftMargin, yPos);
            yPos += 5;
            
            doc.setFont('helvetica', 'normal');
            const custAddressLines = doc.splitTextToSize(invoice.customerAddress, 100);
            doc.text(custAddressLines, leftMargin, yPos);
            yPos += (custAddressLines.length * 4);
            
            if (invoice.customerGSTIN) {
                doc.text(`GSTIN ${invoice.customerGSTIN}`, leftMargin, yPos);
                yPos += 5;
            }
            
            doc.text(`Place Of Supply: ${invoice.customerState} (${invoice.customerStateCode})`, leftMargin, yPos);
            yPos += 10;

            // Determine if this is IGST or CGST/SGST invoice
            const isIGST = invoice.igst > 0;

            // Items Table Header - Custom spacing per requirements
            // Description: 50px | HSN-Qty: 10mm | Qty-Rate: as before | Rate-CGST: 25mm | CGST-SGST: 22mm | SGST-Amount: 58mm
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, yPos, rightMargin - leftMargin, 7, 'F');
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('#', leftMargin + 2, yPos + 5);
            doc.text('Item & Description', leftMargin + 8, yPos + 5);
            doc.text('HSN/SAC', leftMargin + 60, yPos + 5);
            doc.text('Qty', leftMargin + 74, yPos + 5);
            doc.text('Rate', leftMargin + 80, yPos + 5);   // Was 86, halved gap ‚Üí 80
            
            if (isIGST) {
                doc.text('IGST', leftMargin + 112, yPos + 5);
            } else {
                doc.text('CGST', leftMargin + 111, yPos + 5);
                doc.text('SGST', leftMargin + 133, yPos + 5);
            }
            
            doc.text('Amount', rightMargin - 2, yPos + 5, { align: 'right' });
            
            yPos += 9;

            // Items
            doc.setFont('helvetica', 'normal');
            invoice.items.forEach((item, index) => {
                checkPageBreak(15);
                
                const amount = item.quantity * item.rate;
                const gstAmount = (amount * item.gstRate) / 100;
                const cgst = invoice.cgst > 0 ? gstAmount / 2 : 0;
                const sgst = invoice.sgst > 0 ? gstAmount / 2 : 0;
                const igst = invoice.igst > 0 ? gstAmount : 0;
                
                doc.setFontSize(8);
                doc.text(String(index + 1), leftMargin + 2, yPos);
                
                const descLines = doc.splitTextToSize(item.description, 50);
                doc.text(descLines, leftMargin + 8, yPos);
                
                doc.text(item.hsnCode, leftMargin + 60, yPos);
                const qtyDisplay = Number.isInteger(item.quantity) ? String(item.quantity) : parseFloat(item.quantity.toFixed(2)).toString();
                doc.text(qtyDisplay, leftMargin + 74, yPos);
                doc.text('Rs. ' + formatAmount(item.rate), leftMargin + 80, yPos);  // Was 86
                
                if (isIGST) {
                    doc.text('Rs. ' + formatAmount(igst), leftMargin + 112, yPos);
                    doc.setFontSize(6);
                    doc.text(`${item.gstRate}%`, leftMargin + 115, yPos + 3);
                    doc.setFontSize(8);
                } else {
                    if (cgst > 0) {
                        doc.text('Rs. ' + formatAmount(cgst), leftMargin + 111, yPos);
                        doc.setFontSize(6);
                        doc.text(`${item.gstRate/2}%`, leftMargin + 114, yPos + 3);
                        doc.setFontSize(8);
                    }
                    if (sgst > 0) {
                        doc.text('Rs. ' + formatAmount(sgst), leftMargin + 133, yPos);
                        doc.setFontSize(6);
                        doc.text(`${item.gstRate/2}%`, leftMargin + 136, yPos + 3);
                        doc.setFontSize(8);
                    }
                }
                
                doc.text('Rs. ' + formatAmount(amount), rightMargin - 2, yPos, { align: 'right' });
                
                yPos += Math.max(descLines.length * 4, 8);
                
                doc.setDrawColor(220, 220, 220);
                doc.line(leftMargin, yPos, rightMargin, yPos);
                yPos += 3;
            });

            yPos += 5;

            // Summary
            checkPageBreak(40);
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            
            doc.text('Sub Total', rightMargin - 55, yPos);
            doc.text('Rs. ' + formatAmount(invoice.subtotal), rightMargin - 5, yPos, { align: 'right' });
            yPos += 5;

            if (invoice.cgst > 0) {
                doc.text(`CGST (${invoice.items[0]?.gstRate/2}%)`, rightMargin - 55, yPos);
                doc.text('Rs. ' + formatAmount(invoice.cgst), rightMargin - 5, yPos, { align: 'right' });
                yPos += 5;
            }

            if (invoice.sgst > 0) {
                doc.text(`SGST (${invoice.items[0]?.gstRate/2}%)`, rightMargin - 55, yPos);
                doc.text('Rs. ' + formatAmount(invoice.sgst), rightMargin - 5, yPos, { align: 'right' });
                yPos += 5;
            }

            if (invoice.igst > 0) {
                doc.text(`IGST (${invoice.items[0]?.gstRate}%)`, rightMargin - 55, yPos);
                doc.text('Rs. ' + formatAmount(invoice.igst), rightMargin - 5, yPos, { align: 'right' });
                yPos += 5;
            }

            if (invoice.discount > 0) {
                doc.text('Discount', rightMargin - 55, yPos);
                doc.text('-Rs. ' + formatAmount(invoice.discount), rightMargin - 5, yPos, { align: 'right' });
                yPos += 5;
            }

            yPos += 2;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('Total', rightMargin - 55, yPos);
            doc.text('Rs. ' + formatAmount(invoice.grandTotal), rightMargin - 5, yPos, { align: 'right' });
            yPos += 6;
            
            doc.text('Balance Due', rightMargin - 55, yPos);
            doc.text('Rs. ' + formatAmount(invoice.grandTotal), rightMargin - 5, yPos, { align: 'right' });
            yPos += 10;

            // Amount in words
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            const amountInWords = numberToWords(invoice.grandTotal);
            doc.text(`Total In Words: ${amountInWords}`, leftMargin, yPos);
            yPos += 10;

            // Notes
            doc.setFont('helvetica', 'bold');
            doc.text('Notes', leftMargin, yPos);
            yPos += 5;
            doc.setFont('helvetica', 'normal');
            doc.text('Thanks for your business.', leftMargin, yPos);

            // Save PDF
            doc.save(`${invoice.invoiceNumber}.pdf`);
        }

        // Helper function to convert number to words (Indian format)
        function numberToWords(amount) {
            const crores = Math.floor(amount / 10000000);
            const lakhs = Math.floor((amount % 10000000) / 100000);
            const thousands = Math.floor((amount % 100000) / 1000);
            const hundreds = Math.floor((amount % 1000) / 100);
            const remainder = Math.floor(amount % 100);
            const paise = Math.round((amount - Math.floor(amount)) * 100);

            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

            const convertTwoDigits = (n) => {
                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
            };

            let words = 'Indian Rupee ';
            
            if (crores > 0) words += convertTwoDigits(crores) + ' Crore ';
            if (lakhs > 0) words += convertTwoDigits(lakhs) + ' Lakh ';
            if (thousands > 0) words += convertTwoDigits(thousands) + ' Thousand ';
            if (hundreds > 0) words += ones[hundreds] + ' Hundred ';
            if (remainder > 0) words += convertTwoDigits(remainder) + ' ';
            
            if (paise > 0) {
                words += 'and ' + convertTwoDigits(paise) + ' Paise ';
            }
            
            return words.trim() + ' Only';
        }

        function editInvoice(id) {
            const invoice = (selectedProject.invoices || []).find(inv => inv.id === id);
            if (!invoice) {
                alert('Invoice not found');
                return;
            }

            editingInvoiceId = id;
            document.getElementById('invoiceModalTitle').textContent = 'Edit Tax Invoice';
            document.getElementById('saveInvoiceBtn').textContent = 'Update Invoice';

            // Fill form with existing data
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
            document.getElementById('invoiceDate').value = invoice.invoiceDate;
            document.getElementById('companyName').value = invoice.companyName;
            document.getElementById('companyGSTIN').value = invoice.companyGSTIN;
            document.getElementById('companyState').value = invoice.companyState;
            document.getElementById('companyStateCode').value = invoice.companyStateCode;
            document.getElementById('companyAddress').value = invoice.companyAddress;
            document.getElementById('customerName').value = invoice.customerName;
            document.getElementById('customerGSTIN').value = invoice.customerGSTIN || '';
            document.getElementById('customerState').value = invoice.customerState;
            document.getElementById('customerStateCode').value = invoice.customerStateCode;
            document.getElementById('customerAddress').value = invoice.customerAddress;
            document.getElementById('invoiceDiscount').value = invoice.discount || 0;

            // Load items
            tempInvoiceItems = invoice.items.map(item => ({
                id: Date.now().toString() + Math.random(),
                description: item.description,
                hsnCode: item.hsnCode,
                quantity: item.quantity,
                unit: item.unit,
                rate: item.rate,
                gstRate: item.gstRate
            }));

            renderInvoiceItemsContainer();
            calculateInvoiceTotal();

            document.getElementById('invoiceModal').classList.add('show');
        }

        // ========================================
        // SALES LEADS MANAGEMENT
        // ========================================

        const leadStages = [
            { id: 'contacted', label: 'Contacted', color: 'stage-contacted' },
            { id: 'proposal_shared', label: 'Proposal Shared', color: 'stage-proposal_shared' },
            { id: 'negotiation', label: 'Negotiation', color: 'stage-negotiation' },
            { id: 'won_token', label: 'Won with Token', color: 'stage-won_token' },
            { id: 'won_material', label: 'Won with Material Advance', color: 'stage-won_material' },
            { id: 'dropped', label: 'Dropped', color: 'stage-dropped' },
            { id: 'on_hold', label: 'On Hold/Archive', color: 'stage-on_hold' }
        ];

        function renderLeadPipeline() {
            const pipeline = document.getElementById('leadPipeline');
            if (!pipeline) return;

            const searchTerm = document.getElementById('leadSearchInput')?.value.toLowerCase() || '';
            const stageFilter = leadStageFilter;

            pipeline.innerHTML = leadStages.map(stage => {
                const stageLeads = leads.filter(lead => {
                    const matchesStage = stageFilter === 'all' || lead.stage === stage.id;
                    const matchesSearch = !searchTerm || 
                        lead.contactPerson.toLowerCase().includes(searchTerm) ||
                        (lead.company && lead.company.toLowerCase().includes(searchTerm)) ||
                        (lead.email && lead.email.toLowerCase().includes(searchTerm)) ||
                        (lead.phone && lead.phone.toLowerCase().includes(searchTerm));
                    
                    return lead.stage === stage.id && matchesStage && matchesSearch;
                });

                return `
                    <div class="lead-column">
                        <div class="lead-column-header ${stage.color}">
                            ${stage.label}
                            <span class="lead-column-count">(${stageLeads.length})</span>
                        </div>
                        ${stageLeads.length === 0 ? 
                            '<div style="text-align: center; color: #9ca3af; font-size: 0.875rem; padding: 1rem;">No leads</div>' :
                            stageLeads.map(lead => `
                                <div class="lead-card" onclick="selectLead('${lead.id}')">
                                    <div class="lead-card-title">${lead.contactPerson}</div>
                                    ${lead.company ? `<div class="lead-card-company">üè¢ ${lead.company}</div>` : ''}
                                    ${lead.projectType ? `<div class="lead-card-company">üìã ${lead.projectType}</div>` : ''}
                                    ${lead.value ? `<div class="lead-card-value">‚Çπ${formatCurrency(lead.value)}</div>` : ''}
                                    <div class="lead-card-date">Created: ${formatDate(lead.createdAt)}</div>
                                </div>
                            `).join('')
                        }
                    </div>
                `;
            }).join('');
        }

        function selectLead(id) {
            selectedLead = leads.find(l => l.id === id);
            if (!selectedLead) return;

            const card = document.getElementById('leadDetailsPanelCard');
            card.style.display = 'block';

            renderLeadDetails();
        }

        function closeLeadDetails() {
            selectedLead = null;
            document.getElementById('leadDetailsPanelCard').style.display = 'none';
        }

        function renderLeadDetails() {
            if (!selectedLead) return;

            const stage = leadStages.find(s => s.id === selectedLead.stage);
            const stageLabel = stage ? stage.label : selectedLead.stage;
            const stageClass = stage ? stage.color : '';

            const activities = selectedLead.activities || [];

            document.getElementById('leadDetailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem; padding: 1.5rem;">
                    <!-- Lead Header -->
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h2 style="margin: 0 0 0.5rem 0;">${selectedLead.contactPerson}</h2>
                            ${selectedLead.company ? `<p style="margin: 0; color: #6b7280;">üè¢ ${selectedLead.company}</p>` : ''}
                        </div>
                        <span class="status-badge ${stageClass}" style="font-size: 0.875rem;">${stageLabel}</span>
                    </div>

                    <!-- Lead Info Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        ${selectedLead.email ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Email</div>
                                <div>üìß ${selectedLead.email}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.phone ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Phone</div>
                                <div>üìû ${selectedLead.phone}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.leadGenDate ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Lead Gen Date</div>
                                <div>üìÖ ${new Date(selectedLead.leadGenDate).toLocaleDateString()}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.propertyType ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Property Type</div>
                                <div>üè¢ ${selectedLead.propertyType.charAt(0).toUpperCase() + selectedLead.propertyType.slice(1).replace('_', ' ')}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.location ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Location</div>
                                <div>üìç ${selectedLead.location}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.projectType ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Project Type</div>
                                <div>üìã ${selectedLead.projectType}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.value ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Estimated Value</div>
                                <div style="font-weight: 600; color: #16a34a;">‚Çπ${formatCurrency(selectedLead.value)}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.source ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Source</div>
                                <div>üéØ ${selectedLead.source === 'other' && selectedLead.sourceOther ? selectedLead.sourceOther : selectedLead.source.replace('_', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.leadOwner ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Lead Owner / Sales Person</div>
                                <div>üë§ ${selectedLead.leadOwner}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.priority ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Priority</div>
                                <div>${selectedLead.priority === 'high' ? 'üî¥' : selectedLead.priority === 'medium' ? 'üü°' : 'üü¢'} ${selectedLead.priority.charAt(0).toUpperCase() + selectedLead.priority.slice(1)}</div>
                            </div>
                        ` : ''}
                    </div>

                    ${selectedLead.scopeOfWork ? `
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Scope of Work</div>
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">${selectedLead.scopeOfWork}</div>
                        </div>
                    ` : ''}

                    ${selectedLead.notes ? `
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Requirements/Notes</div>
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">${selectedLead.notes}</div>
                        </div>
                    ` : ''}

                    <!-- BOQ Files -->
                    ${selectedLead.boqFiles && selectedLead.boqFiles.length > 0 ? `
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">üìä BOQ Files (${selectedLead.boqFiles.length})</div>
                            <div class="files-grid">
                                ${selectedLead.boqFiles.map(f => `
                                    <div class="attached-file">
                                        <div class="file-icon">${getFileIcon(f.type)}</div>
                                        <div style="flex: 1; min-width: 0; overflow: hidden;">
                                            <div style="font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                                            <div style="font-size: 0.7rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                                        </div>
                                        <a href="${f.downloadUrl || f.data}" download="${f.name}" target="_blank" class="download-btn" title="Download from OneDrive">‚¨áÔ∏è</a>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Design Files -->
                    ${selectedLead.designFiles && selectedLead.designFiles.length > 0 ? `
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">üé® Design Bundle (${selectedLead.designFiles.length})</div>
                            <div class="files-grid">
                                ${selectedLead.designFiles.map(f => `
                                    <div class="attached-file">
                                        <div class="file-icon">${f.type && f.type.startsWith('image/') ? 'üñºÔ∏è' : getFileIcon(f.type)}</div>
                                        <div style="flex: 1; min-width: 0; overflow: hidden;">
                                            <div style="font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                                            <div style="font-size: 0.7rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                                        </div>
                                        <a href="${f.downloadUrl || f.data}" download="${f.name}" target="_blank" class="download-btn" title="Download from OneDrive">‚¨áÔ∏è</a>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${isAdmin() ? `
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <select class="input" style="flex: 1; min-width: 200px;" onchange="updateLeadStage(this.value)">
                                ${leadStages.map(s => `
                                    <option value="${s.id}" ${selectedLead.stage === s.id ? 'selected' : ''}>${s.label}</option>
                                `).join('')}
                            </select>
                            <button class="btn btn-primary" onclick="showEditLeadModal()">‚úèÔ∏è Edit</button>
                            <button class="btn btn-secondary" onclick="showAddActivityModal()">+ Add Activity</button>
                            ${(selectedLead.stage === 'won_token' || selectedLead.stage === 'won_material') ? `
                                <button class="btn btn-success" onclick="convertLeadToCustomer()">üìã Create Final Quote</button>
                            ` : ''}
                            <button class="btn btn-danger" onclick="deleteLead('${selectedLead.id}')">üóëÔ∏è Delete</button>
                        </div>
                    ` : ''}

                    <!-- Actions / Follow-ups -->
                    ${selectedLead.leadActions && selectedLead.leadActions.length > 0 ? `
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">üìã Follow-up Actions</div>
                            ${selectedLead.leadActions.map(action => {
                                const _today = new Date(); _today.setHours(0,0,0,0);
                                const _due = new Date(action.dueDate); _due.setHours(0,0,0,0);
                                const _diff = Math.round((_due - _today) / (1000*60*60*24));
                                const _overdue = action.status !== 'completed' && _diff < 0;
                                const _dueToday = action.status !== 'completed' && _diff === 0;
                                let _dayLabel = '';
                                if (action.status !== 'completed') {
                                    if (_diff < 0) _dayLabel = `<span style="color:#dc2626;font-weight:700;"> ‚Ä¢ üî¥ ${Math.abs(_diff)} day${Math.abs(_diff)!==1?'s':''} overdue</span>`;
                                    else if (_diff === 0) _dayLabel = `<span style="color:#d97706;font-weight:700;"> ‚Ä¢ ‚ö†Ô∏è Due today</span>`;
                                    else _dayLabel = `<span style="color:#16a34a;font-weight:600;"> ‚Ä¢ ${_diff} day${_diff!==1?'s':''} left</span>`;
                                }
                                const _bg = action.status === 'completed' ? '#f0fdf4' : _overdue ? '#fef2f2' : _dueToday ? '#fffbeb' : '#fef3c7';
                                const _border = action.status === 'completed' ? '#10b981' : _overdue ? '#dc2626' : _dueToday ? '#d97706' : '#f59e0b';
                                return `
                                <div style="background: ${_bg}; border-left: 3px solid ${_border}; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.875rem; font-weight: 600; color: ${_overdue ? '#b91c1c' : 'inherit'};">${action.actionType}</div>
                                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                                üìÖ Due: ${new Date(action.dueDate).toLocaleDateString()}
                                                ${action.status === 'completed' ? ' ‚Ä¢ ‚úì Completed' : ' ‚Ä¢ ‚è≥ Pending'}
                                                ${_dayLabel}
                                            </div>
                                            ${action.notes ? `<div style="font-size: 0.8rem; margin-top: 0.25rem;">${action.notes}</div>` : ''}
                                        </div>
                                        ${isAdmin() && action.status !== 'completed' ? `
                                            <button class="btn btn-success" onclick="markActionComplete('${action.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Mark Done</button>
                                        ` : ''}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    ` : ''}

                    <!-- Quotes -->
                    ${(selectedLead.finalQuotes && selectedLead.finalQuotes.length > 0) ? `
                    <div>
                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">üìã Quotes / Proposals</div>
                        ${selectedLead.finalQuotes.map(q => {
                            const fmt = v => '‚Çπ' + (v||0).toLocaleString('en-IN', { maximumFractionDigits: 0 });
                            const dStr = q.date ? new Date(q.date).toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'}) : '';
                            return `<div style="background:#f0f9ff;border-left:3px solid #0284c7;border-radius:0.375rem;padding:0.75rem;margin-bottom:0.5rem;">
                                <div style="display:flex;justify-content:space-between;align-items:start;gap:0.5rem;flex-wrap:wrap;">
                                    <div>
                                        <div style="font-weight:700;font-size:0.9rem;">üìã ${q.quoteNo || 'Quote'}</div>
                                        <div style="font-size:0.75rem;color:#6b7280;margin-top:0.15rem;">${dStr}${q.validDays ? ` ¬∑ Valid ${q.validDays} days` : ''}</div>
                                        <div style="font-size:0.8rem;margin-top:0.25rem;">
                                            Subtotal: ${fmt(q.subtotal)} ¬∑ GST: ${fmt(q.totalGST)} ¬∑ Discount: ${fmt(q.discount)}
                                        </div>
                                        <div style="font-weight:700;color:#0369a1;font-size:0.95rem;margin-top:0.2rem;">Grand Total: ${fmt(q.grandTotal)}</div>
                                        ${(q.files||[]).length > 0 ? `<div style="margin-top:0.3rem;">${q.files.map(f=>`<a href="${f.shareLink||f.downloadUrl||f.data||'#'}" target="_blank" style="font-size:0.75rem;color:#0369a1;margin-right:0.5rem;">üìé ${f.name}</a>`).join('')}</div>` : ''}
                                    </div>
                                    ${isAdmin() ? `<div style="display:flex;gap:0.4rem;flex-shrink:0;">
                                        <button class="btn btn-secondary" onclick="editLeadQuote('${q.id}')" style="padding:0.25rem 0.5rem;font-size:0.75rem;">‚úèÔ∏è Edit</button>
                                        <button class="btn btn-danger" onclick="deleteLeadQuote('${q.id}')" style="padding:0.25rem 0.5rem;font-size:0.75rem;">üóëÔ∏è</button>
                                    </div>` : ''}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    ` : ''}

                    <!-- Activities -->
                    <div>
                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Activity Timeline</div>
                        ${activities.length === 0 ? 
                            '<div style="text-align: center; color: #9ca3af; padding: 1rem;">No activities yet</div>' :
                            activities.map(activity => `
                                <div style="border-left: 2px solid #e5e7eb; padding-left: 1rem; margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; font-weight: 600;">${activity.type}</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">${formatDate(activity.date)}</div>
                                    <div style="margin-top: 0.25rem;">${activity.description}</div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        }

        // ========================================
        // LEAD FILE HANDLING
        // ========================================

        async function handleLeadBOQFiles(files) {
            for (const file of Array.from(files)) {
                // Initialize OneDrive if not already done
                if (!msalInstance) {
                    initializeOneDrive();
                }
                
                // Check OneDrive connection
                if (!oneDriveAccessToken) {
                    const connected = await connectOneDrive();
                    if (!connected) {
                        alert('Please connect OneDrive to upload files');
                        return;
                    }
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };

                        // Show upload progress
                        document.getElementById('syncStatus').textContent = `Uploading ${file.name} to OneDrive...`;

                        // Upload to OneDrive
                        const oneDriveFile = await uploadToOneDrive(fileData, 'boq');
                        
                        selectedBOQFiles.push(oneDriveFile);
                        displayLeadBOQFiles();

                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert(`Failed to upload ${file.name}: ${error.message}`);
                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleLeadDesignFiles(files) {
            for (const file of Array.from(files)) {
                // Initialize OneDrive if not already done
                if (!msalInstance) {
                    initializeOneDrive();
                }
                
                // Check OneDrive connection
                if (!oneDriveAccessToken) {
                    const connected = await connectOneDrive();
                    if (!connected) {
                        alert('Please connect OneDrive to upload files');
                        return;
                    }
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };

                        // Show upload progress
                        document.getElementById('syncStatus').textContent = `Uploading ${file.name} to OneDrive...`;

                        // Upload to OneDrive
                        const oneDriveFile = await uploadToOneDrive(fileData, 'design');
                        
                        selectedDesignFiles.push(oneDriveFile);
                        displayLeadDesignFiles();

                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert(`Failed to upload ${file.name}: ${error.message}`);
                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function displayLeadBOQFiles() {
            const container = document.getElementById('leadBOQFilesList');
            if (!container) return;

            container.innerHTML = selectedBOQFiles.map((file, index) => `
                <div class="attached-file">
                    <div class="file-icon">${getFileIcon(file.type)}</div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.875rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="removeLeadBOQFile(${index})">‚úï</button>
                </div>
            `).join('');
        }

        function displayLeadDesignFiles() {
            const container = document.getElementById('leadDesignFilesList');
            if (!container) return;

            container.innerHTML = selectedDesignFiles.map((file, index) => `
                <div class="attached-file">
                    ${file.type.startsWith('image/') ? 
                        `<img src="${file.data}" class="file-thumbnail" alt="${file.name}">` :
                        `<div class="file-icon">${getFileIcon(file.type)}</div>`
                    }
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.875rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="removeLeadDesignFile(${index})">‚úï</button>
                </div>
            `).join('');
        }

        function removeLeadBOQFile(index) {
            selectedBOQFiles.splice(index, 1);
            displayLeadBOQFiles();
        }

        function removeLeadDesignFile(index) {
            selectedDesignFiles.splice(index, 1);
            displayLeadDesignFiles();
        }

        function showAddLeadModal() {
            if (!checkPermission('write')) return;

            editingLeadId = null;
            document.getElementById('leadModalTitle').textContent = 'Add Sales Lead';
            document.getElementById('saveLeadBtn').textContent = 'Add Lead';
            
            // Clear form
            document.getElementById('leadContactPerson').value = '';
            document.getElementById('leadCompany').value = '';
            document.getElementById('leadEmail').value = '';
            document.getElementById('leadPhone').value = '';
            document.getElementById('leadGenDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('leadPropertyType').value = '';
            document.getElementById('leadLocation').value = '';
            document.getElementById('leadProjectType').value = '';
            document.getElementById('leadValue').value = '';
            document.getElementById('leadStage').value = 'contacted';
            document.getElementById('leadSource').value = '';
            document.getElementById('leadSourceOther').value = '';
            document.getElementById('leadSourceOtherContainer').style.display = 'none';
            document.getElementById('leadCloseDate').value = '';
            document.getElementById('leadPriority').value = 'medium';
            document.getElementById('leadScopeOfWork').value = '';
            document.getElementById('leadNotes').value = '';
            // Populate owner dropdown, default to current user's name
            const currentUserName = (allUsers.find(u => u.uid === currentUser?.uid) || {});
            const defaultOwner = currentUserName.name || currentUserName.displayName || '';
            populateLeadOwners(defaultOwner);

            // Clear files
            selectedBOQFiles = [];
            selectedDesignFiles = [];
            displayLeadBOQFiles();
            displayLeadDesignFiles();

            document.getElementById('leadModal').classList.add('show');
        }

        function populateLeadOwners(currentValue) {
            const ownerSelect = document.getElementById('leadOwner');
            if (!ownerSelect) return;
            const users = allUsers || [];
            ownerSelect.innerHTML = '<option value="">Select sales person...</option>' +
                users.map(u => {
                    const name = u.name || u.displayName || u.email || '';
                    return `<option value="${name}" ${currentValue === name ? 'selected' : ''}>${name}</option>`;
                }).join('');
        }

        function toggleLeadSourceOther() {
            const source = document.getElementById('leadSource').value;
            const otherContainer = document.getElementById('leadSourceOtherContainer');
            if (source === 'other') {
                otherContainer.style.display = 'block';
            } else {
                otherContainer.style.display = 'none';
                document.getElementById('leadSourceOther').value = '';
            }
        }

        function showEditLeadModal() {
            if (!checkPermission('write') || !selectedLead) return;

            editingLeadId = selectedLead.id;
            document.getElementById('leadModalTitle').textContent = 'Edit Sales Lead';
            document.getElementById('saveLeadBtn').textContent = 'Update Lead';

            // Fill form with existing data
            document.getElementById('leadContactPerson').value = selectedLead.contactPerson || '';
            document.getElementById('leadCompany').value = selectedLead.company || '';
            document.getElementById('leadEmail').value = selectedLead.email || '';
            document.getElementById('leadPhone').value = selectedLead.phone || '';
            document.getElementById('leadGenDate').value = selectedLead.leadGenDate || '';
            document.getElementById('leadPropertyType').value = selectedLead.propertyType || '';
            document.getElementById('leadLocation').value = selectedLead.location || '';
            document.getElementById('leadProjectType').value = selectedLead.projectType || '';
            document.getElementById('leadValue').value = selectedLead.value || '';
            document.getElementById('leadStage').value = selectedLead.stage || 'contacted';
            document.getElementById('leadSource').value = selectedLead.source || '';
            document.getElementById('leadSourceOther').value = selectedLead.sourceOther || '';
            
            // Show/hide source other field
            if (selectedLead.source === 'other') {
                document.getElementById('leadSourceOtherContainer').style.display = 'block';
            } else {
                document.getElementById('leadSourceOtherContainer').style.display = 'none';
            }
            
            // Populate owner dropdown with saved value
            populateLeadOwners(selectedLead.leadOwner || '');
            
            document.getElementById('leadCloseDate').value = selectedLead.expectedCloseDate || '';
            document.getElementById('leadPriority').value = selectedLead.priority || 'medium';
            document.getElementById('leadScopeOfWork').value = selectedLead.scopeOfWork || '';
            document.getElementById('leadNotes').value = selectedLead.notes || '';

            // Load existing files
            selectedBOQFiles = selectedLead.boqFiles || [];
            selectedDesignFiles = selectedLead.designFiles || [];
            displayLeadBOQFiles();
            displayLeadDesignFiles();

            document.getElementById('leadModal').classList.add('show');
        }

        let currentActionLeadId = null;
        let currentActionLeadName = null;

        function promptForLeadAction(leadId, leadName) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            currentActionLeadId = leadId;
            currentActionLeadName = leadName;

            // Get last action date
            const lastAction = (lead.leadActions || []).length > 0 
                ? lead.leadActions[lead.leadActions.length - 1] 
                : null;
            const lastActionDate = lastAction ? new Date(lastAction.createdAt).toLocaleDateString() : 'None';

            // Show modal
            document.getElementById('actionModalTitle').textContent = `Add Action for ${leadName}`;
            document.getElementById('lastActionDate').textContent = lastActionDate;
            document.getElementById('nextActionType').value = '';
            document.getElementById('nextActionDate').value = '';
            document.getElementById('actionRemarks').value = '';
            document.getElementById('actionModal').classList.add('show');
        }

        function saveNewAction() {
            const actionType = document.getElementById('nextActionType').value.trim();
            const actionDate = document.getElementById('nextActionDate').value;
            const remarks = document.getElementById('actionRemarks').value.trim();

            if (!actionType) {
                alert('Please enter action type');
                return;
            }
            if (!actionDate) {
                alert('Please select action date');
                return;
            }

            // Create the action
            const action = {
                id: Date.now().toString(),
                actionType: actionType,
                dueDate: actionDate,
                notes: remarks,
                status: 'pending',
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.email || 'User'
            };

            // Save to lead
            const lead = leads.find(l => l.id === currentActionLeadId);
            if (!lead) return;

            const leadActions = [...(lead.leadActions || []), action];
            const activity = {
                type: 'Action Added',
                description: `${actionType} scheduled for ${new Date(actionDate).toLocaleDateString()}`,
                date: new Date().toISOString(),
                by: currentUser?.email || ''
            };
            const activities = [...(lead.activities || []), activity];

            // Update in database
            if (db) {
                db.collection('leads').doc(currentActionLeadId).update({ 
                    leadActions: leadActions,
                    activities: activities 
                }).then(() => {
                    // Update local data
                    lead.leadActions = leadActions;
                    lead.activities = activities;
                    if (selectedLead && selectedLead.id === currentActionLeadId) {
                        selectedLead.leadActions = leadActions;
                        selectedLead.activities = activities;
                        renderLeadDetails();
                    }
                    renderLeadPipeline();
                    closeModal('actionModal');
                    alert('‚úì Action added successfully!');
                }).catch(err => {
                    console.error('Error adding action:', err);
                    alert('Failed to add action');
                });
            } else {
                const idx = leads.findIndex(l => l.id === currentActionLeadId);
                leads[idx].leadActions = leadActions;
                leads[idx].activities = activities;
                if (selectedLead && selectedLead.id === currentActionLeadId) {
                    selectedLead.leadActions = leadActions;
                    selectedLead.activities = activities;
                    renderLeadDetails();
                }
                saveToLocalStorage();
                renderLeadPipeline();
                closeModal('actionModal');
                alert('‚úì Action added successfully!');
            }
        }

        async function markLeadWon() {
            if (!checkPermission('write')) return;
            const leadId = currentActionLeadId;
            if (!leadId) return;
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;
            const newStage = 'won_token';
            const activity = {
                type: 'Stage Change',
                description: `Project marked as Won with Token ‚Äî moved to stage Won with Token`,
                date: new Date().toISOString(),
                by: currentUser?.email || 'Unknown'
            };
            const activities = [...(lead.activities || []), activity];
            try {
                if (db) {
                    await db.collection('leads').doc(leadId).update({ stage: newStage, activities });
                } else {
                    const idx = leads.findIndex(l => l.id === leadId);
                    leads[idx].stage = newStage;
                    leads[idx].activities = activities;
                    if (selectedLead && selectedLead.id === leadId) {
                        selectedLead.stage = newStage;
                        selectedLead.activities = activities;
                        renderLeadDetails();
                    }
                    saveToLocalStorage();
                    renderLeadPipeline();
                }
                closeModal('actionModal');
                alert('üèÜ Project marked as Won! Stage updated to "Won with Token".');
            } catch(e) { alert('Failed to update stage: ' + e.message); }
        }

        async function markLeadDropped() {
            if (!checkPermission('write')) return;
            const leadId = currentActionLeadId;
            if (!leadId) return;
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;
            if (!confirm('Mark this project as Dropped?')) return;
            const newStage = 'dropped';
            const activity = {
                type: 'Stage Change',
                description: `Project marked as Dropped`,
                date: new Date().toISOString(),
                by: currentUser?.email || 'Unknown'
            };
            const activities = [...(lead.activities || []), activity];
            try {
                if (db) {
                    await db.collection('leads').doc(leadId).update({ stage: newStage, activities });
                } else {
                    const idx = leads.findIndex(l => l.id === leadId);
                    leads[idx].stage = newStage;
                    leads[idx].activities = activities;
                    if (selectedLead && selectedLead.id === leadId) {
                        selectedLead.stage = newStage;
                        selectedLead.activities = activities;
                        renderLeadDetails();
                    }
                    saveToLocalStorage();
                    renderLeadPipeline();
                }
                closeModal('actionModal');
                alert('‚ùå Project marked as Dropped.');
            } catch(e) { alert('Failed to update stage: ' + e.message); }
        }

        async function markActionComplete(actionId) {
            if (!checkPermission('write') || !selectedLead) return;

            // Check if lead is won or dropped
            const isLeadClosed = selectedLead.stage === 'won_token' || 
                                 selectedLead.stage === 'won_material' || 
                                 selectedLead.stage === 'dropped';

            const leadActions = (selectedLead.leadActions || []).map(a => {
                if (a.id === actionId) {
                    return { ...a, status: 'completed', completedAt: new Date().toISOString() };
                }
                return a;
            });

            const completedAction = selectedLead.leadActions.find(a => a.id === actionId);
            const activity = {
                type: 'Action Completed',
                description: `${completedAction?.actionType || 'Action'} marked as completed`,
                date: new Date().toISOString(),
                by: currentUser?.email || ''
            };
            const activities = [...(selectedLead.activities || []), activity];

            try {
                if (db) {
                    await db.collection('leads').doc(selectedLead.id).update({ 
                        leadActions: leadActions,
                        activities: activities 
                    });
                } else {
                    const idx = leads.findIndex(l => l.id === selectedLead.id);
                    leads[idx].leadActions = leadActions;
                    leads[idx].activities = activities;
                    selectedLead.leadActions = leadActions;
                    selectedLead.activities = activities;
                    saveToLocalStorage();
                    renderLeadDetails();
                }

                // Update in-memory data
                selectedLead.leadActions = leadActions;
                selectedLead.activities = activities;
                renderLeadDetails();

                // If lead is still active (not won/dropped), directly show next action form
                if (!isLeadClosed) {
                    setTimeout(() => {
                        promptForLeadAction(selectedLead.id, selectedLead.contactPerson);
                    }, 300);
                }
            } catch (error) {
                console.error('Error completing action:', error);
                alert('Failed to complete action');
            }
        }

        async function saveLead() {
            if (!checkPermission('write')) return;

            const contactPerson = document.getElementById('leadContactPerson').value.trim();
            const company = document.getElementById('leadCompany').value.trim();
            const email = document.getElementById('leadEmail').value.trim();
            const phone = document.getElementById('leadPhone').value.trim();
            const leadGenDate = document.getElementById('leadGenDate').value;
            const propertyType = document.getElementById('leadPropertyType').value;
            const location = document.getElementById('leadLocation').value.trim();
            const projectType = document.getElementById('leadProjectType').value.trim();
            const value = parseFloat(document.getElementById('leadValue').value) || 0;
            const stage = document.getElementById('leadStage').value;
            const source = document.getElementById('leadSource').value;
            const sourceOther = document.getElementById('leadSourceOther').value.trim();
            const leadOwner = document.getElementById('leadOwner').value;
            const expectedCloseDate = document.getElementById('leadCloseDate').value;
            const priority = document.getElementById('leadPriority').value;
            const scopeOfWork = document.getElementById('leadScopeOfWork').value.trim();
            const notes = document.getElementById('leadNotes').value.trim();

            if (!contactPerson) {
                alert('Please enter contact person name');
                return;
            }

            if (!email) {
                alert('Please enter email');
                return;
            }

            if (!phone) {
                alert('Please enter phone number');
                return;
            }

            if (!leadGenDate) {
                alert('Please enter lead generation date');
                return;
            }

            if (!source) {
                alert('Please select lead source');
                return;
            }

            const lead = {
                contactPerson,
                company,
                email,
                phone,
                leadGenDate,
                propertyType,
                location,
                projectType,
                value,
                stage,
                source,
                sourceOther: source === 'other' ? sourceOther : '',
                leadOwner,
                expectedCloseDate,
                priority,
                scopeOfWork,
                notes,
                boqFiles: selectedBOQFiles,
                designFiles: selectedDesignFiles,
                activities: editingLeadId ? (leads.find(l => l.id === editingLeadId)?.activities || []) : [],
                createdAt: editingLeadId ? (leads.find(l => l.id === editingLeadId)?.createdAt) : new Date().toISOString(),
                createdBy: currentUser?.uid
            };

            try {
                if (editingLeadId) {
                    // Update existing lead
                    if (db) {
                        await db.collection('leads').doc(editingLeadId).update(lead);
                    } else {
                        const index = leads.findIndex(l => l.id === editingLeadId);
                        leads[index] = { ...leads[index], ...lead };
                        saveToLocalStorage();
                        renderLeadPipeline();
                        if (selectedLead && selectedLead.id === editingLeadId) {
                            selectedLead = { ...selectedLead, ...lead };
                            renderLeadDetails();
                        }
                    }
                } else {
                    // Add new lead
                    const newLead = {
                        id: Date.now().toString(),
                        ...lead
                    };

                    if (db) {
                        await db.collection('leads').doc(newLead.id).set(newLead);
                    } else {
                        leads.push(newLead);
                        saveToLocalStorage();
                        renderLeadPipeline();
                    }

                    // Prompt for first action after creating new lead
                    const wasNewLead = true;
                    const newLeadId = newLead.id;
                    const newLeadName = newLead.contactPerson;
                    
                    closeModal('leadModal');
                    editingLeadId = null;

                    // Directly show the action form for the new lead
                    setTimeout(() => {
                        promptForLeadAction(newLeadId, newLeadName);
                    }, 400);
                    return; // Exit early after new lead
                }

                closeModal('leadModal');
                editingLeadId = null;
            } catch (error) {
                console.error('Error saving lead:', error);
                alert('Failed to save lead');
            }
        }

        async function updateLeadStage(newStage) {
            if (!checkPermission('write') || !selectedLead) return;

            const oldStage = selectedLead.stage;
            
            try {
                const activity = {
                    type: 'Stage Change',
                    description: `Moved from ${leadStages.find(s => s.id === oldStage)?.label || oldStage} to ${leadStages.find(s => s.id === newStage)?.label || newStage}`,
                    date: new Date().toISOString(),
                    by: currentUser?.email || 'Unknown'
                };

                const activities = [...(selectedLead.activities || []), activity];

                if (db) {
                    await db.collection('leads').doc(selectedLead.id).update({ 
                        stage: newStage,
                        activities: activities
                    });
                } else {
                    const index = leads.findIndex(l => l.id === selectedLead.id);
                    leads[index].stage = newStage;
                    leads[index].activities = activities;
                    selectedLead.stage = newStage;
                    selectedLead.activities = activities;
                    saveToLocalStorage();
                    renderLeadPipeline();
                    renderLeadDetails();
                }
            } catch (error) {
                console.error('Error updating lead stage:', error);
                alert('Failed to update stage');
            }
        }

        async function deleteLead(id) {
            if (!checkPermission('write')) return;

            if (!confirm('Are you sure you want to delete this lead?')) return;

            try {
                if (db) {
                    await db.collection('leads').doc(id).delete();
                } else {
                    leads = leads.filter(l => l.id !== id);
                    saveToLocalStorage();
                    renderLeadPipeline();
                }

                closeLeadDetails();
            } catch (error) {
                console.error('Error deleting lead:', error);
                alert('Failed to delete lead');
            }
        }

        function filterLeads() {
            renderLeadPipeline();
        }

        function filterLeadsByStage() {
            leadStageFilter = document.getElementById('leadStageFilter').value;
            renderLeadPipeline();
        }

        // ========================================
        // TASKS TAB
        // ========================================

        function renderTasksTab() {
            // Populate owner filter
            const ownerSel = document.getElementById('taskOwnerFilter');
            if (ownerSel) {
                const savedOwner = ownerSel.value;
                const owners = [...new Set(leads.map(l => l.leadOwner).filter(Boolean))].sort();
                ownerSel.innerHTML = '<option value="all">All Owners</option>' +
                    owners.map(o => `<option value="${o}" ${savedOwner === o ? 'selected' : ''}>${o}</option>`).join('');
            }

            const statusFilter = document.getElementById('taskStatusFilter')?.value || 'all';
            const ownerFilter = document.getElementById('taskOwnerFilter')?.value || 'all';
            const search = (document.getElementById('taskSearchInput')?.value || '').toLowerCase().trim();
            const today = new Date(); today.setHours(0, 0, 0, 0);

            // Collect all actions from all leads
            const allTasks = [];
            leads.forEach(lead => {
                (lead.leadActions || []).forEach(action => {
                    if (!action.dueDate) return;
                    const due = new Date(action.dueDate); due.setHours(0, 0, 0, 0);
                    const diffDays = Math.round((due - today) / 86400000);
                    const isCompleted = action.status === 'completed';
                    const taskStatus = isCompleted ? 'completed'
                        : diffDays < 0 ? 'overdue'
                        : diffDays === 0 ? 'due_today'
                        : 'upcoming';
                    allTasks.push({ ...action, leadId: lead.id, leadName: lead.contactPerson || '', leadCompany: lead.company || '', leadOwner: lead.leadOwner || '', leadStage: lead.stage, diffDays, taskStatus });
                });
            });

            // Summary counts
            const counts = { overdue: 0, due_today: 0, upcoming: 0, completed: 0 };
            allTasks.forEach(t => counts[t.taskStatus] !== undefined && counts[t.taskStatus]++);

            const summaryEl = document.getElementById('tasksSummaryBadges');
            if (summaryEl) {
                summaryEl.innerHTML = [
                    { key: 'overdue',   icon: 'üî¥', label: 'Overdue',   color: '#dc2626', bg: '#fef2f2', border: '#fecaca', count: counts.overdue },
                    { key: 'due_today', icon: '‚ö†Ô∏è', label: 'Due Today', color: '#d97706', bg: '#fffbeb', border: '#fde68a', count: counts.due_today },
                    { key: 'upcoming',  icon: '‚è≥', label: 'Upcoming',  color: '#0369a1', bg: '#eff6ff', border: '#bfdbfe', count: counts.upcoming },
                    { key: 'completed', icon: '‚úÖ', label: 'Completed', color: '#059669', bg: '#f0fdf4', border: '#bbf7d0', count: counts.completed },
                    { key: 'all',       icon: 'üìã', label: 'Total',     color: '#374151', bg: '#f3f4f6', border: '#e5e7eb', count: allTasks.length }
                ].map(b => `
                    <div onclick="setTaskFilter('${b.key}')" style="cursor:pointer;background:${b.bg};border:1px solid ${b.border};border-radius:0.6rem;padding:0.55rem 0.9rem;text-align:center;min-width:80px;flex:1;">
                        <div style="font-size:1.3rem;font-weight:700;color:${b.color};">${b.count}</div>
                        <div style="font-size:0.72rem;color:${b.color};font-weight:600;">${b.icon} ${b.label}</div>
                    </div>`).join('');
            }

            // Filter tasks ‚Äî default 'active' excludes completed
            let filtered = allTasks;
            if (statusFilter === 'all') {
                filtered = allTasks.filter(t => t.taskStatus !== 'completed');
            } else if (statusFilter !== 'all') {
                filtered = allTasks.filter(t => t.taskStatus === statusFilter);
            }
            if (ownerFilter !== 'all') filtered = filtered.filter(t => t.leadOwner === ownerFilter);
            if (search) filtered = filtered.filter(t =>
                t.leadName.toLowerCase().includes(search) ||
                t.leadCompany.toLowerCase().includes(search) ||
                (t.actionType || '').toLowerCase().includes(search) ||
                (t.notes || '').toLowerCase().includes(search) ||
                t.leadOwner.toLowerCase().includes(search)
            );

            // Sort: overdue first (most overdue first), due_today, upcoming (soonest first), completed last
            const order = { overdue: 0, due_today: 1, upcoming: 2, completed: 3 };
            filtered.sort((a, b) => {
                if (order[a.taskStatus] !== order[b.taskStatus]) return order[a.taskStatus] - order[b.taskStatus];
                return a.diffDays - b.diffDays;
            });

            const listEl = document.getElementById('tasksList');
            if (!listEl) return;

            if (filtered.length === 0) {
                listEl.innerHTML = `<div style="padding:3rem;text-align:center;color:#9ca3af;">No tasks found</div>`;
                return;
            }

            const stageLabelMap = {};
            (leadStages || []).forEach(s => stageLabelMap[s.id] = s.label);

            listEl.innerHTML = filtered.map(task => {
                const isOverdue    = task.taskStatus === 'overdue';
                const isDueToday   = task.taskStatus === 'due_today';
                const isCompleted  = task.taskStatus === 'completed';
                const isUpcoming   = task.taskStatus === 'upcoming';

                const rowBg        = isOverdue  ? '#fff8f8' : isDueToday ? '#fffdf0' : isCompleted ? '#f6fef9' : '#ffffff';
                const accentColor  = isOverdue  ? '#dc2626' : isDueToday ? '#d97706' : isCompleted ? '#059669' : '#0369a1';

                let daysBadge = '';
                if (isOverdue)   daysBadge = `<span style="background:#dc2626;color:#fff;padding:0.15rem 0.55rem;border-radius:1rem;font-size:0.7rem;font-weight:700;">üî¥ ${Math.abs(task.diffDays)}d overdue</span>`;
                if (isDueToday)  daysBadge = `<span style="background:#d97706;color:#fff;padding:0.15rem 0.55rem;border-radius:1rem;font-size:0.7rem;font-weight:700;">‚ö†Ô∏è Due Today</span>`;
                if (isUpcoming)  daysBadge = `<span style="background:#0369a1;color:#fff;padding:0.15rem 0.55rem;border-radius:1rem;font-size:0.7rem;font-weight:700;">‚è≥ ${task.diffDays}d left</span>`;
                if (isCompleted) daysBadge = `<span style="background:#059669;color:#fff;padding:0.15rem 0.55rem;border-radius:1rem;font-size:0.7rem;font-weight:700;">‚úÖ Done</span>`;

                const dueDateStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) : '-';
                const stageLabel = stageLabelMap[task.leadStage] || task.leadStage || '';
                const completedStr = task.completedAt ? new Date(task.completedAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' }) : '';

                return `
                <div style="display:flex;align-items:stretch;border-bottom:1px solid #f0f0f0;background:${rowBg};border-left:4px solid ${accentColor};">
                    <div style="flex:1;padding:0.85rem 1rem;">
                        <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.4rem;">
                            <span style="font-weight:700;font-size:0.93rem;color:${isOverdue ? '#b91c1c' : '#111827'};">${task.actionType || 'Action'}</span>
                            ${daysBadge}
                        </div>
                        <div style="display:flex;flex-wrap:wrap;gap:0.75rem 1.5rem;font-size:0.8rem;color:#6b7280;">
                            <span>üë§ <strong style="color:#374151;">${task.leadName}</strong>${task.leadCompany ? ' ¬∑ ' + task.leadCompany : ''}</span>
                            <span>üìÖ Due: <strong style="color:#374151;">${dueDateStr}</strong></span>
                            ${task.leadOwner ? `<span>üè∑Ô∏è ${task.leadOwner}</span>` : ''}
                            <span>Stage: <span style="background:#dbeafe;color:#1e40af;padding:0.1rem 0.4rem;border-radius:0.75rem;font-size:0.7rem;font-weight:600;">${stageLabel}</span></span>
                            ${completedStr ? `<span>‚úì Completed: ${completedStr}</span>` : ''}
                        </div>
                        ${task.notes ? `<div style="margin-top:0.4rem;font-size:0.8rem;color:#374151;background:rgba(0,0,0,0.03);border-radius:0.375rem;padding:0.3rem 0.6rem;">${task.notes}</div>` : ''}
                    </div>
                    <div style="display:flex;flex-direction:column;justify-content:center;gap:0.4rem;padding:0.75rem 0.85rem;border-left:1px solid #f0f0f0;min-width:90px;">
                        <button onclick="jumpToLead('${task.leadId}')" class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem;white-space:nowrap;">üîó View Lead</button>
                        ${!isCompleted ? `<button onclick="markTaskDoneFromTab('${task.leadId}','${task.id}')" class="btn btn-success" style="padding:0.3rem 0.6rem;font-size:0.75rem;white-space:nowrap;">‚úì Mark Done</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function setTaskFilter(status) {
            const sel = document.getElementById('taskStatusFilter');
            if (sel) { sel.value = status; renderTasksTab(); }
        }

        function jumpToLead(leadId) {
            // Switch to leads tab and open that lead
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[0].classList.add('active');
            currentTab = 'leads';
            ['leadsTab','customersTab','projectsTab','usersTab','tasksTab'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            document.getElementById('leadsTab').style.display = 'block';
            document.getElementById('addCustomerBtn').style.display = 'none';
            document.getElementById('addProjectBtn').style.display = 'none';
            renderLeadPipeline();
            selectLead(leadId);
            setTimeout(() => {
                const panel = document.getElementById('leadDetailsPanelCard') || document.getElementById('leadDetailsPanel');
                if (panel) panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);
        }

        async function markTaskDoneFromTab(leadId, actionId) {
            if (!checkPermission('write')) return;
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;
            const targetAction = (lead.leadActions || []).find(a => a.id === actionId);
            if (!targetAction) return;

            const updatedActions = (lead.leadActions || []).map(a =>
                a.id === actionId ? { ...a, status: 'completed', completedAt: new Date().toISOString() } : a
            );
            const activity = {
                id: Date.now().toString(),
                type: 'Action Completed',
                description: `${targetAction.actionType} completed (from Tasks tab)`,
                date: new Date().toISOString(),
                by: currentUser?.email || ''
            };
            const updatedActivities = [...(lead.activities || []), activity];

            try {
                if (db) {
                    await db.collection('leads').doc(leadId).update({ leadActions: updatedActions, activities: updatedActivities });
                }
                // Update in-memory
                const idx = leads.findIndex(l => l.id === leadId);
                if (idx !== -1) { leads[idx].leadActions = updatedActions; leads[idx].activities = updatedActivities; }
                saveToLocalStorage();
                // Refresh selected lead details if open
                if (selectedLead && selectedLead.id === leadId) {
                    selectedLead.leadActions = updatedActions;
                    selectedLead.activities = updatedActivities;
                    renderLeadDetails();
                }
                renderTasksTab();
                // Prompt for next action if lead is still active
                const isLeadClosed = ['won_token','won_material','dropped'].includes(lead.stage);
                if (!isLeadClosed) {
                    setTimeout(() => promptForLeadAction(leadId, lead.contactPerson), 300);
                }
            } catch (e) {
                console.error('Error marking task done:', e);
                alert('Failed to mark task done: ' + e.message);
            }
        }

        function convertLeadToCustomer() {
            if (!selectedLead) return;
            const stage = selectedLead.stage;
            if (stage !== 'won_token' && stage !== 'won_material') {
                alert('Only leads marked as "Won with Token" or "Won with Material Advance" can be converted.');
                return;
            }
            showFinalQuoteModal();
        }

        function showFinalQuoteModal(editQuote, context) {
            if (!selectedLead && context !== 'project') return;
            fqEditingQuoteId = editQuote ? editQuote.id : null;
            fqEditingContext = context || 'lead';
            fqUploadedFiles = editQuote ? (editQuote.files || []) : [];

            const q = editQuote || {};
            const lead = selectedLead || {};

            document.getElementById('fqClientName').value = q.clientName || lead.contactPerson || '';
            document.getElementById('fqClientCompany').value = q.clientCompany || lead.company || '';
            document.getElementById('fqClientPhone').value = q.clientPhone || lead.phone || '';
            document.getElementById('fqClientEmail').value = q.clientEmail || lead.email || '';
            document.getElementById('fqClientAddress').value = q.clientAddress || lead.location || '';
            document.getElementById('fqScopeOfWork').value = q.scopeOfWork || lead.scopeOfWork || '';
            document.getElementById('fqProjectType').value = q.projectType || lead.projectType || '';
            document.getElementById('fqPropertyType').value = q.propertyType || lead.propertyType || '';
            document.getElementById('fqDate').value = q.date || new Date().toISOString().split('T')[0];
            document.getElementById('fqQuoteNo').value = q.quoteNo || ('QT-' + Date.now().toString().slice(-6));
            document.getElementById('fqValidDays').value = q.validDays || '30';
            document.getElementById('fqNotes').value = q.notes || '';
            document.getElementById('fqDiscount').value = q.discount || '0';

            fqItems = editQuote ? JSON.parse(JSON.stringify(editQuote.items || [])) : [];
            if (!editQuote && lead.value) {
                fqItems.push({ id: Date.now().toString(), description: lead.scopeOfWork || 'Interior Design & Execution', qty: 1, unit: 'Lump Sum', rate: parseFloat(lead.value) || 0, gstPct: 18 });
            }
            renderFQItems();
            calculateFQTotal();
            renderFQUploadedFiles();

            // Update modal title
            document.querySelector('#finalQuoteModal h2').textContent = editQuote ? '‚úèÔ∏è Edit Quote / Proposal' : 'üìã Final Quote / Proposal';
            document.querySelector('#finalQuoteModal .modal-footer .btn-primary').textContent = editQuote ? 'üíæ Update Quote' : 'üíæ Save Quote & Proceed';

            document.getElementById('finalQuoteModal').classList.add('show');
        }

        let fqItems = [];
        let fqUploadedFiles = [];
        let fqEditingQuoteId = null; // null = new quote, string = editing existing
        let fqEditingContext = null; // 'lead' or 'project'

        function addFQItem() {
            fqItems.push({ id: Date.now().toString(), description: '', qty: 1, unit: 'Sqft', rate: 0, gstPct: 18 });
            renderFQItems();
            calculateFQTotal();
        }

        function removeFQItem(id) {
            fqItems = fqItems.filter(i => i.id !== id);
            renderFQItems();
            calculateFQTotal();
        }

        function updateFQItem(id, field, value) {
            const item = fqItems.find(i => i.id === id);
            if (!item) return;
            item[field] = ['qty','rate','gstPct'].includes(field) ? parseFloat(value) || 0 : value;
            // Update just the calculated cells for this row without re-rendering
            const base = (item.qty||0) * (item.rate||0);
            const gstAmt = base * (item.gstPct||0) / 100;
            const total = base + gstAmt;
            const fmt = v => '‚Çπ' + v.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const gstEl = document.getElementById('fqGstAmt_' + id);
            const totEl = document.getElementById('fqTotal_' + id);
            if (gstEl) gstEl.value = fmt(gstAmt);
            if (totEl) totEl.value = fmt(total);
            calculateFQTotal();
        }

        function renderFQItems() {
            const container = document.getElementById('fqItemsContainer');
            if (!container) return;
            if (fqItems.length === 0) {
                container.innerHTML = `<div style="text-align:center;color:#9ca3af;padding:1rem;font-size:0.85rem;">No items yet. Click "+ Add Item" to begin.</div>`;
                return;
            }
            container.innerHTML = fqItems.map(item => {
                const base = (item.qty||0) * (item.rate||0);
                const gstAmt = base * (item.gstPct||0) / 100;
                const total = base + gstAmt;
                const fmt = v => '‚Çπ' + v.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                return `
                <div style="display:grid;grid-template-columns:2fr 60px 90px 100px 70px 90px 110px 36px;gap:0.35rem;align-items:center;padding:0.45rem 0;border-bottom:1px solid #f0f0f0;">
                    <input class="input" style="font-size:0.8rem;padding:0.3rem 0.45rem;" placeholder="Description / Work Item" value="${item.description.replace(/"/g,'&quot;')}"
                        oninput="updateFQItem('${item.id}','description',this.value)">
                    <input class="input" type="number" style="font-size:0.8rem;padding:0.3rem 0.45rem;" placeholder="Qty" value="${item.qty}"
                        oninput="updateFQItem('${item.id}','qty',this.value)">
                    <select class="input" style="font-size:0.8rem;padding:0.3rem 0.45rem;" onchange="updateFQItem('${item.id}','unit',this.value)">
                        ${['Sqft','Sqmt','Rft','Nos','Set','Lump Sum','LS'].map(u => `<option ${item.unit===u?'selected':''}>${u}</option>`).join('')}
                    </select>
                    <input class="input" type="number" style="font-size:0.8rem;padding:0.3rem 0.45rem;" placeholder="Rate ‚Çπ" value="${item.rate}"
                        oninput="updateFQItem('${item.id}','rate',this.value)">
                    <select class="input" style="font-size:0.8rem;padding:0.3rem 0.45rem;" onchange="updateFQItem('${item.id}','gstPct',this.value)">
                        ${[0,5,12,18,28].map(g => `<option value="${g}" ${(item.gstPct||0)==g?'selected':''}>${g}%</option>`).join('')}
                    </select>
                    <input id="fqGstAmt_${item.id}" class="input" style="font-size:0.8rem;padding:0.3rem 0.45rem;background:#fffbeb;" readonly value="${fmt(gstAmt)}">
                    <input id="fqTotal_${item.id}" class="input" style="font-size:0.8rem;padding:0.3rem 0.45rem;background:#f0fdf4;font-weight:600;" readonly value="${fmt(total)}">
                    <button onclick="removeFQItem('${item.id}')" style="background:#fee2e2;border:none;border-radius:0.375rem;cursor:pointer;color:#dc2626;font-size:1rem;width:36px;height:36px;">‚úï</button>
                </div>`;
            }).join('');
        }

        function calculateFQTotal() {
            const subtotal = fqItems.reduce((s, i) => s + (i.qty||0)*(i.rate||0), 0);
            const totalGST = fqItems.reduce((s, i) => {
                const base = (i.qty||0)*(i.rate||0);
                return s + base * (i.gstPct||0) / 100;
            }, 0);
            const discount = parseFloat(document.getElementById('fqDiscount')?.value) || 0;
            const grand = Math.max(0, subtotal + totalGST - discount);
            const fmt = v => '‚Çπ' + v.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const setEl = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
            setEl('fqSubtotal', fmt(subtotal));
            setEl('fqGSTDisplay', fmt(totalGST));
            setEl('fqDiscountDisplay', fmt(discount));
            setEl('fqGrandTotal', fmt(grand));
        }

        function renderFQUploadedFiles() {
            const el = document.getElementById('fqUploadedFilesList');
            if (!el) return;
            if (fqUploadedFiles.length === 0) {
                el.innerHTML = '';
                return;
            }
            el.innerHTML = fqUploadedFiles.map((f, idx) => `
                <div style="display:flex;align-items:center;gap:0.5rem;background:white;border:1px solid #fed7aa;border-radius:0.375rem;padding:0.35rem 0.6rem;margin-bottom:0.3rem;">
                    <span style="font-size:0.85rem;flex:1;">üìÑ ${f.name} <span style="color:#6b7280;font-size:0.75rem;">${f.size ? '¬∑ ' + (f.size/1024).toFixed(0) + ' KB' : ''}</span></span>
                    ${f.shareLink || f.downloadUrl ? `<a href="${f.shareLink || f.downloadUrl}" target="_blank" style="font-size:0.75rem;color:#0369a1;">View ‚Üó</a>` : ''}
                    <button onclick="removeFQFile(${idx})" style="background:none;border:none;cursor:pointer;color:#dc2626;font-size:0.85rem;padding:0 4px;">‚úï</button>
                </div>`).join('');
        }

        function removeFQFile(idx) {
            fqUploadedFiles.splice(idx, 1);
            renderFQUploadedFiles();
        }

        async function handleFQFiles(fileList) {
            const statusEl = document.getElementById('fqUploadStatus');
            if (!msalInstance) initializeOneDrive();
            if (!oneDriveAccessToken) {
                const connected = await connectOneDrive();
                if (!connected) {
                    if (statusEl) statusEl.textContent = '‚ö†Ô∏è OneDrive not connected. Files saved locally.';
                }
            }
            for (const file of Array.from(fileList)) {
                if (statusEl) statusEl.textContent = `‚è≥ Uploading ${file.name}...`;
                try {
                    const reader = new FileReader();
                    const fileData = await new Promise((res, rej) => {
                        reader.onload = e => res({ name: file.name, size: file.size, type: file.type, data: e.target.result });
                        reader.onerror = rej;
                        reader.readAsDataURL(file);
                    });
                    if (oneDriveAccessToken) {
                        const uploaded = await uploadToOneDrive(fileData, 'Quotes');
                        fqUploadedFiles.push(uploaded);
                        if (statusEl) statusEl.textContent = `‚úÖ ${file.name} uploaded to OneDrive`;
                    } else {
                        // Fallback: store base64 locally
                        fqUploadedFiles.push({ name: file.name, size: file.size, type: file.type, data: fileData.data, uploadedAt: new Date().toISOString() });
                        if (statusEl) statusEl.textContent = `‚úÖ ${file.name} saved locally (OneDrive unavailable)`;
                    }
                } catch (e) {
                    if (statusEl) statusEl.textContent = `‚ùå Failed to upload ${file.name}: ${e.message}`;
                }
                renderFQUploadedFiles();
            }
            // Clear the file input so same file can be re-selected
            const inp = document.getElementById('fqFileInput');
            if (inp) inp.value = '';
        }

        function editLeadQuote(quoteId) {
            if (!selectedLead) return;
            const q = (selectedLead.finalQuotes || []).find(q => q.id === quoteId);
            if (!q) return;
            showFinalQuoteModal(q, 'lead');
        }

        async function deleteLeadQuote(quoteId) {
            if (!selectedLead || !confirm('Delete this quote?')) return;
            try {
                const quotes = (selectedLead.finalQuotes || []).filter(q => q.id !== quoteId);
                if (db) await db.collection('leads').doc(selectedLead.id).update({ finalQuotes: quotes });
                else {
                    const idx = leads.findIndex(l => l.id === selectedLead.id);
                    if (idx !== -1) { leads[idx].finalQuotes = quotes; saveToLocalStorage(); }
                }
                selectedLead.finalQuotes = quotes;
                renderLeadDetails();
            } catch(e) { alert('Failed to delete quote: ' + e.message); }
        }

        function editProjectQuote(projectId, quoteId) {
            const proj = projects.find(p => p.id === projectId) || selectedProject;
            if (!proj) return;
            const q = (proj.quotes || []).find(q => q.id === quoteId);
            if (!q) return;
            selectedProject = proj;
            showFinalQuoteModal(q, 'project');
        }

        function showProjectQuoteModal() {
            if (!selectedProject) return;
            // Temporarily clear selectedLead so the modal works in project context
            showFinalQuoteModal(null, 'project');
        }

        async function deleteProjectQuote(projectId, quoteId) {
            const proj = projects.find(p => p.id === projectId) || selectedProject;
            if (!proj || !confirm('Delete this quote?')) return;
            try {
                const quotes = (proj.quotes || []).filter(q => q.id !== quoteId);
                if (db) await db.collection('projects').doc(proj.id).update({ quotes });
                else {
                    const idx = projects.findIndex(p => p.id === proj.id);
                    if (idx !== -1) { projects[idx].quotes = quotes; saveToLocalStorage(); }
                }
                if (selectedProject && selectedProject.id === proj.id) { selectedProject.quotes = quotes; renderProjectDetails(); }
            } catch(e) { alert('Failed to delete quote: ' + e.message); }
        }

        async function saveFinalQuote() {
            if (!selectedLead && fqEditingContext !== 'project') return;
            if (fqItems.length === 0) { alert('Please add at least one line item.'); return; }
            if (fqUploadedFiles.length === 0) { alert('‚ö†Ô∏è Please upload at least one quote document (mandatory).'); return; }

            // Read ALL form values BEFORE closing modal
            const subtotal = fqItems.reduce((s, i) => s + (i.qty||0)*(i.rate||0), 0);
            const totalGST = fqItems.reduce((s, i) => {
                const base = (i.qty||0)*(i.rate||0);
                return s + base * (i.gstPct||0) / 100;
            }, 0);
            const discount = parseFloat(document.getElementById('fqDiscount').value) || 0;
            const grand = Math.max(0, subtotal + totalGST - discount);

            const quote = {
                id: fqEditingQuoteId || Date.now().toString(),
                quoteNo: document.getElementById('fqQuoteNo').value,
                date: document.getElementById('fqDate').value,
                validDays: document.getElementById('fqValidDays').value,
                clientName: document.getElementById('fqClientName').value,
                clientCompany: document.getElementById('fqClientCompany').value,
                clientPhone: document.getElementById('fqClientPhone').value,
                clientEmail: document.getElementById('fqClientEmail').value,
                clientAddress: document.getElementById('fqClientAddress').value,
                scopeOfWork: document.getElementById('fqScopeOfWork').value,
                projectType: document.getElementById('fqProjectType').value,
                propertyType: document.getElementById('fqPropertyType').value,
                notes: document.getElementById('fqNotes').value,
                items: JSON.parse(JSON.stringify(fqItems)),
                files: JSON.parse(JSON.stringify(fqUploadedFiles)),
                subtotal, totalGST, discount, grandTotal: grand,
                updatedAt: new Date().toISOString(),
                createdBy: currentUser?.email || ''
            };
            if (!fqEditingQuoteId) quote.createdAt = new Date().toISOString();

            // Snapshot lead/project data now
            const isEditing = !!fqEditingQuoteId;
            const context = fqEditingContext;

            try {
                if (context === 'lead' && selectedLead) {
                    const leadId = selectedLead.id;
                    const leadName = selectedLead.contactPerson;
                    let quotes;
                    if (isEditing) {
                        quotes = (selectedLead.finalQuotes || []).map(q => q.id === quote.id ? quote : q);
                    } else {
                        quotes = [...(selectedLead.finalQuotes || []), quote];
                    }
                    const activity = {
                        type: isEditing ? 'Quote Updated' : 'Final Quote Created',
                        description: `Quote ${quote.quoteNo} ¬∑ Grand Total ‚Çπ${grand.toLocaleString('en-IN', {maximumFractionDigits:0})}${quote.files.length ? ` ¬∑ ${quote.files.length} file(s)` : ''}`,
                        date: new Date().toISOString(),
                        by: currentUser?.email || ''
                    };
                    const activities = [...(selectedLead.activities || []), activity];
                    if (db) {
                        await db.collection('leads').doc(leadId).update({ finalQuotes: quotes, activities });
                    } else {
                        const idx = leads.findIndex(l => l.id === leadId);
                        if (idx !== -1) { leads[idx].finalQuotes = quotes; leads[idx].activities = activities; }
                        saveToLocalStorage();
                    }
                    selectedLead.finalQuotes = quotes;
                    selectedLead.activities = activities;
                    closeModal('finalQuoteModal');
                    renderLeadDetails();

                    if (!isEditing) {
                        const doConvert = confirm(`‚úÖ Quote "${quote.quoteNo}" saved!\n\nConvert "${leadName}" to a Customer and auto-create a Project?`);
                        if (!doConvert) return;

                        // Auto-create customer
                        const newCustomer = {
                            name: leadName,
                            contact: selectedLead.phone || selectedLead.email,
                            email: selectedLead.email || '',
                            phone: selectedLead.phone || '',
                            company: selectedLead.company || '',
                            address: selectedLead.location || '',
                            payments: [], materials: [], quotes: [quote],
                            createdAt: new Date().toISOString(),
                            createdFromLead: leadId
                        };
                        let customerId = null;
                        if (db) {
                            const ref = await db.collection('customers').add(newCustomer);
                            customerId = ref.id;
                        } else {
                            customerId = Date.now().toString();
                            customers.push({ id: customerId, ...newCustomer });
                            saveToLocalStorage(); renderCustomerList();
                        }

                        // Auto-create project
                        const newProject = {
                            name: `${leadName}${selectedLead.company ? ' ‚Äì ' + selectedLead.company : ''} ‚Äì ${quote.projectType || quote.scopeOfWork || 'Project'}`,
                            customerId, customerName: leadName,
                            stage: 'won', value: grand,
                            description: quote.scopeOfWork || '',
                            startDate: new Date().toISOString().split('T')[0],
                            endDate: null,
                            quotes: [quote], payments: [], materials: [],
                            createdAt: new Date().toISOString(),
                            createdFromLead: leadId
                        };
                        let newProjectId = null;
                        if (db) {
                            const ref = await db.collection('projects').add(newProject);
                            newProjectId = ref.id;
                        } else {
                            newProjectId = (Date.now()+1).toString();
                            projects.push({ id: newProjectId, ...newProject });
                            saveToLocalStorage(); renderProjectList();
                        }
                        // Mark lead as converted
                        const linkAct = { type: 'Converted to Customer', description: `Customer & Project created. Project: ${newProject.name}`, date: new Date().toISOString(), by: currentUser?.email || '' };
                        if (db) await db.collection('leads').doc(leadId).update({ convertedToCustomerId: customerId, convertedToProjectId: newProjectId, activities: [...activities, linkAct] });

                        alert(`‚úÖ Done!\n\nCustomer & Project "${newProject.name}" created.\nNavigating to the project now.`);

                        currentTab = 'projects';
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab')[2].classList.add('active');
                        ['leadsTab','customersTab','projectsTab','usersTab','tasksTab'].forEach(id => { const el=document.getElementById(id); if(el) el.style.display='none'; });
                        document.getElementById('projectsTab').style.display = 'block';
                        document.getElementById('addCustomerBtn').style.display = 'none';
                        document.getElementById('addProjectBtn').style.display = canManageData() ? 'block' : 'none';
                        setTimeout(() => {
                            selectedProject = projects.find(p => p.id === newProjectId) || { id: newProjectId, ...newProject };
                            renderProjectList(); renderProjectDetails();
                            const panel = document.getElementById('projectDetailsPanel');
                            if (panel) panel.scrollIntoView({ behavior:'smooth', block:'start' });
                        }, 800);
                    }

                } else if (context === 'project' && selectedProject) {
                    // Edit/save quote in project context
                    let quotes;
                    if (isEditing) {
                        quotes = (selectedProject.quotes || []).map(q => q.id === quote.id ? quote : q);
                    } else {
                        quotes = [...(selectedProject.quotes || []), quote];
                    }
                    if (db) await db.collection('projects').doc(selectedProject.id).update({ quotes });
                    else {
                        const idx = projects.findIndex(p => p.id === selectedProject.id);
                        if (idx !== -1) { projects[idx].quotes = quotes; saveToLocalStorage(); }
                    }
                    selectedProject.quotes = quotes;
                    closeModal('finalQuoteModal');
                    renderProjectDetails();
                }

            } catch (e) {
                console.error('Error in saveFinalQuote:', e);
                alert('Failed to save quote: ' + e.message);
            }
        }

        function showAddActivityModal() {
            if (!checkPermission('write') || !selectedLead) return;
            promptForLeadAction(selectedLead.id, selectedLead.contactPerson);
        }

        async function addLeadActivity(type, description) {
            if (!selectedLead) return;

            const activity = {
                type: type,
                description: description,
                date: new Date().toISOString(),
                by: currentUser?.email || 'Unknown'
            };

            try {
                const activities = [...(selectedLead.activities || []), activity];

                if (db) {
                    await db.collection('leads').doc(selectedLead.id).update({ activities });
                } else {
                    const index = leads.findIndex(l => l.id === selectedLead.id);
                    leads[index].activities = activities;
                    selectedLead.activities = activities;
                    saveToLocalStorage();
                    renderLeadDetails();
                }
            } catch (error) {
                console.error('Error adding activity:', error);
                alert('Failed to add activity');
            }
        }

        // Helper to switch to projects tab and select a project
        function switchToProject(projectId) {
            currentTab = 'projects';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('customersTab').style.display = 'none';
            document.getElementById('projectsTab').style.display = 'block';
            document.getElementById('addCustomerBtn').style.display = 'none';
            document.getElementById('addProjectBtn').style.display = 'block';
            
            selectedProject = projects.find(p => p.id === projectId);
            renderProjectList();
            renderProjectDetails();
        }

        // Helper to create a new project for a customer
        function createProjectForCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('saveProjectBtn').textContent = 'Add Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectStage').value = 'won';
            document.getElementById('projectValue').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            document.getElementById('projectDescription').value = '';
            
            // Populate customer dropdown and pre-select this customer
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === customerId) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        // Delete customer
        async function deleteCustomer() {
            if (!checkPermission('write')) return;
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            try {
                if (db) {
                    await db.collection('customers').doc(selectedCustomer.id).delete();
                } else {
                    customers = customers.filter(c => c.id !== selectedCustomer.id);
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                selectedCustomer = null;
                renderDetails();
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('Failed to delete customer');
            }
        }

        // Get file icon
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.includes('pdf')) return 'üìÑ';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Download file
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Make all onclick functions globally accessible
        window.handleLogin = handleLogin;
        window.handleSignup = handleSignup;
        window.handleLogout = handleLogout;
        window.toggleAuthForm = toggleAuthForm;
        window.toggleUserMenu = toggleUserMenu;
        window.showGenerateChallanModal = showGenerateChallanModal;
        window.saveDeliveryChallan = saveDeliveryChallan;
        window.deleteDeliveryChallan = deleteDeliveryChallan;
        window.downloadChallan = downloadChallan;
        window.editDeliveryChallan = editDeliveryChallan;
        window.uploadSignedCopy = uploadSignedCopy;
        window.removeSignedCopy = removeSignedCopy;
        window.editProjectCollection = editProjectCollection;
        window.saveProjectCollection = saveProjectCollection;
        window.showInstallationModal = showInstallationModal;
        window.saveInstallation = saveInstallation;
        window.updateInstallationStatus = updateInstallationStatus;
        window.deleteInstallation = deleteInstallation;
        window.showAddLeadModal = showAddLeadModal;
        window.showEditLeadModal = showEditLeadModal;
        window.saveLead = saveLead;
        window.promptForLeadAction = promptForLeadAction;
        window.markActionComplete = markActionComplete;
        window.saveNewAction = saveNewAction;
        window.selectLead = selectLead;
        window.closeLeadDetails = closeLeadDetails;
        window.updateLeadStage = updateLeadStage;
        window.deleteLead = deleteLead;
        window.filterLeads = filterLeads;
        window.filterLeadsByStage = filterLeadsByStage;
        window.convertLeadToCustomer = convertLeadToCustomer;
        window.showAddActivityModal = showAddActivityModal;
        window.handleLeadBOQFiles = handleLeadBOQFiles;
        window.handleLeadDesignFiles = handleLeadDesignFiles;
        window.removeLeadBOQFile = removeLeadBOQFile;
        window.removeLeadDesignFile = removeLeadDesignFile;
        window.toggleLeadSourceOther = toggleLeadSourceOther;
        window.showGenerateInvoiceModal = showGenerateInvoiceModal;
        window.addInvoiceItemRow = addInvoiceItemRow;
        window.updateInvoiceItem = updateInvoiceItem;
        window.removeInvoiceItem = removeInvoiceItem;
        window.calculateInvoiceTotal = calculateInvoiceTotal;
        window.saveInvoice = saveInvoice;
        window.deleteInvoice = deleteInvoice;
        window.downloadInvoice = downloadInvoice;
        window.editInvoice = editInvoice;
        window.addMaterialItemRow = addMaterialItemRow;
        window.updateMaterialItem = updateMaterialItem;
        window.removeMaterialItem = removeMaterialItem;
        window.addSupplierPaymentRow = addSupplierPaymentRow;
        window.updateSupplierPayment = updateSupplierPayment;
        window.removeSupplierPayment = removeSupplierPayment;
        window.markLeadWon = markLeadWon;
        window.markLeadDropped = markLeadDropped;
        window.showFinalQuoteModal = showFinalQuoteModal;
        window.addFQItem = addFQItem;
        window.removeFQItem = removeFQItem;
        window.updateFQItem = updateFQItem;
        window.calculateFQTotal = calculateFQTotal;
        window.saveFinalQuote = saveFinalQuote;
        window.handleFQFiles = handleFQFiles;
        window.removeFQFile = removeFQFile;
        window.editLeadQuote = editLeadQuote;
        window.deleteLeadQuote = deleteLeadQuote;
        window.editProjectQuote = editProjectQuote;
        window.deleteProjectQuote = deleteProjectQuote;
        window.showProjectQuoteModal = showProjectQuoteModal;
        window.renderTasksTab = renderTasksTab;
        window.setTaskFilter = setTaskFilter;
        window.jumpToLead = jumpToLead;
        window.markTaskDoneFromTab = markTaskDoneFromTab;
        window.saveProjectMaterials = saveProjectMaterials;
        window.editProjectMaterial = editProjectMaterial;
    </script>
    <!-- Action Modal -->
    <div class="modal" id="actionModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="actionModalTitle">Add Action</h2>
                <button class="close-btn" onclick="closeModal('actionModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; display: block;">
                        Last Action Date: <strong id="lastActionDate" style="color: #374151;">None</strong>
                    </label>
                </div>
                <div class="form-group">
                    <label>Next Action <span style="color: red;">*</span></label>
                    <input type="text" class="input" id="nextActionType" placeholder="e.g., Call, Site Visit, Send Quotation..." style="width:100%;">
                </div>
                <div class="form-group">
                    <label>Next Action Date <span style="color: red;">*</span></label>
                    <input type="date" class="input" id="nextActionDate" style="width:100%;">
                </div>
                <div class="form-group">
                    <label>Remarks</label>
                    <textarea class="input" id="actionRemarks" rows="3" placeholder="Notes about this action..." style="width:100%;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 0.75rem;">
                <button class="btn btn-primary" onclick="saveNewAction()" style="width:100%; padding: 0.625rem;">üíæ Save Action</button>
                <div style="display: flex; gap: 0.75rem; width: 100%;">
                    <button class="btn btn-success" onclick="markLeadWon()" style="flex:1; padding: 0.625rem;">üèÜ Project Won</button>
                    <button class="btn btn-danger" onclick="markLeadDropped()" style="flex:1; padding: 0.625rem; background:#dc2626;">‚ùå Project Dropped</button>
                </div>
                <div style="font-size: 0.75rem; color: #9ca3af; text-align: center;">
                    "Project Won" and "Project Dropped" will update the lead stage and close this form.
                </div>
            </div>
        </div>
    </div>

</body>
</html>

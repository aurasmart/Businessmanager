<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Manager - Cloud Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f9fafb;
            color: #111827;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sync-status {
            font-size: 0.875rem;
            color: #16a34a;
            margin-left: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-warning {
            background: #ea580c;
            color: white;
        }

        .btn-warning:hover {
            background: #c2410c;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            padding: 0.25rem 0.5rem;
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .card-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
        }

        .card-body {
            padding: 1rem;
        }

        .search-box {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .customer-list {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .customer-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .customer-item:hover {
            background: #f9fafb;
        }

        .customer-item.active {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
        }

        .customer-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .customer-contact {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .balance {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .balance.positive {
            color: #16a34a;
        }

        .balance.negative {
            color: #dc2626;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid;
        }

        .stat-card.green {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .stat-card.orange {
            background: #fff7ed;
            border-color: #fed7aa;
        }

        .stat-card.blue {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .stat-card.red {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .list-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .list-item:hover {
            background: #f9fafb;
        }

        .empty-state {
            padding: 3rem;
            text-align: center;
            color: #6b7280;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 100%;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background: white;
            margin-top: 0.75rem;
        }

        .file-upload:hover {
            background: #f9fafb;
        }

        .selected-files {
            margin-top: 0.75rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .file-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 0.25rem;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        .close-btn:hover {
            color: #6b7280;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .item-detail {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .item-date {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .placeholder {
            padding: 4rem;
            text-align: center;
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .placeholder-subtext {
            color: #9ca3af;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .attached-file {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }

        .download-btn {
            background: none;
            border: none;
            color: #2563eb;
            cursor: pointer;
            padding: 0.25rem;
        }

        .download-btn:hover {
            color: #1d4ed8;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
            padding: 0 0.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #111827;
        }

        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-won {
            background: #d1fae5;
            color: #065f46;
        }

        .status-ongoing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-handovered {
            background: #e0e7ff;
            color: #4338ca;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .setup-notice {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .setup-notice h3 {
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .setup-notice p {
            color: #78350f;
            font-size: 0.875rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            margin: 1rem;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            color: #111827;
        }

        .login-box .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 2rem;
            font-size: 0.875rem;
        }

        .login-box .form-group {
            margin-bottom: 1.5rem;
        }

        .login-box .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .login-box .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .login-box .btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .login-toggle {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .login-toggle a {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

        .login-toggle a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .role-badge-header {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .role-admin {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-viewer {
            background: #fef3c7;
            color: #92400e;
        }

        .role-superadmin {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .user-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .user-card-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .user-card-email {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .password-display {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .copy-button:hover {
            background: #1d4ed8;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .user-button:hover {
            background: #e5e7eb;
        }

        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 100;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        .user-dropdown-item:hover {
            background: #f9fafb;
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
            color: #dc2626;
        }

        .readonly-notice {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #92400e;
        }

        /* Lead Pipeline Styles */
        .lead-pipeline {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 1rem;
            min-height: 500px;
        }

        .lead-column {
            flex: 0 0 280px;
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .lead-column-header {
            font-weight: 600;
            padding: 0.5rem;
            border-radius: 0.375rem;
            color: white;
            text-align: center;
            font-size: 0.875rem;
        }

        .lead-column-count {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-left: 0.5rem;
        }

        .lead-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lead-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .lead-card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }

        .lead-card-company {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .lead-card-value {
            font-size: 0.875rem;
            color: #16a34a;
            font-weight: 600;
        }

        .lead-card-date {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }

        .stage-new { background: #3b82f6; }
        .stage-site_survey { background: #06b6d4; }
        .stage-initial_quote { background: #8b5cf6; }
        .stage-negotiation { background: #f59e0b; }
        .stage-final_quote { background: #ec4899; }
        .stage-mockup { background: #6366f1; }
        .stage-won { background: #10b981; }
        .stage-loi { background: #14b8a6; }
        .stage-on_hold { background: #64748b; }
        .stage-dropped { background: #ef4444; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üè¢ Business Manager</h1>
            <p class="subtitle">Secure access to your business data</p>
            
            <div id="loginError" class="error-message" style="display: none;"></div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" class="input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="input" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>
                <div class="login-toggle">
               
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signupName" class="input" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" class="input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" class="input" placeholder="Min. 6 characters">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="signupRole" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="superadmin">Super Admin (User Management)</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="handleSignup()">Create Account</button>
                <div class="login-toggle">
                    Already have an account? <a onclick="toggleAuthForm()">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <div class="header" id="appHeader" style="display: none;">
        <div class="header-content">
            <div style="display: flex; align-items: center;">
                <h1>Business Manager</h1>
                <span class="sync-status" id="syncStatus">‚òÅÔ∏è Cloud Sync Active</span>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-primary" id="addCustomerBtn" onclick="showAddCustomerModal()">+ Add Customer</button>
                <button class="btn btn-primary" id="addProjectBtn" onclick="showAddProjectModal()" style="display: none;">+ Add Project</button>
                
                <!-- User Menu -->
                <div class="user-menu">
                    <button class="user-button" onclick="toggleUserMenu()">
                        <span id="userDisplayName">User</span>
                        <span class="role-badge-header" id="userRoleBadge">Viewer</span>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-item" style="cursor: default; background: #f9fafb;">
                            <div style="font-weight: 600;" id="dropdownEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d0b5bdb1b9bc90b5a8b1bda0bcb5feb3bfbd">[email&#160;protected]</a></div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;" id="dropdownRole">Role: Viewer</div>
                        </div>
                        <div class="user-dropdown-item" onclick="handleLogout()">üö™ Logout</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <div id="setupNotice" class="setup-notice" style="display: none;">
            <h3>‚ö†Ô∏è Firebase Setup Required</h3>
            <p>Please add your Firebase configuration in the script section. See SETUP_GUIDE.md for instructions.</p>
        </div>

        <div id="loadingState" class="loading">
            <div>Loading data from cloud...</div>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab" onclick="switchTab('leads')">üéØ Sales Leads</button>
                <button class="tab active" onclick="switchTab('customers')">üë• Customers</button>
                <button class="tab" onclick="switchTab('projects')">üèóÔ∏è Projects</button>
                <button class="tab" id="userManagementTab" onclick="switchTab('users')" style="display: none;">‚öôÔ∏è User Management</button>
            </div>

            <!-- Leads Tab -->
            <div id="leadsTab" style="display: none;">
                <div class="grid">
                    <!-- Lead Pipeline -->
                    <div class="card" style="grid-column: 1 / -1;">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="text" class="search-box" placeholder="üîç Search leads..." id="leadSearchInput" oninput="filterLeads()" style="margin: 0;">
                                    <select class="input" id="leadStageFilter" onchange="filterLeadsByStage()" style="width: auto; margin: 0;">
                                        <option value="all">All Stages</option>
                                        <option value="new">New</option>
                                        <option value="site_survey">Site Survey Scheduled</option>
                                        <option value="initial_quote">Initial Quote Shared</option>
                                        <option value="negotiation">Negotiation</option>
                                        <option value="final_quote">Final Quote Shared</option>
                                        <option value="mockup">Mockup</option>
                                        <option value="won">Won with Token Advance</option>
                                        <option value="loi">LOI Received</option>
                                        <option value="on_hold">On Hold</option>
                                        <option value="dropped">Dropped</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="showAddLeadModal()">+ Add Lead</button>
                            </div>
                        </div>
                        <div class="lead-pipeline" id="leadPipeline"></div>
                    </div>

                    <!-- Lead Details Panel -->
                    <div class="card" style="grid-column: 1 / -1;" id="leadDetailsPanelCard" style="display: none;">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>Lead Details</h3>
                                <button class="btn btn-secondary" onclick="closeLeadDetails()">‚úï Close</button>
                            </div>
                        </div>
                        <div id="leadDetailsPanel"></div>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customersTab" style="display: block;">
                <div class="grid">
                    <!-- Customer List -->
                    <div class="card">
                        <div class="card-header">
                            <input type="text" class="search-box" placeholder="üîç Search customers..." id="searchInput" oninput="filterCustomers()">
                        </div>
                        <div class="customer-list" id="customerList"></div>
                    </div>

                    <!-- Customer Details -->
                    <div id="detailsPanel"></div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="projectsTab" style="display: none;">
                <div class="grid">
                    <!-- Project List -->
                    <div class="card">
                        <div class="card-header">
                            <input type="text" class="search-box" placeholder="üîç Search projects..." id="projectSearchInput" oninput="filterProjects()">
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('all')">All</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('won')">Won</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('ongoing')">Ongoing</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('handovered')">Handovered</button>
                            </div>
                        </div>
                        <div class="customer-list" id="projectList"></div>
                    </div>

                    <!-- Project Details -->
                    <div id="projectDetailsPanel"></div>
                </div>
            </div>

            <!-- User Management Tab (Super Admin Only) -->
            <div id="usersTab" style="display: none;">
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>üë• User Management</h2>
                        <button class="btn btn-primary" onclick="showCreateUserModal()">+ Create User</button>
                    </div>
                    <div class="card-body">
                        <div id="usersList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal (Super Admin) -->
    <div class="modal" id="createUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New User</h2>
                <button class="close-btn" onclick="closeModal('createUserModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="createUserError" class="error-message" style="display: none;"></div>
                
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="createUserName" class="input" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="createUserEmail" class="input" placeholder="user@company.com">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="createUserRole" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="superadmin">Super Admin (User Management)</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="generateRandomPassword()" style="width: 100%;">üé≤ Generate Random Password</button>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="text" id="createUserPassword" class="input" placeholder="Min. 8 characters">
                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        User will receive this password. Ask them to change it after first login.
                    </div>
                </div>
                <div id="generatedPasswordDisplay" style="display: none;">
                    <label style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; display: block;">Generated Password:</label>
                    <div class="password-display">
                        <span id="generatedPasswordText"></span>
                        <button class="copy-button" onclick="copyPassword()">üìã Copy</button>
                    </div>
                    <div style="font-size: 0.75rem; color: #dc2626; margin-top: 0.25rem;">
                        ‚ö†Ô∏è Save this password! Share it securely with the user.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="createNewUser()" style="flex: 1">Create User</button>
            </div>
        </div>
    </div>

    <!-- Change Role Modal -->
    <div class="modal" id="changeRoleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change User Role</h2>
                <button class="close-btn" onclick="closeModal('changeRoleModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Change role for: <strong id="changeRoleUserEmail"></strong></p>
                <div class="form-group">
                    <label>New Role</label>
                    <select id="newRoleSelect" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="superadmin">Super Admin (User Management)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('changeRoleModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveRoleChange()" style="flex: 1">Save Role</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal" id="resetPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset User Password</h2>
                <button class="close-btn" onclick="closeModal('resetPasswordModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Reset password for: <strong id="resetPasswordUserEmail"></strong></p>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="generateResetPassword()" style="width: 100%;">üé≤ Generate Random Password</button>
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="text" id="resetPasswordInput" class="input" placeholder="Min. 8 characters">
                </div>
                <div id="resetPasswordDisplay" style="display: none;">
                    <label style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; display: block;">Generated Password:</label>
                    <div class="password-display">
                        <span id="resetPasswordText"></span>
                        <button class="copy-button" onclick="copyResetPassword()">üìã Copy</button>
                    </div>
                    <div style="font-size: 0.75rem; color: #dc2626; margin-top: 0.25rem;">
                        ‚ö†Ô∏è Save this password! Share it securely with the user.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="resetUserPassword()" style="flex: 1">Reset Password</button>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Customer</h2>
                <button class="close-btn" onclick="closeModal('addCustomerModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" class="input" id="newCustomerName" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label>Contact (Optional)</label>
                    <input type="text" class="input" id="newCustomerContact" placeholder="Phone or email">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addCustomerModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="addCustomer()" style="flex: 1">Add Customer</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">Add New Project</h2>
                <button class="close-btn" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" class="input" id="projectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <select class="input" id="projectCustomer">
                        <option value="">Select customer (optional)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stage *</label>
                    <select class="input" id="projectStage">
                        <option value="won">Won</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="handovered">Handovered</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project Value</label>
                    <input type="number" class="input" id="projectValue" placeholder="Enter value">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="input" id="projectStartDate">
                </div>
                <div class="form-group">
                    <label>Expected Completion</label>
                    <input type="date" class="input" id="projectEndDate">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="input" id="projectDescription" rows="3" placeholder="Project details..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()" style="flex: 1" id="saveProjectBtn">Add Project</button>
            </div>
        </div>
    </div>

    <!-- Generate Delivery Challan Modal -->
    <div class="modal" id="challanModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="challanModalTitle">Generate Delivery Challan</h2>
                <span class="close" onclick="closeModal('challanModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Challan Number*</label>
                    <input type="text" class="input" id="challanNumber" placeholder="DC-001">
                </div>
                <div class="form-group">
                    <label>Delivery Date*</label>
                    <input type="date" class="input" id="challanDeliveryDate">
                </div>
                <div class="form-group">
                    <label>Vehicle Number</label>
                    <input type="text" class="input" id="challanVehicle" placeholder="MH-01-AB-1234">
                </div>
                <div class="form-group">
                    <label>Received By</label>
                    <input type="text" class="input" id="challanReceivedBy" placeholder="Name of receiver">
                </div>
                <div class="form-group">
                    <label>Select Materials to Deliver*</label>
                    <div id="materialCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;"></div>
                </div>
                <div class="form-group">
                    <label>Remarks</label>
                    <textarea class="input" id="challanRemarks" rows="3" placeholder="Additional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('challanModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveDeliveryChallan()" style="flex: 1">Generate Challan</button>
            </div>
        </div>
    </div>

    <!-- Material Installation/Handover Modal -->
    <div class="modal" id="installationModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Add Installation / Handover</h2>
                <span class="close" onclick="closeModal('installationModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Delivered Item*</label>
                    <select class="input" id="installationItemSelect">
                        <option value="">-- Select Item --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Item Name*</label>
                    <input type="text" class="input" id="installationItemName" placeholder="Material/Item name">
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="text" class="input" id="installationQuantity" placeholder="e.g., 50 bags, 100 sq ft">
                </div>
                <div class="form-group">
                    <label>Status*</label>
                    <select class="input" id="installationStatus">
                        <option value="pending">Pending</option>
                        <option value="installed">Installed</option>
                        <option value="handed_over">Handed Over</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Installation Date</label>
                    <input type="date" class="input" id="installationDate">
                </div>
                <div class="form-group">
                    <label>Installed By</label>
                    <input type="text" class="input" id="installedBy" placeholder="Contractor/Team name">
                </div>
                <div class="form-group">
                    <label>Handover Date</label>
                    <input type="date" class="input" id="handoverDate">
                </div>
                <div class="form-group">
                    <label>Handed Over To</label>
                    <input type="text" class="input" id="handedOverTo" placeholder="Client/Customer name">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" class="input" id="installationLocation" placeholder="e.g., Bedroom 1, Kitchen">
                </div>
                <div class="form-group">
                    <label>Remarks</label>
                    <textarea class="input" id="installationRemarks" rows="3" placeholder="Additional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('installationModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-success" onclick="saveInstallation()" style="flex: 1">Save</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Lead Modal -->
    <div class="modal" id="leadModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="leadModalTitle">Add Sales Lead</h2>
                <span class="close" onclick="closeModal('leadModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Contact Person*</label>
                        <input type="text" class="input" id="leadContactPerson" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" class="input" id="leadCompany" placeholder="ABC Corporation">
                    </div>
                    <div class="form-group">
                        <label>Email*</label>
                        <input type="email" class="input" id="leadEmail" placeholder="contact@company.com">
                    </div>
                    <div class="form-group">
                        <label>Phone*</label>
                        <input type="tel" class="input" id="leadPhone" placeholder="+91 98765 43210">
                    </div>
                    <div class="form-group">
                        <label>Project Type</label>
                        <input type="text" class="input" id="leadProjectType" placeholder="e.g., Office Interior, Home Automation">
                    </div>
                    <div class="form-group">
                        <label>Estimated Value</label>
                        <input type="number" class="input" id="leadValue" placeholder="500000">
                    </div>
                    <div class="form-group">
                        <label>Stage*</label>
                        <select class="input" id="leadStage">
                            <option value="new">New</option>
                            <option value="site_survey">Site Survey Scheduled</option>
                            <option value="initial_quote">Initial Quote Shared</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="final_quote">Final Quote Shared</option>
                            <option value="mockup">Mockup</option>
                            <option value="won">Won with Token Advance</option>
                            <option value="loi">LOI Received</option>
                            <option value="on_hold">On Hold</option>
                            <option value="dropped">Dropped</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <select class="input" id="leadSource">
                            <option value="">Select source...</option>
                            <option value="website">Website</option>
                            <option value="referral">Referral</option>
                            <option value="cold_call">Cold Call</option>
                            <option value="social_media">Social Media</option>
                            <option value="exhibition">Exhibition</option>
                            <option value="email_campaign">Email Campaign</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Expected Close Date</label>
                        <input type="date" class="input" id="leadCloseDate">
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select class="input" id="leadPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Requirements/Notes</label>
                    <textarea class="input" id="leadNotes" rows="4" placeholder="Project requirements, budget constraints, timeline..."></textarea>
                </div>
                
                <!-- BOQ Files Section -->
                <div class="form-group">
                    <label>üìä BOQ (Bill of Quantities)</label>
                    <div class="file-upload" onclick="document.getElementById('leadBOQFiles').click()">
                        <div>üìé Click to upload BOQ files</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Any file type ‚Ä¢ No size limit</div>
                    </div>
                    <input type="file" id="leadBOQFiles" multiple style="display: none" onchange="handleLeadBOQFiles(this.files)">
                    <div class="selected-files" id="leadBOQFilesList"></div>
                </div>

                <!-- Design Bundle Files Section -->
                <div class="form-group">
                    <label>üé® Design Bundle</label>
                    <div class="file-upload" onclick="document.getElementById('leadDesignFiles').click()">
                        <div>üìé Click to upload design files</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Any file type ‚Ä¢ No size limit</div>
                    </div>
                    <input type="file" id="leadDesignFiles" multiple style="display: none" onchange="handleLeadDesignFiles(this.files)">
                    <div class="selected-files" id="leadDesignFilesList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('leadModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveLead()" style="flex: 1" id="saveLeadBtn">Add Lead</button>
            </div>
        </div>
    </div>

    <!-- Microsoft Authentication Library (MSAL) for OneDrive -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // ====================================
        // FIREBASE CONFIGURATION
        // Replace these values with your Firebase project settings
        // ====================================
        const firebaseConfig = {
            apiKey: "AIzaSyAn46wP_Z4ABgo-J3R-oRl-BDPJVih9IEg",
            authDomain: "business-manager-73c4e.firebaseapp.com",
            projectId: "business-manager-73c4e",
            storageBucket: "business-manager-73c4e.firebasestorage.app",
            messagingSenderId: "612350057386",
            appId: "1:612350057386:web:35c5f4d65ce0066b88e9d3"
        };

        // Initialize Firebase
        let db;
        let auth;
        let customersListener;
        let projectsListener;
        let customers = [];
        let projects = [];
        let leads = [];
        let selectedCustomer = null;
        let selectedProject = null;
        let selectedLead = null;
        let selectedFiles = [];
        let selectedBOQFiles = [];
        let selectedDesignFiles = [];
        let currentTab = 'customers';
        let projectStageFilter = 'all';
        let leadStageFilter = 'all';
        let editingProjectId = null;
        let editingLeadId = null;
        let leadsListener;
        let currentUser = null;
        let userRole = null;
        let allUsers = [];
        let selectedUserForRole = null;
        let selectedUserForPassword = null;
        
        // Backend API URL - Update this to your deployed backend URL
        const BACKEND_API_URL = 'https://business-manager-backend-production-8034.up.railway.app/api';  // Change to your production URL when deployed

        // ========================================
        // ONEDRIVE CONFIGURATION
        // ========================================
        const ONEDRIVE_CLIENT_ID = 'e17cddb9-60f6-44c5-b26f-e8d87534d112';
        const ONEDRIVE_REDIRECT_URI = 'https://aurasmart.github.io/Businessmanager/';
        const ONEDRIVE_SCOPES = ['Files.ReadWrite', 'Files.ReadWrite.All', 'User.Read', 'offline_access'];
        
        let msalInstance = null;
        let oneDriveAccessToken = null;

        // Initialize MSAL (called lazily when needed)
        function initializeOneDrive() {
            if (msalInstance) return; // Already initialized
            
            const msalConfig = {
                auth: {
                    clientId: ONEDRIVE_CLIENT_ID,
                    authority: 'https://login.microsoftonline.com/common',
                    redirectUri: ONEDRIVE_REDIRECT_URI
                },
                cache: {
                    cacheLocation: 'localStorage',
                    storeAuthStateInCookie: false
                }
            };

            msalInstance = new msal.PublicClientApplication(msalConfig);
            
            // Handle redirect response
            msalInstance.handleRedirectPromise().then(response => {
                if (response) {
                    oneDriveAccessToken = response.accessToken;
                    console.log('‚úÖ OneDrive authenticated');
                    localStorage.setItem('onedrive_connected', 'true');
                }
            }).catch(error => {
                console.error('OneDrive auth error:', error);
            });

            // Check if already authenticated
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                acquireOneDriveToken();
            }
        }

        async function connectOneDrive() {
            try {
                const loginRequest = {
                    scopes: ONEDRIVE_SCOPES
                };

                const response = await msalInstance.loginPopup(loginRequest);
                oneDriveAccessToken = response.accessToken;
                localStorage.setItem('onedrive_connected', 'true');
                alert('‚úÖ OneDrive connected successfully!');
                return true;
            } catch (error) {
                console.error('OneDrive connection error:', error);
                alert('Failed to connect OneDrive: ' + error.message);
                return false;
            }
        }

        async function acquireOneDriveToken() {
            try {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    return await connectOneDrive();
                }

                const silentRequest = {
                    scopes: ONEDRIVE_SCOPES,
                    account: accounts[0]
                };

                const response = await msalInstance.acquireTokenSilent(silentRequest);
                oneDriveAccessToken = response.accessToken;
                return true;
            } catch (error) {
                console.error('Token acquisition error:', error);
                return await connectOneDrive();
            }
        }

        async function uploadToOneDrive(file, folder) {
            // Ensure we have a token
            if (!oneDriveAccessToken) {
                const connected = await acquireOneDriveToken();
                if (!connected) {
                    throw new Error('OneDrive not connected');
                }
            }

            // Create unique filename
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substr(2, 9);
            const fileName = `lead_${timestamp}_${randomId}_${file.name}`;
            const folderPath = folder === 'boq' ? 'Business Manager Files/BOQ Files' : 'Business Manager Files/Design Files';

            try {
                // Upload file to OneDrive
                const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${folderPath}/${fileName}:/content`;
                
                // Convert base64 to blob
                const base64Data = file.data.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: file.type });

                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${oneDriveAccessToken}`,
                        'Content-Type': file.type
                    },
                    body: blob
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }

                const result = await response.json();

                // Create sharing link
                const shareUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${result.id}/createLink`;
                const shareResponse = await fetch(shareUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${oneDriveAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'view',
                        scope: 'anonymous'
                    })
                });

                const shareResult = await shareResponse.json();

                return {
                    id: result.id,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    oneDriveId: result.id,
                    webUrl: result.webUrl,
                    downloadUrl: result['@microsoft.graph.downloadUrl'],
                    shareLink: shareResult.link.webUrl,
                    uploadedAt: new Date().toISOString()
                };
            } catch (error) {
                console.error('OneDrive upload error:', error);
                throw error;
            }
        }

        // ========================================
        // AUTHENTICATION
        // ========================================

        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            }
            
            document.getElementById('loginError').style.display = 'none';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Login successful');
            } catch (error) {
                console.error('Login error:', error);
                showError(getAuthErrorMessage(error.code));
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;
            
            if (!name || !email || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update profile with name
                await userCredential.user.updateProfile({ displayName: name });
                
                // Store user role in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString()
                });
                
                console.log('‚úÖ Signup successful');
            } catch (error) {
                console.error('Signup error:', error);
                showError(getAuthErrorMessage(error.code));
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                console.log('‚úÖ Logout successful');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out');
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu && !userMenu.contains(event.target)) {
                document.getElementById('userDropdown').classList.remove('show');
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function getAuthErrorMessage(code) {
            const messages = {
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/email-already-in-use': 'Email already registered',
                'auth/weak-password': 'Password is too weak',
                'auth/invalid-email': 'Invalid email address',
                'auth/too-many-requests': 'Too many attempts. Try again later'
            };
            return messages[code] || 'Authentication error. Please try again.';
        }

        async function getUserRole(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    return userDoc.data().role || 'viewer';
                }
                return 'viewer'; // Default to viewer if no role found
            } catch (error) {
                console.error('Error getting user role:', error);
                return 'viewer';
            }
        }

        function isAdmin() {
            return userRole === 'admin' || userRole === 'superadmin';
        }

        function isSuperAdmin() {
            return userRole === 'superadmin';
        }

        function canManageData() {
            return userRole === 'admin' || userRole === 'superadmin';
        }

        function canManageUsers() {
            return userRole === 'superadmin';
        }

        function updateUIForRole() {
            const isAdminUser = isAdmin();
            const isSuperAdminUser = isSuperAdmin();
            
            // Update role badge
            const roleBadge = document.getElementById('userRoleBadge');
            if (isSuperAdminUser) {
                roleBadge.textContent = 'Super Admin';
                roleBadge.className = 'role-badge-header role-superadmin';
            } else if (isAdminUser) {
                roleBadge.textContent = 'Admin';
                roleBadge.className = 'role-badge-header role-admin';
            } else {
                roleBadge.textContent = 'Viewer';
                roleBadge.className = 'role-badge-header role-viewer';
            }
            
            // Show/hide tabs and buttons
            document.getElementById('userManagementTab').style.display = isSuperAdminUser ? 'block' : 'none';
            document.getElementById('addCustomerBtn').style.display = canManageData() ? 'block' : 'none';
            document.getElementById('addProjectBtn').style.display = (canManageData() && currentTab === 'projects') ? 'block' : 'none';
            
            // Add notices
            if (isSuperAdminUser) {
                const notice = document.createElement('div');
                notice.className = 'readonly-notice';
                notice.style.background = '#f3e8ff';
                notice.style.borderColor = '#c084fc';
                notice.style.color = '#6b21a8';
                notice.innerHTML = 'üëë <strong>Super Admin:</strong> You have full access to everything - user management AND business operations.';
                notice.id = 'readonlyNotice';
                
                const container = document.getElementById('appContainer');
                if (container && !document.getElementById('readonlyNotice')) {
                    container.insertBefore(notice, container.firstChild);
                }
            } else if (!isAdminUser) {
                const notice = document.createElement('div');
                notice.className = 'readonly-notice';
                notice.innerHTML = 'üëÅÔ∏è <strong>View-Only Access:</strong> You can view all data but cannot make changes.';
                notice.id = 'readonlyNotice';
                
                const container = document.getElementById('appContainer');
                if (container && !document.getElementById('readonlyNotice')) {
                    container.insertBefore(notice, container.firstChild);
                }
            } else {
                const notice = document.getElementById('readonlyNotice');
                if (notice) notice.remove();
            }
            
            // Re-render UI
            if (currentTab === 'customers' && selectedCustomer) {
                renderDetails();
            } else if (currentTab === 'projects' && selectedProject) {
                renderProjectDetails();
            } else if (currentTab === 'users' && isSuperAdminUser) {
                loadAllUsers();
            }
        }

        function checkPermission(action = 'write') {
            if (action === 'write' && !canManageData()) {
                alert('‚õî Permission Denied\n\nYou have view-only access. Contact an admin to make changes.');
                return false;
            }
            if (action === 'manage-users' && !isSuperAdmin()) {
                alert('‚õî Permission Denied\n\nOnly Super Admins can manage users.');
                return false;
            }
            return true;
        }

        // ========================================
        // USER MANAGEMENT (SUPER ADMIN ONLY)
        // ========================================

        async function loadAllUsers() {
            if (!isSuperAdmin()) return;
            
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    allUsers.push({
                        uid: doc.id,
                        ...doc.data()
                    });
                });
                renderUsersList();
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load users');
            }
        }

        function renderUsersList() {
            if (!isSuperAdmin()) return;
            
            const usersHtml = allUsers.length === 0 ?
                '<div class="empty-state">No users yet</div>' :
                allUsers.map(user => {
                    const roleClass = `status-${user.role}`;
                    const roleBadgeClass = user.role === 'superadmin' ? 'role-superadmin' : user.role === 'admin' ? 'role-admin' : 'role-viewer';
                    const roleLabel = user.role === 'superadmin' ? 'Super Admin' : user.role === 'admin' ? 'Admin' : 'Viewer';
                    
                    return `
                        <div class="user-card">
                            <div class="user-card-header">
                                <div>
                                    <div class="user-card-name">${user.name || 'Unnamed User'}</div>
                                    <div class="user-card-email">${user.email}</div>
                                </div>
                                <span class="status-badge ${roleBadgeClass}">${roleLabel}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                Created: ${new Date(user.createdAt).toLocaleDateString()}
                            </div>
                            ${user.uid !== currentUser.uid ? `
                                <div class="user-actions">
                                    <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="showChangeRoleModal('${user.uid}', '${user.email}', '${user.role}')">Change Role</button>
                                    <button class="btn btn-warning" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="showResetPasswordModal('${user.uid}', '${user.email}')">Reset Password</button>
                                    <button class="btn btn-danger" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="deleteUser('${user.uid}', '${user.email}')">Delete</button>
                                </div>
                            ` : '<div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem; font-style: italic;">This is your account</div>'}
                        </div>
                    `;
                }).join('');
            
            document.getElementById('usersList').innerHTML = usersHtml;
        }

        function showCreateUserModal() {
            if (!checkPermission('manage-users')) return;
            
            document.getElementById('createUserName').value = '';
            document.getElementById('createUserEmail').value = '';
            document.getElementById('createUserRole').value = 'viewer';
            document.getElementById('createUserPassword').value = '';
            document.getElementById('generatedPasswordDisplay').style.display = 'none';
            document.getElementById('createUserError').style.display = 'none';
            document.getElementById('createUserModal').classList.add('show');
        }

        function generateRandomPassword() {
            const length = 12;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('createUserPassword').value = password;
            document.getElementById('generatedPasswordText').textContent = password;
            document.getElementById('generatedPasswordDisplay').style.display = 'block';
        }

        function copyPassword() {
            const password = document.getElementById('generatedPasswordText').textContent;
            navigator.clipboard.writeText(password).then(() => {
                const btn = event.target;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy', 2000);
            });
        }

        async function createNewUser() {
            if (!checkPermission('manage-users')) return;
            
            const name = document.getElementById('createUserName').value.trim();
            const email = document.getElementById('createUserEmail').value.trim();
            const role = document.getElementById('createUserRole').value;
            const password = document.getElementById('createUserPassword').value;
            
            const errorDiv = document.getElementById('createUserError');
            
            if (!name || !email || !password) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 8) {
                errorDiv.textContent = 'Password must be at least 8 characters';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // Get current user's auth token
                const idToken = await currentUser.getIdToken();
                
                // Call backend API to create user
                const response = await fetch(`${BACKEND_API_URL}/users/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        displayName: name,
                        role: role
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create user');
                }
                
                console.log('‚úÖ User created successfully:', data);
                alert(`‚úÖ User created successfully!

Email: ${email}
Password: ${password}
Role: ${role === 'superadmin' ? 'Super Admin' : role === 'admin' ? 'Admin' : 'Viewer'}

Share these credentials securely with the user.
They can login immediately!`);
                
                closeModal('createUserModal');
                loadAllUsers();
                
            } catch (error) {
                console.error('‚ùå Error creating user:', error);
                errorDiv.textContent = 'Failed to create user: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        function showChangeRoleModal(uid, email, currentRole) {
            if (!checkPermission('manage-users')) return;
            
            selectedUserForRole = uid;
            document.getElementById('changeRoleUserEmail').textContent = email;
            document.getElementById('newRoleSelect').value = currentRole;
            document.getElementById('changeRoleModal').classList.add('show');
        }

        async function saveRoleChange() {
            if (!checkPermission('manage-users')) return;
            
            const newRole = document.getElementById('newRoleSelect').value;
            
            try {
                await db.collection('users').doc(selectedUserForRole).update({
                    role: newRole
                });
                
                console.log('‚úÖ Role updated successfully');
                alert('Role updated successfully! User will see changes on next login.');
                closeModal('changeRoleModal');
                loadAllUsers();
            } catch (error) {
                console.error('Error updating role:', error);
                alert('Failed to update role: ' + error.message);
            }
        }

        function showResetPasswordModal(uid, email) {
            if (!checkPermission('manage-users')) return;
            
            selectedUserForPassword = { uid, email };
            document.getElementById('resetPasswordUserEmail').textContent = email;
            document.getElementById('resetPasswordInput').value = '';
            document.getElementById('resetPasswordDisplay').style.display = 'none';
            document.getElementById('resetPasswordModal').classList.add('show');
        }

        function generateResetPassword() {
            const length = 12;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('resetPasswordInput').value = password;
            document.getElementById('resetPasswordText').textContent = password;
            document.getElementById('resetPasswordDisplay').style.display = 'block';
        }

        function copyResetPassword() {
            const password = document.getElementById('resetPasswordText').textContent;
            navigator.clipboard.writeText(password).then(() => {
                const btn = event.target;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy', 2000);
            });
        }

        async function resetUserPassword() {
            if (!checkPermission('manage-users')) return;
            
            const newPassword = document.getElementById('resetPasswordInput').value;
            
            if (!newPassword || newPassword.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }
            
            try {
                // Get current user's auth token
                const idToken = await currentUser.getIdToken();
                
                // Call backend API to reset password
                const response = await fetch(`${BACKEND_API_URL}/users/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        email: selectedUserForPassword.email,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to reset password');
                }
                
                console.log('‚úÖ Password reset successfully');
                alert(`‚úÖ Password reset successfully!

User: ${selectedUserForPassword.email}
New Password: ${newPassword}

Share this password securely with the user.
They can login immediately with the new password!`);
                
                closeModal('resetPasswordModal');
            } catch (error) {
                console.error('‚ùå Error resetting password:', error);
                alert('Failed to reset password: ' + error.message);
            }
        }

        async function deleteUser(uid, email) {
            if (!checkPermission('manage-users')) return;
            
            if (!confirm(`Are you sure you want to delete user: ${email}?\n\nThis will:\n- Remove from Firestore\n- Delete Firebase Authentication account\n\nThis action cannot be undone.`)) return;
            
            try {
                // Get current user's auth token
                const idToken = await currentUser.getIdToken();
                
                // Call backend API to delete user completely
                const response = await fetch(`${BACKEND_API_URL}/users/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        uid: uid
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete user');
                }
                
                console.log('‚úÖ User deleted successfully');
                alert(`‚úÖ User deleted successfully!

${email} has been completely removed from the system.`);
                
                loadAllUsers();
            } catch (error) {
                console.error('‚ùå Error deleting user:', error);
                alert('Failed to delete user: ' + error.message);
            }
        }

        // Firebase Connection Test
        async function testFirebaseConnection() {
            const results = [];
            
            try {
                results.push('üîç Starting Firebase Connection Test...\n');
                
                // Test 1: Check if Firebase is initialized
                results.push('Test 1: Firebase Initialization');
                if (!firebase.apps.length) {
                    results.push('‚ùå FAILED: Firebase not initialized');
                    results.push('   Fix: Check if firebaseConfig is correct\n');
                    alert(results.join('\n'));
                    console.log(results.join('\n'));
                    return;
                }
                results.push('‚úÖ PASSED: Firebase initialized\n');
                
                // Test 2: Check Firestore connection
                results.push('Test 2: Firestore Connection');
                if (!db) {
                    results.push('‚ùå FAILED: Firestore not connected');
                    results.push('   Fix: Check Firebase console - Firestore should be enabled\n');
                    alert(results.join('\n'));
                    console.log(results.join('\n'));
                    return;
                }
                results.push('‚úÖ PASSED: Firestore connected\n');
                
                // Test 3: Try to write test data
                results.push('Test 3: Write Test Data');
                const testDoc = {
                    testField: 'Firebase Connection Test',
                    timestamp: new Date().toISOString()
                };
                
                try {
                    const docRef = await db.collection('_test').add(testDoc);
                    results.push('‚úÖ PASSED: Successfully wrote test document');
                    results.push(`   Document ID: ${docRef.id}\n`);
                    
                    // Test 4: Try to read the data back
                    results.push('Test 4: Read Test Data');
                    const doc = await docRef.get();
                    if (doc.exists) {
                        results.push('‚úÖ PASSED: Successfully read test document');
                        results.push(`   Data: ${JSON.stringify(doc.data())}\n`);
                    } else {
                        results.push('‚ùå FAILED: Could not read test document\n');
                    }
                    
                    // Test 5: Delete test document
                    results.push('Test 5: Delete Test Data');
                    await docRef.delete();
                    results.push('‚úÖ PASSED: Successfully deleted test document\n');
                    
                    // Test 6: Check customers collection
                    results.push('Test 6: Check Customers Collection');
                    const customersSnapshot = await db.collection('customers').limit(1).get();
                    results.push(`‚úÖ PASSED: Customers collection accessible`);
                    results.push(`   Current customers: ${customersSnapshot.size}\n`);
                    
                } catch (writeError) {
                    results.push('‚ùå FAILED: ' + writeError.message);
                    
                    if (writeError.code === 'permission-denied') {
                        results.push('\nüîß FIX NEEDED: Security Rules Issue');
                        results.push('   Go to Firebase Console ‚Üí Firestore ‚Üí Rules');
                        results.push('   Replace rules with:\n');
                        results.push('   rules_version = \'2\';');
                        results.push('   service cloud.firestore {');
                        results.push('     match /databases/{database}/documents {');
                        results.push('       match /{document=**} {');
                        results.push('         allow read, write: if true;');
                        results.push('       }');
                        results.push('     }');
                        results.push('   }\n');
                    } else if (writeError.code === 'unavailable') {
                        results.push('\nüîß FIX NEEDED: Network/Connection Issue');
                        results.push('   - Check your internet connection');
                        results.push('   - Try refreshing the page');
                        results.push('   - Check if Firebase service is down\n');
                    } else {
                        results.push(`\nüîß Error Code: ${writeError.code}`);
                        results.push(`   Message: ${writeError.message}\n`);
                    }
                }
                
                results.push('\n' + '='.repeat(50));
                results.push('üìä TEST SUMMARY');
                results.push('='.repeat(50));
                
                const passed = results.filter(r => r.includes('‚úÖ PASSED')).length;
                const failed = results.filter(r => r.includes('‚ùå FAILED')).length;
                
                results.push(`Tests Passed: ${passed}`);
                results.push(`Tests Failed: ${failed}`);
                
                if (failed === 0) {
                    results.push('\nüéâ ALL TESTS PASSED!');
                    results.push('Firebase is working correctly.');
                    results.push('Your data should sync properly.');
                    document.getElementById('syncStatus').textContent = '‚úÖ Firebase Connected';
                    document.getElementById('syncStatus').style.color = '#16a34a';
                } else {
                    results.push('\n‚ö†Ô∏è  SOME TESTS FAILED');
                    results.push('Please fix the issues above.');
                    document.getElementById('syncStatus').textContent = '‚ö†Ô∏è  Connection Issue';
                    document.getElementById('syncStatus').style.color = '#ea580c';
                }
                
            } catch (error) {
                results.push('\nüí• CRITICAL ERROR:');
                results.push(error.message);
                results.push('\nStack trace:');
                results.push(error.stack);
            }
            
            // Display results
            const resultText = results.join('\n');
            console.log(resultText);
            alert(resultText);
        }

        function initializeFirebase() {
            try {
                // Check if config is set
                if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                    document.getElementById('setupNotice').style.display = 'block';
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    // Fallback to localStorage
                    loadFromLocalStorage();
                    return;
                }

                console.log('üî• Initializing Firebase...');
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log('‚úÖ Firebase initialized successfully!');
                
                // Set up authentication state listener
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üë§ User logged in:', user.email);
                        currentUser = user;
                        
                        // Get user role
                        userRole = await getUserRole(user.uid);
                        console.log('üîë User role:', userRole);
                        
                        // Update UI with user info
                        document.getElementById('userDisplayName').textContent = user.displayName || user.email.split('@')[0];
                        document.getElementById('dropdownEmail').textContent = user.email;
                        document.getElementById('dropdownRole').textContent = `Role: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`;
                        
                        // Hide login, show app
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('appHeader').style.display = 'block';
                        document.getElementById('appContainer').style.display = 'block';
                        
                        // Update UI based on role
                        updateUIForRole();
                        
                        // Initialize data listeners
                        setupDataListeners();
                    } else {
                        console.log('üë§ User logged out');
                        currentUser = null;
                        userRole = null;
                        
                        // Show login, hide app
                        document.getElementById('loginScreen').style.display = 'flex';
                        document.getElementById('appHeader').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'none';
                        
                        // Clear data
                        customers = [];
                        projects = [];
                        selectedCustomer = null;
                        selectedProject = null;
                    }
                });
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.getElementById('syncStatus').textContent = '‚ùå Offline Mode';
                loadFromLocalStorage();
            }
        }

        function setupDataListeners() {
            // Listen to real-time updates
            customersListener = db.collection('customers').onSnapshot((snapshot) => {
                console.log('üì° Received snapshot update:', snapshot.size, 'customers');
                customers = [];
                snapshot.forEach((doc) => {
                    customers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by creation date
                customers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                document.getElementById('syncStatus').style.color = '#16a34a';
                renderCustomerList();
                
                // Update selected customer if viewing one
                if (selectedCustomer) {
                    const updated = customers.find(c => c.id === selectedCustomer.id);
                    if (updated) {
                        selectedCustomer = updated;
                        renderDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Firebase snapshot error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                document.getElementById('syncStatus').textContent = '‚ùå Sync Error';
                document.getElementById('syncStatus').style.color = '#dc2626';
                
                if (error.code === 'permission-denied') {
                    alert('Logged Out');
                }
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            });

            // Listen to projects real-time updates
            projectsListener = db.collection('projects').onSnapshot((snapshot) => {
                console.log('üì° Received projects update:', snapshot.size, 'projects');
                projects = [];
                snapshot.forEach((doc) => {
                    projects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                renderProjectList();
                
                if (selectedProject) {
                    const updated = projects.find(p => p.id === selectedProject.id);
                    if (updated) {
                        selectedProject = updated;
                        renderProjectDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Projects snapshot error:', error);
            });

            // Listen to leads real-time updates
            leadsListener = db.collection('leads').onSnapshot((snapshot) => {
                console.log('üì° Received leads update:', snapshot.size, 'leads');
                leads = [];
                snapshot.forEach((doc) => {
                    leads.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by creation date
                leads.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                if (currentTab === 'leads') {
                    renderLeadPipeline();
                }
                
                // Update selected lead if viewing one
                if (selectedLead) {
                    const updated = leads.find(l => l.id === selectedLead.id);
                    if (updated) {
                        selectedLead = updated;
                        renderLeadDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Leads snapshot error:', error);
            });
        }

        // Fallback to localStorage if Firebase not configured
        function loadFromLocalStorage() {
            const customerData = localStorage.getItem('business-manager-data');
            if (customerData) {
                customers = JSON.parse(customerData);
            }
            const projectData = localStorage.getItem('business-manager-projects');
            if (projectData) {
                projects = JSON.parse(projectData);
            }
            const leadsData = localStorage.getItem('business-manager-leads');
            if (leadsData) {
                leads = JSON.parse(leadsData);
            }
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            renderCustomerList();
            renderProjectList();
            renderLeadPipeline();
            renderDetails();
        }

        function saveToLocalStorage() {
            localStorage.setItem('business-manager-data', JSON.stringify(customers));
            localStorage.setItem('business-manager-projects', JSON.stringify(projects));
            localStorage.setItem('business-manager-leads', JSON.stringify(leads));
        }

        // Add customer
        async function addCustomer() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('newCustomerName').value.trim();
            const contact = document.getElementById('newCustomerContact').value.trim();

            if (!name) {
                alert('Please enter customer name');
                return;
            }

            const newCustomer = {
                name: name,
                contact: contact,
                payments: [],
                materials: [],
                createdAt: new Date().toISOString()
            };

            try {
                console.log('üíæ Attempting to add customer:', newCustomer);
                
                if (db) {
                    console.log('üì§ Writing to Firebase...');
                    const docRef = await db.collection('customers').add(newCustomer);
                    console.log('‚úÖ Customer added to Firebase with ID:', docRef.id);
                } else {
                    console.log('üíæ No Firebase connection - saving to localStorage');
                    customers.push({
                        id: Date.now().toString(),
                        ...newCustomer
                    });
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                closeModal('addCustomerModal');
                document.getElementById('newCustomerName').value = '';
                document.getElementById('newCustomerContact').value = '';
            } catch (error) {
                console.error('‚ùå Error adding customer:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                if (error.code === 'permission-denied') {
                    alert('Logged Out');
                } else {
                    alert('Failed to add customer: ' + error.message);
                }
            }
        }

        // Render customer list
        function renderCustomerList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(search) || 
                (c.contact && c.contact.toLowerCase().includes(search))
            );

            const html = filtered.length === 0 ? 
                '<div class="empty-state">No customers found</div>' :
                filtered.map(c => {
                    const customerProjects = projects.filter(p => p.customerId === c.id);
                    const projectCount = customerProjects.length;
                    const totalValue = customerProjects.reduce((sum, p) => sum + (p.value || 0), 0);
                    const isActive = selectedCustomer && selectedCustomer.id === c.id;
                    
                    return `
                        <div class="customer-item ${isActive ? 'active' : ''}" onclick="selectCustomer('${c.id}')">
                            <div class="customer-name">${c.name}</div>
                            ${c.contact ? `<div class="customer-contact">${c.contact}</div>` : ''}
                            <div class="balance positive">
                                ${projectCount} project${projectCount !== 1 ? 's' : ''}
                                ${totalValue > 0 ? ` ‚Ä¢ ${formatCurrency(totalValue)}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('customerList').innerHTML = html;
        }

        // Select customer
        function selectCustomer(id) {
            selectedCustomer = customers.find(c => c.id === id);
            renderCustomerList();
            renderDetails();
        }

        // Calculate totals
        function calculateTotals(customer) {
            const totalPaid = (customer.payments || []).reduce((sum, p) => sum + p.amount, 0);
            const totalMaterials = (customer.materials || []).reduce((sum, m) => sum + m.cost, 0);
            return {
                totalPaid,
                totalMaterials,
                balance: totalPaid - totalMaterials
            };
        }

        // Format currency
        function formatCurrency(amount) {
            return '‚Çπ' + amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Render details panel
        function renderDetails() {
            if (!selectedCustomer) {
                document.getElementById('detailsPanel').innerHTML = `
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">üìä</div>
                            <div class="placeholder-text">Select a Customer</div>
                            <div class="placeholder-subtext">Choose a customer to view their projects</div>
                        </div>
                    </div>
                `;
                return;
            }

            // Get projects for this customer
            const customerProjects = projects.filter(p => p.customerId === selectedCustomer.id);
            
            // Calculate totals across all projects
            let totalProjectValue = 0;
            let totalPaid = 0;
            let totalMaterials = 0;
            
            customerProjects.forEach(p => {
                if (p.value) totalProjectValue += p.value;
                if (p.payments) totalPaid += p.payments.reduce((sum, pay) => sum + pay.amount, 0);
                if (p.materials) totalMaterials += p.materials.reduce((sum, mat) => sum + mat.cost, 0);
            });
            
            const balance = totalPaid - totalMaterials;

            const projectsHtml = customerProjects.length === 0 ?
                '<div class="empty-state">No projects for this customer yet</div>' :
                customerProjects.map(p => {
                    const stageClass = `status-${p.stage}`;
                    const stageLabel = p.stage.charAt(0).toUpperCase() + p.stage.slice(1);
                    const projectPayments = (p.payments || []).reduce((sum, pay) => sum + pay.amount, 0);
                    const projectMaterials = (p.materials || []).reduce((sum, mat) => sum + mat.cost, 0);
                    const projectBalance = projectPayments - projectMaterials;
                    
                    return `
                        <div class="list-item" style="cursor: pointer;" onclick="switchToProject('${p.id}')">
                            <div class="item-info" style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div class="item-title">${p.name}</div>
                                    <span class="status-badge ${stageClass}">${stageLabel}</span>
                                </div>
                                ${p.value ? `<div class="item-detail">üí∞ Project Value: ${formatCurrency(p.value)}</div>` : ''}
                                <div class="item-detail">
                                    Paid: ${formatCurrency(projectPayments)} | Materials: ${formatCurrency(projectMaterials)} | 
                                    <span style="color: ${projectBalance >= 0 ? '#16a34a' : '#dc2626'}; font-weight: 600;">
                                        Balance: ${formatCurrency(projectBalance)}
                                    </span>
                                </div>
                                ${p.startDate ? `<div class="item-date">Started: ${new Date(p.startDate).toLocaleDateString()}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('detailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Customer Info -->
                    <div class="card">
                        <div class="card-header">
                            <h2>${selectedCustomer.name}</h2>
                        </div>
                        <div class="card-body">
                            ${selectedCustomer.contact ? `
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Contact</div>
                                    <div style="font-weight: 600;">üìû ${selectedCustomer.contact}</div>
                                </div>
                            ` : ''}
                            <div style="font-size: 0.75rem; color: #9ca3af;">
                                Customer since: ${formatDate(selectedCustomer.createdAt)}
                            </div>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="stats">
                        <div class="stat-card green">
                            <div class="stat-label" style="color: #16a34a">Total Projects</div>
                            <div class="stat-value" style="color: #15803d">${customerProjects.length}</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-label" style="color: #2563eb">Total Value</div>
                            <div class="stat-value" style="color: #1d4ed8">${formatCurrency(totalProjectValue)}</div>
                        </div>
                        <div class="stat-card ${balance >= 0 ? 'blue' : 'red'}">
                            <div class="stat-label" style="color: ${balance >= 0 ? '#2563eb' : '#dc2626'}">Net Balance</div>
                            <div class="stat-value" style="color: ${balance >= 0 ? '#1d4ed8' : '#b91c1c'}">${formatCurrency(balance)}</div>
                        </div>
                    </div>

                    <!-- Projects List -->
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>üèóÔ∏è Projects</h3>
                            ${isAdmin() ? `<button class="btn btn-primary" onclick="createProjectForCustomer('${selectedCustomer.id}')" style="font-size: 0.875rem; padding: 0.5rem 1rem;">+ New Project</button>` : ''}
                        </div>
                        <div>${projectsHtml}</div>
                    </div>

                    ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteCustomer()">Delete Customer</button>` : ''}
                </div>
            `;
        }

        // Add payment
        async function addPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const note = document.getElementById('paymentNote').value.trim();
            const date = document.getElementById('paymentDate').value;

            if (!amount || amount <= 0) {
                alert('Please enter valid amount');
                return;
            }

            const payment = {
                id: Date.now().toString(),
                amount: amount,
                note: note,
                paymentDate: date || new Date().toISOString(),
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const payments = [...(selectedCustomer.payments || []), payment];
                    await db.collection('customers').doc(selectedCustomer.id).update({ payments });
                } else {
                    selectedCustomer.payments = [...(selectedCustomer.payments || []), payment];
                    saveToLocalStorage();
                    renderDetails();
                }

                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentNote').value = '';
                document.getElementById('paymentDate').value = '';
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Failed to add payment');
            }
        }

        // Delete payment
        async function deletePayment(id) {
            try {
                if (db) {
                    const payments = (selectedCustomer.payments || []).filter(p => p.id !== id);
                    await db.collection('customers').doc(selectedCustomer.id).update({ payments });
                } else {
                    selectedCustomer.payments = (selectedCustomer.payments || []).filter(p => p.id !== id);
                    saveToLocalStorage();
                    renderCustomerList();
                    renderDetails();
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Failed to delete payment');
            }
        }

        // Handle file selection
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 2 * 1024 * 1024) {
                    alert(file.name + ' is too large (max 2MB)');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFiles.push({
                        id: Date.now().toString() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderSelectedFiles();
                };
                reader.readAsDataURL(file);
            });
        }

        // Render selected files
        function renderSelectedFiles() {
            if (selectedFiles.length === 0) {
                document.getElementById('selectedFiles').innerHTML = '';
                return;
            }

            const html = `
                <div style="margin-top: 0.75rem;">
                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Selected Files:</div>
                    ${selectedFiles.map(f => `
                        <div class="file-item">
                            ${f.type.startsWith('image/') ?
                                `<img src="${f.data}" class="file-thumbnail" alt="${f.name}">` :
                                `<div class="file-icon">${getFileIcon(f.type)}</div>`
                            }
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.875rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFile('${f.id}')">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('selectedFiles').innerHTML = html;
        }

        // Remove file
        function removeFile(id) {
            selectedFiles = selectedFiles.filter(f => f.id !== id);
            renderSelectedFiles();
        }

        // Get file icon
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.includes('pdf')) return 'üìÑ';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Download file
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add material
        async function addMaterial() {
            const name = document.getElementById('materialName').value.trim();
            const cost = parseFloat(document.getElementById('materialCost').value);
            const quantity = document.getElementById('materialQuantity').value.trim();
            const date = document.getElementById('materialDate').value;

            if (!name || !cost || cost <= 0) {
                alert('Please enter valid material details');
                return;
            }

            const material = {
                id: Date.now().toString(),
                name: name,
                cost: cost,
                quantity: quantity,
                procurementDate: date || new Date().toISOString(),
                files: [...selectedFiles],
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const materials = [...(selectedCustomer.materials || []), material];
                    await db.collection('customers').doc(selectedCustomer.id).update({ materials });
                } else {
                    selectedCustomer.materials = [...(selectedCustomer.materials || []), material];
                    saveToLocalStorage();
                    renderDetails();
                }

                document.getElementById('materialName').value = '';
                document.getElementById('materialCost').value = '';
                document.getElementById('materialQuantity').value = '';
                document.getElementById('materialDate').value = '';
                selectedFiles = [];
            } catch (error) {
                console.error('Error adding material:', error);
                alert('Failed to add material');
            }
        }

        // Delete material
        async function deleteMaterial(id) {
            try {
                if (db) {
                    const materials = (selectedCustomer.materials || []).filter(m => m.id !== id);
                    await db.collection('customers').doc(selectedCustomer.id).update({ materials });
                } else {
                    selectedCustomer.materials = (selectedCustomer.materials || []).filter(m => m.id !== id);
                    saveToLocalStorage();
                    renderCustomerList();
                    renderDetails();
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material');
            }
        }

        // Delete customer
        async function deleteCustomer() {
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            try {
                if (db) {
                    await db.collection('customers').doc(selectedCustomer.id).delete();
                } else {
                    customers = customers.filter(c => c.id !== selectedCustomer.id);
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                selectedCustomer = null;
                renderDetails();
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('Failed to delete customer');
            }
        }

        // Filter customers
        function filterCustomers() {
            renderCustomerList();
        }

        // Show modal
        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('show');
        }

        // Close modal
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // ========================================
        // TAB SWITCHING
        // ========================================
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content
            if (tab === 'leads') {
                document.getElementById('leadsTab').style.display = 'block';
                document.getElementById('customersTab').style.display = 'none';
                document.getElementById('projectsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('addCustomerBtn').style.display = 'none';
                document.getElementById('addProjectBtn').style.display = 'none';
                renderLeadPipeline();
            } else if (tab === 'customers') {
                document.getElementById('leadsTab').style.display = 'none';
                document.getElementById('customersTab').style.display = 'block';
                document.getElementById('projectsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('addCustomerBtn').style.display = canManageData() ? 'block' : 'none';
                document.getElementById('addProjectBtn').style.display = 'none';
            } else if (tab === 'projects') {
                document.getElementById('leadsTab').style.display = 'none';
                document.getElementById('customersTab').style.display = 'none';
                document.getElementById('projectsTab').style.display = 'block';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('addCustomerBtn').style.display = 'none';
                document.getElementById('addProjectBtn').style.display = canManageData() ? 'block' : 'none';
            } else if (tab === 'users') {
                document.getElementById('leadsTab').style.display = 'none';
                document.getElementById('customersTab').style.display = 'none';
                document.getElementById('projectsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'block';
                document.getElementById('addCustomerBtn').style.display = 'none';
                document.getElementById('addProjectBtn').style.display = 'none';
                if (isSuperAdmin()) {
                    loadAllUsers();
                }
            }
        }

        // ========================================
        // PROJECT MANAGEMENT
        // ========================================
        
        function showAddProjectModal() {
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('saveProjectBtn').textContent = 'Add Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectCustomer').value = '';
            document.getElementById('projectStage').value = 'won';
            document.getElementById('projectValue').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            document.getElementById('projectDescription').value = '';
            
            // Populate customer dropdown
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        function showEditProjectModal(project) {
            editingProjectId = project.id;
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('saveProjectBtn').textContent = 'Update Project';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectCustomer').value = project.customerId || '';
            document.getElementById('projectStage').value = project.stage;
            document.getElementById('projectValue').value = project.value || '';
            document.getElementById('projectStartDate').value = project.startDate ? project.startDate.split('T')[0] : '';
            document.getElementById('projectEndDate').value = project.endDate ? project.endDate.split('T')[0] : '';
            document.getElementById('projectDescription').value = project.description || '';
            
            // Populate customer dropdown
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === project.customerId) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        async function saveProject() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('projectName').value.trim();
            const customerId = document.getElementById('projectCustomer').value;
            const stage = document.getElementById('projectStage').value;
            const value = parseFloat(document.getElementById('projectValue').value) || 0;
            const startDate = document.getElementById('projectStartDate').value;
            const endDate = document.getElementById('projectEndDate').value;
            const description = document.getElementById('projectDescription').value.trim();

            if (!name) {
                alert('Please enter project name');
                return;
            }

            const projectData = {
                name,
                customerId,
                customerName: customerId ? customers.find(c => c.id === customerId)?.name : '',
                stage,
                value,
                startDate: startDate || null,
                endDate: endDate || null,
                description,
                updatedAt: new Date().toISOString()
            };

            try {
                if (editingProjectId) {
                    // Update existing project
                    console.log('üìù Updating project:', editingProjectId);
                    if (db) {
                        await db.collection('projects').doc(editingProjectId).update(projectData);
                    } else {
                        const index = projects.findIndex(p => p.id === editingProjectId);
                        if (index !== -1) {
                            projects[index] = { ...projects[index], ...projectData };
                        }
                        saveToLocalStorage();
                        renderProjectList();
                    }
                } else {
                    // Add new project
                    projectData.createdAt = new Date().toISOString();
                    console.log('üíæ Adding new project:', projectData);
                    
                    if (db) {
                        await db.collection('projects').add(projectData);
                    } else {
                        projects.push({
                            id: Date.now().toString(),
                            ...projectData
                        });
                        saveToLocalStorage();
                        renderProjectList();
                    }
                }

                closeModal('projectModal');
            } catch (error) {
                console.error('‚ùå Error saving project:', error);
                alert('Failed to save project: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            if (!checkPermission('write')) return;
            if (!confirm('Are you sure you want to delete this project?')) return;
            
            try {
                if (db) {
                    await db.collection('projects').doc(projectId).delete();
                } else {
                    projects = projects.filter(p => p.id !== projectId);
                    saveToLocalStorage();
                    renderProjectList();
                }
                
                if (selectedProject?.id === projectId) {
                    selectedProject = null;
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project');
            }
        }

        async function updateProjectStage(projectId, newStage) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    await db.collection('projects').doc(projectId).update({ 
                        stage: newStage,
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    const project = projects.find(p => p.id === projectId);
                    if (project) {
                        project.stage = newStage;
                        project.updatedAt = new Date().toISOString();
                        saveToLocalStorage();
                        renderProjectList();
                        if (selectedProject?.id === projectId) {
                            selectedProject.stage = newStage;
                            renderProjectDetails();
                        }
                    }
                }
                console.log('‚úÖ Updated project stage to:', newStage);
            } catch (error) {
                console.error('Error updating stage:', error);
                alert('Failed to update project stage');
            }
        }

        function selectProject(id) {
            selectedProject = projects.find(p => p.id === id);
            renderProjectList();
            renderProjectDetails();
        }

        function filterProjects() {
            renderProjectList();
        }

        function filterProjectsByStage(stage) {
            projectStageFilter = stage;
            renderProjectList();
        }

        function renderProjectList() {
            const search = document.getElementById('projectSearchInput')?.value.toLowerCase() || '';
            let filtered = projects.filter(p => 
                p.name.toLowerCase().includes(search) || 
                (p.customerName && p.customerName.toLowerCase().includes(search)) ||
                (p.description && p.description.toLowerCase().includes(search))
            );

            if (projectStageFilter !== 'all') {
                filtered = filtered.filter(p => p.stage === projectStageFilter);
            }

            const html = filtered.length === 0 ? 
                '<div class="empty-state">No projects found</div>' :
                filtered.map(p => {
                    const isActive = selectedProject && selectedProject.id === p.id;
                    const stageClass = `status-${p.stage}`;
                    const stageLabel = p.stage.charAt(0).toUpperCase() + p.stage.slice(1);
                    
                    return `
                        <div class="customer-item ${isActive ? 'active' : ''}" onclick="selectProject('${p.id}')">
                            <div class="project-header">
                                <div class="customer-name">${p.name}</div>
                                <span class="status-badge ${stageClass}">${stageLabel}</span>
                            </div>
                            ${p.customerName ? `<div class="customer-contact">üë§ ${p.customerName}</div>` : ''}
                            ${p.value ? `<div class="customer-contact">üí∞ ${formatCurrency(p.value)}</div>` : ''}
                        </div>
                    `;
                }).join('');

            const listElement = document.getElementById('projectList');
            if (listElement) {
                listElement.innerHTML = html;
            }
        }

        function renderProjectDetails() {
            if (!selectedProject) {
                document.getElementById('projectDetailsPanel').innerHTML = `
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">üèóÔ∏è</div>
                            <div class="placeholder-text">Select a Project</div>
                            <div class="placeholder-subtext">Choose a project to manage payments and materials</div>
                        </div>
                    </div>
                `;
                return;
            }

            const stageClass = `status-${selectedProject.stage}`;
            const stageLabel = selectedProject.stage.charAt(0).toUpperCase() + selectedProject.stage.slice(1);

            // Calculate project financials
            const payments = selectedProject.payments || [];
            const materials = selectedProject.materials || [];
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const totalMaterials = materials.reduce((sum, m) => sum + m.cost, 0);
            const balance = totalPaid - totalMaterials;
            const balanceColor = balance >= 0 ? 'blue' : 'red';
            const balanceLabel = balance >= 0 ? 'Balance' : 'Outstanding';

            const paymentsHtml = payments.length === 0 ?
                '<div class="empty-state">No payments yet</div>' :
                payments.map(p => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">${formatCurrency(p.amount)}</div>
                            ${p.note ? `<div class="item-detail">${p.note}</div>` : ''}
                            <div class="item-date">Received: ${p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : formatDate(p.date)}</div>
                        </div>
                        ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteProjectPayment('${p.id}')">Delete</button>` : ''}
                    </div>
                `).join('');

            const materialsHtml = materials.length === 0 ?
                '<div class="empty-state">No materials yet</div>' :
                materials.map(m => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">${m.name}${m.quantity ? ` (${m.quantity})` : ''}</div>
                            <div class="item-detail">${formatCurrency(m.cost)}</div>
                            <div class="item-date">Procured: ${m.procurementDate ? new Date(m.procurementDate).toLocaleDateString() : formatDate(m.date)}</div>
                            ${m.files && m.files.length > 0 ? `
                                <div class="files-grid">
                                    ${m.files.map(f => `
                                        <div class="attached-file">
                                            <div class="file-icon">${f.type && f.type.startsWith('image/') ? 'üñºÔ∏è' : getFileIcon(f.type)}</div>
                                            <div style="flex: 1; min-width: 0; overflow: hidden;">
                                                <div style="font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                                                <div style="font-size: 0.7rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                                            </div>
                                            <a href="${f.downloadUrl || f.data}" download="${f.name}" target="_blank" class="download-btn" title="Download from OneDrive">‚¨áÔ∏è</a>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteProjectMaterial('${m.id}')">Delete</button>` : ''}
                    </div>
                `).join('');

            // Delivery Challans HTML
            const deliveryChallans = selectedProject.deliveryChallans || [];
            const deliveryChallansHtml = deliveryChallans.length === 0 ?
                '<div class="empty-state">No delivery challans yet</div>' :
                deliveryChallans.map(dc => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">Challan #${dc.challanNumber}</div>
                            <div class="item-detail">
                                üìÖ Date: ${new Date(dc.deliveryDate).toLocaleDateString()}
                                ${dc.vehicleNumber ? ` | üöõ Vehicle: ${dc.vehicleNumber}` : ''}
                            </div>
                            <div class="item-date">
                                <strong>Items:</strong> ${dc.items.map(item => `${item.name} (${item.quantity})`).join(', ')}
                            </div>
                            ${dc.receivedBy ? `<div class="item-date">Received by: ${dc.receivedBy}</div>` : ''}
                            ${dc.remarks ? `<div class="item-date">Remarks: ${dc.remarks}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="downloadChallan('${dc.id}')">üìÑ Download PDF</button>
                            ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteDeliveryChallan('${dc.id}')">Delete</button>` : ''}
                        </div>
                    </div>
                `).join('');

            // Material Installed/Handover HTML
            const installations = selectedProject.installations || [];
            const installationsHtml = installations.length === 0 ?
                '<div class="empty-state">No installations/handovers yet</div>' :
                installations.map(inst => {
                    const statusColors = {
                        'installed': 'green',
                        'handed_over': 'blue',
                        'pending': 'orange'
                    };
                    const statusLabels = {
                        'installed': 'Installed',
                        'handed_over': 'Handed Over',
                        'pending': 'Pending'
                    };
                    const statusColor = statusColors[inst.status] || 'gray';
                    const statusLabel = statusLabels[inst.status] || inst.status;
                    
                    return `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">
                                ${inst.itemName}
                                <span class="status-badge ${statusColor}" style="display: inline-block; margin-left: 0.5rem; font-size: 0.75rem;">
                                    ${statusLabel}
                                </span>
                            </div>
                            <div class="item-detail">
                                ${inst.installationDate ? `üîß Installed: ${new Date(inst.installationDate).toLocaleDateString()}` : ''}
                                ${inst.installationDate && inst.handoverDate ? ' | ' : ''}
                                ${inst.handoverDate ? `‚úÖ Handed Over: ${new Date(inst.handoverDate).toLocaleDateString()}` : ''}
                            </div>
                            ${inst.quantity ? `<div class="item-date">Quantity: ${inst.quantity}</div>` : ''}
                            ${inst.installedBy ? `<div class="item-date">Installed by: ${inst.installedBy}</div>` : ''}
                            ${inst.handedOverTo ? `<div class="item-date">Handed over to: ${inst.handedOverTo}</div>` : ''}
                            ${inst.location ? `<div class="item-date">Location: ${inst.location}</div>` : ''}
                            ${inst.remarks ? `<div class="item-date">Remarks: ${inst.remarks}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            ${isAdmin() ? `
                                <button class="btn btn-secondary" onclick="updateInstallationStatus('${inst.id}')">Update Status</button>
                                <button class="btn btn-danger" onclick="deleteInstallation('${inst.id}')">Delete</button>
                            ` : ''}
                        </div>
                    </div>
                `}).join('');

            document.getElementById('projectDetailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Project Header -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2>${selectedProject.name}</h2>
                                <span class="status-badge ${stageClass}">${stageLabel}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; gap: 1rem;">
                                ${selectedProject.customerName ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Customer</div>
                                        <div style="font-weight: 600;">üë§ ${selectedProject.customerName}</div>
                                    </div>
                                ` : ''}
                                
                                ${selectedProject.value ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Project Value</div>
                                        <div style="font-weight: 600; font-size: 1.25rem; color: #16a34a;">${formatCurrency(selectedProject.value)}</div>
                                    </div>
                                ` : ''}

                                <div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Update Stage</div>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button class="btn ${selectedProject.stage === 'won' ? 'btn-success' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'won')">Won</button>
                                        <button class="btn ${selectedProject.stage === 'ongoing' ? 'btn-primary' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'ongoing')">Ongoing</button>
                                        <button class="btn ${selectedProject.stage === 'handovered' ? 'btn-secondary' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'handovered')" style="background: #6366f1;">Handovered</button>
                                    </div>
                                </div>

                                ${selectedProject.startDate || selectedProject.endDate ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Timeline</div>
                                        <div>
                                            ${selectedProject.startDate ? `üìÖ Start: ${new Date(selectedProject.startDate).toLocaleDateString()}` : ''}
                                            ${selectedProject.startDate && selectedProject.endDate ? ' ‚Üí ' : ''}
                                            ${selectedProject.endDate ? `üèÅ End: ${new Date(selectedProject.endDate).toLocaleDateString()}` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                ${selectedProject.description ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Description</div>
                                        <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">${selectedProject.description}</div>
                                    </div>
                                ` : ''}

                                ${isAdmin() ? `
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button class="btn btn-primary" onclick="showEditProjectModal(selectedProject)" style="flex: 1">‚úèÔ∏è Edit Project</button>
                                        <button class="btn btn-danger" onclick="deleteProject('${selectedProject.id}')">üóëÔ∏è Delete</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Financial Summary -->
                    <div class="stats">
                        <div class="stat-card green">
                            <div class="stat-label" style="color: #16a34a">Total Paid</div>
                            <div class="stat-value" style="color: #15803d">${formatCurrency(totalPaid)}</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-label" style="color: #ea580c">Materials Cost</div>
                            <div class="stat-value" style="color: #c2410c">${formatCurrency(totalMaterials)}</div>
                        </div>
                        <div class="stat-card ${balanceColor}">
                            <div class="stat-label" style="color: ${balanceColor === 'blue' ? '#2563eb' : '#dc2626'}">${balanceLabel}</div>
                            <div class="stat-value" style="color: ${balanceColor === 'blue' ? '#1d4ed8' : '#b91c1c'}">${formatCurrency(Math.abs(balance))}</div>
                        </div>
                    </div>

                    <!-- Payments Section -->
                    <div class="card">
                        <div class="card-header">üí∞ Payments Received</div>
                        ${isAdmin() ? `
                            <div class="card-body">
                                <div class="form-grid">
                                    <input type="number" class="input" id="projectPaymentAmount" placeholder="Amount">
                                    <input type="text" class="input" id="projectPaymentNote" placeholder="Note (optional)">
                                    <input type="date" class="input" id="projectPaymentDate">
                                    <button class="btn btn-success" onclick="addProjectPayment()">Add Payment</button>
                                </div>
                            </div>
                        ` : ''}
                        <div>${paymentsHtml}</div>
                    </div>

                    <!-- Materials Section -->
                    <div class="card">
                        <div class="card-header">üì¶ Materials Procured</div>
                        ${isAdmin() ? `
                            <div class="card-body">
                                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))">
                                    <input type="text" class="input" id="projectMaterialName" placeholder="Material name">
                                    <input type="number" class="input" id="projectMaterialCost" placeholder="Cost">
                                    <input type="text" class="input" id="projectMaterialQuantity" placeholder="Quantity">
                                    <input type="date" class="input" id="projectMaterialDate">
                                    <button class="btn btn-warning" onclick="addProjectMaterial()">Add Material</button>
                                </div>
                                <div class="file-upload" onclick="document.getElementById('projectFileInput').click()">
                                    <div>üìé Click to upload files to OneDrive</div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Any file type, any size</div>
                                </div>
                                <input type="file" id="projectFileInput" multiple style="display: none" onchange="handleProjectFiles(this.files)">
                                <div class="selected-files" id="projectSelectedFiles"></div>
                            </div>
                        ` : ''}
                        <div>${materialsHtml}</div>
                    </div>

                    <!-- Delivery Challan Section -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>üöö Delivery Challans</span>
                                ${isAdmin() && materials.length > 0 ? `
                                    <button class="btn btn-primary" onclick="showGenerateChallanModal()">+ Generate Challan</button>
                                ` : ''}
                            </div>
                        </div>
                        <div>${deliveryChallansHtml}</div>
                    </div>

                    <!-- Material Installed/Handover Section -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>‚úÖ Material Installed / Handover</span>
                                ${isAdmin() && deliveryChallans.length > 0 ? `
                                    <button class="btn btn-success" onclick="showInstallationModal()">+ Add Installation/Handover</button>
                                ` : ''}
                            </div>
                        </div>
                        <div>${installationsHtml}</div>
                    </div>
                </div>
            `;
        }

        // Initialize
        initializeFirebase();

        // ========================================
        // PROJECT PAYMENTS & MATERIALS
        // ========================================

        async function addProjectPayment() {
            if (!checkPermission('write')) return;
            
            const amount = parseFloat(document.getElementById('projectPaymentAmount').value);
            const note = document.getElementById('projectPaymentNote').value.trim();
            const date = document.getElementById('projectPaymentDate').value;

            if (!amount || amount <= 0) {
                alert('Please enter valid amount');
                return;
            }

            const payment = {
                id: Date.now().toString(),
                amount: amount,
                note: note,
                paymentDate: date || new Date().toISOString(),
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const payments = [...(selectedProject.payments || []), payment];
                    await db.collection('projects').doc(selectedProject.id).update({ payments });
                } else {
                    selectedProject.payments = [...(selectedProject.payments || []), payment];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                document.getElementById('projectPaymentAmount').value = '';
                document.getElementById('projectPaymentNote').value = '';
                document.getElementById('projectPaymentDate').value = '';
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Failed to add payment');
            }
        }

        async function deleteProjectPayment(id) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    const payments = (selectedProject.payments || []).filter(p => p.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ payments });
                } else {
                    selectedProject.payments = (selectedProject.payments || []).filter(p => p.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Failed to delete payment');
            }
        }

        async function handleProjectFiles(files) {
            for (const file of Array.from(files)) {
                // Initialize OneDrive if not already done
                if (!msalInstance) {
                    initializeOneDrive();
                }
                
                // Check OneDrive connection
                if (!oneDriveAccessToken) {
                    const connected = await connectOneDrive();
                    if (!connected) {
                        alert('Please connect OneDrive to upload files');
                        return;
                    }
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };

                        // Show upload progress
                        document.getElementById('syncStatus').textContent = `Uploading ${file.name} to OneDrive...`;

                        // Upload to OneDrive (using 'materials' folder)
                        const folderPath = 'Business Manager Files/Materials';
                        const timestamp = Date.now();
                        const randomId = Math.random().toString(36).substr(2, 9);
                        const fileName = `material_${timestamp}_${randomId}_${file.name}`;
                        const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${folderPath}/${fileName}:/content`;
                        
                        // Convert base64 to blob
                        const base64Data = fileData.data.split(',')[1];
                        const byteCharacters = atob(base64Data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: file.type });

                        const response = await fetch(uploadUrl, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${oneDriveAccessToken}`,
                                'Content-Type': file.type
                            },
                            body: blob
                        });

                        if (!response.ok) {
                            throw new Error(`Upload failed: ${response.statusText}`);
                        }

                        const result = await response.json();

                        // Create sharing link
                        const shareUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${result.id}/createLink`;
                        const shareResponse = await fetch(shareUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${oneDriveAccessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                type: 'view',
                                scope: 'anonymous'
                            })
                        });

                        const shareResult = await shareResponse.json();

                        const oneDriveFile = {
                            id: result.id,
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            oneDriveId: result.id,
                            webUrl: result.webUrl,
                            downloadUrl: result['@microsoft.graph.downloadUrl'],
                            shareLink: shareResult.link.webUrl,
                            uploadedAt: new Date().toISOString()
                        };
                        
                        selectedFiles.push(oneDriveFile);
                        renderProjectSelectedFiles();

                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert(`Failed to upload ${file.name}: ${error.message}`);
                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function renderProjectSelectedFiles() {
            if (selectedFiles.length === 0) {
                document.getElementById('projectSelectedFiles').innerHTML = '';
                return;
            }

            const html = `
                <div style="margin-top: 0.75rem;">
                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Uploaded Files:</div>
                    ${selectedFiles.map(f => `
                        <div class="file-item">
                            <div class="file-icon">${f.type && f.type.startsWith('image/') ? 'üñºÔ∏è' : getFileIcon(f.type)}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.875rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(f.size)} ‚Ä¢ OneDrive</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFile('${f.id || f.oneDriveId}')">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('projectSelectedFiles').innerHTML = html;
        }

        async function addProjectMaterial() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('projectMaterialName').value.trim();
            const cost = parseFloat(document.getElementById('projectMaterialCost').value);
            const quantity = document.getElementById('projectMaterialQuantity').value.trim();
            const date = document.getElementById('projectMaterialDate').value;

            if (!name || !cost || cost <= 0) {
                alert('Please enter valid material details');
                return;
            }

            const material = {
                id: Date.now().toString(),
                name: name,
                cost: cost,
                quantity: quantity,
                procurementDate: date || new Date().toISOString(),
                files: [...selectedFiles],
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const materials = [...(selectedProject.materials || []), material];
                    await db.collection('projects').doc(selectedProject.id).update({ materials });
                } else {
                    selectedProject.materials = [...(selectedProject.materials || []), material];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                document.getElementById('projectMaterialName').value = '';
                document.getElementById('projectMaterialCost').value = '';
                document.getElementById('projectMaterialQuantity').value = '';
                document.getElementById('projectMaterialDate').value = '';
                selectedFiles = [];
            } catch (error) {
                console.error('Error adding material:', error);
                alert('Failed to add material');
            }
        }

        async function deleteProjectMaterial(id) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    const materials = (selectedProject.materials || []).filter(m => m.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ materials });
                } else {
                    selectedProject.materials = (selectedProject.materials || []).filter(m => m.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material');
            }
        }

        // ========================================
        // DELIVERY CHALLAN FUNCTIONS
        // ========================================

        function showGenerateChallanModal() {
            if (!checkPermission('write')) return;
            
            const materials = selectedProject.materials || [];
            if (materials.length === 0) {
                alert('No materials available to create delivery challan');
                return;
            }

            // Populate material checkboxes
            const checkboxContainer = document.getElementById('materialCheckboxes');
            checkboxContainer.innerHTML = materials.map(m => `
                <div style="padding: 0.5rem; border-bottom: 1px solid #f3f4f6;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${m.id}" data-name="${m.name}" data-quantity="${m.quantity || ''}" style="margin-right: 0.5rem;">
                        <span>${m.name}${m.quantity ? ` (${m.quantity})` : ''}</span>
                    </label>
                </div>
            `).join('');

            // Set default challan number
            const challanCount = (selectedProject.deliveryChallans || []).length + 1;
            document.getElementById('challanNumber').value = `DC-${String(challanCount).padStart(3, '0')}`;
            
            // Set today's date
            document.getElementById('challanDeliveryDate').value = new Date().toISOString().split('T')[0];

            document.getElementById('challanModal').classList.add('show');
        }

        async function saveDeliveryChallan() {
            if (!checkPermission('write')) return;

            const challanNumber = document.getElementById('challanNumber').value.trim();
            const deliveryDate = document.getElementById('challanDeliveryDate').value;
            const vehicleNumber = document.getElementById('challanVehicle').value.trim();
            const receivedBy = document.getElementById('challanReceivedBy').value.trim();
            const remarks = document.getElementById('challanRemarks').value.trim();

            if (!challanNumber) {
                alert('Please enter challan number');
                return;
            }

            if (!deliveryDate) {
                alert('Please select delivery date');
                return;
            }

            // Get selected materials
            const checkboxes = document.querySelectorAll('#materialCheckboxes input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one material');
                return;
            }

            const selectedItems = Array.from(checkboxes).map(cb => ({
                id: cb.value,
                name: cb.dataset.name,
                quantity: cb.dataset.quantity
            }));

            const challan = {
                id: Date.now().toString(),
                challanNumber: challanNumber,
                deliveryDate: deliveryDate,
                vehicleNumber: vehicleNumber,
                receivedBy: receivedBy,
                remarks: remarks,
                items: selectedItems,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.uid
            };

            try {
                if (db) {
                    const deliveryChallans = [...(selectedProject.deliveryChallans || []), challan];
                    await db.collection('projects').doc(selectedProject.id).update({ deliveryChallans });
                } else {
                    selectedProject.deliveryChallans = [...(selectedProject.deliveryChallans || []), challan];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                closeModal('challanModal');
                alert('‚úÖ Delivery Challan generated successfully!');
            } catch (error) {
                console.error('Error generating challan:', error);
                alert('Failed to generate delivery challan');
            }
        }

        async function deleteDeliveryChallan(id) {
            if (!checkPermission('write')) return;

            if (!confirm('Delete this delivery challan?')) return;

            try {
                if (db) {
                    const deliveryChallans = (selectedProject.deliveryChallans || []).filter(dc => dc.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ deliveryChallans });
                } else {
                    selectedProject.deliveryChallans = (selectedProject.deliveryChallans || []).filter(dc => dc.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting challan:', error);
                alert('Failed to delete delivery challan');
            }
        }

        function downloadChallan(id) {
            const challan = (selectedProject.deliveryChallans || []).find(dc => dc.id === id);
            if (!challan) return;

            // Create challan HTML for PDF
            const challanHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Delivery Challan ${challan.challanNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #333; padding-bottom: 20px; }
                        .company-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
                        .challan-title { font-size: 20px; color: #666; }
                        .info-section { margin: 20px 0; }
                        .info-row { display: flex; margin: 10px 0; }
                        .label { font-weight: bold; width: 150px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f3f4f6; font-weight: bold; }
                        .footer { margin-top: 50px; border-top: 2px solid #333; padding-top: 20px; }
                        .signature { margin-top: 60px; }
                        .signature-line { border-top: 1px solid #333; width: 200px; display: inline-block; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">AURA SMART</div>
                        <div class="challan-title">DELIVERY CHALLAN</div>
                    </div>

                    <div class="info-section">
                        <div class="info-row">
                            <div class="label">Challan No:</div>
                            <div>${challan.challanNumber}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Date:</div>
                            <div>${new Date(challan.deliveryDate).toLocaleDateString()}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Project:</div>
                            <div>${selectedProject.name}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Customer:</div>
                            <div>${selectedProject.customerName || '-'}</div>
                        </div>
                        ${challan.vehicleNumber ? `
                        <div class="info-row">
                            <div class="label">Vehicle No:</div>
                            <div>${challan.vehicleNumber}</div>
                        </div>
                        ` : ''}
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">Sr. No.</th>
                                <th>Item Description</th>
                                <th style="width: 150px;">Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${challan.items.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.name}</td>
                                    <td>${item.quantity || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    ${challan.remarks ? `
                    <div class="info-section">
                        <div class="label">Remarks:</div>
                        <div>${challan.remarks}</div>
                    </div>
                    ` : ''}

                    <div class="footer">
                        <div class="signature">
                            <div>Delivered By</div>
                            <div class="signature-line"></div>
                        </div>
                        <div class="signature" style="float: right;">
                            <div>Received By${challan.receivedBy ? `: ${challan.receivedBy}` : ''}</div>
                            <div class="signature-line"></div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            // Create a new window and print
            const printWindow = window.open('', '_blank');
            printWindow.document.write(challanHTML);
            printWindow.document.close();
            printWindow.print();
        }

        // ========================================
        // MATERIAL INSTALLATION/HANDOVER FUNCTIONS
        // ========================================

        function showInstallationModal() {
            if (!checkPermission('write')) return;

            const deliveryChallans = selectedProject.deliveryChallans || [];
            if (deliveryChallans.length === 0) {
                alert('No delivered items available. Please create a delivery challan first.');
                return;
            }

            // Populate item dropdown from delivery challans
            const itemSelect = document.getElementById('installationItemSelect');
            const allItems = [];
            deliveryChallans.forEach(dc => {
                dc.items.forEach(item => {
                    allItems.push({
                        name: item.name,
                        quantity: item.quantity,
                        challanId: dc.id
                    });
                });
            });

            itemSelect.innerHTML = '<option value="">-- Select Item --</option>' +
                allItems.map((item, index) => 
                    `<option value="${index}" data-name="${item.name}" data-quantity="${item.quantity}">${item.name}${item.quantity ? ` (${item.quantity})` : ''}</option>`
                ).join('');

            // Auto-fill item name when selected
            itemSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('installationItemName').value = selectedOption.dataset.name;
                    document.getElementById('installationQuantity').value = selectedOption.dataset.quantity || '';
                }
            });

            // Set today's date for installation
            document.getElementById('installationDate').value = new Date().toISOString().split('T')[0];

            document.getElementById('installationModal').classList.add('show');
        }

        async function saveInstallation() {
            if (!checkPermission('write')) return;

            const itemName = document.getElementById('installationItemName').value.trim();
            const quantity = document.getElementById('installationQuantity').value.trim();
            const status = document.getElementById('installationStatus').value;
            const installationDate = document.getElementById('installationDate').value;
            const installedBy = document.getElementById('installedBy').value.trim();
            const handoverDate = document.getElementById('handoverDate').value;
            const handedOverTo = document.getElementById('handedOverTo').value.trim();
            const location = document.getElementById('installationLocation').value.trim();
            const remarks = document.getElementById('installationRemarks').value.trim();

            if (!itemName) {
                alert('Please enter item name');
                return;
            }

            const installation = {
                id: Date.now().toString(),
                itemName: itemName,
                quantity: quantity,
                status: status,
                installationDate: installationDate || null,
                installedBy: installedBy,
                handoverDate: handoverDate || null,
                handedOverTo: handedOverTo,
                location: location,
                remarks: remarks,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.uid
            };

            try {
                if (db) {
                    const installations = [...(selectedProject.installations || []), installation];
                    await db.collection('projects').doc(selectedProject.id).update({ installations });
                } else {
                    selectedProject.installations = [...(selectedProject.installations || []), installation];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                closeModal('installationModal');
                
                // Clear form
                document.getElementById('installationItemSelect').value = '';
                document.getElementById('installationItemName').value = '';
                document.getElementById('installationQuantity').value = '';
                document.getElementById('installationStatus').value = 'pending';
                document.getElementById('installationDate').value = '';
                document.getElementById('installedBy').value = '';
                document.getElementById('handoverDate').value = '';
                document.getElementById('handedOverTo').value = '';
                document.getElementById('installationLocation').value = '';
                document.getElementById('installationRemarks').value = '';

                alert('‚úÖ Installation/Handover record added successfully!');
            } catch (error) {
                console.error('Error saving installation:', error);
                alert('Failed to save installation record');
            }
        }

        async function updateInstallationStatus(id) {
            if (!checkPermission('write')) return;

            const installation = (selectedProject.installations || []).find(inst => inst.id === id);
            if (!installation) return;

            const statuses = ['pending', 'installed', 'handed_over'];
            const currentIndex = statuses.indexOf(installation.status);
            const nextStatus = statuses[(currentIndex + 1) % statuses.length];

            try {
                if (db) {
                    const installations = (selectedProject.installations || []).map(inst => {
                        if (inst.id === id) {
                            const updated = {...inst, status: nextStatus};
                            // Auto-set dates based on status
                            if (nextStatus === 'installed' && !updated.installationDate) {
                                updated.installationDate = new Date().toISOString().split('T')[0];
                            }
                            if (nextStatus === 'handed_over' && !updated.handoverDate) {
                                updated.handoverDate = new Date().toISOString().split('T')[0];
                            }
                            return updated;
                        }
                        return inst;
                    });
                    await db.collection('projects').doc(selectedProject.id).update({ installations });
                } else {
                    selectedProject.installations = (selectedProject.installations || []).map(inst => {
                        if (inst.id === id) {
                            const updated = {...inst, status: nextStatus};
                            if (nextStatus === 'installed' && !updated.installationDate) {
                                updated.installationDate = new Date().toISOString().split('T')[0];
                            }
                            if (nextStatus === 'handed_over' && !updated.handoverDate) {
                                updated.handoverDate = new Date().toISOString().split('T')[0];
                            }
                            return updated;
                        }
                        return inst;
                    });
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error updating installation status:', error);
                alert('Failed to update status');
            }
        }

        async function deleteInstallation(id) {
            if (!checkPermission('write')) return;

            if (!confirm('Delete this installation/handover record?')) return;

            try {
                if (db) {
                    const installations = (selectedProject.installations || []).filter(inst => inst.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ installations });
                } else {
                    selectedProject.installations = (selectedProject.installations || []).filter(inst => inst.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting installation:', error);
                alert('Failed to delete installation record');
            }
        }

        // ========================================
        // SALES LEADS MANAGEMENT
        // ========================================

        const leadStages = [
            { id: 'new', label: 'New', color: 'stage-new' },
            { id: 'site_survey', label: 'Site Survey Scheduled', color: 'stage-site_survey' },
            { id: 'initial_quote', label: 'Initial Quote Shared', color: 'stage-initial_quote' },
            { id: 'negotiation', label: 'Negotiation', color: 'stage-negotiation' },
            { id: 'final_quote', label: 'Final Quote Shared', color: 'stage-final_quote' },
            { id: 'mockup', label: 'Mockup', color: 'stage-mockup' },
            { id: 'won', label: 'Won with Token Advance', color: 'stage-won' },
            { id: 'loi', label: 'LOI Received', color: 'stage-loi' },
            { id: 'on_hold', label: 'On Hold', color: 'stage-on_hold' },
            { id: 'dropped', label: 'Dropped', color: 'stage-dropped' }
        ];

        function renderLeadPipeline() {
            const pipeline = document.getElementById('leadPipeline');
            if (!pipeline) return;

            const searchTerm = document.getElementById('leadSearchInput')?.value.toLowerCase() || '';
            const stageFilter = leadStageFilter;

            pipeline.innerHTML = leadStages.map(stage => {
                const stageLeads = leads.filter(lead => {
                    const matchesStage = stageFilter === 'all' || lead.stage === stage.id;
                    const matchesSearch = !searchTerm || 
                        lead.contactPerson.toLowerCase().includes(searchTerm) ||
                        (lead.company && lead.company.toLowerCase().includes(searchTerm)) ||
                        (lead.email && lead.email.toLowerCase().includes(searchTerm)) ||
                        (lead.phone && lead.phone.toLowerCase().includes(searchTerm));
                    
                    return lead.stage === stage.id && matchesStage && matchesSearch;
                });

                return `
                    <div class="lead-column">
                        <div class="lead-column-header ${stage.color}">
                            ${stage.label}
                            <span class="lead-column-count">(${stageLeads.length})</span>
                        </div>
                        ${stageLeads.length === 0 ? 
                            '<div style="text-align: center; color: #9ca3af; font-size: 0.875rem; padding: 1rem;">No leads</div>' :
                            stageLeads.map(lead => `
                                <div class="lead-card" onclick="selectLead('${lead.id}')">
                                    <div class="lead-card-title">${lead.contactPerson}</div>
                                    ${lead.company ? `<div class="lead-card-company">üè¢ ${lead.company}</div>` : ''}
                                    ${lead.projectType ? `<div class="lead-card-company">üìã ${lead.projectType}</div>` : ''}
                                    ${lead.value ? `<div class="lead-card-value">‚Çπ${formatCurrency(lead.value)}</div>` : ''}
                                    <div class="lead-card-date">Created: ${formatDate(lead.createdAt)}</div>
                                </div>
                            `).join('')
                        }
                    </div>
                `;
            }).join('');
        }

        function selectLead(id) {
            selectedLead = leads.find(l => l.id === id);
            if (!selectedLead) return;

            const card = document.getElementById('leadDetailsPanelCard');
            card.style.display = 'block';

            renderLeadDetails();
        }

        function closeLeadDetails() {
            selectedLead = null;
            document.getElementById('leadDetailsPanelCard').style.display = 'none';
        }

        function renderLeadDetails() {
            if (!selectedLead) return;

            const stage = leadStages.find(s => s.id === selectedLead.stage);
            const stageLabel = stage ? stage.label : selectedLead.stage;
            const stageClass = stage ? stage.color : '';

            const activities = selectedLead.activities || [];

            document.getElementById('leadDetailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem; padding: 1.5rem;">
                    <!-- Lead Header -->
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h2 style="margin: 0 0 0.5rem 0;">${selectedLead.contactPerson}</h2>
                            ${selectedLead.company ? `<p style="margin: 0; color: #6b7280;">üè¢ ${selectedLead.company}</p>` : ''}
                        </div>
                        <span class="status-badge ${stageClass}" style="font-size: 0.875rem;">${stageLabel}</span>
                    </div>

                    <!-- Lead Info Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        ${selectedLead.email ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Email</div>
                                <div>üìß ${selectedLead.email}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.phone ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Phone</div>
                                <div>üìû ${selectedLead.phone}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.projectType ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Project Type</div>
                                <div>üìã ${selectedLead.projectType}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.value ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Estimated Value</div>
                                <div style="font-weight: 600; color: #16a34a;">‚Çπ${formatCurrency(selectedLead.value)}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.source ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Source</div>
                                <div>üìç ${selectedLead.source}</div>
                            </div>
                        ` : ''}
                        ${selectedLead.priority ? `
                            <div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Priority</div>
                                <div>${selectedLead.priority === 'high' ? 'üî¥' : selectedLead.priority === 'medium' ? 'üü°' : 'üü¢'} ${selectedLead.priority.charAt(0).toUpperCase() + selectedLead.priority.slice(1)}</div>
                            </div>
                        ` : ''}
                    </div>

                    ${selectedLead.notes ? `
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Requirements/Notes</div>
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">${selectedLead.notes}</div>
                        </div>
                    ` : ''}

                    <!-- BOQ Files -->
                    ${selectedLead.boqFiles && selectedLead.boqFiles.length > 0 ? `
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">üìä BOQ Files (${selectedLead.boqFiles.length})</div>
                            <div class="files-grid">
                                ${selectedLead.boqFiles.map(f => `
                                    <div class="attached-file">
                                        <div class="file-icon">${getFileIcon(f.type)}</div>
                                        <div style="flex: 1; min-width: 0; overflow: hidden;">
                                            <div style="font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                                            <div style="font-size: 0.7rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                                        </div>
                                        <a href="${f.downloadUrl || f.data}" download="${f.name}" target="_blank" class="download-btn" title="Download from OneDrive">‚¨áÔ∏è</a>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Design Files -->
                    ${selectedLead.designFiles && selectedLead.designFiles.length > 0 ? `
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">üé® Design Bundle (${selectedLead.designFiles.length})</div>
                            <div class="files-grid">
                                ${selectedLead.designFiles.map(f => `
                                    <div class="attached-file">
                                        <div class="file-icon">${f.type && f.type.startsWith('image/') ? 'üñºÔ∏è' : getFileIcon(f.type)}</div>
                                        <div style="flex: 1; min-width: 0; overflow: hidden;">
                                            <div style="font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                                            <div style="font-size: 0.7rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                                        </div>
                                        <a href="${f.downloadUrl || f.data}" download="${f.name}" target="_blank" class="download-btn" title="Download from OneDrive">‚¨áÔ∏è</a>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${isAdmin() ? `
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <select class="input" style="flex: 1; min-width: 200px;" onchange="updateLeadStage(this.value)">
                                ${leadStages.map(s => `
                                    <option value="${s.id}" ${selectedLead.stage === s.id ? 'selected' : ''}>${s.label}</option>
                                `).join('')}
                            </select>
                            <button class="btn btn-primary" onclick="showEditLeadModal()">‚úèÔ∏è Edit</button>
                            <button class="btn btn-secondary" onclick="showAddActivityModal()">+ Add Activity</button>
                            ${selectedLead.stage === 'won' ? `
                                <button class="btn btn-success" onclick="convertLeadToCustomer()">Convert to Customer</button>
                            ` : ''}
                            <button class="btn btn-danger" onclick="deleteLead('${selectedLead.id}')">üóëÔ∏è Delete</button>
                        </div>
                    ` : ''}

                    <!-- Activities -->
                    <div>
                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Activity Timeline</div>
                        ${activities.length === 0 ? 
                            '<div style="text-align: center; color: #9ca3af; padding: 1rem;">No activities yet</div>' :
                            activities.map(activity => `
                                <div style="border-left: 2px solid #e5e7eb; padding-left: 1rem; margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; font-weight: 600;">${activity.type}</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">${formatDate(activity.date)}</div>
                                    <div style="margin-top: 0.25rem;">${activity.description}</div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        }

        // ========================================
        // LEAD FILE HANDLING
        // ========================================

        async function handleLeadBOQFiles(files) {
            for (const file of Array.from(files)) {
                // Initialize OneDrive if not already done
                if (!msalInstance) {
                    initializeOneDrive();
                }
                
                // Check OneDrive connection
                if (!oneDriveAccessToken) {
                    const connected = await connectOneDrive();
                    if (!connected) {
                        alert('Please connect OneDrive to upload files');
                        return;
                    }
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };

                        // Show upload progress
                        document.getElementById('syncStatus').textContent = `Uploading ${file.name} to OneDrive...`;

                        // Upload to OneDrive
                        const oneDriveFile = await uploadToOneDrive(fileData, 'boq');
                        
                        selectedBOQFiles.push(oneDriveFile);
                        displayLeadBOQFiles();

                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert(`Failed to upload ${file.name}: ${error.message}`);
                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleLeadDesignFiles(files) {
            for (const file of Array.from(files)) {
                // Initialize OneDrive if not already done
                if (!msalInstance) {
                    initializeOneDrive();
                }
                
                // Check OneDrive connection
                if (!oneDriveAccessToken) {
                    const connected = await connectOneDrive();
                    if (!connected) {
                        alert('Please connect OneDrive to upload files');
                        return;
                    }
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        };

                        // Show upload progress
                        document.getElementById('syncStatus').textContent = `Uploading ${file.name} to OneDrive...`;

                        // Upload to OneDrive
                        const oneDriveFile = await uploadToOneDrive(fileData, 'design');
                        
                        selectedDesignFiles.push(oneDriveFile);
                        displayLeadDesignFiles();

                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert(`Failed to upload ${file.name}: ${error.message}`);
                        document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function displayLeadBOQFiles() {
            const container = document.getElementById('leadBOQFilesList');
            if (!container) return;

            container.innerHTML = selectedBOQFiles.map((file, index) => `
                <div class="attached-file">
                    <div class="file-icon">${getFileIcon(file.type)}</div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.875rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="removeLeadBOQFile(${index})">‚úï</button>
                </div>
            `).join('');
        }

        function displayLeadDesignFiles() {
            const container = document.getElementById('leadDesignFilesList');
            if (!container) return;

            container.innerHTML = selectedDesignFiles.map((file, index) => `
                <div class="attached-file">
                    ${file.type.startsWith('image/') ? 
                        `<img src="${file.data}" class="file-thumbnail" alt="${file.name}">` :
                        `<div class="file-icon">${getFileIcon(file.type)}</div>`
                    }
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.875rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="removeLeadDesignFile(${index})">‚úï</button>
                </div>
            `).join('');
        }

        function removeLeadBOQFile(index) {
            selectedBOQFiles.splice(index, 1);
            displayLeadBOQFiles();
        }

        function removeLeadDesignFile(index) {
            selectedDesignFiles.splice(index, 1);
            displayLeadDesignFiles();
        }

        function showAddLeadModal() {
            if (!checkPermission('write')) return;

            editingLeadId = null;
            document.getElementById('leadModalTitle').textContent = 'Add Sales Lead';
            document.getElementById('saveLeadBtn').textContent = 'Add Lead';
            
            // Clear form
            document.getElementById('leadContactPerson').value = '';
            document.getElementById('leadCompany').value = '';
            document.getElementById('leadEmail').value = '';
            document.getElementById('leadPhone').value = '';
            document.getElementById('leadProjectType').value = '';
            document.getElementById('leadValue').value = '';
            document.getElementById('leadStage').value = 'new';
            document.getElementById('leadSource').value = '';
            document.getElementById('leadCloseDate').value = '';
            document.getElementById('leadPriority').value = 'medium';
            document.getElementById('leadNotes').value = '';

            // Clear files
            selectedBOQFiles = [];
            selectedDesignFiles = [];
            displayLeadBOQFiles();
            displayLeadDesignFiles();

            document.getElementById('leadModal').classList.add('show');
        }

        function showEditLeadModal() {
            if (!checkPermission('write') || !selectedLead) return;

            editingLeadId = selectedLead.id;
            document.getElementById('leadModalTitle').textContent = 'Edit Sales Lead';
            document.getElementById('saveLeadBtn').textContent = 'Update Lead';

            // Fill form with existing data
            document.getElementById('leadContactPerson').value = selectedLead.contactPerson || '';
            document.getElementById('leadCompany').value = selectedLead.company || '';
            document.getElementById('leadEmail').value = selectedLead.email || '';
            document.getElementById('leadPhone').value = selectedLead.phone || '';
            document.getElementById('leadProjectType').value = selectedLead.projectType || '';
            document.getElementById('leadValue').value = selectedLead.value || '';
            document.getElementById('leadStage').value = selectedLead.stage || 'new';
            document.getElementById('leadSource').value = selectedLead.source || '';
            document.getElementById('leadCloseDate').value = selectedLead.expectedCloseDate || '';
            document.getElementById('leadPriority').value = selectedLead.priority || 'medium';
            document.getElementById('leadNotes').value = selectedLead.notes || '';

            // Load existing files
            selectedBOQFiles = selectedLead.boqFiles || [];
            selectedDesignFiles = selectedLead.designFiles || [];
            displayLeadBOQFiles();
            displayLeadDesignFiles();

            document.getElementById('leadModal').classList.add('show');
        }

        async function saveLead() {
            if (!checkPermission('write')) return;

            const contactPerson = document.getElementById('leadContactPerson').value.trim();
            const company = document.getElementById('leadCompany').value.trim();
            const email = document.getElementById('leadEmail').value.trim();
            const phone = document.getElementById('leadPhone').value.trim();
            const projectType = document.getElementById('leadProjectType').value.trim();
            const value = parseFloat(document.getElementById('leadValue').value) || 0;
            const stage = document.getElementById('leadStage').value;
            const source = document.getElementById('leadSource').value;
            const expectedCloseDate = document.getElementById('leadCloseDate').value;
            const priority = document.getElementById('leadPriority').value;
            const notes = document.getElementById('leadNotes').value.trim();

            if (!contactPerson) {
                alert('Please enter contact person name');
                return;
            }

            if (!email) {
                alert('Please enter email');
                return;
            }

            if (!phone) {
                alert('Please enter phone number');
                return;
            }

            const lead = {
                contactPerson,
                company,
                email,
                phone,
                projectType,
                value,
                stage,
                source,
                expectedCloseDate,
                priority,
                notes,
                boqFiles: selectedBOQFiles,
                designFiles: selectedDesignFiles,
                activities: editingLeadId ? (leads.find(l => l.id === editingLeadId)?.activities || []) : [],
                createdAt: editingLeadId ? (leads.find(l => l.id === editingLeadId)?.createdAt) : new Date().toISOString(),
                createdBy: currentUser?.uid
            };

            try {
                if (editingLeadId) {
                    // Update existing lead
                    if (db) {
                        await db.collection('leads').doc(editingLeadId).update(lead);
                    } else {
                        const index = leads.findIndex(l => l.id === editingLeadId);
                        leads[index] = { ...leads[index], ...lead };
                        saveToLocalStorage();
                        renderLeadPipeline();
                        if (selectedLead && selectedLead.id === editingLeadId) {
                            selectedLead = { ...selectedLead, ...lead };
                            renderLeadDetails();
                        }
                    }
                } else {
                    // Add new lead
                    const newLead = {
                        id: Date.now().toString(),
                        ...lead
                    };

                    if (db) {
                        await db.collection('leads').doc(newLead.id).set(newLead);
                    } else {
                        leads.push(newLead);
                        saveToLocalStorage();
                        renderLeadPipeline();
                    }
                }

                closeModal('leadModal');
                editingLeadId = null;
            } catch (error) {
                console.error('Error saving lead:', error);
                alert('Failed to save lead');
            }
        }

        async function updateLeadStage(newStage) {
            if (!checkPermission('write') || !selectedLead) return;

            const oldStage = selectedLead.stage;
            
            try {
                const activity = {
                    type: 'Stage Change',
                    description: `Moved from ${leadStages.find(s => s.id === oldStage)?.label || oldStage} to ${leadStages.find(s => s.id === newStage)?.label || newStage}`,
                    date: new Date().toISOString(),
                    by: currentUser?.email || 'Unknown'
                };

                const activities = [...(selectedLead.activities || []), activity];

                if (db) {
                    await db.collection('leads').doc(selectedLead.id).update({ 
                        stage: newStage,
                        activities: activities
                    });
                } else {
                    const index = leads.findIndex(l => l.id === selectedLead.id);
                    leads[index].stage = newStage;
                    leads[index].activities = activities;
                    selectedLead.stage = newStage;
                    selectedLead.activities = activities;
                    saveToLocalStorage();
                    renderLeadPipeline();
                    renderLeadDetails();
                }
            } catch (error) {
                console.error('Error updating lead stage:', error);
                alert('Failed to update stage');
            }
        }

        async function deleteLead(id) {
            if (!checkPermission('write')) return;

            if (!confirm('Are you sure you want to delete this lead?')) return;

            try {
                if (db) {
                    await db.collection('leads').doc(id).delete();
                } else {
                    leads = leads.filter(l => l.id !== id);
                    saveToLocalStorage();
                    renderLeadPipeline();
                }

                closeLeadDetails();
            } catch (error) {
                console.error('Error deleting lead:', error);
                alert('Failed to delete lead');
            }
        }

        function filterLeads() {
            renderLeadPipeline();
        }

        function filterLeadsByStage() {
            leadStageFilter = document.getElementById('leadStageFilter').value;
            renderLeadPipeline();
        }

        function convertLeadToCustomer() {
            if (!selectedLead || selectedLead.stage !== 'won') {
                alert('Only won leads can be converted to customers');
                return;
            }

            // Pre-fill customer modal with lead data
            document.getElementById('customerName').value = selectedLead.contactPerson;
            document.getElementById('customerEmail').value = selectedLead.email;
            document.getElementById('customerPhone').value = selectedLead.phone;
            document.getElementById('customerCompany').value = selectedLead.company || '';
            
            // Switch to customers tab and show modal
            switchTab('customers');
            showAddCustomerModal();
            
            alert('Lead data has been pre-filled. Please complete and save the customer details.');
        }

        function showAddActivityModal() {
            if (!checkPermission('write') || !selectedLead) return;

            const activityType = prompt('Activity type (e.g., Call, Email, Meeting, Follow-up):');
            if (!activityType) return;

            const activityDesc = prompt('Activity description:');
            if (!activityDesc) return;

            addLeadActivity(activityType, activityDesc);
        }

        async function addLeadActivity(type, description) {
            if (!selectedLead) return;

            const activity = {
                type: type,
                description: description,
                date: new Date().toISOString(),
                by: currentUser?.email || 'Unknown'
            };

            try {
                const activities = [...(selectedLead.activities || []), activity];

                if (db) {
                    await db.collection('leads').doc(selectedLead.id).update({ activities });
                } else {
                    const index = leads.findIndex(l => l.id === selectedLead.id);
                    leads[index].activities = activities;
                    selectedLead.activities = activities;
                    saveToLocalStorage();
                    renderLeadDetails();
                }
            } catch (error) {
                console.error('Error adding activity:', error);
                alert('Failed to add activity');
            }
        }

        // Helper to switch to projects tab and select a project
        function switchToProject(projectId) {
            currentTab = 'projects';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('customersTab').style.display = 'none';
            document.getElementById('projectsTab').style.display = 'block';
            document.getElementById('addCustomerBtn').style.display = 'none';
            document.getElementById('addProjectBtn').style.display = 'block';
            
            selectedProject = projects.find(p => p.id === projectId);
            renderProjectList();
            renderProjectDetails();
        }

        // Helper to create a new project for a customer
        function createProjectForCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('saveProjectBtn').textContent = 'Add Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectStage').value = 'won';
            document.getElementById('projectValue').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            document.getElementById('projectDescription').value = '';
            
            // Populate customer dropdown and pre-select this customer
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === customerId) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        // Delete customer
        async function deleteCustomer() {
            if (!checkPermission('write')) return;
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            try {
                if (db) {
                    await db.collection('customers').doc(selectedCustomer.id).delete();
                } else {
                    customers = customers.filter(c => c.id !== selectedCustomer.id);
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                selectedCustomer = null;
                renderDetails();
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('Failed to delete customer');
            }
        }

        // Get file icon
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.includes('pdf')) return 'üìÑ';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Download file
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Make all onclick functions globally accessible
        window.handleLogin = handleLogin;
        window.handleSignup = handleSignup;
        window.handleLogout = handleLogout;
        window.toggleAuthForm = toggleAuthForm;
        window.toggleUserMenu = toggleUserMenu;
        window.showGenerateChallanModal = showGenerateChallanModal;
        window.saveDeliveryChallan = saveDeliveryChallan;
        window.deleteDeliveryChallan = deleteDeliveryChallan;
        window.downloadChallan = downloadChallan;
        window.showInstallationModal = showInstallationModal;
        window.saveInstallation = saveInstallation;
        window.updateInstallationStatus = updateInstallationStatus;
        window.deleteInstallation = deleteInstallation;
        window.showAddLeadModal = showAddLeadModal;
        window.showEditLeadModal = showEditLeadModal;
        window.saveLead = saveLead;
        window.selectLead = selectLead;
        window.closeLeadDetails = closeLeadDetails;
        window.updateLeadStage = updateLeadStage;
        window.deleteLead = deleteLead;
        window.filterLeads = filterLeads;
        window.filterLeadsByStage = filterLeadsByStage;
        window.convertLeadToCustomer = convertLeadToCustomer;
        window.showAddActivityModal = showAddActivityModal;
        window.handleLeadBOQFiles = handleLeadBOQFiles;
        window.handleLeadDesignFiles = handleLeadDesignFiles;
        window.removeLeadBOQFile = removeLeadBOQFile;
        window.removeLeadDesignFile = removeLeadDesignFile;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Manager - Cloud Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f9fafb;
            color: #111827;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sync-status {
            font-size: 0.875rem;
            color: #16a34a;
            margin-left: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-warning {
            background: #ea580c;
            color: white;
        }

        .btn-warning:hover {
            background: #c2410c;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            padding: 0.25rem 0.5rem;
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .card-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
        }

        .card-body {
            padding: 1rem;
        }

        .search-box {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .customer-list {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .customer-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .customer-item:hover {
            background: #f9fafb;
        }

        .customer-item.active {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
        }

        .customer-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .customer-contact {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .balance {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .balance.positive {
            color: #16a34a;
        }

        .balance.negative {
            color: #dc2626;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid;
        }

        .stat-card.green {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .stat-card.orange {
            background: #fff7ed;
            border-color: #fed7aa;
        }

        .stat-card.blue {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .stat-card.red {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .list-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .list-item:hover {
            background: #f9fafb;
        }

        .empty-state {
            padding: 3rem;
            text-align: center;
            color: #6b7280;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 100%;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background: white;
            margin-top: 0.75rem;
        }

        .file-upload:hover {
            background: #f9fafb;
        }

        .selected-files {
            margin-top: 0.75rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .file-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 0.25rem;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        .close-btn:hover {
            color: #6b7280;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .item-detail {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .item-date {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .placeholder {
            padding: 4rem;
            text-align: center;
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .placeholder-subtext {
            color: #9ca3af;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .attached-file {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }

        .download-btn {
            background: none;
            border: none;
            color: #2563eb;
            cursor: pointer;
            padding: 0.25rem;
        }

        .download-btn:hover {
            color: #1d4ed8;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
            padding: 0 0.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #111827;
        }

        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-won {
            background: #d1fae5;
            color: #065f46;
        }

        .status-ongoing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-handovered {
            background: #e0e7ff;
            color: #4338ca;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .setup-notice {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .setup-notice h3 {
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .setup-notice p {
            color: #78350f;
            font-size: 0.875rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            margin: 1rem;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            color: #111827;
        }

        .login-box .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 2rem;
            font-size: 0.875rem;
        }

        .login-box .form-group {
            margin-bottom: 1.5rem;
        }

        .login-box .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .login-box .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .login-box .btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .login-toggle {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .login-toggle a {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

        .login-toggle a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .role-badge-header {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .role-admin {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-viewer {
            background: #fef3c7;
            color: #92400e;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .user-button:hover {
            background: #e5e7eb;
        }

        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 100;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        .user-dropdown-item:hover {
            background: #f9fafb;
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
            color: #dc2626;
        }

        .readonly-notice {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #92400e;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üè¢ Business Manager</h1>
            <p class="subtitle">Secure access to your business data</p>
            
            <div id="loginError" class="error-message" style="display: none;"></div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" class="input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="input" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>
                <div class="login-toggle">
                    Don't have an account? <a onclick="toggleAuthForm()">Sign Up</a>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signupName" class="input" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" class="input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" class="input" placeholder="Min. 6 characters">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="signupRole" class="input">
                        <option value="viewer">Viewer (Read Only)</option>
                        <option value="admin">Admin (Full Access)</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="handleSignup()">Create Account</button>
                <div class="login-toggle">
                    Already have an account? <a onclick="toggleAuthForm()">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <div class="header" id="appHeader" style="display: none;">
        <div class="header-content">
            <div style="display: flex; align-items: center;">
                <h1>Business Manager</h1>
                <span class="sync-status" id="syncStatus">‚òÅÔ∏è Cloud Sync Active</span>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-secondary" onclick="testFirebaseConnection()" style="background: #10b981; color: white; border: none;">üß™ Test Firebase</button>
                <button class="btn btn-primary" id="addCustomerBtn" onclick="showAddCustomerModal()">+ Add Customer</button>
                <button class="btn btn-primary" id="addProjectBtn" onclick="showAddProjectModal()" style="display: none;">+ Add Project</button>
                
                <!-- User Menu -->
                <div class="user-menu">
                    <button class="user-button" onclick="toggleUserMenu()">
                        <span id="userDisplayName">User</span>
                        <span class="role-badge-header" id="userRoleBadge">Viewer</span>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-item" style="cursor: default; background: #f9fafb;">
                            <div style="font-weight: 600;" id="dropdownEmail">email@example.com</div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;" id="dropdownRole">Role: Viewer</div>
                        </div>
                        <div class="user-dropdown-item" onclick="handleLogout()">üö™ Logout</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <div id="setupNotice" class="setup-notice" style="display: none;">
            <h3>‚ö†Ô∏è Firebase Setup Required</h3>
            <p>Please add your Firebase configuration in the script section. See SETUP_GUIDE.md for instructions.</p>
        </div>

        <div id="loadingState" class="loading">
            <div>Loading data from cloud...</div>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('customers')">üë• Customers</button>
                <button class="tab" onclick="switchTab('projects')">üèóÔ∏è Projects</button>
            </div>

            <!-- Customers Tab -->
            <div id="customersTab" style="display: block;">
                <div class="grid">
                    <!-- Customer List -->
                    <div class="card">
                        <div class="card-header">
                            <input type="text" class="search-box" placeholder="üîç Search customers..." id="searchInput" oninput="filterCustomers()">
                        </div>
                        <div class="customer-list" id="customerList"></div>
                    </div>

                    <!-- Customer Details -->
                    <div id="detailsPanel"></div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="projectsTab" style="display: none;">
                <div class="grid">
                    <!-- Project List -->
                    <div class="card">
                        <div class="card-header">
                            <input type="text" class="search-box" placeholder="üîç Search projects..." id="projectSearchInput" oninput="filterProjects()">
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('all')">All</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('won')">Won</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('ongoing')">Ongoing</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;" onclick="filterProjectsByStage('handovered')">Handovered</button>
                            </div>
                        </div>
                        <div class="customer-list" id="projectList"></div>
                    </div>

                    <!-- Project Details -->
                    <div id="projectDetailsPanel"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Customer</h2>
                <button class="close-btn" onclick="closeModal('addCustomerModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" class="input" id="newCustomerName" placeholder="Enter name">
                </div>
                <div class="form-group">
                    <label>Contact (Optional)</label>
                    <input type="text" class="input" id="newCustomerContact" placeholder="Phone or email">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addCustomerModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="addCustomer()" style="flex: 1">Add Customer</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">Add New Project</h2>
                <button class="close-btn" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" class="input" id="projectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label>Customer</label>
                    <select class="input" id="projectCustomer">
                        <option value="">Select customer (optional)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stage *</label>
                    <select class="input" id="projectStage">
                        <option value="won">Won</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="handovered">Handovered</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project Value</label>
                    <input type="number" class="input" id="projectValue" placeholder="Enter value">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="input" id="projectStartDate">
                </div>
                <div class="form-group">
                    <label>Expected Completion</label>
                    <input type="date" class="input" id="projectEndDate">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="input" id="projectDescription" rows="3" placeholder="Project details..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')" style="flex: 1">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()" style="flex: 1" id="saveProjectBtn">Add Project</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // ====================================
        // FIREBASE CONFIGURATION
        // Replace these values with your Firebase project settings
        // ====================================
        const firebaseConfig = {
            apiKey: "AIzaSyAn46wP_Z4ABgo-J3R-oRl-BDPJVih9IEg",
            authDomain: "business-manager-73c4e.firebaseapp.com",
            projectId: "business-manager-73c4e",
            storageBucket: "business-manager-73c4e.firebasestorage.app",
            messagingSenderId: "612350057386",
            appId: "1:612350057386:web:35c5f4d65ce0066b88e9d3"
        };

        // Initialize Firebase
        let db;
        let auth;
        let customersListener;
        let projectsListener;
        let customers = [];
        let projects = [];
        let selectedCustomer = null;
        let selectedProject = null;
        let selectedFiles = [];
        let currentTab = 'customers';
        let projectStageFilter = 'all';
        let editingProjectId = null;
        let currentUser = null;
        let userRole = null;

        // ========================================
        // AUTHENTICATION
        // ========================================

        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                signupForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                signupForm.style.display = 'block';
            }
            
            document.getElementById('loginError').style.display = 'none';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Login successful');
            } catch (error) {
                console.error('Login error:', error);
                showError(getAuthErrorMessage(error.code));
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;
            
            if (!name || !email || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update profile with name
                await userCredential.user.updateProfile({ displayName: name });
                
                // Store user role in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString()
                });
                
                console.log('‚úÖ Signup successful');
            } catch (error) {
                console.error('Signup error:', error);
                showError(getAuthErrorMessage(error.code));
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                console.log('‚úÖ Logout successful');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out');
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu && !userMenu.contains(event.target)) {
                document.getElementById('userDropdown').classList.remove('show');
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function getAuthErrorMessage(code) {
            const messages = {
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/email-already-in-use': 'Email already registered',
                'auth/weak-password': 'Password is too weak',
                'auth/invalid-email': 'Invalid email address',
                'auth/too-many-requests': 'Too many attempts. Try again later'
            };
            return messages[code] || 'Authentication error. Please try again.';
        }

        async function getUserRole(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    return userDoc.data().role || 'viewer';
                }
                return 'viewer'; // Default to viewer if no role found
            } catch (error) {
                console.error('Error getting user role:', error);
                return 'viewer';
            }
        }

        function isAdmin() {
            return userRole === 'admin';
        }

        function updateUIForRole() {
            const isAdminUser = isAdmin();
            
            // Update role badge
            const roleBadge = document.getElementById('userRoleBadge');
            roleBadge.textContent = isAdminUser ? 'Admin' : 'Viewer';
            roleBadge.className = isAdminUser ? 'role-badge-header role-admin' : 'role-badge-header role-viewer';
            
            // Show/hide add buttons
            document.getElementById('addCustomerBtn').style.display = isAdminUser ? 'block' : 'none';
            document.getElementById('addProjectBtn').style.display = (isAdminUser && currentTab === 'projects') ? 'block' : 'none';
            
            // Add read-only notice for viewers
            if (!isAdminUser) {
                const notice = document.createElement('div');
                notice.className = 'readonly-notice';
                notice.innerHTML = 'üëÅÔ∏è <strong>View-Only Access:</strong> You can view all data but cannot make changes.';
                notice.id = 'readonlyNotice';
                
                const container = document.getElementById('appContainer');
                if (container && !document.getElementById('readonlyNotice')) {
                    container.insertBefore(notice, container.firstChild);
                }
            } else {
                const notice = document.getElementById('readonlyNotice');
                if (notice) notice.remove();
            }
            
            // Re-render UI to show/hide edit buttons
            if (currentTab === 'customers' && selectedCustomer) {
                renderDetails();
            } else if (currentTab === 'projects' && selectedProject) {
                renderProjectDetails();
            }
        }

        function checkPermission(action = 'write') {
            if (action === 'write' && !isAdmin()) {
                alert('‚õî Permission Denied\n\nYou have view-only access. Contact an admin to make changes.');
                return false;
            }
            return true;
        }

        // Firebase Connection Test
        async function testFirebaseConnection() {
            const results = [];
            
            try {
                results.push('üîç Starting Firebase Connection Test...\n');
                
                // Test 1: Check if Firebase is initialized
                results.push('Test 1: Firebase Initialization');
                if (!firebase.apps.length) {
                    results.push('‚ùå FAILED: Firebase not initialized');
                    results.push('   Fix: Check if firebaseConfig is correct\n');
                    alert(results.join('\n'));
                    console.log(results.join('\n'));
                    return;
                }
                results.push('‚úÖ PASSED: Firebase initialized\n');
                
                // Test 2: Check Firestore connection
                results.push('Test 2: Firestore Connection');
                if (!db) {
                    results.push('‚ùå FAILED: Firestore not connected');
                    results.push('   Fix: Check Firebase console - Firestore should be enabled\n');
                    alert(results.join('\n'));
                    console.log(results.join('\n'));
                    return;
                }
                results.push('‚úÖ PASSED: Firestore connected\n');
                
                // Test 3: Try to write test data
                results.push('Test 3: Write Test Data');
                const testDoc = {
                    testField: 'Firebase Connection Test',
                    timestamp: new Date().toISOString()
                };
                
                try {
                    const docRef = await db.collection('_test').add(testDoc);
                    results.push('‚úÖ PASSED: Successfully wrote test document');
                    results.push(`   Document ID: ${docRef.id}\n`);
                    
                    // Test 4: Try to read the data back
                    results.push('Test 4: Read Test Data');
                    const doc = await docRef.get();
                    if (doc.exists) {
                        results.push('‚úÖ PASSED: Successfully read test document');
                        results.push(`   Data: ${JSON.stringify(doc.data())}\n`);
                    } else {
                        results.push('‚ùå FAILED: Could not read test document\n');
                    }
                    
                    // Test 5: Delete test document
                    results.push('Test 5: Delete Test Data');
                    await docRef.delete();
                    results.push('‚úÖ PASSED: Successfully deleted test document\n');
                    
                    // Test 6: Check customers collection
                    results.push('Test 6: Check Customers Collection');
                    const customersSnapshot = await db.collection('customers').limit(1).get();
                    results.push(`‚úÖ PASSED: Customers collection accessible`);
                    results.push(`   Current customers: ${customersSnapshot.size}\n`);
                    
                } catch (writeError) {
                    results.push('‚ùå FAILED: ' + writeError.message);
                    
                    if (writeError.code === 'permission-denied') {
                        results.push('\nüîß FIX NEEDED: Security Rules Issue');
                        results.push('   Go to Firebase Console ‚Üí Firestore ‚Üí Rules');
                        results.push('   Replace rules with:\n');
                        results.push('   rules_version = \'2\';');
                        results.push('   service cloud.firestore {');
                        results.push('     match /databases/{database}/documents {');
                        results.push('       match /{document=**} {');
                        results.push('         allow read, write: if true;');
                        results.push('       }');
                        results.push('     }');
                        results.push('   }\n');
                    } else if (writeError.code === 'unavailable') {
                        results.push('\nüîß FIX NEEDED: Network/Connection Issue');
                        results.push('   - Check your internet connection');
                        results.push('   - Try refreshing the page');
                        results.push('   - Check if Firebase service is down\n');
                    } else {
                        results.push(`\nüîß Error Code: ${writeError.code}`);
                        results.push(`   Message: ${writeError.message}\n`);
                    }
                }
                
                results.push('\n' + '='.repeat(50));
                results.push('üìä TEST SUMMARY');
                results.push('='.repeat(50));
                
                const passed = results.filter(r => r.includes('‚úÖ PASSED')).length;
                const failed = results.filter(r => r.includes('‚ùå FAILED')).length;
                
                results.push(`Tests Passed: ${passed}`);
                results.push(`Tests Failed: ${failed}`);
                
                if (failed === 0) {
                    results.push('\nüéâ ALL TESTS PASSED!');
                    results.push('Firebase is working correctly.');
                    results.push('Your data should sync properly.');
                    document.getElementById('syncStatus').textContent = '‚úÖ Firebase Connected';
                    document.getElementById('syncStatus').style.color = '#16a34a';
                } else {
                    results.push('\n‚ö†Ô∏è  SOME TESTS FAILED');
                    results.push('Please fix the issues above.');
                    document.getElementById('syncStatus').textContent = '‚ö†Ô∏è  Connection Issue';
                    document.getElementById('syncStatus').style.color = '#ea580c';
                }
                
            } catch (error) {
                results.push('\nüí• CRITICAL ERROR:');
                results.push(error.message);
                results.push('\nStack trace:');
                results.push(error.stack);
            }
            
            // Display results
            const resultText = results.join('\n');
            console.log(resultText);
            alert(resultText);
        }

        function initializeFirebase() {
            try {
                // Check if config is set
                if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                    document.getElementById('setupNotice').style.display = 'block';
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    // Fallback to localStorage
                    loadFromLocalStorage();
                    return;
                }

                console.log('üî• Initializing Firebase...');
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log('‚úÖ Firebase initialized successfully!');
                
                // Set up authentication state listener
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üë§ User logged in:', user.email);
                        currentUser = user;
                        
                        // Get user role
                        userRole = await getUserRole(user.uid);
                        console.log('üîë User role:', userRole);
                        
                        // Update UI with user info
                        document.getElementById('userDisplayName').textContent = user.displayName || user.email.split('@')[0];
                        document.getElementById('dropdownEmail').textContent = user.email;
                        document.getElementById('dropdownRole').textContent = `Role: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`;
                        
                        // Hide login, show app
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('appHeader').style.display = 'block';
                        document.getElementById('appContainer').style.display = 'block';
                        
                        // Update UI based on role
                        updateUIForRole();
                        
                        // Initialize data listeners
                        setupDataListeners();
                    } else {
                        console.log('üë§ User logged out');
                        currentUser = null;
                        userRole = null;
                        
                        // Show login, hide app
                        document.getElementById('loginScreen').style.display = 'flex';
                        document.getElementById('appHeader').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'none';
                        
                        // Clear data
                        customers = [];
                        projects = [];
                        selectedCustomer = null;
                        selectedProject = null;
                    }
                });
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.getElementById('syncStatus').textContent = '‚ùå Offline Mode';
                loadFromLocalStorage();
            }
        }

        function setupDataListeners() {
            // Listen to real-time updates
            customersListener = db.collection('customers').onSnapshot((snapshot) => {
                console.log('üì° Received snapshot update:', snapshot.size, 'customers');
                customers = [];
                snapshot.forEach((doc) => {
                    customers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by creation date
                customers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('syncStatus').textContent = '‚òÅÔ∏è Cloud Sync Active';
                document.getElementById('syncStatus').style.color = '#16a34a';
                renderCustomerList();
                
                // Update selected customer if viewing one
                if (selectedCustomer) {
                    const updated = customers.find(c => c.id === selectedCustomer.id);
                    if (updated) {
                        selectedCustomer = updated;
                        renderDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Firebase snapshot error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                document.getElementById('syncStatus').textContent = '‚ùå Sync Error';
                document.getElementById('syncStatus').style.color = '#dc2626';
                
                if (error.code === 'permission-denied') {
                    alert('‚ö†Ô∏è PERMISSION DENIED\n\nFirebase security rules are blocking access.\n\nFix:\n1. Go to Firebase Console\n2. Click Firestore Database\n3. Click Rules tab\n4. Update rules (see setup guide)\n5. Click Publish\n\nThen refresh this page.');
                }
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            });

            // Listen to projects real-time updates
            projectsListener = db.collection('projects').onSnapshot((snapshot) => {
                console.log('üì° Received projects update:', snapshot.size, 'projects');
                projects = [];
                snapshot.forEach((doc) => {
                    projects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                renderProjectList();
                
                if (selectedProject) {
                    const updated = projects.find(p => p.id === selectedProject.id);
                    if (updated) {
                        selectedProject = updated;
                        renderProjectDetails();
                    }
                }
            }, (error) => {
                console.error('‚ùå Projects snapshot error:', error);
            });
        }

        // Fallback to localStorage if Firebase not configured
        function loadFromLocalStorage() {
            const customerData = localStorage.getItem('business-manager-data');
            if (customerData) {
                customers = JSON.parse(customerData);
            }
            const projectData = localStorage.getItem('business-manager-projects');
            if (projectData) {
                projects = JSON.parse(projectData);
            }
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            renderCustomerList();
            renderProjectList();
            renderDetails();
        }

        function saveToLocalStorage() {
            localStorage.setItem('business-manager-data', JSON.stringify(customers));
            localStorage.setItem('business-manager-projects', JSON.stringify(projects));
        }

        // Add customer
        async function addCustomer() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('newCustomerName').value.trim();
            const contact = document.getElementById('newCustomerContact').value.trim();

            if (!name) {
                alert('Please enter customer name');
                return;
            }

            const newCustomer = {
                name: name,
                contact: contact,
                payments: [],
                materials: [],
                createdAt: new Date().toISOString()
            };

            try {
                console.log('üíæ Attempting to add customer:', newCustomer);
                
                if (db) {
                    console.log('üì§ Writing to Firebase...');
                    const docRef = await db.collection('customers').add(newCustomer);
                    console.log('‚úÖ Customer added to Firebase with ID:', docRef.id);
                } else {
                    console.log('üíæ No Firebase connection - saving to localStorage');
                    customers.push({
                        id: Date.now().toString(),
                        ...newCustomer
                    });
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                closeModal('addCustomerModal');
                document.getElementById('newCustomerName').value = '';
                document.getElementById('newCustomerContact').value = '';
            } catch (error) {
                console.error('‚ùå Error adding customer:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                if (error.code === 'permission-denied') {
                    alert('‚ö†Ô∏è PERMISSION DENIED\n\nCannot write to Firebase.\n\nFix:\n1. Go to Firebase Console\n2. Click Firestore Database\n3. Click Rules tab\n4. Set: allow read, write: if true;\n5. Click Publish');
                } else {
                    alert('Failed to add customer: ' + error.message);
                }
            }
        }

        // Render customer list
        function renderCustomerList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(search) || 
                (c.contact && c.contact.toLowerCase().includes(search))
            );

            const html = filtered.length === 0 ? 
                '<div class="empty-state">No customers found</div>' :
                filtered.map(c => {
                    const customerProjects = projects.filter(p => p.customerId === c.id);
                    const projectCount = customerProjects.length;
                    const totalValue = customerProjects.reduce((sum, p) => sum + (p.value || 0), 0);
                    const isActive = selectedCustomer && selectedCustomer.id === c.id;
                    
                    return `
                        <div class="customer-item ${isActive ? 'active' : ''}" onclick="selectCustomer('${c.id}')">
                            <div class="customer-name">${c.name}</div>
                            ${c.contact ? `<div class="customer-contact">${c.contact}</div>` : ''}
                            <div class="balance positive">
                                ${projectCount} project${projectCount !== 1 ? 's' : ''}
                                ${totalValue > 0 ? ` ‚Ä¢ ${formatCurrency(totalValue)}` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('customerList').innerHTML = html;
        }

        // Select customer
        function selectCustomer(id) {
            selectedCustomer = customers.find(c => c.id === id);
            renderCustomerList();
            renderDetails();
        }

        // Calculate totals
        function calculateTotals(customer) {
            const totalPaid = (customer.payments || []).reduce((sum, p) => sum + p.amount, 0);
            const totalMaterials = (customer.materials || []).reduce((sum, m) => sum + m.cost, 0);
            return {
                totalPaid,
                totalMaterials,
                balance: totalPaid - totalMaterials
            };
        }

        // Format currency
        function formatCurrency(amount) {
            return '‚Çπ' + amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Render details panel
        function renderDetails() {
            if (!selectedCustomer) {
                document.getElementById('detailsPanel').innerHTML = `
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">üìä</div>
                            <div class="placeholder-text">Select a Customer</div>
                            <div class="placeholder-subtext">Choose a customer to view their projects</div>
                        </div>
                    </div>
                `;
                return;
            }

            // Get projects for this customer
            const customerProjects = projects.filter(p => p.customerId === selectedCustomer.id);
            
            // Calculate totals across all projects
            let totalProjectValue = 0;
            let totalPaid = 0;
            let totalMaterials = 0;
            
            customerProjects.forEach(p => {
                if (p.value) totalProjectValue += p.value;
                if (p.payments) totalPaid += p.payments.reduce((sum, pay) => sum + pay.amount, 0);
                if (p.materials) totalMaterials += p.materials.reduce((sum, mat) => sum + mat.cost, 0);
            });
            
            const balance = totalPaid - totalMaterials;

            const projectsHtml = customerProjects.length === 0 ?
                '<div class="empty-state">No projects for this customer yet</div>' :
                customerProjects.map(p => {
                    const stageClass = `status-${p.stage}`;
                    const stageLabel = p.stage.charAt(0).toUpperCase() + p.stage.slice(1);
                    const projectPayments = (p.payments || []).reduce((sum, pay) => sum + pay.amount, 0);
                    const projectMaterials = (p.materials || []).reduce((sum, mat) => sum + mat.cost, 0);
                    const projectBalance = projectPayments - projectMaterials;
                    
                    return `
                        <div class="list-item" style="cursor: pointer;" onclick="switchToProject('${p.id}')">
                            <div class="item-info" style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div class="item-title">${p.name}</div>
                                    <span class="status-badge ${stageClass}">${stageLabel}</span>
                                </div>
                                ${p.value ? `<div class="item-detail">üí∞ Project Value: ${formatCurrency(p.value)}</div>` : ''}
                                <div class="item-detail">
                                    Paid: ${formatCurrency(projectPayments)} | Materials: ${formatCurrency(projectMaterials)} | 
                                    <span style="color: ${projectBalance >= 0 ? '#16a34a' : '#dc2626'}; font-weight: 600;">
                                        Balance: ${formatCurrency(projectBalance)}
                                    </span>
                                </div>
                                ${p.startDate ? `<div class="item-date">Started: ${new Date(p.startDate).toLocaleDateString()}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('detailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Customer Info -->
                    <div class="card">
                        <div class="card-header">
                            <h2>${selectedCustomer.name}</h2>
                        </div>
                        <div class="card-body">
                            ${selectedCustomer.contact ? `
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Contact</div>
                                    <div style="font-weight: 600;">üìû ${selectedCustomer.contact}</div>
                                </div>
                            ` : ''}
                            <div style="font-size: 0.75rem; color: #9ca3af;">
                                Customer since: ${formatDate(selectedCustomer.createdAt)}
                            </div>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="stats">
                        <div class="stat-card green">
                            <div class="stat-label" style="color: #16a34a">Total Projects</div>
                            <div class="stat-value" style="color: #15803d">${customerProjects.length}</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-label" style="color: #2563eb">Total Value</div>
                            <div class="stat-value" style="color: #1d4ed8">${formatCurrency(totalProjectValue)}</div>
                        </div>
                        <div class="stat-card ${balance >= 0 ? 'blue' : 'red'}">
                            <div class="stat-label" style="color: ${balance >= 0 ? '#2563eb' : '#dc2626'}">Net Balance</div>
                            <div class="stat-value" style="color: ${balance >= 0 ? '#1d4ed8' : '#b91c1c'}">${formatCurrency(balance)}</div>
                        </div>
                    </div>

                    <!-- Projects List -->
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>üèóÔ∏è Projects</h3>
                            ${isAdmin() ? `<button class="btn btn-primary" onclick="createProjectForCustomer('${selectedCustomer.id}')" style="font-size: 0.875rem; padding: 0.5rem 1rem;">+ New Project</button>` : ''}
                        </div>
                        <div>${projectsHtml}</div>
                    </div>

                    ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteCustomer()">Delete Customer</button>` : ''}
                </div>
            `;
        }

        // Add payment
        async function addPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const note = document.getElementById('paymentNote').value.trim();
            const date = document.getElementById('paymentDate').value;

            if (!amount || amount <= 0) {
                alert('Please enter valid amount');
                return;
            }

            const payment = {
                id: Date.now().toString(),
                amount: amount,
                note: note,
                paymentDate: date || new Date().toISOString(),
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const payments = [...(selectedCustomer.payments || []), payment];
                    await db.collection('customers').doc(selectedCustomer.id).update({ payments });
                } else {
                    selectedCustomer.payments = [...(selectedCustomer.payments || []), payment];
                    saveToLocalStorage();
                    renderDetails();
                }

                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentNote').value = '';
                document.getElementById('paymentDate').value = '';
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Failed to add payment');
            }
        }

        // Delete payment
        async function deletePayment(id) {
            try {
                if (db) {
                    const payments = (selectedCustomer.payments || []).filter(p => p.id !== id);
                    await db.collection('customers').doc(selectedCustomer.id).update({ payments });
                } else {
                    selectedCustomer.payments = (selectedCustomer.payments || []).filter(p => p.id !== id);
                    saveToLocalStorage();
                    renderCustomerList();
                    renderDetails();
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Failed to delete payment');
            }
        }

        // Handle file selection
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 2 * 1024 * 1024) {
                    alert(file.name + ' is too large (max 2MB)');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFiles.push({
                        id: Date.now().toString() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderSelectedFiles();
                };
                reader.readAsDataURL(file);
            });
        }

        // Render selected files
        function renderSelectedFiles() {
            if (selectedFiles.length === 0) {
                document.getElementById('selectedFiles').innerHTML = '';
                return;
            }

            const html = `
                <div style="margin-top: 0.75rem;">
                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Selected Files:</div>
                    ${selectedFiles.map(f => `
                        <div class="file-item">
                            ${f.type.startsWith('image/') ?
                                `<img src="${f.data}" class="file-thumbnail" alt="${f.name}">` :
                                `<div class="file-icon">${getFileIcon(f.type)}</div>`
                            }
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.875rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFile('${f.id}')">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('selectedFiles').innerHTML = html;
        }

        // Remove file
        function removeFile(id) {
            selectedFiles = selectedFiles.filter(f => f.id !== id);
            renderSelectedFiles();
        }

        // Get file icon
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.includes('pdf')) return 'üìÑ';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Download file
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add material
        async function addMaterial() {
            const name = document.getElementById('materialName').value.trim();
            const cost = parseFloat(document.getElementById('materialCost').value);
            const quantity = document.getElementById('materialQuantity').value.trim();
            const date = document.getElementById('materialDate').value;

            if (!name || !cost || cost <= 0) {
                alert('Please enter valid material details');
                return;
            }

            const material = {
                id: Date.now().toString(),
                name: name,
                cost: cost,
                quantity: quantity,
                procurementDate: date || new Date().toISOString(),
                files: [...selectedFiles],
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const materials = [...(selectedCustomer.materials || []), material];
                    await db.collection('customers').doc(selectedCustomer.id).update({ materials });
                } else {
                    selectedCustomer.materials = [...(selectedCustomer.materials || []), material];
                    saveToLocalStorage();
                    renderDetails();
                }

                document.getElementById('materialName').value = '';
                document.getElementById('materialCost').value = '';
                document.getElementById('materialQuantity').value = '';
                document.getElementById('materialDate').value = '';
                selectedFiles = [];
            } catch (error) {
                console.error('Error adding material:', error);
                alert('Failed to add material');
            }
        }

        // Delete material
        async function deleteMaterial(id) {
            try {
                if (db) {
                    const materials = (selectedCustomer.materials || []).filter(m => m.id !== id);
                    await db.collection('customers').doc(selectedCustomer.id).update({ materials });
                } else {
                    selectedCustomer.materials = (selectedCustomer.materials || []).filter(m => m.id !== id);
                    saveToLocalStorage();
                    renderCustomerList();
                    renderDetails();
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material');
            }
        }

        // Delete customer
        async function deleteCustomer() {
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            try {
                if (db) {
                    await db.collection('customers').doc(selectedCustomer.id).delete();
                } else {
                    customers = customers.filter(c => c.id !== selectedCustomer.id);
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                selectedCustomer = null;
                renderDetails();
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('Failed to delete customer');
            }
        }

        // Filter customers
        function filterCustomers() {
            renderCustomerList();
        }

        // Show modal
        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('show');
        }

        // Close modal
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // ========================================
        // TAB SWITCHING
        // ========================================
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content
            if (tab === 'customers') {
                document.getElementById('customersTab').style.display = 'block';
                document.getElementById('projectsTab').style.display = 'none';
                document.getElementById('addCustomerBtn').style.display = 'block';
                document.getElementById('addProjectBtn').style.display = 'none';
            } else {
                document.getElementById('customersTab').style.display = 'none';
                document.getElementById('projectsTab').style.display = 'block';
                document.getElementById('addCustomerBtn').style.display = 'none';
                document.getElementById('addProjectBtn').style.display = 'block';
            }
        }

        // ========================================
        // PROJECT MANAGEMENT
        // ========================================
        
        function showAddProjectModal() {
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('saveProjectBtn').textContent = 'Add Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectCustomer').value = '';
            document.getElementById('projectStage').value = 'won';
            document.getElementById('projectValue').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            document.getElementById('projectDescription').value = '';
            
            // Populate customer dropdown
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        function showEditProjectModal(project) {
            editingProjectId = project.id;
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('saveProjectBtn').textContent = 'Update Project';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectCustomer').value = project.customerId || '';
            document.getElementById('projectStage').value = project.stage;
            document.getElementById('projectValue').value = project.value || '';
            document.getElementById('projectStartDate').value = project.startDate ? project.startDate.split('T')[0] : '';
            document.getElementById('projectEndDate').value = project.endDate ? project.endDate.split('T')[0] : '';
            document.getElementById('projectDescription').value = project.description || '';
            
            // Populate customer dropdown
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === project.customerId) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        async function saveProject() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('projectName').value.trim();
            const customerId = document.getElementById('projectCustomer').value;
            const stage = document.getElementById('projectStage').value;
            const value = parseFloat(document.getElementById('projectValue').value) || 0;
            const startDate = document.getElementById('projectStartDate').value;
            const endDate = document.getElementById('projectEndDate').value;
            const description = document.getElementById('projectDescription').value.trim();

            if (!name) {
                alert('Please enter project name');
                return;
            }

            const projectData = {
                name,
                customerId,
                customerName: customerId ? customers.find(c => c.id === customerId)?.name : '',
                stage,
                value,
                startDate: startDate || null,
                endDate: endDate || null,
                description,
                updatedAt: new Date().toISOString()
            };

            try {
                if (editingProjectId) {
                    // Update existing project
                    console.log('üìù Updating project:', editingProjectId);
                    if (db) {
                        await db.collection('projects').doc(editingProjectId).update(projectData);
                    } else {
                        const index = projects.findIndex(p => p.id === editingProjectId);
                        if (index !== -1) {
                            projects[index] = { ...projects[index], ...projectData };
                        }
                        saveToLocalStorage();
                        renderProjectList();
                    }
                } else {
                    // Add new project
                    projectData.createdAt = new Date().toISOString();
                    console.log('üíæ Adding new project:', projectData);
                    
                    if (db) {
                        await db.collection('projects').add(projectData);
                    } else {
                        projects.push({
                            id: Date.now().toString(),
                            ...projectData
                        });
                        saveToLocalStorage();
                        renderProjectList();
                    }
                }

                closeModal('projectModal');
            } catch (error) {
                console.error('‚ùå Error saving project:', error);
                alert('Failed to save project: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            if (!checkPermission('write')) return;
            if (!confirm('Are you sure you want to delete this project?')) return;
            
            try {
                if (db) {
                    await db.collection('projects').doc(projectId).delete();
                } else {
                    projects = projects.filter(p => p.id !== projectId);
                    saveToLocalStorage();
                    renderProjectList();
                }
                
                if (selectedProject?.id === projectId) {
                    selectedProject = null;
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project');
            }
        }

        async function updateProjectStage(projectId, newStage) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    await db.collection('projects').doc(projectId).update({ 
                        stage: newStage,
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    const project = projects.find(p => p.id === projectId);
                    if (project) {
                        project.stage = newStage;
                        project.updatedAt = new Date().toISOString();
                        saveToLocalStorage();
                        renderProjectList();
                        if (selectedProject?.id === projectId) {
                            selectedProject.stage = newStage;
                            renderProjectDetails();
                        }
                    }
                }
                console.log('‚úÖ Updated project stage to:', newStage);
            } catch (error) {
                console.error('Error updating stage:', error);
                alert('Failed to update project stage');
            }
        }

        function selectProject(id) {
            selectedProject = projects.find(p => p.id === id);
            renderProjectList();
            renderProjectDetails();
        }

        function filterProjects() {
            renderProjectList();
        }

        function filterProjectsByStage(stage) {
            projectStageFilter = stage;
            renderProjectList();
        }

        function renderProjectList() {
            const search = document.getElementById('projectSearchInput')?.value.toLowerCase() || '';
            let filtered = projects.filter(p => 
                p.name.toLowerCase().includes(search) || 
                (p.customerName && p.customerName.toLowerCase().includes(search)) ||
                (p.description && p.description.toLowerCase().includes(search))
            );

            if (projectStageFilter !== 'all') {
                filtered = filtered.filter(p => p.stage === projectStageFilter);
            }

            const html = filtered.length === 0 ? 
                '<div class="empty-state">No projects found</div>' :
                filtered.map(p => {
                    const isActive = selectedProject && selectedProject.id === p.id;
                    const stageClass = `status-${p.stage}`;
                    const stageLabel = p.stage.charAt(0).toUpperCase() + p.stage.slice(1);
                    
                    return `
                        <div class="customer-item ${isActive ? 'active' : ''}" onclick="selectProject('${p.id}')">
                            <div class="project-header">
                                <div class="customer-name">${p.name}</div>
                                <span class="status-badge ${stageClass}">${stageLabel}</span>
                            </div>
                            ${p.customerName ? `<div class="customer-contact">üë§ ${p.customerName}</div>` : ''}
                            ${p.value ? `<div class="customer-contact">üí∞ ${formatCurrency(p.value)}</div>` : ''}
                        </div>
                    `;
                }).join('');

            const listElement = document.getElementById('projectList');
            if (listElement) {
                listElement.innerHTML = html;
            }
        }

        function renderProjectDetails() {
            if (!selectedProject) {
                document.getElementById('projectDetailsPanel').innerHTML = `
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">üèóÔ∏è</div>
                            <div class="placeholder-text">Select a Project</div>
                            <div class="placeholder-subtext">Choose a project to manage payments and materials</div>
                        </div>
                    </div>
                `;
                return;
            }

            const stageClass = `status-${selectedProject.stage}`;
            const stageLabel = selectedProject.stage.charAt(0).toUpperCase() + selectedProject.stage.slice(1);

            // Calculate project financials
            const payments = selectedProject.payments || [];
            const materials = selectedProject.materials || [];
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const totalMaterials = materials.reduce((sum, m) => sum + m.cost, 0);
            const balance = totalPaid - totalMaterials;
            const balanceColor = balance >= 0 ? 'blue' : 'red';
            const balanceLabel = balance >= 0 ? 'Balance' : 'Outstanding';

            const paymentsHtml = payments.length === 0 ?
                '<div class="empty-state">No payments yet</div>' :
                payments.map(p => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">${formatCurrency(p.amount)}</div>
                            ${p.note ? `<div class="item-detail">${p.note}</div>` : ''}
                            <div class="item-date">Received: ${p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : formatDate(p.date)}</div>
                        </div>
                        ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteProjectPayment('${p.id}')">Delete</button>` : ''}
                    </div>
                `).join('');

            const materialsHtml = materials.length === 0 ?
                '<div class="empty-state">No materials yet</div>' :
                materials.map(m => `
                    <div class="list-item">
                        <div class="item-info">
                            <div class="item-title">${m.name}${m.quantity ? ` (${m.quantity})` : ''}</div>
                            <div class="item-detail">${formatCurrency(m.cost)}</div>
                            <div class="item-date">Procured: ${m.procurementDate ? new Date(m.procurementDate).toLocaleDateString() : formatDate(m.date)}</div>
                            ${m.files && m.files.length > 0 ? `
                                <div class="files-grid">
                                    ${m.files.map(f => `
                                        <div class="attached-file">
                                            ${f.type.startsWith('image/') ? 
                                                `<img src="${f.data}" class="file-thumbnail" alt="${f.name}">` :
                                                `<div class="file-icon">${getFileIcon(f.type)}</div>`
                                            }
                                            <div style="flex: 1; min-width: 0; overflow: hidden;">
                                                <div style="font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                                            </div>
                                            <button class="download-btn" onclick='downloadFile(${JSON.stringify(f)})' title="Download">‚¨áÔ∏è</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        ${isAdmin() ? `<button class="btn btn-danger" onclick="deleteProjectMaterial('${m.id}')">Delete</button>` : ''}
                    </div>
                `).join('');

            document.getElementById('projectDetailsPanel').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Project Header -->
                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2>${selectedProject.name}</h2>
                                <span class="status-badge ${stageClass}">${stageLabel}</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; gap: 1rem;">
                                ${selectedProject.customerName ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Customer</div>
                                        <div style="font-weight: 600;">üë§ ${selectedProject.customerName}</div>
                                    </div>
                                ` : ''}
                                
                                ${selectedProject.value ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Project Value</div>
                                        <div style="font-weight: 600; font-size: 1.25rem; color: #16a34a;">${formatCurrency(selectedProject.value)}</div>
                                    </div>
                                ` : ''}

                                <div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Update Stage</div>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button class="btn ${selectedProject.stage === 'won' ? 'btn-success' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'won')">Won</button>
                                        <button class="btn ${selectedProject.stage === 'ongoing' ? 'btn-primary' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'ongoing')">Ongoing</button>
                                        <button class="btn ${selectedProject.stage === 'handovered' ? 'btn-secondary' : 'btn-secondary'}" onclick="updateProjectStage('${selectedProject.id}', 'handovered')" style="background: #6366f1;">Handovered</button>
                                    </div>
                                </div>

                                ${selectedProject.startDate || selectedProject.endDate ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Timeline</div>
                                        <div>
                                            ${selectedProject.startDate ? `üìÖ Start: ${new Date(selectedProject.startDate).toLocaleDateString()}` : ''}
                                            ${selectedProject.startDate && selectedProject.endDate ? ' ‚Üí ' : ''}
                                            ${selectedProject.endDate ? `üèÅ End: ${new Date(selectedProject.endDate).toLocaleDateString()}` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                ${selectedProject.description ? `
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Description</div>
                                        <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap;">${selectedProject.description}</div>
                                    </div>
                                ` : ''}

                                ${isAdmin() ? `
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button class="btn btn-primary" onclick="showEditProjectModal(selectedProject)" style="flex: 1">‚úèÔ∏è Edit Project</button>
                                        <button class="btn btn-danger" onclick="deleteProject('${selectedProject.id}')">üóëÔ∏è Delete</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Financial Summary -->
                    <div class="stats">
                        <div class="stat-card green">
                            <div class="stat-label" style="color: #16a34a">Total Paid</div>
                            <div class="stat-value" style="color: #15803d">${formatCurrency(totalPaid)}</div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-label" style="color: #ea580c">Materials Cost</div>
                            <div class="stat-value" style="color: #c2410c">${formatCurrency(totalMaterials)}</div>
                        </div>
                        <div class="stat-card ${balanceColor}">
                            <div class="stat-label" style="color: ${balanceColor === 'blue' ? '#2563eb' : '#dc2626'}">${balanceLabel}</div>
                            <div class="stat-value" style="color: ${balanceColor === 'blue' ? '#1d4ed8' : '#b91c1c'}">${formatCurrency(Math.abs(balance))}</div>
                        </div>
                    </div>

                    <!-- Payments Section -->
                    <div class="card">
                        <div class="card-header">üí∞ Payments Received</div>
                        ${isAdmin() ? `
                            <div class="card-body">
                                <div class="form-grid">
                                    <input type="number" class="input" id="projectPaymentAmount" placeholder="Amount">
                                    <input type="text" class="input" id="projectPaymentNote" placeholder="Note (optional)">
                                    <input type="date" class="input" id="projectPaymentDate">
                                    <button class="btn btn-success" onclick="addProjectPayment()">Add Payment</button>
                                </div>
                            </div>
                        ` : ''}
                        <div>${paymentsHtml}</div>
                    </div>

                    <!-- Materials Section -->
                    <div class="card">
                        <div class="card-header">üì¶ Materials Procured</div>
                        ${isAdmin() ? `
                            <div class="card-body">
                                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))">
                                    <input type="text" class="input" id="projectMaterialName" placeholder="Material name">
                                    <input type="number" class="input" id="projectMaterialCost" placeholder="Cost">
                                    <input type="text" class="input" id="projectMaterialQuantity" placeholder="Quantity">
                                    <input type="date" class="input" id="projectMaterialDate">
                                    <button class="btn btn-warning" onclick="addProjectMaterial()">Add Material</button>
                                </div>
                                <div class="file-upload" onclick="document.getElementById('projectFileInput').click()">
                                    <div>üìé Click to attach files</div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">Max 2MB per file</div>
                                </div>
                                <input type="file" id="projectFileInput" multiple accept="image/*,.pdf" style="display: none" onchange="handleProjectFiles(this.files)">
                                <div class="selected-files" id="projectSelectedFiles"></div>
                            </div>
                        ` : ''}
                        <div>${materialsHtml}</div>
                    </div>
                </div>
            `;
        }

        // Initialize
        initializeFirebase();

        // ========================================
        // PROJECT PAYMENTS & MATERIALS
        // ========================================

        async function addProjectPayment() {
            if (!checkPermission('write')) return;
            
            const amount = parseFloat(document.getElementById('projectPaymentAmount').value);
            const note = document.getElementById('projectPaymentNote').value.trim();
            const date = document.getElementById('projectPaymentDate').value;

            if (!amount || amount <= 0) {
                alert('Please enter valid amount');
                return;
            }

            const payment = {
                id: Date.now().toString(),
                amount: amount,
                note: note,
                paymentDate: date || new Date().toISOString(),
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const payments = [...(selectedProject.payments || []), payment];
                    await db.collection('projects').doc(selectedProject.id).update({ payments });
                } else {
                    selectedProject.payments = [...(selectedProject.payments || []), payment];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                document.getElementById('projectPaymentAmount').value = '';
                document.getElementById('projectPaymentNote').value = '';
                document.getElementById('projectPaymentDate').value = '';
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Failed to add payment');
            }
        }

        async function deleteProjectPayment(id) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    const payments = (selectedProject.payments || []).filter(p => p.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ payments });
                } else {
                    selectedProject.payments = (selectedProject.payments || []).filter(p => p.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Failed to delete payment');
            }
        }

        function handleProjectFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 2 * 1024 * 1024) {
                    alert(file.name + ' is too large (max 2MB)');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFiles.push({
                        id: Date.now().toString() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                    renderProjectSelectedFiles();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderProjectSelectedFiles() {
            if (selectedFiles.length === 0) {
                document.getElementById('projectSelectedFiles').innerHTML = '';
                return;
            }

            const html = `
                <div style="margin-top: 0.75rem;">
                    <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Selected Files:</div>
                    ${selectedFiles.map(f => `
                        <div class="file-item">
                            ${f.type.startsWith('image/') ?
                                `<img src="${f.data}" class="file-thumbnail" alt="${f.name}">` :
                                `<div class="file-icon">${getFileIcon(f.type)}</div>`
                            }
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.875rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${formatFileSize(f.size)}</div>
                            </div>
                            <button class="btn btn-danger" onclick="removeFile('${f.id}')">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('projectSelectedFiles').innerHTML = html;
        }

        async function addProjectMaterial() {
            if (!checkPermission('write')) return;
            
            const name = document.getElementById('projectMaterialName').value.trim();
            const cost = parseFloat(document.getElementById('projectMaterialCost').value);
            const quantity = document.getElementById('projectMaterialQuantity').value.trim();
            const date = document.getElementById('projectMaterialDate').value;

            if (!name || !cost || cost <= 0) {
                alert('Please enter valid material details');
                return;
            }

            const material = {
                id: Date.now().toString(),
                name: name,
                cost: cost,
                quantity: quantity,
                procurementDate: date || new Date().toISOString(),
                files: [...selectedFiles],
                date: new Date().toISOString()
            };

            try {
                if (db) {
                    const materials = [...(selectedProject.materials || []), material];
                    await db.collection('projects').doc(selectedProject.id).update({ materials });
                } else {
                    selectedProject.materials = [...(selectedProject.materials || []), material];
                    saveToLocalStorage();
                    renderProjectDetails();
                }

                document.getElementById('projectMaterialName').value = '';
                document.getElementById('projectMaterialCost').value = '';
                document.getElementById('projectMaterialQuantity').value = '';
                document.getElementById('projectMaterialDate').value = '';
                selectedFiles = [];
            } catch (error) {
                console.error('Error adding material:', error);
                alert('Failed to add material');
            }
        }

        async function deleteProjectMaterial(id) {
            if (!checkPermission('write')) return;
            
            try {
                if (db) {
                    const materials = (selectedProject.materials || []).filter(m => m.id !== id);
                    await db.collection('projects').doc(selectedProject.id).update({ materials });
                } else {
                    selectedProject.materials = (selectedProject.materials || []).filter(m => m.id !== id);
                    saveToLocalStorage();
                    renderProjectDetails();
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material');
            }
        }

        // Helper to switch to projects tab and select a project
        function switchToProject(projectId) {
            currentTab = 'projects';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('customersTab').style.display = 'none';
            document.getElementById('projectsTab').style.display = 'block';
            document.getElementById('addCustomerBtn').style.display = 'none';
            document.getElementById('addProjectBtn').style.display = 'block';
            
            selectedProject = projects.find(p => p.id === projectId);
            renderProjectList();
            renderProjectDetails();
        }

        // Helper to create a new project for a customer
        function createProjectForCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('saveProjectBtn').textContent = 'Add Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectStage').value = 'won';
            document.getElementById('projectValue').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            document.getElementById('projectDescription').value = '';
            
            // Populate customer dropdown and pre-select this customer
            const select = document.getElementById('projectCustomer');
            select.innerHTML = '<option value="">Select customer (optional)</option>';
            customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === customerId) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('projectModal').classList.add('show');
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        // Delete customer
        async function deleteCustomer() {
            if (!checkPermission('write')) return;
            if (!confirm('Are you sure you want to delete this customer?')) return;
            
            try {
                if (db) {
                    await db.collection('customers').doc(selectedCustomer.id).delete();
                } else {
                    customers = customers.filter(c => c.id !== selectedCustomer.id);
                    saveToLocalStorage();
                    renderCustomerList();
                }
                
                selectedCustomer = null;
                renderDetails();
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('Failed to delete customer');
            }
        }

        // Get file icon
        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.includes('pdf')) return 'üìÑ';
            return 'üìé';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Download file
        function downloadFile(file) {
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Remove file from selection
        function removeFile(id) {
            selectedFiles = selectedFiles.filter(f => f.id !== id);
            renderProjectSelectedFiles();
        }
    </script>
</body>
</html>